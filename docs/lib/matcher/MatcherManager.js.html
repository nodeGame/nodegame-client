<!DOCTYPE html>
<html>
<head>
  <title>MatcherManager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "lib/matcher/MatcherManager.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#matchermanager">MatcherManager</a>
      </div>
      <div class="heading h2">
        <a href="#global%20scope">Global scope</a>
      </div>
      <div class="heading h2">
        <a href="#matchermanager%20constructor">MatcherManager constructor</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.node">MatcherManager.node</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.roler">MatcherManager.roler</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.matcher">MatcherManager.matcher</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.lastsettings">MatcherManager.lastSettings</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.lastmatches">MatcherManager.lastMatches</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.clear">MatcherManager.clear</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.match">MatcherManager.match</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.getmatches">MatcherManager.getMatches</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.getmatchfor">MatcherManager.getMatchFor</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.getrolefor">MatcherManager.getRoleFor</a>
      </div>
      <div class="heading h3">
        <a href="#roler.getidforrole">Roler.getIdForRole</a>
      </div>
      <div class="heading h3">
        <a href="#matchermanager.getiterationround">MatcherManager.getIterationRound</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods.">Helper Methods.</a>
      </div>
      <div class="heading h3">
        <a href="#round2index">round2Index</a>
      </div>
      <div class="heading h3">
        <a href="#randompairs">randomPairs</a>
      </div>
      <div class="heading h2">
        <a href="#closure">Closure</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager">
  <h1>
    <a href="#matchermanager" name="matchermanager" class="pilcrow">&#182;</a>
    MatcherManager
  </h1>
</div>


<p>Copyright(c) 2017 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>Handles matching roles to players and players to players.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>

    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global%20scope">
  <h2>
    <a href="#global%20scope" name="global%20scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">JSUS</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Roler</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">Roler</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Matcher</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">Matcher</span><span class="p">;</span>

    <span class="nx">exports</span><span class="p">.</span><span class="nx">MatcherManager</span> <span class="o">=</span> <span class="nx">MatcherManager</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager%20constructor">
  <h2>
    <a href="#matchermanager%20constructor" name="matchermanager%20constructor" class="pilcrow">&#182;</a>
    MatcherManager constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates a new instance of role mapper</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">MatcherManager</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.node">
  <h3>
    <a href="#matchermanager.node" name="matchermanager.node" class="pilcrow">&#182;</a>
    MatcherManager.node
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the node object</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.roler">
  <h3>
    <a href="#matchermanager.roler" name="matchermanager.roler" class="pilcrow">&#182;</a>
    MatcherManager.roler
  </h3>
</div>

  </div>
  <div class="body"><p>The roler object</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Roler
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">roler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Roler</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.matcher">
  <h3>
    <a href="#matchermanager.matcher" name="matchermanager.matcher" class="pilcrow">&#182;</a>
    MatcherManager.matcher
  </h3>
</div>

  </div>
  <div class="body"><p>The matcher object</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matcher</span><span class="p">({</span> <span class="nx">roler</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span> <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.lastsettings">
  <h3>
    <a href="#matchermanager.lastsettings" name="matchermanager.lastsettings" class="pilcrow">&#182;</a>
    MatcherManager.lastSettings
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the last settings parsed</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastSettings</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.lastmatches">
  <h3>
    <a href="#matchermanager.lastmatches" name="matchermanager.lastmatches" class="pilcrow">&#182;</a>
    MatcherManager.lastMatches
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the last matches</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastMatches</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.clear">
  <h3>
    <a href="#matchermanager.clear" name="matchermanager.clear" class="pilcrow">&#182;</a>
    MatcherManager.clear
  </h3>
</div>

  </div>
  <div class="body"><p>Clears current matches and roles</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mod</span>
      <span class="dox_type">string</span>
      <span>Optional. Modifies what must be cleared.
   Values: 'roles', 'matches', 'all'. Default: 'all'</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;roles&#39;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;matches&#39;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.match">
  <h3>
    <a href="#matchermanager.match" name="matchermanager.match" class="pilcrow">&#182;</a>
    MatcherManager.match
  </h3>
</div>

  </div>
  <div class="body"><p>Parses a conf object and returns the desired matches of roles and players</p>

<p>Stores a reference of last matches under <code>MatcherManager.lastMatches</code>.</p>

<p>Returned matches are in a format which is ready to be sent out as
remote options. That is:</p>

<p>matches = [
        {
            id: 'playerId',
            options: {
                role: "A", // Optional.
                partner: "partnerId", // Optional.
                group: "yyy" // For future use.
            }
        },
        // More matches...
    ];</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>The settings to generate the matches.
  The object is passed to <code>Matcher.match</code></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span>Array of matches ready to be sent out as remote options.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">MatcherManager.lastMatches</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.match</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">match</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">matches</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>String is turned into object. Might still fail.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">)</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">match</span><span class="o">:</span> <span class="nx">settings</span> <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span> <span class="o">||</span> <span class="nx">settings</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;MatcherManager.match: settings must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;object or string. Found: &#39;</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">match</span> <span class="o">===</span> <span class="s1">&#39;random_pairs&#39;</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">match</span> <span class="o">===</span> <span class="s1">&#39;round_robin&#39;</span> <span class="o">||</span>
             <span class="nx">settings</span><span class="p">.</span><span class="nx">match</span> <span class="o">===</span> <span class="s1">&#39;roundrobin&#39;</span><span class="p">))</span> <span class="p">{</span>

            <span class="nx">matches</span> <span class="o">=</span> <span class="nx">randomPairs</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;MatcherManager.match: only &quot;random_pairs&quot; and &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;&quot;round_robin&quot; algorithms supported. Found: &#39;</span> <span class="o">+</span>
                            <span class="nx">settings</span><span class="p">.</span><span class="nx">match</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matches</span> <span class="o">||</span> <span class="o">!</span><span class="nx">matches</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;MatcheManager.match: &quot;&#39;</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">match</span> <span class="o">+</span>
                            <span class="s1">&#39;&quot; did not return matches.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">lastMatches</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">matches</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.getmatches">
  <h3>
    <a href="#matchermanager.getmatches" name="matchermanager.getmatches" class="pilcrow">&#182;</a>
    MatcherManager.getMatches
  </h3>
</div>

  </div>
  <div class="body"><p>Returns all the matches in a round in the requested format</p>

<p>Accepts two parameters to specify a round, and a modifier for
the return value. Important! Both parameters are optional and
they can be passed in either order.</p>

<p>Valid modifiers and return values:</p>

<ul>
<li><p>'ARRAY' (default): [ [ 'id1', 'id2' ], [ 'id3', 'id4' ], ... ]</p></li>
<li><p>'ARRAY_ROLES': [ [ 'ROLE1', 'ROLE2' ], [ 'ROLE1', 'ROLE2' ] ]</p></li>
<li><p>'ARRAY_ROLES_ID': [ { ROLE1: 'id1', ROLE2: 'id2' },
                { ROLE1: 'id3', ROLE2: 'id4' }, ... ]</p></li>
<li><p>'ARRAY_ID_ROLES': [ { id1: 'ROLE1', id2: 'ROLE2' },
                   { id3: 'ROLE1', id4: 'ROLE4' }, ... ]</p></li>
<li><p>'OBJ': { id1: 'id2', id2: 'id1', id3: 'id4', id4: 'id3' }</p></li>
<li><p>'OBJ_ROLES_ID': { ROLE1: [ 'id1', 'id3' ], ROLE2: [ 'id2', 'id4' ] }</p></li>
<li><p>'OBJ_ID_ROLES': { id1: 'ROLE1', id2: 'ROLE2',
                 id3: 'ROLE1', id4: 'ROLE2' }</p></li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mod</span>
      <span class="dox_type">string</span>
      <span>Optional. A valid modifier (default: 'ARRAY')</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">round</span>
      <span class="dox_type">number</span>
      <span>Optional. The round of the matches
  (default: current game round).</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span class="dox_type">object</span>
      <span class="dox_type">null</span>
      <span>The requested matches in the requested
  format, or null if none is found</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">round2Index</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.getMatch</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.getMatchObject</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Roler.getRoleObj</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Roler.getIdRoleObj
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getMatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mod</span><span class="p">,</span> <span class="nx">round</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;MatcherManager.getMatches: mod must be &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;undefined or string. Found: &#39;</span> <span class="o">+</span> <span class="nx">mod</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">mod</span> <span class="o">=</span> <span class="s1">&#39;ARRAY&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">round</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;MatcherManager.getMatches: round &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;must be undefined or number. Found: &#39;</span> <span class="o">+</span> <span class="nx">round</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">round</span> <span class="o">=</span> <span class="nx">round2Index</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;getMatches&#39;</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;ARRAY&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">getMatch</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;ARRAY_ROLES&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getRoleMatch</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;ARRAY_ID_ROLES&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getId2RoleMatch</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;ARRAY_ROLES_ID&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getRole2IdMatch</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;OBJ&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">getMatchObject</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;OBJ_ROLES_ID&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getRole2IdRoundMap</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;OBJ_ID_ROLES&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getId2RoleRoundMap</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;MatcherManager.getMatches: unknown modifier: &#39;</span> <span class="o">+</span> <span class="nx">mod</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.getmatchfor">
  <h3>
    <a href="#matchermanager.getmatchfor" name="matchermanager.getmatchfor" class="pilcrow">&#182;</a>
    MatcherManager.getMatchFor
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the match for the specified id</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>The id to search a match for</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">round</span>
      <span class="dox_type">number</span>
      <span>Optional. Specifies a round other
  than current (will be normalized if there are more
  rounds than matches)</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span class="dox_type">null</span>
      <span>The current match for the id, or null
   if the id is not found</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.getMatchFor</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">round2Index
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getMatchFor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">round</span> <span class="o">=</span> <span class="nx">round2Index</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;getMatchFor&#39;</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">getMatchFor</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.getrolefor">
  <h3>
    <a href="#matchermanager.getrolefor" name="matchermanager.getrolefor" class="pilcrow">&#182;</a>
    MatcherManager.getRoleFor
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the role for the specified id</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>The id to search a role for</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">round</span>
      <span class="dox_type">number</span>
      <span>Optional. Specifies a round other
  than current (will be normalized if there are more
  rounds than matches)</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span class="dox_type">null</span>
      <span>The role hold by id at the
   specified round or null if not found</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Roler.getRolerFor</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">round2Index
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getRoleFor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">round</span> <span class="o">=</span> <span class="nx">round2Index</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;getRoleFor&#39;</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getRoleFor</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="roler.getidforrole">
  <h3>
    <a href="#roler.getidforrole" name="roler.getidforrole" class="pilcrow">&#182;</a>
    Roler.getIdForRole
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the id/s holding a roles at round x</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">role</span>
      <span class="dox_type">string</span>
      <span>The role to check</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">round</span>
      <span class="dox_type">number</span>
      <span>Optional. Specifies a round other
  than current (will be normalized if there are more
  rounds than matches)</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span>Array of id/s holding the role at round x</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Roler.getIdForRole</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">round2Index
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getIdForRole</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">role</span><span class="p">,</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">round</span> <span class="o">=</span> <span class="nx">round2Index</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;getIdForRole&#39;</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getIdForRole</span><span class="p">(</span><span class="nx">role</span><span class="p">,</span> <span class="nx">round</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="matchermanager.getiterationround">
  <h3>
    <a href="#matchermanager.getiterationround" name="matchermanager.getiterationround" class="pilcrow">&#182;</a>
    MatcherManager.getIterationRound
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the pointer the round in the matcher (matches are cycled through)</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">number</span>
      <span>The current iteration round</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.x</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.hasNext
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">MatcherManager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getIterationRound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods.">
  <h2>
    <a href="#helper%20methods." name="helper%20methods." class="pilcrow">&#182;</a>
    Helper Methods.
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="round2index">
  <h3>
    <a href="#round2index" name="round2index" class="pilcrow">&#182;</a>
    round2Index
  </h3>
</div>

  </div>
  <div class="body"><p>Parses a round into corresponding index of matches</p>

<p>Important! Matches are 0-based, but rounds are 1-based.
<code>Matcher.normalizeRound</code> takes care of it.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">round</span>
      <span class="dox_type">number</span>
      <span>Optional. The round to parse to an index.
  Default: current game round.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">number</span>
      <span>The normalized round</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.normalizeRound</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Matcher.x</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.getCurrentGameStage
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">round2Index</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">round</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">().</span><span class="nx">round</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">round</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;MatcherManager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: game stage &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;is 0.0.0, please specify a valid round.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">round</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">round</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">normalizeRound</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">round</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="randompairs">
  <h3>
    <a href="#randompairs" name="randompairs" class="pilcrow">&#182;</a>
    randomPairs
  </h3>
</div>

  </div>
  <div class="body"><p>Matches players and/or roles in random pairs</p>

<p>Supports odd number of players, if 3 roles are given in settings.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>The settings object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span>The array of matches.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">randomPairs</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">r1</span><span class="p">,</span> <span class="nx">r2</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ii</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">roundMatches</span><span class="p">,</span> <span class="nx">nMatchesIdx</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">id1</span><span class="p">,</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">soloId</span><span class="p">,</span> <span class="nx">missId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">matches</span><span class="p">,</span>  <span class="nx">sayPartner</span><span class="p">,</span> <span class="nx">doRoles</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">roles</span><span class="p">,</span> <span class="nx">matchedRoles</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">game</span><span class="p">,</span> <span class="nx">n</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">nRounds</span><span class="p">;</span>

        <span class="nx">sayPartner</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">sayPartner</span> <span class="o">?</span>
            <span class="kc">true</span> <span class="o">:</span> <span class="o">!!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">sayPartner</span><span class="p">;</span>

        <span class="nx">doRoles</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">roles</span><span class="p">;</span>

        <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">;</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Settings the number of rounds.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">rounds</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nRounds</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">rounds</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">nRounds</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getRound</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">getNextStep</span><span class="p">(),</span> <span class="s1">&#39;total&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nRounds</span> <span class="o">&gt;</span> <span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">nRounds</span> <span class="o">=</span> <span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Algorithm: random.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">match</span> <span class="o">===</span> <span class="s1">&#39;random&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">doRoles</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">setRoles</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">roles</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">fixedRoles</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">setRolifyCb</span><span class="p">(</span><span class="nx">Roler</span><span class="p">.</span><span class="nx">fixedRolifier</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span> <span class="nx">doRoles</span><span class="o">:</span> <span class="nx">doRoles</span> <span class="p">});</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">generateMatches</span><span class="p">(</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">rounds</span><span class="o">:</span> <span class="nx">nRounds</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>cycle: settings.cycle,</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">skipBye</span><span class="o">:</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">skipBye</span><span class="p">,</span>
                <span class="nx">bye</span><span class="o">:</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">bye</span>
            <span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">setIds</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">());</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Generates new random matches for this round.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Algorithm: round robin (but only if not already initialized
or if reInit = true).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">matches</span> <span class="o">||</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">reInit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">doRoles</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">setRoles</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">roles</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">fixedRoles</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">setRolifyCb</span><span class="p">(</span><span class="nx">Roler</span><span class="p">.</span><span class="nx">fixedRolifier</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span> <span class="nx">doRoles</span><span class="o">:</span> <span class="nx">doRoles</span> <span class="p">});</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Make a manual copy of settings object, and generate matches.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">generateMatches</span><span class="p">(</span><span class="s1">&#39;roundrobin&#39;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">rounds</span><span class="o">:</span> <span class="nx">nRounds</span><span class="p">,</span>
                    <span class="nx">cycle</span><span class="o">:</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">cycle</span><span class="p">,</span>
                    <span class="nx">skipBye</span><span class="o">:</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">skipBye</span><span class="p">,</span>
                    <span class="nx">bye</span><span class="o">:</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">bye</span>
                <span class="p">});</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">setIds</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">());</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Generates matches.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Cycle through the matches, if we do not have enough.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="kc">null</span> <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>Get all the matches for round x, and increments x.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">nMatchesIdx</span> <span class="o">=</span> <span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">x</span> <span class="o">?</span>
            <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>This also increments the index matcher.x.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">roundMatches</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">getMatch</span><span class="p">(</span><span class="nx">nMatchesIdx</span><span class="p">);</span>

        <span class="nx">len</span> <span class="o">=</span> <span class="nx">roundMatches</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Contains one remoteOptions object per player.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">matches</span> <span class="o">=</span> <span class="p">((</span><span class="nx">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
            <span class="k">new</span> <span class="nb">Array</span><span class="p">((</span><span class="nx">len</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="o">:</span>
            <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">skipBye</span> <span class="o">?</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">((</span><span class="nx">len</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">((</span><span class="nx">len</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>The id in case the number of player is odd.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">missId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">missingId</span><span class="p">;</span>

        <span class="nx">matchedRoles</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">roler</span><span class="p">.</span><span class="nx">getRolifiedMatches</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>While we have matches, send them to clients.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">ii</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">ii</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">match</span> <span class="o">=</span> <span class="nx">roundMatches</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">id1</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">id2</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Verify that id1 and id2 are still connected.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">id1</span><span class="p">))</span> <span class="nx">id1</span> <span class="o">=</span> <span class="nx">missId</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">id2</span><span class="p">))</span> <span class="nx">id2</span> <span class="o">=</span> <span class="nx">missId</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>If both id1 and id2 are disconnected, skip matching them.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">id1</span> <span class="o">===</span> <span class="nx">id2</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Reduce matches array length.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">len</span><span class="o">--</span><span class="p">;</span>
                <span class="nx">matches</span><span class="p">.</span><span class="nx">length</span><span class="o">--</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">doRoles</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">roles</span> <span class="o">=</span> <span class="nx">matchedRoles</span><span class="p">[</span><span class="nx">nMatchesIdx</span><span class="p">][</span><span class="nx">i</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Prepare options to send to player 1, if role1 is defined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">r1</span> <span class="o">=</span> <span class="nx">roles</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">r1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sayPartner</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id1</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">role</span><span class="o">:</span> <span class="nx">r1</span> <span class="p">}</span> <span class="p">};</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id1</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">role</span><span class="o">:</span> <span class="nx">r1</span><span class="p">,</span> <span class="nx">partner</span><span class="o">:</span> <span class="nx">id2</span> <span class="p">}</span> <span class="p">};</span>
                    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Add options to array.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">matches</span><span class="p">[</span><span class="nx">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">;</span>
                <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Prepare options to send to player 2, if role2 is defined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">r2</span> <span class="o">=</span> <span class="nx">roles</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">r2</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Increment ii index if both r1 and r2 are defined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">r1</span><span class="p">)</span> <span class="nx">ii</span><span class="o">++</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sayPartner</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">role</span><span class="o">:</span> <span class="nx">r2</span> <span class="p">}</span> <span class="p">};</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">role</span><span class="o">:</span> <span class="nx">r2</span><span class="p">,</span> <span class="nx">partner</span><span class="o">:</span> <span class="nx">id1</span> <span class="p">}</span> <span class="p">};</span>
                    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Add options to array.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">matches</span><span class="p">[</span><span class="nx">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sayPartner</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">id1</span> <span class="o">!==</span> <span class="nx">missId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id1</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">partner</span><span class="o">:</span> <span class="nx">id2</span> <span class="p">}</span> <span class="p">};</span>
                    <span class="nx">matches</span><span class="p">[</span><span class="nx">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">id2</span> <span class="o">!==</span> <span class="nx">missId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">id1</span> <span class="o">!==</span> <span class="nx">missId</span><span class="p">)</span> <span class="nx">ii</span><span class="o">++</span><span class="p">;</span>
                    <span class="nx">opts2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">partner</span><span class="o">:</span> <span class="nx">id1</span> <span class="p">}</span> <span class="p">};</span>
                    <span class="nx">matches</span><span class="p">[</span><span class="nx">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Store reference to last valid settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastSettings</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">matches</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="closure">
  <h2>
    <a href="#closure" name="closure" class="pilcrow">&#182;</a>
    Closure
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="p">})(</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span>
<span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
