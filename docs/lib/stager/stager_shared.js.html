<!DOCTYPE html>
<html>
<head>
  <title>stager_shared.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "lib/stager/stager_shared.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#stager%20stages%20and%20steps">Stager stages and steps</a>
      </div>
      <div class="heading h2">
        <a href="#block.blocktypes">Block.blockTypes</a>
      </div>
      <div class="heading h4">
        <a href="#block_default">BLOCK_DEFAULT</a>
      </div>
      <div class="heading h4">
        <a href="#block_stageblock">BLOCK_STAGEBLOCK</a>
      </div>
      <div class="heading h4">
        <a href="#block_stage">BLOCK_STAGE</a>
      </div>
      <div class="heading h4">
        <a href="#block_stepblock">BLOCK_STEPBLOCK</a>
      </div>
      <div class="heading h4">
        <a href="#block_step">BLOCK_STEP</a>
      </div>
      <div class="heading h4">
        <a href="#block_enclosing_steps">BLOCK_ENCLOSING_STEPS</a>
      </div>
      <div class="heading h4">
        <a href="#block_enclosing_stages">BLOCK_ENCLOSING_STAGES</a>
      </div>
      <div class="heading h4">
        <a href="#handlestepsarray">handleStepsArray</a>
      </div>
      <div class="heading h4">
        <a href="#addstageblock">addStageBlock</a>
      </div>
      <div class="heading h4">
        <a href="#addblock">addBlock</a>
      </div>
      <div class="heading h4">
        <a href="#checkfinalized">checkFinalized</a>
      </div>
      <div class="heading h4">
        <a href="#checkpositionsparameter">checkPositionsParameter</a>
      </div>
      <div class="heading h4">
        <a href="#addsteptoblock">addStepToBlock</a>
      </div>
      <div class="heading h4">
        <a href="#makedefaultcb">makeDefaultCb</a>
      </div>
      <div class="heading h4">
        <a href="#isdefaultcb">isDefaultCb</a>
      </div>
      <div class="heading h4">
        <a href="#makedefaultstep">makeDefaultStep</a>
      </div>
      <div class="heading h4">
        <a href="#isdefaultstep">isDefaultStep</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager%20stages%20and%20steps">
  <h1>
    <a href="#stager%20stages%20and%20steps" name="stager%20stages%20and%20steps" class="pilcrow">&#182;</a>
    Stager stages and steps
  </h1>
</div>


<p>Copyright(c) 2015 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">JSUS</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Export Stager.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">Stager</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Stager</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.blocktypes">
  <h2>
    <a href="#block.blocktypes" name="block.blocktypes" class="pilcrow">&#182;</a>
    Block.blockTypes
  </h2>
</div>

  </div>
  <div class="body"><p>List of available block types</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">blockTypes</span> <span class="o">=</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_default">
  <h4>
    <a href="#block_default" name="block_default" class="pilcrow">&#182;</a>
    BLOCK_DEFAULT
  </h4>
</div>


<p>The first block automatically added to the stager.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_DEFAULT</span><span class="o">:</span>           <span class="s1">&#39;__default&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_stageblock">
  <h4>
    <a href="#block_stageblock" name="block_stageblock" class="pilcrow">&#182;</a>
    BLOCK_STAGEBLOCK
  </h4>
</div>


<p>A block that is a collection of stages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_STAGEBLOCK</span><span class="o">:</span>        <span class="s1">&#39;__stageBlock_&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_stage">
  <h4>
    <a href="#block_stage" name="block_stage" class="pilcrow">&#182;</a>
    BLOCK_STAGE
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_STAGE</span><span class="o">:</span>             <span class="s1">&#39;__stage&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_stepblock">
  <h4>
    <a href="#block_stepblock" name="block_stepblock" class="pilcrow">&#182;</a>
    BLOCK_STEPBLOCK
  </h4>
</div>


<p>A block that is a collection of steps</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_STEPBLOCK</span><span class="o">:</span>         <span class="s1">&#39;__stepBlock_&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_step">
  <h4>
    <a href="#block_step" name="block_step" class="pilcrow">&#182;</a>
    BLOCK_STEP
  </h4>
</div>


<p>?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_STEP</span><span class="o">:</span>              <span class="s1">&#39;__step&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>BLOCK_ENCLOSING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_ENCLOSING</span><span class="o">:</span>         <span class="s1">&#39;__enclosing_&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_enclosing_steps">
  <h4>
    <a href="#block_enclosing_steps" name="block_enclosing_steps" class="pilcrow">&#182;</a>
    BLOCK_ENCLOSING_STEPS
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_ENCLOSING_STEPS</span><span class="o">:</span>   <span class="s1">&#39;__enclosing_steps&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block_enclosing_stages">
  <h4>
    <a href="#block_enclosing_stages" name="block_enclosing_stages" class="pilcrow">&#182;</a>
    BLOCK_ENCLOSING_STAGES
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">BLOCK_ENCLOSING_STAGES</span><span class="o">:</span>  <span class="s1">&#39;__enclosing_stages&#39;</span><span class="p">,</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Add private functions to Stager.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">blockTypes</span> <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">checkPositionsParameter</span> <span class="o">=</span> <span class="nx">checkPositionsParameter</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">addStageBlock</span> <span class="o">=</span> <span class="nx">addStageBlock</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">addBlock</span> <span class="o">=</span> <span class="nx">addBlock</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">checkFinalized</span> <span class="o">=</span> <span class="nx">checkFinalized</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">handleStepsArray</span> <span class="o">=</span> <span class="nx">handleStepsArray</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">makeDefaultCb</span> <span class="o">=</span> <span class="nx">makeDefaultCb</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">isDefaultCb</span> <span class="o">=</span> <span class="nx">isDefaultCb</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">isDefaultStep</span> <span class="o">=</span> <span class="nx">isDefaultStep</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">makeDefaultStep</span> <span class="o">=</span> <span class="nx">makeDefaultStep</span><span class="p">;</span>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">addStepToBlock</span> <span class="o">=</span> <span class="nx">addStepToBlock</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">BLOCK_DEFAULT</span>     <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_DEFAULT</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STAGEBLOCK</span>  <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_STAGEBLOCK</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STAGE</span>       <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span> <span class="nx">BLOCK_STAGE</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STEPBLOCK</span>   <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span> <span class="nx">BLOCK_STEPBLOCK</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STEP</span>        <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_STEP</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">BLOCK_ENCLOSING</span>          <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_ENCLOSING</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_ENCLOSING_STEPS</span>    <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span> <span class="nx">BLOCK_ENCLOSING_STEPS</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_ENCLOSING_STAGES</span>   <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_ENCLOSING_STAGES</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="handlestepsarray">
  <h4>
    <a href="#handlestepsarray" name="handlestepsarray" class="pilcrow">&#182;</a>
    handleStepsArray
  </h4>
</div>

  </div>
  <div class="body"><p>Validates the items of a steps array, creates new steps if necessary</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">Stager</span>
      <span>Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stageId</span>
      <span class="dox_type">string</span>
      <span>The original stage id</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">steps</span>
      <span class="dox_type">array</span>
      <span>The array of steps to validate</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method invoking the method</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">handleStepsArray</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">stageId</span><span class="p">,</span> <span class="nx">steps</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Missing steps are added with default callback (if string),
or as they are if object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Throw error if step.id is not unique.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">that</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Substitute with its id.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Create a step with a default cb (will be substituted).
Note: default callback and default step are two
different things.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">addStep</span><span class="p">({</span>
                        <span class="nx">id</span><span class="o">:</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
                        <span class="nx">cb</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getDefaultCb</span><span class="p">()</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage &#39;</span> <span class="o">+</span>
                                    <span class="nx">stageId</span>  <span class="o">+</span> <span class="s1">&#39;: items of the steps array &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;must be string or object.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="addstageblock">
  <h4>
    <a href="#addstageblock" name="addstageblock" class="pilcrow">&#182;</a>
    addStageBlock
  </h4>
</div>

  </div>
  <div class="body"><p>Close last step and stage blocks and add a new stage block</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">Stager</span>
      <span>The stager instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>Optional. The id of the stage block</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type</span>
      <span class="dox_type">string</span>
      <span>The type of the stage block</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">The</span>
      <span class="dox_type">string</span>
      <span class="dox_type">number</span>
      <span>allowed positions for the block</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">addBlock
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">addStageBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Begin stage block (closes two: steps and stage).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">!==</span> <span class="nx">BLOCK_DEFAULT</span><span class="p">)</span> <span class="nx">that</span><span class="p">.</span><span class="nx">endBlocks</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">=</span> <span class="nx">BLOCK_DEFAULT</span><span class="p">;</span>
        <span class="nx">addBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">positions</span><span class="p">,</span> <span class="nx">BLOCK_STAGE</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="addblock">
  <h4>
    <a href="#addblock" name="addblock" class="pilcrow">&#182;</a>
    addBlock
  </h4>
</div>

  </div>
  <div class="body"><p>Adds a new block of the specified type to the sequence</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">Stager</span>
      <span>The stager instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>Optional. The id of the stage block</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type</span>
      <span class="dox_type">string</span>
      <span>The block type</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span class="dox_type">number</span>
      <span>The allowed positions for the block</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type2</span>
      <span class="dox_type">string</span>
      <span>The value that the currentBlock variable
   will be set to (BLOCK_STAGE or BLOCK_STEP)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">addBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">positions</span><span class="p">,</span> <span class="nx">type2</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">block</span><span class="p">,</span> <span class="nx">options</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">options</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">||</span> <span class="nx">J</span><span class="p">.</span><span class="nx">uniqueKey</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">blocksIds</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">=</span> <span class="nx">type2</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Create the new block, and add it block arrays.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">block</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Block</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">block</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">block</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Save block id into the blocks map.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">that</span><span class="p">.</span><span class="nx">blocksIds</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checkfinalized">
  <h4>
    <a href="#checkfinalized" name="checkfinalized" class="pilcrow">&#182;</a>
    checkFinalized
  </h4>
</div>

  </div>
  <div class="body"><p>Check whether the stager is already finalized, and throws an error if so</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">object</span>
      <span>Reference to Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">checkFinalized</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">finalized</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stager has been &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;already finalized.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checkpositionsparameter">
  <h4>
    <a href="#checkpositionsparameter" name="checkpositionsparameter" class="pilcrow">&#182;</a>
    checkPositionsParameter
  </h4>
</div>

  </div>
  <div class="body"><p>Check validity of a positions parameter</p>

<p>Called by: <code>stage</code>, <code>repeat</code>, <code>doLoop</code>, 'loop`.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">number</span>
      <span>The positions parameter to validate</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">checkPositionsParameter</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">err</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">positions</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span> <span class="o">||</span>
                <span class="nx">positions</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
                <span class="o">!</span><span class="nb">isFinite</span><span class="p">(</span><span class="nx">positions</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">positions</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">positions</span> <span class="o">||</span> <span class="nx">positions</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: positions must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be a non-empty string, a positive finite &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number, or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">positions</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">positions</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="addsteptoblock">
  <h4>
    <a href="#addsteptoblock" name="addsteptoblock" class="pilcrow">&#182;</a>
    addStepToBlock
  </h4>
</div>

  </div>
  <div class="body"><p>Adds a step to a block</p>

<p>Checks if a step with the same id was already added.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">object</span>
      <span>Reference to Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>The block object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stepId</span>
      <span class="dox_type">string</span>
      <span>The id of the step</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span class="dox_type">number</span>
      <span>Optional. Positions allowed for
   step in the block</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if the step is added to the block</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">addStepToBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">block</span><span class="p">,</span> <span class="nx">stepId</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stepInBlock</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Add step, if not already added.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">hasItem</span><span class="p">(</span><span class="nx">stepId</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

        <span class="nx">stepInBlock</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">currentType</span><span class="p">,</span>
            <span class="nx">item</span><span class="o">:</span> <span class="nx">stepId</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">stepId</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">isDefaultStep</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">makeDefaultStep</span><span class="p">(</span><span class="nx">stepInBlock</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">block</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">stepInBlock</span><span class="p">,</span> <span class="nx">positions</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="makedefaultcb">
  <h4>
    <a href="#makedefaultcb" name="makedefaultcb" class="pilcrow">&#182;</a>
    makeDefaultCb
  </h4>
</div>

  </div>
  <div class="body"><p>Flags or create a callback function marked as <code>default</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">function</span>
      <span>Optional. The function to mark. If undefined,
  an empty function is used</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function</span>
      <span>A function flagged as <code>default</code></span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">isDefaultCb
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">makeDefaultCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="nx">cb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
        <span class="nx">cb</span><span class="p">.</span><span class="nx">_defaultCb</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="isdefaultcb">
  <h4>
    <a href="#isdefaultcb" name="isdefaultcb" class="pilcrow">&#182;</a>
    isDefaultCb
  </h4>
</div>

  </div>
  <div class="body"><p>Returns TRUE if a callback was previously marked as <code>default</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">function</span>
      <span>The function to check</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if function is default callback</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">makeDefaultCb
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">isDefaultCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">_defaultCb</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="makedefaultstep">
  <h4>
    <a href="#makedefaultstep" name="makedefaultstep" class="pilcrow">&#182;</a>
    makeDefaultStep
  </h4>
</div>

  </div>
  <div class="body"><p>Flags or create a step object marked as <code>default</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">object</span>
      <span class="dox_type">string</span>
      <span>The step object to mark. If a string
  is passed, a new step object with default cb is created.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function</span>
      <span>A function flagged as <code>default</code></span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">makeDefaultCb</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">isDefaultStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">makeDefaultStep</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">step</span><span class="p">,</span>
                <span class="nx">cb</span><span class="o">:</span> <span class="nx">makeDefaultCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="nx">step</span><span class="p">.</span><span class="nx">_defaultStep</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">step</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="isdefaultstep">
  <h4>
    <a href="#isdefaultstep" name="isdefaultstep" class="pilcrow">&#182;</a>
    isDefaultStep
  </h4>
</div>

  </div>
  <div class="body"><p>Returns TRUE if a step object was previously marked as <code>default</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">object</span>
      <span>The step object to check</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if step object is default step</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">makeDefaultStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">isDefaultStep</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">step</span><span class="p">.</span><span class="nx">_defaultStep</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">})(</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span>
<span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
