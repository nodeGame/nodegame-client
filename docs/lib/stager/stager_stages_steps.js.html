<!DOCTYPE html>
<html>
<head>
  <title>stager_stages_steps.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "lib/stager/stager_stages_steps.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#stager%20stages%20and%20steps">Stager stages and steps</a>
      </div>
      <div class="heading h4">
        <a href="#stager.addstep%20%7C%20createstep">Stager.addStep | createStep</a>
      </div>
      <div class="heading h4">
        <a href="#stager.addstage%20%7C%20createstage">Stager.addStage | createStage</a>
      </div>
      <div class="heading h4">
        <a href="#stager.clonestep">Stager.cloneStep</a>
      </div>
      <div class="heading h4">
        <a href="#stager.clonestage">Stager.cloneStage</a>
      </div>
      <div class="heading h4">
        <a href="#stager.step">Stager.step</a>
      </div>
      <div class="heading h4">
        <a href="#stager.next%20%7C%20stage">Stager.next | stage</a>
      </div>
      <div class="heading h4">
        <a href="#stager.repeat%20%7C%20repeatstage">Stager.repeat | repeatStage</a>
      </div>
      <div class="heading h4">
        <a href="#stager.loop%20%7C%20loopstage">Stager.loop | loopStage</a>
      </div>
      <div class="heading h4">
        <a href="#stager.doloop%20%7C%20doloopstage">Stager.doLoop | doLoopStage</a>
      </div>
      <div class="heading h4">
        <a href="#stager.gameover">Stager.gameover</a>
      </div>
      <div class="heading h2">
        <a href="#private%20methods">Private Methods</a>
      </div>
      <div class="heading h4">
        <a href="#addloop">addLoop</a>
      </div>
      <div class="heading h4">
        <a href="#addstagetocurrentblock">addStageToCurrentBlock</a>
      </div>
      <div class="heading h4">
        <a href="#addstepstocurrentblock">addStepsToCurrentBlock</a>
      </div>
      <div class="heading h4">
        <a href="#extractalias">extractAlias</a>
      </div>
      <div class="heading h4">
        <a href="#handlealias">handleAlias</a>
      </div>
      <div class="heading h4">
        <a href="#checkstepvalidity">checkStepValidity</a>
      </div>
      <div class="heading h4">
        <a href="#checkstepparameter">checkStepParameter</a>
      </div>
      <div class="heading h4">
        <a href="#handlestageparameter">handleStageParameter</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager%20stages%20and%20steps">
  <h1>
    <a href="#stager%20stages%20and%20steps" name="stager%20stages%20and%20steps" class="pilcrow">&#182;</a>
    Stager stages and steps
  </h1>
</div>


<p>Copyright(c) 2015 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">J</span>      <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">JSUS</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Stager</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Stager</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Block</span>  <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Block</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Get reference to shared entities in Stager.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">checkPositionsParameter</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">checkPositionsParameter</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">addStageBlock</span>           <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">addStageBlock</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">addBlock</span>                <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">addBlock</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">checkFinalized</span>          <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">checkFinalized</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">handleStepsArray</span>        <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">handleStepsArray</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">makeDefaultCb</span>           <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">makeDefaultCb</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isDefaultCb</span>             <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">isDefaultCb</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">makeDefaultStep</span>         <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">makeDefaultStep</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isDefaultStep</span>           <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">isDefaultStep</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">blockTypes</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">blockTypes</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">BLOCK_DEFAULT</span>     <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_DEFAULT</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STAGEBLOCK</span>  <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_STAGEBLOCK</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STAGE</span>       <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span> <span class="nx">BLOCK_STAGE</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STEPBLOCK</span>   <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span> <span class="nx">BLOCK_STEPBLOCK</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_STEP</span>        <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_STEP</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">BLOCK_ENCLOSING</span>          <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_ENCLOSING</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_ENCLOSING_STEPS</span>    <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span> <span class="nx">BLOCK_ENCLOSING_STEPS</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">BLOCK_ENCLOSING_STAGES</span>   <span class="o">=</span> <span class="nx">blockTypes</span><span class="p">.</span><span class="nx">BLOCK_ENCLOSING_STAGES</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.addstep%20%7C%20createstep">
  <h4>
    <a href="#stager.addstep%20%7C%20createstep" name="stager.addstep%20%7C%20createstep" class="pilcrow">&#182;</a>
    Stager.addStep | createStep
  </h4>
</div>

  </div>
  <div class="body"><p>Adds a new step</p>

<p>Registers a new game step object. Must have the following fields:</p>

<ul>
<li>id (string): The step's name</li>
<li>cb (function): The step's callback function</li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">object</span>
      <span>A valid step object. Shallowly copied.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createStep</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">checkStepValidity</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;addStep&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.addStep: step id already &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;existing: &#39;</span> <span class="o">+</span> <span class="nx">step</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span>
                            <span class="s1">&#39;. Use extendStep to modify it.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">step</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.addstage%20%7C%20createstage">
  <h4>
    <a href="#stager.addstage%20%7C%20createstage" name="stager.addstage%20%7C%20createstage" class="pilcrow">&#182;</a>
    Stager.addStage | createStage
  </h4>
</div>

  </div>
  <div class="body"><p>Adds a new stage</p>

<p>Registers a new game stage object. Must have an id field:</p>

<ul>
<li>id (string): The stage's name</li>
</ul>

<p>and either of the two following fields:</p>

<ul>
<li><p>steps (array of strings|objects): The names of the steps belonging
to this stage, or the steps objects to define them. In the latter
case steps with the same id must not have been defined before.</p></li>
<li><p>cb (function): The callback function. If this field is used,
then a step with the same name as the stage will be created,
containing all the properties. The stage will be an empty
container referencing</p></li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>A valid stage or step object. Shallowly
   copied.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">checkStageValidity
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createStage</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span><span class="p">;</span>

        <span class="nx">checkStageValidity</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="s1">&#39;addStage&#39;</span><span class="p">);</span>

        <span class="nx">id</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: stage id already existing: &#39;</span> <span class="o">+</span>
                            <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;. Use extendStage to modify it.&#39;</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>The stage contains only 1 step inside given through the callback
function. A step will be created with same id and callback.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addStep</span><span class="p">({</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span>
                <span class="nx">cb</span><span class="o">:</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span>
            <span class="p">});</span>
            <span class="k">delete</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">;</span>
            <span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">id</span> <span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Process every step in the array. Steps array is modified.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">handleStepsArray</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">,</span> <span class="s1">&#39;addStage&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.clonestep">
  <h4>
    <a href="#stager.clonestep" name="stager.clonestep" class="pilcrow">&#182;</a>
    Stager.cloneStep
  </h4>
</div>

  </div>
  <div class="body"><p>Clones a stage and assigns a new id to it</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stepId</span>
      <span class="dox_type">string</span>
      <span>The name of the stage to clone</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">newStepId</span>
      <span class="dox_type">string</span>
      <span>The new unique id to assign to the clone</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>step Reference to the cloned step</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cloneStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepId</span><span class="p">,</span> <span class="nx">newStepId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">step</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stepId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStep: stepId must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">newStepId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStep: newStepId must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">newStepId</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStep: newStepId already taken: &#39;</span> <span class="o">+</span>
                            <span class="nx">newStepId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStep: step not found: &#39;</span> <span class="o">+</span>
                            <span class="nx">stepId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">step</span><span class="p">);</span>
        <span class="nx">step</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">newStepId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">step</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">step</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.clonestage">
  <h4>
    <a href="#stager.clonestage" name="stager.clonestage" class="pilcrow">&#182;</a>
    Stager.cloneStage
  </h4>
</div>

  </div>
  <div class="body"><p>Clones a stage and assigns a new id to it</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stageId</span>
      <span class="dox_type">string</span>
      <span>The id of the stage to clone</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">newStageId</span>
      <span class="dox_type">string</span>
      <span>The new unique id to assign to the clone</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>stage Reference to the cloned stage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cloneStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stageId</span><span class="p">,</span> <span class="nx">newStageId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stage</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stageId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStage: stageId must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">newStageId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStage: newStageId must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">newStageId</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStage: newStageId already taken: &#39;</span> <span class="o">+</span>
                            <span class="nx">newStageId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">stage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageId</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.cloneStage: stage not found: &#39;</span> <span class="o">+</span>
                            <span class="nx">stageId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">stage</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
        <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">newStageId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addStage</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">stage</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.step">
  <h4>
    <a href="#stager.step" name="stager.step" class="pilcrow">&#182;</a>
    Stager.step
  </h4>
</div>

  </div>
  <div class="body"><p>Adds a step to the current Block.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A valid step object or the stepId string.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
   enclosing Block that this step can occupy.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to this instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span><span class="p">;</span>

        <span class="nx">checkFinalized</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">);</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">checkStepParameter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">);</span>
        <span class="nx">positions</span> <span class="o">=</span> <span class="nx">checkPositionsParameter</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentBlock</span><span class="p">().</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span><span class="p">,</span>
            <span class="nx">item</span><span class="o">:</span> <span class="nx">id</span>
        <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentType</span><span class="p">].</span><span class="nx">steps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.next%20%7C%20stage">
  <h4>
    <a href="#stager.next%20%7C%20stage" name="stager.next%20%7C%20stage" class="pilcrow">&#182;</a>
    Stager.next | stage
  </h4>
</div>

  </div>
  <div class="body"><p>Adds a stage block to sequence</p>

<p>The <code>id</code> parameter must have the form 'stageID' or 'stageID AS alias'.
stageID must be a valid stage and it (or alias if given) must be
unique in the sequence.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A stage name with optional alias
  or a stage object.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Allowed positions for the stage</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to this instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stage</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">stageName</span><span class="p">;</span>

            <span class="nx">checkFinalized</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">);</span>
            <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">handleStageParameter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">);</span>
            <span class="nx">positions</span> <span class="o">=</span> <span class="nx">checkPositionsParameter</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">);</span>

            <span class="nx">addStageToCurrentBlock</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;plain&#39;</span><span class="p">,</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">stageName</span>
            <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Must be done after addStageToCurrentBlock is called.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">addStepsToCurrentBlock</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageName</span><span class="p">]);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.repeat%20%7C%20repeatstage">
  <h4>
    <a href="#stager.repeat%20%7C%20repeatstage" name="stager.repeat%20%7C%20repeatstage" class="pilcrow">&#182;</a>
    Stager.repeat | repeatStage
  </h4>
</div>

  </div>
  <div class="body"><p>Adds repeated stage block to sequence</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A stage name with optional alias
  or a stage object.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Allowed positions for the stage</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to this instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">repeatStage</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">=</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">nRepeats</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">stageName</span><span class="p">;</span>

            <span class="nx">checkFinalized</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">);</span>

            <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">handleStageParameter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">nRepeats</span> <span class="o">||</span>
                <span class="nb">isNaN</span><span class="p">(</span><span class="nx">nRepeats</span><span class="p">)</span> <span class="o">||</span>
                <span class="nx">nRepeats</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.repeat: nRepeats must be a positive &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number. Found: &#39;</span> <span class="o">+</span> <span class="nx">nRepeats</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">positions</span> <span class="o">=</span> <span class="nx">checkPositionsParameter</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">);</span>

            <span class="nx">addStageToCurrentBlock</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;repeat&#39;</span><span class="p">,</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">stageName</span><span class="p">,</span>
                <span class="nx">num</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">nRepeats</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Must be done after addStageToCurrentBlock is called.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">addStepsToCurrentBlock</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageName</span><span class="p">]);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.loop%20%7C%20loopstage">
  <h4>
    <a href="#stager.loop%20%7C%20loopstage" name="stager.loop%20%7C%20loopstage" class="pilcrow">&#182;</a>
    Stager.loop | loopStage
  </h4>
</div>

  </div>
  <div class="body"><p>Adds looped stage block to sequence</p>

<p>The given stage will be repeated as long as the <code>func</code> callback
returns TRUE. If it returns FALSE on the first time, the stage is
never executed.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A stage name with optional alias
  or a stage object.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">loopFunc</span>
      <span class="dox_type">function</span>
      <span>Callback returning TRUE for
  repetition.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to this instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.doLoop
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loopStage</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">loopFunc</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">return</span> <span class="nx">addLoop</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;loop&#39;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">loopFunc</span><span class="p">,</span> <span class="nx">positions</span><span class="p">);</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.doloop%20%7C%20doloopstage">
  <h4>
    <a href="#stager.doloop%20%7C%20doloopstage" name="stager.doloop%20%7C%20doloopstage" class="pilcrow">&#182;</a>
    Stager.doLoop | doLoopStage
  </h4>
</div>

  </div>
  <div class="body"><p>Adds alternatively looped stage block to sequence</p>

<p>The given stage will be repeated once plus as many times as the
<code>func</code> callback returns TRUE.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A stage name with optional alias
  or a stage object.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">loopFunc</span>
      <span class="dox_type">function</span>
      <span>Optional. Callback returning TRUE for
  repetition.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to this instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.loop
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doLoopStage</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doLoop</span> <span class="o">=</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">loopFunc</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">return</span> <span class="nx">addLoop</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;doLoop&#39;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">loopFunc</span><span class="p">,</span> <span class="nx">positions</span><span class="p">);</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.gameover">
  <h4>
    <a href="#stager.gameover" name="stager.gameover" class="pilcrow">&#182;</a>
    Stager.gameover
  </h4>
</div>

  </div>
  <div class="body"><p>Adds gameover block to sequence</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>this object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gameover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">addStageToCurrentBlock</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;gameover&#39;</span> <span class="p">});</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="private%20methods">
  <h2>
    <a href="#private%20methods" name="private%20methods" class="pilcrow">&#182;</a>
    Private Methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="addloop">
  <h4>
    <a href="#addloop" name="addloop" class="pilcrow">&#182;</a>
    addLoop
  </h4>
</div>

  </div>
  <div class="body"><p>Handles adding a looped stage (doLoop or loop)</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">object</span>
      <span>Reference to Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type</span>
      <span class="dox_type">string</span>
      <span>The type of loop (doLoop or loop)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>The stage to loop</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">loopFunc</span>
      <span class="dox_type">function</span>
      <span>The function checking the</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this block can occupy.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span class="dox_type">null</span>
      <span>this object on success, NULL on error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.loop</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.doLoop
</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">addLoop</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">loopFunc</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stageName</span><span class="p">;</span>

        <span class="nx">checkFinalized</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>

        <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">handleStageParameter</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">loopFunc</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;: loopFunc must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function. Found: &#39;</span> <span class="o">+</span> <span class="nx">loopFunc</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">positions</span> <span class="o">=</span> <span class="nx">checkPositionsParameter</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>

        <span class="nx">addStageToCurrentBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">stageName</span><span class="p">,</span>
            <span class="nx">cb</span><span class="o">:</span> <span class="nx">loopFunc</span>
        <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Must be done after addStageToCurrentBlock is called.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">addStepsToCurrentBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageName</span><span class="p">]);</span>
        <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="addstagetocurrentblock">
  <h4>
    <a href="#addstagetocurrentblock" name="addstagetocurrentblock" class="pilcrow">&#182;</a>
    addStageToCurrentBlock
  </h4>
</div>

  </div>
  <div class="body"><p>Performs several meta operations necessary to add a stage block</p>

<p>Operations:</p>

<ul>
<li>Ends any unclosed blocks.
<ul><li>Begin a new enclosing block.</li>
<li>Adds a stage block.</li>
<li>Adds a steps block.</li></ul></li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">Stager</span>
      <span>Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>The stage to add containing its type</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. The allowed positions for the stage</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">addStageToCurrentBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">curBlock</span><span class="p">,</span> <span class="nx">rndName</span><span class="p">;</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>

        <span class="nx">rndName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nx">J</span><span class="p">.</span><span class="nx">randomInt</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>

        <span class="nx">addStageBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span>
                      <span class="nx">BLOCK_ENCLOSING</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="nx">rndName</span><span class="p">,</span>
                      <span class="nx">BLOCK_ENCLOSING_STAGES</span><span class="p">,</span>
                      <span class="nx">positions</span><span class="p">,</span>
                      <span class="nx">BLOCK_STAGE</span><span class="p">);</span>

        <span class="nx">curBlock</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getCurrentBlock</span><span class="p">();</span>
        <span class="nx">curBlock</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">BLOCK_STAGE</span><span class="p">,</span>
            <span class="nx">item</span><span class="o">:</span> <span class="nx">stage</span>
        <span class="p">});</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>

        <span class="nx">addBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span>
                 <span class="nx">BLOCK_ENCLOSING</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;_steps&#39;</span> <span class="o">+</span> <span class="nx">rndName</span><span class="p">,</span>
                 <span class="nx">BLOCK_ENCLOSING_STEPS</span><span class="p">,</span>
                 <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                 <span class="nx">BLOCK_STEP</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="addstepstocurrentblock">
  <h4>
    <a href="#addstepstocurrentblock" name="addstepstocurrentblock" class="pilcrow">&#182;</a>
    addStepsToCurrentBlock
  </h4>
</div>

  </div>
  <div class="body"><p>Adds steps to current block</p>

<p>For each step inside stage.step, it checks whether the step was
already added to current block, and if not, it adds it.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">object</span>
      <span>Reference to Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>The stage object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">addStepsToCurrentBlock</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">curBlock</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">stepInBlock</span><span class="p">;</span>
        <span class="nx">curBlock</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getCurrentBlock</span><span class="p">();</span>

        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Add step, if not already added.
TODO: This If might be always true.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">curBlock</span><span class="p">.</span><span class="nx">hasItem</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nx">stepInBlock</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">type</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">currentType</span><span class="p">,</span>
                    <span class="nx">item</span><span class="o">:</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                <span class="p">};</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">isDefaultStep</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]]))</span> <span class="p">{</span>
                    <span class="nx">makeDefaultStep</span><span class="p">(</span><span class="nx">stepInBlock</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">curBlock</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">stepInBlock</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="extractalias">
  <h4>
    <a href="#extractalias" name="extractalias" class="pilcrow">&#182;</a>
    extractAlias
  </h4>
</div>

  </div>
  <div class="body"><p>Returns an object where alias and id are separated</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nameAndAlias</span>
      <span class="dox_type">string</span>
      <span>The stage-name string</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>Object with properties id and alias (if found)</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">handleAlias
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">extractAlias</span><span class="p">(</span><span class="nx">nameAndAlias</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span><span class="p">;</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">nameAndAlias</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">(),</span>
            <span class="nx">alias</span><span class="o">:</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span> <span class="o">:</span> <span class="kc">undefined</span>
        <span class="p">};</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="handlealias">
  <h4>
    <a href="#handlealias" name="handlealias" class="pilcrow">&#182;</a>
    handleAlias
  </h4>
</div>

  </div>
  <div class="body"><p>Handles stage id and alias strings</p>

<p>Takes a string like 'stageID' or 'stageID AS alias' and return 'alias'.
Checks that alias and stage id are different.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">object</span>
      <span>Reference to Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nameAndAlias</span>
      <span class="dox_type">string</span>
      <span>The stage-name string</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>Object with properties id and alias (if found)</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">handleAlias
</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">handleAlias</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">nameAndAlias</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">alias</span><span class="p">;</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">extractAlias</span><span class="p">(</span><span class="nx">nameAndAlias</span><span class="p">);</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">alias</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">alias</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: id equal to alias: &#39;</span> <span class="o">+</span>
                            <span class="nx">nameAndAlias</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">alias</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: alias is referencing &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;non-existing stage: &#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">alias</span> <span class="o">&amp;&amp;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">alias</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: alias is not unique: &#39;</span> <span class="o">+</span>
                            <span class="nx">alias</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checkstepvalidity">
  <h4>
    <a href="#checkstepvalidity" name="checkstepvalidity" class="pilcrow">&#182;</a>
    checkStepValidity
  </h4>
</div>

  </div>
  <div class="body"><p>Returns whether given step is valid</p>

<p>Checks for syntactic validity of the step object. Does not validate
whether the name is unique, etc.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">object</span>
      <span>The step object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStep
</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">checkStepValidity</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: step must be object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: step.cb must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: step.id must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: step.id cannot &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be an empty string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>checkStageValidity</p>
  </div>
  <div class="body"><p>Returns whether given stage is valid</p>

<p>Checks for syntactic validity of the stage object. Does not validate
whether the stage name is unique, the steps exists, etc.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>The stage to validate</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">checkStageValidity</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage must be object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage must have &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;either a steps or a cb property.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage.steps cannot &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be empty.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage.steps must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;array or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage.id must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage.id cannot &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be an empty string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
     <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checkstepparameter">
  <h4>
    <a href="#checkstepparameter" name="checkstepparameter" class="pilcrow">&#182;</a>
    checkStepParameter
  </h4>
</div>

  </div>
  <div class="body"><p>Check validity of a stage parameter, eventually adds it if missing</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">Stager</span>
      <span>Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>The step to validate</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The id of the step</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">checkStepParameter</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">step</span><span class="p">,</span>
                <span class="nx">cb</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getDefaultCallback</span><span class="p">()</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: step must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;string or object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>A new step is created if not found (performs validation).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="nx">that</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">step</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="handlestageparameter">
  <h4>
    <a href="#handlestageparameter" name="handlestageparameter" class="pilcrow">&#182;</a>
    handleStageParameter
  </h4>
</div>

  </div>
  <div class="body"><p>Check validity of a stage parameter, eventually adds it if missing</p>

<p>Called by: <code>stage</code>, <code>repeat</code>, <code>doLoop</code>, 'loop`.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">Stager</span>
      <span>Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>The stage to validate</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method calling the validation</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The id or alias of the stage</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">handleStageParameter</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">alias</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage is object, &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;but a stage with the same id already &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;exists: &#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>It's a step.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="nx">that</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
                <span class="nx">stage</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">steps</span><span class="o">:</span> <span class="p">[</span> <span class="nx">id</span> <span class="p">]</span> <span class="p">};</span>
            <span class="p">}</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">addStage</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: stage must be &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;string or object.&#39;</span><span class="p">);</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>See whether the stage id contains an alias. Throws errors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">handleAlias</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">method</span><span class="p">);</span>
            <span class="nx">alias</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">alias</span><span class="p">;</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Alias must reference an existing stage (checked before).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">alias</span><span class="p">]</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Add the step if not existing and flag it as default.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">makeDefaultStep</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getDefaultCb</span><span class="p">()));</span>
                <span class="p">}</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">addStage</span><span class="p">({</span>
                    <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span>
                    <span class="nx">steps</span><span class="o">:</span> <span class="p">[</span> <span class="nx">id</span> <span class="p">]</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">alias</span> <span class="o">||</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">})(</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span>
<span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
