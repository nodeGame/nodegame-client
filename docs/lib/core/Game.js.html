<!DOCTYPE html>
<html>
<head>
  <title>Game.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "lib/core/Game.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#game">Game</a>
      </div>
      <div class="heading h2">
        <a href="#global%20scope">Global scope</a>
      </div>
      <div class="heading h2">
        <a href="#game%20constructor">Game constructor</a>
      </div>
      <div class="heading h2">
        <a href="#properties">Properties</a>
      </div>
      <div class="heading h3">
        <a href="#game.metadata">Game.metadata</a>
      </div>
      <div class="heading h3">
        <a href="#game.settings">Game.settings</a>
      </div>
      <div class="heading h3">
        <a href="#game.pl%20%7C%20playerlist">Game.pl | playerList</a>
      </div>
      <div class="heading h3">
        <a href="#game.ml%20%7C%20monitorlist">Game.ml | monitorList</a>
      </div>
      <div class="heading h3">
        <a href="#game.memory">Game.memory</a>
      </div>
      <div class="heading h3">
        <a href="#game.plot">Game.plot</a>
      </div>
      <div class="heading h2">
        <a href="#game.timer">Game.timer</a>
      </div>
      <div class="heading h3">
        <a href="#game.checkplistsize">Game.checkPlistSize</a>
      </div>
      <div class="heading h3">
        <a href="#game.plchangehandler">Game.plChangeHandler</a>
      </div>
      <div class="heading h3">
        <a href="#game.paused">Game.paused</a>
      </div>
      <div class="heading h3">
        <a href="#game.pausecounter">Game.pauseCounter</a>
      </div>
      <div class="heading h3">
        <a href="#game.willbedone">Game.willBeDone</a>
      </div>
      <div class="heading h3">
        <a href="#game.minplayercbcalled">Game.minPlayerCbCalled</a>
      </div>
      <div class="heading h3">
        <a href="#game.maxplayercbcalled">Game.maxPlayerCbCalled</a>
      </div>
      <div class="heading h3">
        <a href="#game.exactplayercbcalled">Game.exactPlayerCbCalled</a>
      </div>
      <div class="heading h3">
        <a href="#game.globals">Game.globals</a>
      </div>
      <div class="heading h3">
        <a href="#game._steppedsteps">Game._steppedSteps</a>
      </div>
      <div class="heading h3">
        <a href="#game.pushmanager">Game.pushManager</a>
      </div>
      <div class="heading h2">
        <a href="#game%20methods">Game methods</a>
      </div>
      <div class="heading h3">
        <a href="#game.start">Game.start</a>
      </div>
      <div class="heading h3">
        <a href="#game.restart">Game.restart</a>
      </div>
      <div class="heading h3">
        <a href="#game.stop">Game.stop</a>
      </div>
      <div class="heading h3">
        <a href="#game.gameover">Game.gameover</a>
      </div>
      <div class="heading h3">
        <a href="#game.ispaused">Game.isPaused</a>
      </div>
      <div class="heading h3">
        <a href="#game.pause">Game.pause</a>
      </div>
      <div class="heading h3">
        <a href="#game.resume">Game.resume</a>
      </div>
      <div class="heading h3">
        <a href="#game.shouldstep">Game.shouldStep</a>
      </div>
      <div class="heading h3">
        <a href="#game.step">Game.step</a>
      </div>
      <div class="heading h3">
        <a href="#game.gotostep">Game.gotoStep</a>
      </div>
      <div class="heading h3">
        <a href="#game.execstep">Game.execStep</a>
      </div>
      <div class="heading h2">
        <a href="#game.execcallback">Game.execCallback</a>
      </div>
      <div class="heading h3">
        <a href="#game.getcurrentstepobj">Game.getCurrentStepObj</a>
      </div>
      <div class="heading h3">
        <a href="#game.getcurrentstep">Game.getCurrentStep</a>
      </div>
      <div class="heading h3">
        <a href="#game.getcurrentstepproperty">Game.getCurrentStepProperty</a>
      </div>
      <div class="heading h3">
        <a href="#game.getcurrentgamestage">Game.getCurrentGameStage</a>
      </div>
      <div class="heading h3">
        <a href="#game.setcurrentgamestage">Game.setCurrentGameStage</a>
      </div>
      <div class="heading h3">
        <a href="#game.getstatelevel">Game.getStateLevel</a>
      </div>
      <div class="heading h3">
        <a href="#game.setstatelevel">Game.setStateLevel</a>
      </div>
      <div class="heading h3">
        <a href="#game.getstagelevel">Game.getStageLevel</a>
      </div>
      <div class="heading h3">
        <a href="#game.setstagelevel">Game.setStageLevel</a>
      </div>
      <div class="heading h3">
        <a href="#game.publishupdate">Game.publishUpdate</a>
      </div>
      <div class="heading h3">
        <a href="#game.shouldpublishupdate">Game.shouldPublishUpdate</a>
      </div>
      <div class="heading h3">
        <a href="#game.isready">Game.isReady</a>
      </div>
      <div class="heading h3">
        <a href="#game.isstartable">Game.isStartable</a>
      </div>
      <div class="heading h3">
        <a href="#game.isstoppable">Game.isStoppable</a>
      </div>
      <div class="heading h3">
        <a href="#game.ispausable">Game.isPausable</a>
      </div>
      <div class="heading h3">
        <a href="#game.isresumable">Game.isResumable</a>
      </div>
      <div class="heading h3">
        <a href="#game.issteppable">Game.isSteppable</a>
      </div>
      <div class="heading h3">
        <a href="#game.isgameover">Game.isGameover</a>
      </div>
      <div class="heading h3">
        <a href="#game.shouldemitplaying">Game.shouldEmitPlaying</a>
      </div>
      <div class="heading h3">
        <a href="#game.comparecurrentstep">Game.compareCurrentStep</a>
      </div>
      <div class="heading h3">
        <a href="#game.getpreviousstep">Game.getPreviousStep</a>
      </div>
      <div class="heading h3">
        <a href="#game.getnextstep">Game.getNextStep</a>
      </div>
      <div class="heading h3">
        <a href="#game.updateglobals">Game.updateGlobals</a>
      </div>
      <div class="heading h3">
        <a href="#game.getproperty">Game.getProperty</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods">Helper Methods</a>
      </div>
      <div class="heading h3">
        <a href="#processgotostepoptions">processGoToStepOptions</a>
      </div>
      <div class="heading h3">
        <a href="#checkminmaxexactparams">checkMinMaxExactParams</a>
      </div>
      <div class="heading h2">
        <a href="#closure">Closure</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game">
  <h1>
    <a href="#game" name="game" class="pilcrow">&#182;</a>
    Game
  </h1>
</div>


<p>Copyright(c) 2016 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>Handles the flow of the game</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>

    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global%20scope">
  <h2>
    <a href="#global%20scope" name="global%20scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Exposing Game constructor</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Game</span> <span class="o">=</span> <span class="nx">Game</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">GameStage</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GameStage</span><span class="p">,</span>
    <span class="nx">GameDB</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GameDB</span><span class="p">,</span>
    <span class="nx">GamePlot</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GamePlot</span><span class="p">,</span>
    <span class="nx">PlayerList</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">PlayerList</span><span class="p">,</span>
    <span class="nx">Stager</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">Stager</span><span class="p">,</span>
    <span class="nx">PushManager</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">PushManager</span><span class="p">,</span>
    <span class="nx">J</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">JSUS</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">constants</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">constants</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game%20constructor">
  <h2>
    <a href="#game%20constructor" name="game%20constructor" class="pilcrow">&#182;</a>
    Game constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates a new instance of Game</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">node</span>
      <span class="dox_type">NodeGameClient</span>
      <span>A valid NodeGameClient object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">Game</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>This updates are never published.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="properties">
  <h2>
    <a href="#properties" name="properties" class="pilcrow">&#182;</a>
    Properties
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.metadata">
  <h3>
    <a href="#game.metadata" name="game.metadata" class="pilcrow">&#182;</a>
    Game.metadata
  </h3>
</div>

  </div>
  <div class="body"><p>The game's metadata</p>

<p>This object is under normal auto filled with the data
from the file <code>package.json</code> inside the game folder.</p>

<p>Contains at least the following properties:</p>

<ul>
<li>name,
<ul><li>description,</li>
<li>version</li></ul></li>
</ul>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">name</span><span class="o">:</span>        <span class="s1">&#39;A nodeGame game&#39;</span><span class="p">,</span>
            <span class="nx">description</span><span class="o">:</span> <span class="s1">&#39;No description&#39;</span><span class="p">,</span>
            <span class="nx">version</span><span class="o">:</span>     <span class="s1">&#39;0.0.1&#39;</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.settings">
  <h3>
    <a href="#game.settings" name="game.settings" class="pilcrow">&#182;</a>
    Game.settings
  </h3>
</div>

  </div>
  <div class="body"><p>The game's settings</p>

<p>This object is under normal auto filled with the settings
contained in the game folder: <code>game/game.settings</code>,
depending also on the chosen treatment.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.pl%20%7C%20playerlist">
  <h3>
    <a href="#game.pl%20%7C%20playerlist" name="game.pl%20%7C%20playerlist" class="pilcrow">&#182;</a>
    Game.pl | playerList
  </h3>
</div>

  </div>
  <div class="body"><p>The list of players connected to the game</p>

<p>The list may be empty, depending on the server settings.</p>

<p>Two players with the same id, or any player with id equal to
<code>node.player.id</code> is not allowed, and it will throw an error.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">playerList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PlayerList</span><span class="p">({</span>
            <span class="nx">log</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span>
            <span class="nx">logCtx</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span>
            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;pl_&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodename</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;node.game.pl.on.insert: cannot add player &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;with id equal to node.player.id.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.ml%20%7C%20monitorlist">
  <h3>
    <a href="#game.ml%20%7C%20monitorlist" name="game.ml%20%7C%20monitorlist" class="pilcrow">&#182;</a>
    Game.ml | monitorList
  </h3>
</div>

  </div>
  <div class="body"><p>The list of monitor clients connected to the game</p>

<p>The list may be empty, depending on the server settings</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">monitorList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ml</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PlayerList</span><span class="p">({</span>
            <span class="nx">log</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span>
            <span class="nx">logCtx</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span>
            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;ml_&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodename</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.memory">
  <h3>
    <a href="#game.memory" name="game.memory" class="pilcrow">&#182;</a>
    Game.memory
  </h3>
</div>

  </div>
  <div class="body"><p>A storage database for the game</p>

<p>In the server logic the content of SET messages are
automatically inserted in this object</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">NodeGameClient.set
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">memory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GameDB</span><span class="p">({</span>
            <span class="nx">log</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span>
            <span class="nx">logCtx</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span>
            <span class="nx">shared</span><span class="o">:</span> <span class="p">{</span> <span class="nx">node</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="p">}</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.plot">
  <h3>
    <a href="#game.plot" name="game.plot" class="pilcrow">&#182;</a>
    Game.plot
  </h3>
</div>

  </div>
  <div class="body"><p>The Game plot</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">plot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GamePlot</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Stager</span><span class="p">());</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>TODO: check if we need this.
       // Overriding stdout for game plot and stager.
       this.plot.setDefaultLog(function() {
           // Must use apply, else will be executed in the wrong context.
           node.log.apply(node, arguments);
       });</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.timer">
  <h2>
    <a href="#game.timer" name="game.timer" class="pilcrow">&#182;</a>
    Game.timer
  </h2>
</div>

  </div>
  <div class="body"><p>Default game timer synced with stager 'timer' property</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameTimer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameTimer.syncWithStager
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">createTimer</span><span class="p">({</span>
            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;game_timer&#39;</span><span class="p">,</span>
            <span class="nx">stagerSync</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.checkplistsize">
  <h3>
    <a href="#game.checkplistsize" name="game.checkplistsize" class="pilcrow">&#182;</a>
    Game.checkPlistSize
  </h3>
</div>

  </div>
  <div class="body"><p>Applies to the PlayerList the constraints defined in the Stager</p>

<p>Reads the properties min/max/exactPlayers for the current step
and checks them with the PlayerList object.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if all checks are passed</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.step
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">checkPlistSize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.plchangehandler">
  <h3>
    <a href="#game.plchangehandler" name="game.plchangehandler" class="pilcrow">&#182;</a>
    Game.plChangeHandler
  </h3>
</div>

  </div>
  <div class="body"><p>Handles changes in the number of players</p>

<p>Reads the properties min/max/exactPlayers for the current step
and calls the appropriate callback functions.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">plChangeHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span> <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Setting to stage 0.0.0 and starting.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentGameStage</span><span class="p">(</span><span class="k">new</span> <span class="nx">GameStage</span><span class="p">(),</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STARTING</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.paused">
  <h3>
    <a href="#game.paused" name="game.paused" class="pilcrow">&#182;</a>
    Game.paused
  </h3>
</div>

  </div>
  <div class="body"><p>TRUE, if the game is paused</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.pause</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.resume
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">paused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.pausecounter">
  <h3>
    <a href="#game.pausecounter" name="game.pausecounter" class="pilcrow">&#182;</a>
    Game.pauseCounter
  </h3>
</div>

  </div>
  <div class="body"><p>Counts the number of times the game was paused</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.pause</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.resume
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">pauseCounter</span> <span class="o">=</span> <span class="mi">0</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.willbedone">
  <h3>
    <a href="#game.willbedone" name="game.willbedone" class="pilcrow">&#182;</a>
    Game.willBeDone
  </h3>
</div>

  </div>
  <div class="body"><p>TRUE, if DONE was emitted and evaluated successfully</p>

<p>If TRUE, when PLAYING is emitted the game will try to step
immediately.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">NodeGameClient.done</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.doneCalled
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">willBeDone</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.minplayercbcalled">
  <h3>
    <a href="#game.minplayercbcalled" name="game.minplayercbcalled" class="pilcrow">&#182;</a>
    Game.minPlayerCbCalled
  </h3>
</div>

  </div>
  <div class="body"><p>TRUE, if the mininum-player callback has already been called</p>

<p>This is reset when the min-condition is satisfied again.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">minPlayerCbCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.maxplayercbcalled">
  <h3>
    <a href="#game.maxplayercbcalled" name="game.maxplayercbcalled" class="pilcrow">&#182;</a>
    Game.maxPlayerCbCalled
  </h3>
</div>

  </div>
  <div class="body"><p>TRUE, if the maxinum-player callback has already been called</p>

<p>This is reset when the max-condition is satisfied again.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">maxPlayerCbCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.exactplayercbcalled">
  <h3>
    <a href="#game.exactplayercbcalled" name="game.exactplayercbcalled" class="pilcrow">&#182;</a>
    Game.exactPlayerCbCalled
  </h3>
</div>

  </div>
  <div class="body"><p>TRUE, if the exact-player callback has already been called</p>

<p>This is reset when the exact-condition is satisfied again.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">exactPlayerCbCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.globals">
  <h3>
    <a href="#game.globals" name="game.globals" class="pilcrow">&#182;</a>
    Game.globals
  </h3>
</div>

  </div>
  <div class="body"><p>Object pointing to the current step <em>globals</em> properties</p>

<p>Whenever a new step is executed the <em>globals</em> properties of
the step are copied here. The <em>globals</em> properties of the previous
stage are deleted.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">globals</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game._steppedsteps">
  <h3>
    <a href="#game._steppedsteps" name="game._steppedsteps" class="pilcrow">&#182;</a>
    Game._steppedSteps
  </h3>
</div>

  </div>
  <div class="body"><p>Array of steps previously played</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.step
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">_steppedSteps</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">GameStage</span><span class="p">()];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.pushmanager">
  <h3>
    <a href="#game.pushmanager" name="game.pushmanager" class="pilcrow">&#182;</a>
    Game.pushManager
  </h3>
</div>

  </div>
  <div class="body"><p>Handles pushing client to advance to next step</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">PushManager
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">pushManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PushManager</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="game%20methods">
  <h2>
    <a href="#game%20methods" name="game%20methods" class="pilcrow">&#182;</a>
    Game methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.start">
  <h3>
    <a href="#game.start" name="game.start" class="pilcrow">&#182;</a>
    Game.start
  </h3>
</div>

  </div>
  <div class="body"><p>Starts the game</p>

<p>Calls the init function, and steps.</p>

<p>Important: it does not use <code>Game.publishUpdate</code> because that is
just for change of state after the game has started.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Configuration object. Fields:

<ul>
<li>step: true/false. If false, jus call the init function, and
does not enter the first step. Default, TRUE.</li>
</ul></span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">onInit</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">startStage</span><span class="p">;</span>

        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.start: options must be object or &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">placeholder</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.start: no player defined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isStartable</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.start: game cannot be started.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;game started.&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Store time.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">setTimestamp</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">);</span>

        <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Starts from beginning (default) or from a predefined stage
This options is useful when a player reconnets.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">startStage</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">startStage</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">GameStage</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Update GLOBALS.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">updateGlobals</span><span class="p">(</span><span class="nx">startStage</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>INIT the game.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">onInit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">stager</span><span class="p">.</span><span class="nx">getOnInit</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">onInit</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">);</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;INIT&#39;</span><span class="p">);</span>
            <span class="nx">onInit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZED</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentGameStage</span><span class="p">(</span><span class="nx">startStage</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;game started.&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">step</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">step</span><span class="p">();</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.restart">
  <h3>
    <a href="#game.restart" name="game.restart" class="pilcrow">&#182;</a>
    Game.restart
  </h3>
</div>

  </div>
  <div class="body"><p>Stops and starts the game.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.stop</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.start
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">restart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.stop">
  <h3>
    <a href="#game.stop" name="game.stop" class="pilcrow">&#182;</a>
    Game.stop
  </h3>
</div>

  </div>
  <div class="body"><p>Stops the current game</p>

<p>Clears timers, event handlers, local memory, and window frame (if any).</p>

<p>Does <strong>not</strong> clear <em>node.env</em> variables and any node.player extra
property.</p>

<p>If additional properties (e.g. widgets) have been added to the game
object by any of the previous game callbacks, they will not be removed.
TODO: avoid pollution of the game object.</p>

<p>GameStage is set to 0.0.0 and server is notified.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">;</span>

        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isStoppable</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.stop: game cannot be stopped.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Destroy currently running timers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">destroyAllTimers</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Remove all events registered during the game.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">step</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Clear memory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>If a <em>GameWindow</em> object is found, clears it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Update state/stage levels and game stage.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STARTING</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>This command is notifying the server.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentGameStage</span><span class="p">(</span><span class="k">new</span> <span class="nx">GameStage</span><span class="p">());</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Temporary change:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pl</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">ml</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ml</span><span class="p">;</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;game stopped.&#39;</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.gameover">
  <h3>
    <a href="#game.gameover" name="game.gameover" class="pilcrow">&#182;</a>
    Game.gameover
  </h3>
</div>

  </div>
  <div class="body"><p>Ends the game</p>

<p>Calls the gameover function, sets levels.</p>

<p>TODO: should it set the game stage to 0.0.0 again ?</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gameover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">onGameover</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">FINISHING</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Game.gameover called on a finishing game.&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;GAME_ALMOST_OVER&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Call gameover callback, if it exists.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">onGameover</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">stager</span><span class="p">.</span><span class="nx">getOnGameover</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">onGameover</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">FINISHING</span><span class="p">);</span>
            <span class="nx">onGameover</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">GAMEOVER</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;game over.&#39;</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;GAME_OVER&#39;</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.ispaused">
  <h3>
    <a href="#game.ispaused" name="game.ispaused" class="pilcrow">&#182;</a>
    Game.isPaused
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE, if game is paused</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.pause
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isPaused</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">paused</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.pause">
  <h3>
    <a href="#game.pause" name="game.pause" class="pilcrow">&#182;</a>
    Game.pause
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the game to pause</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">param</span>
      <span class="dox_type">string</span>
      <span>Optional. A parameter to pass along the
  emitted events PAUSING and PAUSED.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.resume
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">msgHandler</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isPausable</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.pause: game cannot be paused.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;PAUSING&#39;</span><span class="p">,</span> <span class="nx">param</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">paused</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">pauseCounter</span><span class="o">++</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>If the Stager has a method for accepting messages during a
pause, pass them to it. Otherwise, buffer the messages
until the game is resumed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">msgHandler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">(),</span>
                                           <span class="s1">&#39;pauseMsgHandler&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">msgHandler</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">setMsgListener</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">msg</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">secureParse</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                <span class="nx">msgHandler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toInEvent</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">setTimestamp</span><span class="p">(</span><span class="s1">&#39;paused&#39;</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;PAUSED&#39;</span><span class="p">,</span> <span class="nx">param</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>TODO: broadcast?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

        <span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;game paused.&#39;</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.resume">
  <h3>
    <a href="#game.resume" name="game.resume" class="pilcrow">&#182;</a>
    Game.resume
  </h3>
</div>

  </div>
  <div class="body"><p>Resumes the game from pause</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">param</span>
      <span class="dox_type">string</span>
      <span>Optional. A parameter to pass along the
  emitted events RESUMING and RESUMED.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.pause
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">msgHandler</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isResumable</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.resume: game cannot be resumed.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;RESUMING&#39;</span><span class="p">,</span> <span class="nx">param</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">paused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>If the Stager defines an appropriate handler, give it the messages
that were buffered during the pause.
Otherwise, emit the buffered messages normally.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">msgHandler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">(),</span>
                                           <span class="s1">&#39;resumeMsgHandler&#39;</span><span class="p">);</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clearBuffer</span><span class="p">(</span><span class="nx">msgHandler</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Reset the Socket's message handler to the default:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">setMsgListener</span><span class="p">();</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">setTimestamp</span><span class="p">(</span><span class="s1">&#39;resumed&#39;</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;RESUMED&#39;</span><span class="p">,</span> <span class="nx">param</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>TODO: broadcast?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Maybe the game was LOADED during the pausing.
In this case the PLAYING event got lost.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shouldEmitPlaying</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;PLAYING&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;game resumed.&#39;</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.shouldstep">
  <h3>
    <a href="#game.shouldstep" name="game.shouldstep" class="pilcrow">&#182;</a>
    Game.shouldStep
  </h3>
</div>

  </div>
  <div class="body"><p>Checks if the next step can be executed</p>

<p>Checks the number of players required.
If the game has been initialized and is not in GAME_OVER, then
evaluates the stepRule function for the current step and returns
its result.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stageLevel</span>
      <span class="dox_type">number</span>
      <span>Optional. If set, it is used instead
  of <code>Game.getStageLevel()</code></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE, if stepping is allowed;
  FALSE, if stepping is not allowed</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.step</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.checkPlistSize</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">stepRules
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shouldStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stageLevel</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stepRule</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">checkPlistSize</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isSteppable</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">stepRule</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStepRule</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">());</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stepRule</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.shouldStep: stepRule is not a function.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">stageLevel</span> <span class="o">=</span> <span class="nx">stageLevel</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStageLevel</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">stepRule</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">(),</span> <span class="nx">stageLevel</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pl</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.step">
  <h3>
    <a href="#game.step" name="game.step" class="pilcrow">&#182;</a>
    Game.step
  </h3>
</div>

  </div>
  <div class="body"><p>Executes the next stage / step</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Options passed to <code>gotoStep</code></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>FALSE, if the execution encountered an error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.stager</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.currentStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.execStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">curStep</span><span class="p">,</span> <span class="nx">nextStep</span><span class="p">;</span>
        <span class="nx">curStep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">();</span>
        <span class="nx">nextStep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">curStep</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">gotoStep</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.gotostep">
  <h3>
    <a href="#game.gotostep" name="game.gotostep" class="pilcrow">&#182;</a>
    Game.gotoStep
  </h3>
</div>

  </div>
  <div class="body"><p>Updates the current game step to toStep and executes it.</p>

<p>It unloads the old step listeners, before loading the listeners of the
new one.</p>

<p>It does note check if the next step is different from the current one,
and in this case the same step is re-executed.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nextStep</span>
      <span class="dox_type">string</span>
      <span class="dox_type">GameStage</span>
      <span>A game stage object, or a string like
  GAME_OVER.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Additional options, such as:
  <code>willBeDone</code> (immediately calls <code>node.done()</code>, useful
  for reconnections)</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.execStep</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameStage

TODO: harmonize return values
TODO: remove some unused comments in the code.
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gotoStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">curStep</span><span class="p">,</span> <span class="nx">curStepObj</span><span class="p">,</span> <span class="nx">curStageObj</span><span class="p">,</span> <span class="nx">nextStepObj</span><span class="p">,</span> <span class="nx">nextStageObj</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">stageInit</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">handler</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">doPlChangeHandler</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">minThreshold</span><span class="p">,</span> <span class="nx">maxThreshold</span><span class="p">,</span> <span class="nx">exactThreshold</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">minCallback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">maxCallback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">exactCallback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">minRecoverCb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">maxRecoverCb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">exactRecoverCb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isSteppable</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: game cannot be stepped.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">nextStep</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">nextStep</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: nextStep must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;an object or a string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: options must be object or &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">silly</span><span class="p">(</span><span class="s1">&#39;Next step ---&gt; &#39;</span> <span class="o">+</span> <span class="nx">nextStep</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>TODO: even if node.game.timer.syncWithStage is on,
node.done() is not called on logics. So the timer
is not stopped. We do it manually here for the moment,
and we clear also the milliseconds count.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Clear push-timer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">pushManager</span><span class="p">.</span><span class="nx">clearTimer</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>Clear the cache of temporary changes to steps.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">tmpCache</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>

        <span class="nx">curStep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">();</span>
        <span class="nx">curStageObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStage</span><span class="p">(</span><span class="nx">curStep</span><span class="p">);</span>
        <span class="nx">curStepObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStep</span><span class="p">(</span><span class="nx">curStep</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Sends start / step command to connected clients if option is on.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">,</span> <span class="s1">&#39;syncStepping&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">curStep</span><span class="p">.</span><span class="nx">stage</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">remoteCommand</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">remoteCommand</span><span class="p">(</span><span class="s1">&#39;goto_step&#39;</span><span class="p">,</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">,</span> <span class="nx">nextStep</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Calling exit function of the step.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">curStepObj</span> <span class="o">&amp;&amp;</span> <span class="nx">curStepObj</span><span class="p">.</span><span class="nx">exit</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STEP_EXIT</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">EXITING</span><span class="p">);</span>

            <span class="nx">curStepObj</span><span class="p">.</span><span class="nx">exit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Listeners from previous step are cleared (must be after exit).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">step</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Emit buffered messages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">shouldClearBuffer</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clearBuffer</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">nextStep</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>TODO: see if we can avoid code duplication below.
Calling exit function of the stage.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">curStageObj</span> <span class="o">&amp;&amp;</span> <span class="nx">curStageObj</span><span class="p">.</span><span class="nx">exit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STAGE_EXIT</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">EXITING</span><span class="p">);</span>

                <span class="nx">curStageObj</span><span class="p">.</span><span class="nx">exit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>Clear any event listeners added in the stage exit function.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">nextStep</span> <span class="o">===</span> <span class="nx">GamePlot</span><span class="p">.</span><span class="nx">GAMEOVER</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">gameover</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>Emit buffered messages:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">shouldClearBuffer</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clearBuffer</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>else do nothing</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>TODO maybe update also in case of string.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;STEPPING&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Check for stage/step existence:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">nextStageObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStage</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nextStageObj</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">nextStepObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStep</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nextStepObj</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>

<div class="highlight"><pre><code>        <span class="c1">// TODO: was here. (options might be undefined now)</span>
        <span class="c1">// Check options.</span>
        <span class="c1">// TODO: this does not lock screen / stop timer.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">willBeDone</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">willBeDone</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>If we enter a new stage we need to update a few things.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">curStageObj</span> <span class="o">||</span> <span class="nx">nextStageObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">curStageObj</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>Calling exit function.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">curStageObj</span> <span class="o">&amp;&amp;</span> <span class="nx">curStageObj</span><span class="p">.</span><span class="nx">exit</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STAGE_EXIT</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">EXITING</span><span class="p">);</span>

                    <span class="nx">curStageObj</span><span class="p">.</span><span class="nx">exit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">stageInit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>stageLevel needs to be changed (silent), otherwise it stays
DONE for a short time in the new game stage:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentGameStage</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>Process options before calling any init function.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">processGotoStepOptions</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: options must be object &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;or undefined. Found: &#39;</span> <span class="o">+</span>  <span class="nx">options</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">stageInit</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>Store time:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">setTimestamp</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">());</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Clear the previous stage listeners.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">stage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STAGE_INIT</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>Execute the init function of the stage, if any:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">nextStageObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">nextStageObj</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>Execute the init function of the step, if any:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">nextStepObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STEP_INIT</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">);</span>
                <span class="nx">nextStepObj</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">setStateLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">PLAYING_STEP</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">INITIALIZED</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Updating the globals object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">updateGlobals</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>Min/Max/Exact Properties.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

            <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">,</span> <span class="s1">&#39;minPlayers&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">property</span> <span class="o">=</span> <span class="nx">checkMinMaxExactParams</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
                <span class="nx">minThreshold</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="nx">minCallback</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">minRecoverCb</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="nx">doPlChangeHandler</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">,</span> <span class="s1">&#39;maxPlayers&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">property</span> <span class="o">=</span> <span class="nx">checkMinMaxExactParams</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
                <span class="nx">maxThreshold</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="nx">maxCallback</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">maxRecoverCb</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">maxThreshold</span> <span class="o">&lt;=</span> <span class="nx">minThreshold</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: maxPlayers is smaller &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;than minPlayers: &#39;</span> <span class="o">+</span> <span class="nx">maxThreshold</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">doPlChangeHandler</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">property</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">,</span> <span class="s1">&#39;exactPlayers&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">doPlChangeHandler</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: exactPlayers cannot be &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;set if minPlayers or maxPlayers are set.&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">property</span> <span class="o">=</span> <span class="nx">checkMinMaxExactParams</span><span class="p">(</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
                <span class="nx">exactThreshold</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="nx">exactCallback</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">exactRecoverCb</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="nx">doPlChangeHandler</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">doPlChangeHandler</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>Register event handler.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">nPlayers</span><span class="p">,</span> <span class="nx">wrongNumCb</span><span class="p">,</span> <span class="nx">correctNumCb</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">res</span><span class="p">;</span>
                    <span class="nx">res</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">that</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">;</span>
                    <span class="nx">nPlayers</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>Players should count themselves too.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="nx">nPlayers</span><span class="o">++</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">minThreshold</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayers</span> <span class="o">&lt;</span> <span class="nx">minThreshold</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">minPlayerCbCalled</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">that</span><span class="p">.</span><span class="nx">minPlayerCbCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;onWrongPlayerNum&#39;</span><span class="p">);</span>

                                <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="nx">minCallback</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="nx">res</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">minPlayerCbCalled</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;onCorrectPlayerNum&#39;</span><span class="p">);</span>
                                <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="nx">minRecoverCb</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">minPlayerCbCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">maxThreshold</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayers</span> <span class="o">&gt;</span> <span class="nx">maxThreshold</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">maxPlayerCbCalled</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">that</span><span class="p">.</span><span class="nx">maxPlayerCbCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;onWrongPlayerNum&#39;</span><span class="p">);</span>
                                <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="nx">maxCallback</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="nx">res</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">maxPlayerCbCalled</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;onCorrectPlayerNum&#39;</span><span class="p">);</span>
                                <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="nx">maxRecoverCb</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">maxPlayerCbCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">exactThreshold</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayers</span> <span class="o">!==</span> <span class="nx">exactThreshold</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">exactPlayerCbCalled</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">that</span><span class="p">.</span><span class="nx">exactPlayerCbCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;onWrongPlayerNum&#39;</span><span class="p">);</span>
                                <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="nx">exactCallback</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="nx">res</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">exactPlayerCbCalled</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;onCorrectPlayerNum&#39;</span><span class="p">);</span>
                                <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="nx">exactRecoverCb</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">exactPlayerCbCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
                <span class="p">};</span>

                <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">step</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;in.say.PCONNECT&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">step</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;in.say.PDISCONNECT&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>PRECONNECT needs to verify client is authorized,
so we don't have to handle it here.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>Check conditions explicitly:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">plChangeHandler</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">plChangeHandler</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>Set bounds-checking function:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">checkPlistSize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">nPlayers</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>Players should count themselves too.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="nx">nPlayers</span><span class="o">++</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">minCallback</span> <span class="o">&amp;&amp;</span> <span class="nx">nPlayers</span> <span class="o">&lt;</span> <span class="nx">minThreshold</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">maxCallback</span> <span class="o">&amp;&amp;</span> <span class="nx">nPlayers</span> <span class="o">&gt;</span> <span class="nx">maxThreshold</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">exactCallback</span> <span class="o">&amp;&amp;</span> <span class="nx">nPlayers</span> <span class="o">!==</span> <span class="nx">exactThreshold</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>Set bounds-checking function:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">checkPlistSize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">plChangeHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">};</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>Emit buffered messages:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">shouldClearBuffer</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clearBuffer</span><span class="p">();</span>
            <span class="p">}</span>

        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>Update list of stepped steps.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">_steppedSteps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nextStep</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">execStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">());</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.execstep">
  <h3>
    <a href="#game.execstep" name="game.execstep" class="pilcrow">&#182;</a>
    Game.execStep
  </h3>
</div>

  </div>
  <div class="body"><p>Executes the specified stage object</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">GameStage</span>
      <span>Step to execute</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>The result of the execution of the step callback</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">execStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">origCb</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">widget</span><span class="p">,</span> <span class="nx">widgetObj</span><span class="p">,</span> <span class="nx">widgetRoot</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">widgetCb</span><span class="p">,</span> <span class="nx">widgetExit</span><span class="p">,</span> <span class="nx">widgetDone</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">doneCb</span><span class="p">,</span> <span class="nx">origDoneCb</span><span class="p">,</span> <span class="nx">exitCb</span><span class="p">,</span> <span class="nx">origExitCb</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">frame</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">frameOptions</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">frameLoadMode</span><span class="p">,</span> <span class="nx">frameStoreMode</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">frameAutoParse</span><span class="p">,</span> <span class="nx">frameAutoParsePrefix</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.execStep: step must be object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">cb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;cb&#39;</span><span class="p">);</span>
        <span class="nx">frame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">);</span>
        <span class="nx">widget</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;widget&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Parse input params. // TODO: throws errors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">widget</span><span class="p">)</span> <span class="nx">widget</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">name</span><span class="o">:</span> <span class="nx">widget</span><span class="p">,</span>
                <span class="nx">ref</span><span class="o">:</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
            <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">widget</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;ng_step_widget_&#39;</span> <span class="o">+</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>Make main callback to get/append the widget.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">widgetCb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">append</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">widgetObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                                                      <span class="nx">widget</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>Default id 'container' (as in default.html).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">widgetRoot</span> <span class="o">=</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">root</span> <span class="o">||</span> <span class="s1">&#39;container&#39;</span><span class="p">;</span>
                    <span class="nx">widgetRoot</span> <span class="o">=</span>  <span class="nx">W</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">widgetRoot</span><span class="p">);</span>
                    <span class="nx">widgetObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                                                         <span class="nx">widgetRoot</span><span class="p">,</span>
                                                         <span class="nx">widget</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">[</span><span class="nx">widget</span><span class="p">.</span><span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="nx">widgetObj</span><span class="p">;</span>
            <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>Make the step callback.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">origCb</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
                <span class="nx">cb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">widgetCb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                    <span class="nx">origCb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">widgetCb</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>Make the done callback to send results.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">widgetDone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">opts</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">checkAnswers</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">highlight</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">markAttempt</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">highlight</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">markAttemps</span><span class="o">:</span> <span class="kc">false</span> <span class="p">};</span>
                <span class="p">}</span>

                <span class="nx">values</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">widget</span><span class="p">.</span><span class="nx">ref</span><span class="p">].</span><span class="nx">getValues</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>If it is not timeup, and user did not
disabled it, check answers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">checkAnswers</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">isTimeup</span><span class="p">())</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">missValues</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span>
                        <span class="nx">values</span><span class="p">.</span><span class="nx">choice</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="nx">values</span><span class="p">.</span><span class="nx">isCorrect</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>

                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
            <span class="p">};</span>
            <span class="nx">doneCb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">doneCb</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">origDoneCb</span> <span class="o">=</span> <span class="nx">doneCb</span><span class="p">;</span>
                <span class="nx">doneCb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">values</span><span class="p">;</span>
                    <span class="nx">values</span> <span class="o">=</span> <span class="nx">widgetDone</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">values</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">values</span> <span class="o">=</span> <span class="nx">origDoneCb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">doneCb</span> <span class="o">=</span> <span class="nx">widgetDone</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>Update the exit function for this step.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">tmpCache</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nx">doneCb</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>Make the exit callback (destroy widget by default).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">destroyOnExit</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">widgetExit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">[</span><span class="nx">widget</span><span class="p">.</span><span class="nx">ref</span><span class="p">].</span><span class="nx">destroy</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>Remove node.game reference.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">this</span><span class="p">[</span><span class="nx">widget</span><span class="p">.</span><span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">};</span>
                <span class="nx">exitCb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="s1">&#39;exit&#39;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">exitCb</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">origExitCb</span> <span class="o">=</span> <span class="nx">exitCb</span><span class="p">;</span>
                    <span class="nx">exitCb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">widgetExit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                        <span class="nx">origCb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                    <span class="p">};</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">exitCb</span> <span class="o">=</span> <span class="nx">widgetExit</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>Update the exit function for this step.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">tmpCache</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nx">exitCb</span><span class="p">);</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>Sets a default frame, if none was found.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">append</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">frame</span> <span class="o">=</span> <span class="s1">&#39;/pages/default.html&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<p>Handle frame loading natively, if required.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.execStep: frame option in step &#39;</span> <span class="o">+</span>
                                <span class="nx">step</span> <span class="o">+</span> <span class="s1">&#39;, but nodegame-window is not loaded.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">frameOptions</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">uri</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">uri</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.execStep: frame.uri must &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;be string: &#39;</span> <span class="o">+</span> <span class="nx">uri</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;Step: &#39;</span> <span class="o">+</span> <span class="nx">step</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">frameOptions</span><span class="p">.</span><span class="nx">frameLoadMode</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">loadMode</span><span class="p">;</span>
                <span class="nx">frameOptions</span><span class="p">.</span><span class="nx">storeMode</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">storeMode</span><span class="p">;</span>
                <span class="nx">frameAutoParse</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">autoParse</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">frameAutoParse</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>Replacing TRUE with node.game.settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">frameAutoParse</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">frameAutoParse</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">frameOptions</span><span class="p">.</span><span class="nx">autoParse</span> <span class="o">=</span> <span class="nx">frameAutoParse</span><span class="p">;</span>
                    <span class="nx">frameOptions</span><span class="p">.</span><span class="nx">autoParseMod</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">autoParseMod</span><span class="p">;</span>
                    <span class="nx">frameOptions</span><span class="p">.</span><span class="nx">autoParsePrefix</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">autoParsePrefix</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.execStep: frame must be string or &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;object: &#39;</span> <span class="o">+</span> <span class="nx">frame</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;Step: &#39;</span> <span class="o">+</span> <span class="nx">step</span><span class="p">);</span>

            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>Auto load frame and wrap cb.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">execCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">loadFrame</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">frameOptions</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">execCallback</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.execcallback">
  <h2>
    <a href="#game.execcallback" name="game.execcallback" class="pilcrow">&#182;</a>
    Game.execCallback
  </h2>
</div>

  </div>
  <div class="body"><p>Executes a game callback</p>

<p>Sets the stage levels before and after executing the callback,
and emits an event before exiting.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">function</span>
      <span>The callback to execute</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">mixed</span>
      <span>res The return value of the callback</span>
    </div>
    <div class="dox_tag_title">emit</div>
    <div class="dox_tag_detail">
      <span>'STEP_CALLBACK_EXECUTED'</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">execCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">EXECUTING_CALLBACK</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>Execute custom callback. Can throw errors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>A non fatal error occurred.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">err</span><span class="p">(</span><span class="s1">&#39;A non fatal error occurred in callback &#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;of stage &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setStageLevel</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">CALLBACK_EXECUTED</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;STEP_CALLBACK_EXECUTED&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>Internal listeners will check whether we need to emit PLAYING.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getcurrentstepobj">
  <h3>
    <a href="#game.getcurrentstepobj" name="game.getcurrentstepobj" class="pilcrow">&#182;</a>
    Game.getCurrentStepObj
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the object representing the current game step.</p>

<p>The returning object includes all the properties, such as:
<em>id</em>, <em>cb</em>, <em>timer</em>, etc.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The game-step as defined in the stager.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCurrentStepObj</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">());</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getcurrentstep">
  <h3>
    <a href="#game.getcurrentstep" name="game.getcurrentstep" class="pilcrow">&#182;</a>
    Game.getCurrentStep
  </h3>
</div>

  </div>
  <div class="body"><p>Alias for Game.prototype.getCurrentStepObj</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">deprecated
</div>


<div class="highlight"><pre><code><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;dox_tag_detail&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">/div&gt;</span>
</code></pre></div>



<p></div>
</div></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCurrentStep</span> <span class="o">=</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCurrentStepObj</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getcurrentstepproperty">
  <h3>
    <a href="#game.getcurrentstepproperty" name="game.getcurrentstepproperty" class="pilcrow">&#182;</a>
    Game.getCurrentStepProperty
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the object representing the current game step.</p>

<p>The returning object includes all the properties, such as:
<em>id</em>, <em>cb</em>, <em>timer</em>, etc.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The game-step as defined in the stager.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCurrentStepProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propertyName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">step</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">propertyName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.getCurrentStepProperty: propertyName &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;must be string&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">());</span>
        <span class="k">return</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">?</span>
            <span class="kc">null</span> <span class="o">:</span> <span class="nx">step</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">];</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getcurrentgamestage">
  <h3>
    <a href="#game.getcurrentgamestage" name="game.getcurrentgamestage" class="pilcrow">&#182;</a>
    Game.getCurrentGameStage
  </h3>
</div>

  </div>
  <div class="body"><p>Return the GameStage that is currently being executed.</p>

<p>The return value is a reference to node.player.stage.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameStage</span>
      <span>The stage currently played.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.player.stage
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCurrentGameStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stage</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.setcurrentgamestage">
  <h3>
    <a href="#game.setcurrentgamestage" name="game.setcurrentgamestage" class="pilcrow">&#182;</a>
    Game.setCurrentGameStage
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the current game stage and notifies the server</p>

<p>Stores the value of current game stage in <code>node.player.stage</code>.</p>

<p>By default, it does not send the update to the server if the
new stage is the same as the previous one. However, it is
possible to override this behavior with specyfing a second
parameter <code>mod</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameStage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">GameStage</span>
      <span>The value of the update.
  For example, an object, or a string like '1.1.1'.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mod</span>
      <span class="dox_type">string</span>
      <span>Optional. A string modifiying the default
  behavior ('F' = force, 'S' = silent').</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.publishUpdate
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setCurrentGameStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gameStage</span><span class="p">,</span> <span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gameStage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GameStage</span><span class="p">(</span><span class="nx">gameStage</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;F&#39;</span> <span class="o">||</span>
            <span class="p">(</span><span class="o">!</span><span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="nx">GameStage</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">(),</span>
                                       <span class="nx">gameStage</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>
<p>Important: First publish, then actually update.
The stage level, must also be sent in the published update,
otherwise we could have a mismatch in the remote
representation of the stage + stageLevel of the client.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">publishUpdate</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">stage</span><span class="o">:</span> <span class="nx">gameStage</span><span class="p">,</span>
                <span class="nx">stageLevel</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStageLevel</span><span class="p">()</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stage</span> <span class="o">=</span> <span class="nx">gameStage</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getstatelevel">
  <h3>
    <a href="#game.getstatelevel" name="game.getstatelevel" class="pilcrow">&#182;</a>
    Game.getStateLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the state of the nodeGame engine</p>

<p>The engine states are defined in <code>node.constants.stateLevels</code>,
and it is of the type: STAGE_INIT, PLAYING_STEP, GAMEOVER, etc.
The return value is a reference to <code>node.player.stateLevel</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">number</span>
      <span>The state of the engine.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.player.stateLevel</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.constants.stateLevels
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getStateLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stateLevel</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.setstatelevel">
  <h3>
    <a href="#game.setstatelevel" name="game.setstatelevel" class="pilcrow">&#182;</a>
    Game.setStateLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the current game state level, and optionally notifies the server</p>

<p>The value is actually stored in <code>node.player.stateLevel</code>.</p>

<p>Stage levels are defined in <code>node.constants.stageLevels</code>, for example:
STAGE_INIT, PLAYING_STEP, GAMEOVER, etc.</p>

<p>By default, it does not send the update to the server if the
new state level is the same as the previous one. However, it is
possible to override this behavior with specyfing a second
parameter <code>mod</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stateLevel</span>
      <span class="dox_type">number</span>
      <span>The value of the update.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mod</span>
      <span class="dox_type">string</span>
      <span>Optional. A string modifiying the default
  behavior ('F' = force, 'S' = silent').</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.publishUpdate</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.constants.stageLevels
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setStateLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stateLevel</span><span class="p">,</span> <span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">;</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stateLevel</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.setStateLevel: stateLevel must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number. Found: &#39;</span> <span class="o">+</span> <span class="nx">stateLevel</span><span class="p">);</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-116" id="section-116">&#182;</a>
</div>
<p>Important: First publish, then actually update.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;F&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">stateLevel</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">publishUpdate</span><span class="p">(</span><span class="s1">&#39;stateLevel&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">stateLevel</span><span class="o">:</span> <span class="nx">stateLevel</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stateLevel</span> <span class="o">=</span> <span class="nx">stateLevel</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getstagelevel">
  <h3>
    <a href="#game.getstagelevel" name="game.getstagelevel" class="pilcrow">&#182;</a>
    Game.getStageLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Return the execution level of the current game stage</p>

<p>The execution level is defined in <code>node.constants.stageLevels</code>,
and it is of the type INITIALIZED, CALLBACK_EXECUTED, etc.
The return value is a reference to <code>node.player.stageLevel</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">number</span>
      <span>The level of the stage execution.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.player.stageLevel</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.constants.stageLevels
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getStageLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stageLevel</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.setstagelevel">
  <h3>
    <a href="#game.setstagelevel" name="game.setstagelevel" class="pilcrow">&#182;</a>
    Game.setStageLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the current game stage level, and optionally notifies the server</p>

<p>The value is actually stored in <code>node.player.stageLevel</code>.</p>

<p>Stage levels are defined in <code>node.constants.stageLevels</code>, for example:
PLAYING, DONE, etc.</p>

<p>By default, it does not send the update to the server if the
new state level is the same as the previous one. However, it is
possible to override this behavior with specyfing a second
parameter <code>mod</code>.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameStage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">GameStage</span>
      <span>The value of the update.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mod</span>
      <span class="dox_type">string</span>
      <span>Optional. A string modifiying the default
  behavior ('F' = force, 'S' = silent').</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.publishUpdate</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.constants.stageLevels
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setStageLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stageLevel</span><span class="p">,</span> <span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">;</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stageLevel</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.setStageLevel: stageLevel must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number. Found: &#39;</span> <span class="o">+</span> <span class="nx">stageLevel</span><span class="p">);</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-119" id="section-119">&#182;</a>
</div>
<p>Important: First publish, then actually update.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;F&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStageLevel</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">stageLevel</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">publishUpdate</span><span class="p">(</span><span class="s1">&#39;stageLevel&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">stageLevel</span><span class="o">:</span> <span class="nx">stageLevel</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stageLevel</span> <span class="o">=</span> <span class="nx">stageLevel</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.publishupdate">
  <h3>
    <a href="#game.publishupdate" name="game.publishupdate" class="pilcrow">&#182;</a>
    Game.publishUpdate
  </h3>
</div>

  </div>
  <div class="body"><p>Sends out a PLAYER_UPDATE message, if conditions are met.</p>

<p>Type is a property of the <code>node.player</code> object.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type</span>
      <span class="dox_type">string</span>
      <span>The type of update:
  'stateLevel', 'stageLevel', 'gameStage'.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">newValue</span>
      <span class="dox_type">mixed</span>
      <span>Optional. The actual value of update to be sent.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.shouldPublishUpdate
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">publishUpdate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.publishUpdate: type must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;stage&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;stageLevel&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;stateLevel&#39;</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
                <span class="s1">&#39;Game.publishUpdate: unknown update type (&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shouldPublishUpdate</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">update</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">target</span><span class="o">:</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">PLAYER_UPDATE</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">update</span><span class="p">,</span>
                <span class="nx">text</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
                <span class="nx">to</span><span class="o">:</span> <span class="s1">&#39;ROOM&#39;</span>
            <span class="p">}));</span>
        <span class="p">}</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.shouldpublishupdate">
  <h3>
    <a href="#game.shouldpublishupdate" name="game.shouldpublishupdate" class="pilcrow">&#182;</a>
    Game.shouldPublishUpdate
  </h3>
</div>

  </div>
  <div class="body"><p>Checks whether a game update should be sent to the server</p>

<p>Evaluates the current <code>publishLevel</code>, the type of update, and the
value of the update to decide whether is to be published or not.</p>

<p>Checks also if the <code>syncOnLoaded</code> option is on.</p>

<p>Updates rules are described in '/lib/modules/variables.js'.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type</span>
      <span class="dox_type">string</span>
      <span>The type of update:
  'stateLevel', 'stageLevel', 'gameStage'.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">value</span>
      <span class="dox_type">mixed</span>
      <span>Optional. The actual update to be sent</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE, if the update should be sent</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shouldPublishUpdate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">myStage</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">levels</span><span class="p">,</span> <span class="nx">myPublishLevel</span><span class="p">,</span> <span class="nx">stageLevels</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Game.shouldPublishUpdate: type must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">myStage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">();</span>
        <span class="nx">levels</span> <span class="o">=</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">publishLevels</span><span class="p">;</span>
        <span class="nx">stageLevels</span> <span class="o">=</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">;</span>

        <span class="nx">myPublishLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">myStage</span><span class="p">,</span> <span class="s1">&#39;publishLevel&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-122" id="section-122">&#182;</a>
</div>
<p>Two cases are handled outside of the switch: NO msg
and LOADED stage with syncOnLoaded option.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">myPublishLevel</span> <span class="o">===</span> <span class="nx">levels</span><span class="p">.</span><span class="nx">NONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">myStage</span><span class="p">,</span> <span class="s1">&#39;syncOnLoaded&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;stageLevel&#39;</span> <span class="o">&amp;&amp;</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">stageLevel</span> <span class="o">===</span> <span class="nx">stageLevels</span><span class="p">.</span><span class="nx">LOADED</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-123" id="section-123">&#182;</a>
</div>
<p>Else will be evaluated below.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-124" id="section-124">&#182;</a>
</div>
<p>Check all the other cases.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">switch</span><span class="p">(</span><span class="nx">myPublishLevel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">levels</span><span class="p">.</span><span class="nx">FEW</span><span class="o">:</span>
            <span class="k">return</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;stage&#39;</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">levels</span><span class="p">.</span><span class="nx">REGULAR</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;stateLevel&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;stageLevel&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">stageLevel</span> <span class="o">===</span> <span class="nx">stageLevels</span><span class="p">.</span><span class="nx">PLAYING</span> <span class="o">||</span>
                        <span class="nx">value</span><span class="p">.</span><span class="nx">stageLevel</span> <span class="o">===</span> <span class="nx">stageLevels</span><span class="p">.</span><span class="nx">DONE</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// type === &#39;stage&#39;</span>
        <span class="k">case</span> <span class="nx">levels</span><span class="p">.</span><span class="nx">MOST</span><span class="o">:</span>
            <span class="k">return</span> <span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;stateLevel&#39;</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">levels</span><span class="p">.</span><span class="nx">ALL</span><span class="o">:</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-125" id="section-125">&#182;</a>
</div>
<p>Unknown values of publishLevels are treated as ALL.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.isready">
  <h3>
    <a href="#game.isready" name="game.isready" class="pilcrow">&#182;</a>
    Game.isReady
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if a game is set and interactive</p>

<p>A game is ready unless a stage or step is currently being
loaded or DONE procedure has been started, i.e. between the
stage levels: PLAYING and GETTING_DONE.</p>

<p>If a game is paused, it is also NOT ready.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">node.constants.stageLevels
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isReady</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">stageLevel</span><span class="p">,</span> <span class="nx">stateLevel</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">paused</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

        <span class="nx">stateLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">();</span>
        <span class="nx">stageLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStageLevel</span><span class="p">();</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nx">stateLevel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">UNINITIALIZED</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STAGE_INIT</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STEP_INIT</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">FINISHING</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STAGE_EXIT</span><span class="o">:</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">STEP_EXIT</span><span class="o">:</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">PLAYING_STEP</span><span class="o">:</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">stageLevel</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">EXECUTING_CALLBACK</span><span class="o">:</span>
            <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">CALLBACK_EXECUTED</span><span class="o">:</span>
            <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">PAUSING</span><span class="o">:</span>
            <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">RESUMING</span><span class="o">:</span>
            <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">GETTING_DONE</span><span class="o">:</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.isstartable">
  <h3>
    <a href="#game.isstartable" name="game.isstartable" class="pilcrow">&#182;</a>
    Game.isStartable
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if Game.start can be called</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if the game can be started.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isStartable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">isReady</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">;</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.isstoppable">
  <h3>
    <a href="#game.isstoppable" name="game.isstoppable" class="pilcrow">&#182;</a>
    Game.isStoppable
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if Game.stop can be called</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if the game can be stopped.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isStoppable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">;</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.ispausable">
  <h3>
    <a href="#game.ispausable" name="game.ispausable" class="pilcrow">&#182;</a>
    Game.isPausable
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if Game.pause can be called</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if the game can be paused.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isPausable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">paused</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">;</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.isresumable">
  <h3>
    <a href="#game.isresumable" name="game.isresumable" class="pilcrow">&#182;</a>
    Game.isResumable
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if Game.resume can be called</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if the game can be resumed.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isResumable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">paused</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span><span class="p">;</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.issteppable">
  <h3>
    <a href="#game.issteppable" name="game.issteppable" class="pilcrow">&#182;</a>
    Game.isSteppable
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if Game.step and Game.gotoStep can be called</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if the game can be stepped.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isSteppable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stateLevel</span><span class="p">;</span>
        <span class="nx">stateLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">stateLevel</span> <span class="o">&gt;</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">INITIALIZING</span> <span class="o">&amp;&amp;</span>
               <span class="nx">stateLevel</span> <span class="o">&lt;</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">FINISHING</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.isgameover">
  <h3>
    <a href="#game.isgameover" name="game.isgameover" class="pilcrow">&#182;</a>
    Game.isGameover
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE if gameover was called and state level set</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if is game over</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isGameover</span> <span class="o">=</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isGameOver</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">===</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">GAMEOVER</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.shouldemitplaying">
  <h3>
    <a href="#game.shouldemitplaying" name="game.shouldemitplaying" class="pilcrow">&#182;</a>
    Game.shouldEmitPlaying
  </h3>
</div>

  </div>
  <div class="body"><p>Gives the last green light to let the players play a step.</p>

<p>Sometimes we want to synchronize players to the very last
moment before they start playing. Here we check again.
This handles the case also if some players has disconnected
between the beginning of the stepping procedure and this
method call.</p>

<p>Checks also the GameWindow object.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">strict</span>
      <span class="dox_type">boolean</span>
      <span>If TRUE, PLAYING can be emitted only coming
  from the LOADED stage level. Default: TRUE</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE, if the PLAYING event should be emitted.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shouldEmitPlaying</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">strict</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">curGameStage</span><span class="p">,</span> <span class="nx">curStageLevel</span><span class="p">,</span> <span class="nx">syncOnLoaded</span><span class="p">,</span> <span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">strict</span> <span class="o">||</span> <span class="nx">strict</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-134" id="section-134">&#182;</a>
</div>
<p>Should emit PLAYING only after LOADED.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">curStageLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStageLevel</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">curStageLevel</span> <span class="o">!==</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">stageLevels</span><span class="p">.</span><span class="nx">LOADED</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>
        <span class="nx">curGameStage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isReady</span><span class="p">())</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">checkPlistSize</span><span class="p">())</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

        <span class="nx">syncOnLoaded</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">curGameStage</span><span class="p">,</span> <span class="s1">&#39;syncOnLoaded&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">syncOnLoaded</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">isStepLoaded</span><span class="p">(</span><span class="nx">curGameStage</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.comparecurrentstep">
  <h3>
    <a href="#game.comparecurrentstep" name="game.comparecurrentstep" class="pilcrow">&#182;</a>
    Game.compareCurrentStep
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the relative order of a step with the current step</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">GameStage</span>
      <span class="dox_type">string</span>
      <span>The step to compare</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">number</span>
      <span>0 if comparing step is the same as current step,
  -1 if current step is before comparing step, 1 if current step
  is after comparing step</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compareCurrentStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">normalizedStep</span><span class="p">;</span>
        <span class="nx">normalizedStep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">normalizeGameStage</span><span class="p">(</span><span class="k">new</span> <span class="nx">GameStage</span><span class="p">(</span><span class="nx">step</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">GameStage</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">(),</span> <span class="nx">normalizedStep</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getpreviousstep">
  <h3>
    <a href="#game.getpreviousstep" name="game.getpreviousstep" class="pilcrow">&#182;</a>
    Game.getPreviousStep
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the game-stage played delta steps ago</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">delta</span>
      <span class="dox_type">number</span>
      <span>Optional. The number of past steps. Default 1</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameStage</span>
      <span class="dox_type">null</span>
      <span>The game-stage played delta steps ago,
  or null if none is found</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPreviousStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">delta</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">len</span><span class="p">;</span>
        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">delta</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">delta</span> <span class="o">||</span> <span class="nx">delta</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.getPreviousStep: delta must be a &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;positive number or undefined: &#39;</span><span class="p">,</span> <span class="nx">delta</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_steppedSteps</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">delta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_steppedSteps</span><span class="p">[</span><span class="nx">len</span><span class="p">];</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getnextstep">
  <h3>
    <a href="#game.getnextstep" name="game.getnextstep" class="pilcrow">&#182;</a>
    Game.getNextStep
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the game-stage that will be played in delta steps</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">delta</span>
      <span class="dox_type">number</span>
      <span>Optional. The number of future steps. Default 1</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameStage</span>
      <span class="dox_type">null</span>
      <span>The game-stage that will be played in
  delta future steps, or null if none is found, or if the game
  sequence contains a loop in between</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getNextStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">delta</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">delta</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">delta</span> <span class="o">||</span> <span class="nx">delta</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.getNextStep: delta must be a &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;positive number or undefined: &#39;</span><span class="p">,</span> <span class="nx">delta</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">jump</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">(),</span> <span class="nx">delta</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.updateglobals">
  <h3>
    <a href="#game.updateglobals" name="game.updateglobals" class="pilcrow">&#182;</a>
    Game.updateGlobals
  </h3>
</div>

  </div>
  <div class="body"><p>Updates node.globals and adds properties to window in the browser</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">GameStage</span>
      <span>Optional. The reference game stage.
  Default: Game.currentGameStage()</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>Game.globals</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateGlobals</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newGlobals</span><span class="p">,</span> <span class="nx">g</span><span class="p">;</span>
        <span class="nx">stage</span> <span class="o">=</span> <span class="nx">stage</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">();</span>
        <span class="nx">newGlobals</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getGlobals</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-139" id="section-139">&#182;</a>
</div>
<p>Adding new globals.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">for</span> <span class="p">(</span><span class="nx">g</span> <span class="k">in</span> <span class="nx">newGlobals</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">newGlobals</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">g</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">===</span> <span class="s1">&#39;node&#39;</span> <span class="o">||</span> <span class="nx">g</span> <span class="o">===</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">node</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Game.updateGlobals: invalid name: &#39;</span> <span class="o">+</span> <span class="nx">g</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nb">window</span><span class="p">[</span><span class="nx">g</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newGlobals</span><span class="p">[</span><span class="nx">g</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-140" id="section-140">&#182;</a>
</div>
<p>Removing old ones.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">for</span> <span class="p">(</span><span class="nx">g</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">globals</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">globals</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">newGlobals</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">g</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">!==</span> <span class="s1">&#39;node&#39;</span> <span class="o">||</span> <span class="nx">g</span> <span class="o">!==</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">delete</span> <span class="nb">window</span><span class="p">[</span><span class="nx">g</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-141" id="section-141">&#182;</a>
</div>
<p>Updating globals reference.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">globals</span> <span class="o">=</span> <span class="nx">newGlobals</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">globals</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="game.getproperty">
  <h3>
    <a href="#game.getproperty" name="game.getproperty" class="pilcrow">&#182;</a>
    Game.getProperty
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the requested step property from the game plot</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">property</span>
      <span class="dox_type">string</span>
      <span>The name of the property</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameStage</span>
      <span class="dox_type">GameStage</span>
      <span>Optional. The reference game stage.
  Default: Game.currentGameStage()</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">miexed</span>
      <span>The value of the requested step property</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getProperty
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Game</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">gameStage</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gameStage</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameStage</span> <span class="o">?</span>
            <span class="nx">gameStage</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentGameStage</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="nx">gameStage</span><span class="p">,</span> <span class="nx">property</span><span class="p">);</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods">
  <h2>
    <a href="#helper%20methods" name="helper%20methods" class="pilcrow">&#182;</a>
    Helper Methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="processgotostepoptions">
  <h3>
    <a href="#processgotostepoptions" name="processgotostepoptions" class="pilcrow">&#182;</a>
    processGoToStepOptions
  </h3>
</div>

  </div>
  <div class="body"><p>Process options before executing the init functions of stage/steps</p>

<p>Valid options:</p>

<ul>
<li>willBeDone: sets game.willBeDone to TRUE,
<ul><li>plot: add entries to the tmpCache of the plot,</li>
<li>cb: a callback executed with the game context, and with options
 object itself as parameter</li></ul></li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">game</span>
      <span class="dox_type">Game</span>
      <span>The game instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>The options to process</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.tmpCache</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.willBeDone
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">processGotoStepOptions</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-145" id="section-145">&#182;</a>
</div>
<p>Set willBeDone. TODO: this does not lock screen / stop timer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">willBeDone</span><span class="p">)</span> <span class="nx">game</span><span class="p">.</span><span class="nx">willBeDone</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-146" id="section-146">&#182;</a>
</div>
<p>Temporarily modify plot properties.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">plot</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">game</span><span class="p">.</span><span class="nx">plot</span><span class="p">.</span><span class="nx">tmpCache</span><span class="p">(</span><span class="nx">prop</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">plot</span><span class="p">[</span><span class="nx">prop</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-147" id="section-147">&#182;</a>
</div>
<p>Call the cb with options as param, if found.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: options.cb must be &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;function or undefined. Found: &#39;</span> <span class="o">+</span>
                                    <span class="nx">options</span><span class="p">.</span><span class="nx">cb</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checkminmaxexactparams">
  <h3>
    <a href="#checkminmaxexactparams" name="checkminmaxexactparams" class="pilcrow">&#182;</a>
    checkMinMaxExactParams
  </h3>
</div>

  </div>
  <div class="body"><p>Checks the parameters of min|max|exactPlayers property of a step</p>

<p>Method is invoked by Game.gotoStep, and errors are thrown accordingly.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">name</span>
      <span class="dox_type">string</span>
      <span>The name of the parameter: min|max|exact</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">property</span>
      <span class="dox_type">number</span>
      <span class="dox_type">array</span>
      <span>The property to check</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Game.gotoStep
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">checkMinMaxExactParams</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">recoverCb</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">property</span><span class="p">)</span> <span class="nx">property</span> <span class="o">=</span> <span class="p">[</span><span class="nx">property</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">property</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;Players field &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;is empty array.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">num</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">cb</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="nx">recoverCb</span> <span class="o">=</span> <span class="nx">property</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;Players field &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;must be number or non-empty array. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">property</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">num</span> <span class="o">||</span> <span class="o">!</span><span class="nb">isFinite</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="o">||</span> <span class="nx">num</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span>
                                <span class="s1">&#39;Players must be a finite number &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;greater than 1: &#39;</span> <span class="o">+</span> <span class="nx">num</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span>
                                <span class="s1">&#39;Players cb must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function or undefined: &#39;</span> <span class="o">+</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">recoverCb</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Game.gotoStep: &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span>
                                <span class="s1">&#39;Players recoverCb must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function or undefined: &#39;</span> <span class="o">+</span> <span class="nx">recoverCb</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">property</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="closure">
  <h2>
    <a href="#closure" name="closure" class="pilcrow">&#182;</a>
    Closure
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="p">})(</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span>
<span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
