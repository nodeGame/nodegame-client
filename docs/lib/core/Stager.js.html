<!DOCTYPE html>
<html>
<head>
  <title>Stager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = '../../', thisFile = 'lib/core/Stager.js', defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#stager">Stager</a>
      </div>
      <div class="heading h2">
        <a href="#global-scope">Global scope</a>
      </div>
      <div class="heading h2">
        <a href="#stager-constructor">Stager constructor</a>
      </div>
      <div class="heading h2">
        <a href="#properties">Properties</a>
      </div>
      <div class="heading h3">
        <a href="#stager.steps">Stager.steps</a>
      </div>
      <div class="heading h3">
        <a href="#stager.stages">Stager.stages</a>
      </div>
      <div class="heading h3">
        <a href="#stager.sequence">Stager.sequence</a>
      </div>
      <div class="heading h3">
        <a href="#stager.generalnextfunction">Stager.generalNextFunction</a>
      </div>
      <div class="heading h3">
        <a href="#stager.nextfunctions">Stager.nextFunctions</a>
      </div>
      <div class="heading h3">
        <a href="#stager.defaultsteprule">Stager.defaultStepRule</a>
      </div>
      <div class="heading h3">
        <a href="#stager.defaultglobals">Stager.defaultGlobals</a>
      </div>
      <div class="heading h3">
        <a href="#stager.defaultproperties">Stager.defaultProperties</a>
      </div>
      <div class="heading h3">
        <a href="#stager.oninit">Stager.onInit</a>
      </div>
      <div class="heading h3">
        <a href="#stager.ongameover">Stager.onGameover</a>
      </div>
      <div class="heading h3">
        <a href="#stager.blocks">Stager.blocks</a>
      </div>
      <div class="heading h3">
        <a href="#stager.unfinishedblocks">Stager.unfinishedBlocks</a>
      </div>
      <div class="heading h3">
        <a href="#stager.finalized">Stager.finalized</a>
      </div>
      <div class="heading h3">
        <a href="#stager.currenttype">Stager.currentType</a>
      </div>
      <div class="heading h3">
        <a href="#stager.currentblocktype">Stager.currentBlockType</a>
      </div>
      <div class="heading h3">
        <a href="#stager.defaultsteps">Stager.defaultSteps</a>
      </div>
      <div class="heading h3">
        <a href="#stager.log">Stager.log</a>
      </div>
      <div class="heading h2">
        <a href="#stager-methods">Stager methods</a>
      </div>
      <div class="heading h3">
        <a href="#stager.clear">Stager.clear</a>
      </div>
      <div class="heading h3">
        <a href="#stager.init">Stager.init</a>
      </div>
      <div class="heading h2">
        <a href="#stager.finalize">Stager.finalize</a>
      </div>
      <div class="heading h2">
        <a href="#stager.reset">Stager.reset</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setstate">Stager.setState</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getstate">Stager.getState</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setdefaultsteprule">Stager.setDefaultStepRule</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getdefaultsteprule">Stager.getDefaultStepRule</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setdefaultglobals">Stager.setDefaultGlobals</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getdefaultglobals">Stager.getDefaultGlobals</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setdefaultproperty">Stager.setDefaultProperty</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setdefaultproperties">Stager.setDefaultProperties</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getdefaultproperties">Stager.getDefaultProperties</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setoninit">Stager.setOnInit</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getoninit">Stager.getOnInit</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setongameover">Stager.setOnGameover</a>
      </div>
      <div class="heading h3">
        <a href="#stager.setongameover">Stager.setOnGameOver</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getongameover">Stager.getOnGameover</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getongameover">Stager.getOnGameOver</a>
      </div>
      <div class="heading h3">
        <a href="#stager.addstep">Stager.addStep</a>
      </div>
      <div class="heading h3">
        <a href="#stager.addstage">Stager.addStage</a>
      </div>
      <div class="heading h3">
        <a href="#stager.step">Stager.step</a>
      </div>
      <div class="heading h3">
        <a href="#stager.next">Stager.next</a>
      </div>
      <div class="heading h3">
        <a href="#stager.repeat">Stager.repeat</a>
      </div>
      <div class="heading h3">
        <a href="#stager.loop">Stager.loop</a>
      </div>
      <div class="heading h3">
        <a href="#stager.doloop">Stager.doLoop</a>
      </div>
      <div class="heading h3">
        <a href="#stager.gameover">Stager.gameover</a>
      </div>
      <div class="heading h2">
        <a href="#stager.handlestageadd">Stager.handleStageAdd</a>
      </div>
      <div class="heading h2">
        <a href="#stager.beginblock">Stager.beginBlock</a>
      </div>
      <div class="heading h2">
        <a href="#stager.endblock">Stager.endBlock</a>
      </div>
      <div class="heading h2">
        <a href="#stager.endblocks">Stager.endBlocks</a>
      </div>
      <div class="heading h2">
        <a href="#stager.endallblocks">Stager.endAllBlocks</a>
      </div>
      <div class="heading h2">
        <a href="#stager.stepblock">Stager.stepBlock</a>
      </div>
      <div class="heading h2">
        <a href="#stager.stageblock">Stager.stageBlock</a>
      </div>
      <div class="heading h2">
        <a href="#stager.nextblock">Stager.nextBlock</a>
      </div>
      <div class="heading h2">
        <a href="#stager.getcurrentblock">Stager.getCurrentBlock</a>
      </div>
      <div class="heading h3">
        <a href="#stager.extendstep">Stager.extendStep</a>
      </div>
      <div class="heading h3">
        <a href="#stager.extendstage">Stager.extendStage</a>
      </div>
      <div class="heading h3">
        <a href="#stager.skip">Stager.skip</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getsequence">Stager.getSequence</a>
      </div>
      <div class="heading h3">
        <a href="#stager.extractstage">Stager.extractStage</a>
      </div>
      <div class="heading h3">
        <a href="#stager.getstepsfromstage">Stager.getStepsFromStage</a>
      </div>
      <div class="heading h3">
        <a href="#stager.registergeneralnext">Stager.registerGeneralNext</a>
      </div>
      <div class="heading h3">
        <a href="#stager.registernext">Stager.registerNext</a>
      </div>
      <div class="heading h2">
        <a href="#stager-private-methods">Stager private methods</a>
      </div>
      <div class="heading h2">
        <a href="#block">Block</a>
      </div>
      <div class="heading h2">
        <a href="#block-constructor">Block constructor</a>
      </div>
      <div class="heading h3">
        <a href="#block.id">Block.id</a>
      </div>
      <div class="heading h3">
        <a href="#block.positions">Block.positions</a>
      </div>
      <div class="heading h3">
        <a href="#block.tajenpositions">Block.tajenPositions</a>
      </div>
      <div class="heading h3">
        <a href="#block.items">Block.items</a>
      </div>
      <div class="heading h3">
        <a href="#block.unfinishedentries">Block.unfinishedEntries</a>
      </div>
      <div class="heading h3">
        <a href="#block.index">Block.index</a>
      </div>
      <div class="heading h3">
        <a href="#block.finalized">Block.finalized</a>
      </div>
      <div class="heading h3">
        <a href="#block.numberofitems">Block.numberOfItems</a>
      </div>
      <div class="heading h3">
        <a href="#block.resetcache">Block.resetCache</a>
      </div>
      <div class="heading h2">
        <a href="#block.add">Block.add</a>
      </div>
      <div class="heading h2">
        <a href="#block.finalize">Block.finalize</a>
      </div>
      <div class="heading h2">
        <a href="#block.next">Block.next</a>
      </div>
      <div class="heading h2">
        <a href="#block.reset">Block.reset</a>
      </div>
      <div class="heading h2">
        <a href="#closure">Closure</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager">
  <h1>
    <a href="#stager" class="pilcrow">&#182;</a>
    Stager
  </h1>
</div>


<p>Copyright(c) 2015 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p><code>nodeGame</code> container and builder of the game sequence</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>

    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global-scope">
  <h2>
    <a href="#global-scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">exports</span><span class="p">.</span><span class="nx">Stager</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">stepRules</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">stepRules</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">JSUS</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager-constructor">
  <h2>
    <a href="#stager-constructor" class="pilcrow">&#182;</a>
    Stager constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates a new instance of Stager</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stateObj</span>
      <span class="dox_type">object</span>
      <span>Optional. State to initialize the new
  Stager object with. See <code>Stager.setState</code>.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setState
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">Stager</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="properties">
  <h2>
    <a href="#properties" class="pilcrow">&#182;</a>
    Properties
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.steps">
  <h3>
    <a href="#stager.steps" class="pilcrow">&#182;</a>
    Stager.steps
  </h3>
</div>

  </div>
  <div class="body"><p>Step object container</p>

<p>key: step ID,  value: step object</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStep
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span> <span class="o">=</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.stages">
  <h3>
    <a href="#stager.stages" class="pilcrow">&#182;</a>
    Stager.stages
  </h3>
</div>

  </div>
  <div class="body"><p>Stage object container</p>

<p>key: stage ID,  value: stage object</p>

<p>Stage aliases are stored the same way, with a reference to
the original stage object as the value.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span> <span class="o">=</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.sequence">
  <h3>
    <a href="#stager.sequence" class="pilcrow">&#182;</a>
    Stager.sequence
  </h3>
</div>

  </div>
  <div class="body"><p>Sequence block container</p>

<p>Stores the game plan in 'simple mode'.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.gameover</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.repeat</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.loop</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.doLoop
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.generalnextfunction">
  <h3>
    <a href="#stager.generalnextfunction" class="pilcrow">&#182;</a>
    Stager.generalNextFunction
  </h3>
</div>

  </div>
  <div class="body"><p>General next-stage decider function</p>

<p>Returns the id of the next game step.
Available only when nodegame is executed in <em>flexible</em> mode.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.registerGeneralNext
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">generalNextFunction</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.nextfunctions">
  <h3>
    <a href="#stager.nextfunctions" class="pilcrow">&#182;</a>
    Stager.nextFunctions
  </h3>
</div>

  </div>
  <div class="body"><p>Per-stage next-stage decider function</p>

<p>key: stage ID,  value: callback function</p>

<p>Stores functions to be called to yield the id of the next
game stage for a specific previous stage.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.registerNext
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">nextFunctions</span> <span class="o">=</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.defaultsteprule">
  <h3>
    <a href="#stager.defaultsteprule" class="pilcrow">&#182;</a>
    Stager.defaultStepRule
  </h3>
</div>

  </div>
  <div class="body"><p>Default step-rule function</p>

<p>This function decides whether it is possible to proceed to
the next step/stage. If a step/stage object defines a
<code>steprule</code> property, then that function is used instead.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.getDefaultStepRule</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getStepRule
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultStepRule</span><span class="p">();</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.defaultglobals">
  <h3>
    <a href="#stager.defaultglobals" class="pilcrow">&#182;</a>
    Stager.defaultGlobals
  </h3>
</div>

  </div>
  <div class="body"><p>Defaults of global variables</p>

<p>This map holds the default values of global variables. These
values are overridable by more specific version in step and
stage objects.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setDefaultGlobals</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getGlobal
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">defaultGlobals</span> <span class="o">=</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.defaultproperties">
  <h3>
    <a href="#stager.defaultproperties" class="pilcrow">&#182;</a>
    Stager.defaultProperties
  </h3>
</div>

  </div>
  <div class="body"><p>Defaults of properties</p>

<p>This map holds the default values of properties. These values
are overridable by more specific version in step and stage
objects.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setDefaultProperties</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getProperty
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span> <span class="o">=</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.oninit">
  <h3>
    <a href="#stager.oninit" class="pilcrow">&#182;</a>
    Stager.onInit
  </h3>
</div>

  </div>
  <div class="body"><p>Initialization function</p>

<p>This function is called as soon as the game is instantiated,
i.e. at stage 0.0.0.</p>

<p>Event listeners defined here stay valid throughout the whole
game, unlike event listeners defined inside a function of the
gamePlot, which are valid only within the specific function.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">onInit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.ongameover">
  <h3>
    <a href="#stager.ongameover" class="pilcrow">&#182;</a>
    Stager.onGameover
  </h3>
</div>

  </div>
  <div class="body"><p>Cleaning up function</p>

<p>This function is called after the last stage of the gamePlot
is terminated.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">onGameover</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.blocks">
  <h3>
    <a href="#stager.blocks" class="pilcrow">&#182;</a>
    Stager.blocks
  </h3>
</div>

  </div>
  <div class="body"><p>List of all Blocks used to build the hierarchy</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.unfinishedblocks">
  <h3>
    <a href="#stager.unfinishedblocks" class="pilcrow">&#182;</a>
    Stager.unfinishedBlocks
  </h3>
</div>

  </div>
  <div class="body"><p>List of all Blocks stager might still modify</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.finalized">
  <h3>
    <a href="#stager.finalized" class="pilcrow">&#182;</a>
    Stager.finalized
  </h3>
</div>

  </div>
  <div class="body"><p>Flag indicating if the hierarchy of has been set</p>

<p>Indicates if the hierarchy of stages and steps has been set.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.currenttype">
  <h3>
    <a href="#stager.currenttype" class="pilcrow">&#182;</a>
    Stager.currentType
  </h3>
</div>

  </div>
  <div class="body"><p>Name of the stage currently worked with in building hierarchy</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">=</span> <span class="s2">&quot;__default&quot;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.currentblocktype">
  <h3>
    <a href="#stager.currentblocktype" class="pilcrow">&#182;</a>
    Stager.currentBlockType
  </h3>
</div>

  </div>
  <div class="body"><p>Indicates what type of Block was added last</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">=</span> <span class="s2">&quot;__default&quot;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.defaultsteps">
  <h3>
    <a href="#stager.defaultsteps" class="pilcrow">&#182;</a>
    Stager.defaultSteps
  </h3>
</div>

  </div>
  <div class="body"><p>Holds the default steps of each stage</p>

<p>Default steps are either none if any step is defined for that
stage and a step with the same name as the stage otherwise.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span> <span class="o">=</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.log">
  <h3>
    <a href="#stager.log" class="pilcrow">&#182;</a>
    Stager.log
  </h3>
</div>

  </div>
  <div class="body"><p>Default standard output. Override to redirect.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Set the state if one is passed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stateObj</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager: stateObj must be object.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Add first block.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">stageBlock</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;__default_block&#39;</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="stager-methods">
  <h2>
    <a href="#stager-methods" class="pilcrow">&#182;</a>
    Stager methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Clear, init, finalize, reset.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.clear">
  <h3>
    <a href="#stager.clear" class="pilcrow">&#182;</a>
    Stager.clear
  </h3>
</div>

  </div>
  <div class="body"><p>Clears the state of the stager</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>this object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">generalNextFunction</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nextFunctions</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultStepRule</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">defaultGlobals</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onInit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onGameover</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">=</span> <span class="s2">&quot;__default&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">=</span> <span class="s2">&quot;__default&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.init">
  <h3>
    <a href="#stager.init" class="pilcrow">&#182;</a>
    Stager.init
  </h3>
</div>

  </div>
  <div class="body"><p>Clears the state of the stager and adds a default block</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>this object</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.clear
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stageBlock</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;__default_block&#39;</span> <span class="p">});</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.finalize">
  <h2>
    <a href="#stager.finalize" class="pilcrow">&#182;</a>
    Stager.finalize
  </h2>
</div>

  </div>
  <div class="body"><p>Builds stage and step sequence from the Block hieararchy</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to the current instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.reset
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">finalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">currentItem</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">outermostBlock</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">blockIndex</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">finalized</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">endAllBlocks</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">blockIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">blockIndex</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="o">++</span><span class="nx">blockIndex</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">blockIndex</span><span class="p">].</span><span class="nx">finalize</span><span class="p">();</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Do we really need this ???.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">steps</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span>
                <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">outermostBlock</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Create sequence.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">currentItem</span> <span class="o">=</span> <span class="nx">outermostBlock</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!!</span><span class="nx">currentItem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">currentItem</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;__stage&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">currentItem</span><span class="p">.</span><span class="nx">item</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">currentItem</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">steps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
                    <span class="nx">currentItem</span><span class="p">.</span><span class="nx">item</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">currentItem</span> <span class="o">=</span> <span class="nx">outermostBlock</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.reset">
  <h2>
    <a href="#stager.reset" class="pilcrow">&#182;</a>
    Stager.reset
  </h2>
</div>

  </div>
  <div class="body"><p>Undoes a previous call to <code>finalize</code></p>

<p>Allows to call <code>Stager.finalize</code> again to build a potentially
different sequence from the Block hierarchy.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to the current instance for method chaining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.finalize
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">blockIndex</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">finalized</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">blockIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">blockIndex</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="o">++</span><span class="nx">blockIndex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">blockIndex</span><span class="p">].</span><span class="nx">reset</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">steps</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Setters, Getters.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setstate">
  <h3>
    <a href="#stager.setstate" class="pilcrow">&#182;</a>
    Stager.setState
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the internal state of the Stager</p>

<p>The passed state object can have the following fields:
steps, stages, sequence, generalNextFunction, nextFunctions,
defaultStepRule, defaultGlobals, defaultProperties, onInit,
onGameover.
All fields are optional.</p>

<p>This function calls the corresponding functions to set these
fields, and performs error checking.</p>

<p>If updateRule is 'replace', the Stager is cleared before applying
the state.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stateObj</span>
      <span class="dox_type">object</span>
      <span>The Stager's state</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">updateRule</span>
      <span class="dox_type">string</span>
      <span>Optional. Whether to
   'replace' (default) or to 'append'.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.getState
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">,</span> <span class="nx">updateRule</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">idx</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">stageObj</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">seqObj</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stateObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setState: stateObj must be object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">updateRule</span> <span class="o">=</span> <span class="nx">updateRule</span> <span class="o">||</span> <span class="s1">&#39;replace&#39;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">updateRule</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setState: updateRule must be object &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Clear previous state:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">updateRule</span> <span class="o">===</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">updateRule</span> <span class="o">!==</span> <span class="s1">&#39;append&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.setState: invalid updateRule: &#39;</span> <span class="o">+</span>
                            <span class="nx">updateRule</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Add steps:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">idx</span> <span class="k">in</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">steps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">idx</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">idx</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Add stages:
first, handle all non-aliases
(key of <code>stages</code> entry is same as <code>id</code> field of its value)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">idx</span> <span class="k">in</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">stages</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stageObj</span> <span class="o">=</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">stages</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">stageObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">addStage</span><span class="p">(</span><span class="nx">stageObj</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>second, handle all aliases
(key of <code>stages</code> entry is different from <code>id</code> field of
its value)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">idx</span> <span class="k">in</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">stages</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stageObj</span> <span class="o">=</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">stages</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">stageObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageObj</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Add sequence blocks:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">seqObj</span> <span class="o">=</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nx">seqObj</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>switch (seqObj.type) {
case 'gameover':
this.gameover();
break;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>case 'plain':
if (!this.next(seqObj.id)) {
throw new Error('Stager.setState: invalid' +
+ 'sequence.');
}
break;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>case 'repeat':
if (!this.repeat(seqObj.id, seqObj.num)) {
throw new Error('Stager.setState: invalid' +
+ 'sequence.');                    //}
break;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>case 'loop':
if (!this.loop(seqObj.id, seqObj.cb)) {
throw new Error('Stager.setState: invalid' +
+ 'sequence.');                    //}
}
break;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>case 'doLoop':
if (!this.doLoop(seqObj.id, seqObj.cb)) {
throw new Error('Stager.setState: invalid' +
+ 'sequence.');                    //}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>}
break;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>default:
// Unknown type:
throw new Error('Stager.setState: invalid' +
+ 'sequence.');                    //}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>}</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>Set general next-decider:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;generalNextFunction&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">registerGeneralNext</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">generalNextFunction</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Set specific next-deciders:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">idx</span> <span class="k">in</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">nextFunctions</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">nextFunctions</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">idx</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">registerNext</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="nx">stateObj</span><span class="p">.</span><span class="nx">nextFunctions</span><span class="p">[</span><span class="nx">idx</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Set default step-rule:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;defaultStepRule&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultStepRule</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">defaultStepRule</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Set default globals:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;defaultGlobals&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultGlobals</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">defaultGlobals</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Set default properties:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;defaultProperties&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultProperties</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">defaultProperties</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Set onInit:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;onInit&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setOnInit</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">onInit</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Set onGameover:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;onGameover&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setOnGameover</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">.</span><span class="nx">onGameover</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getstate">
  <h3>
    <a href="#stager.getstate" class="pilcrow">&#182;</a>
    Stager.getState
  </h3>
</div>

  </div>
  <div class="body"><p>Finalizes the stager and returns a copy of internal state</p>

<p>Fields of returned object:</p>

<p>steps, stages, sequence, generalNextFunction, nextFunctions,
defaultStepRule, defaultGlobals, defaultProperties, onInit,
onGameover, blocks.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>Clone of the Stager's state</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setState</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.finalize
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">finalize</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">({</span>
            <span class="nx">steps</span><span class="o">:</span>               <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">,</span>
            <span class="nx">stages</span><span class="o">:</span>              <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">,</span>
            <span class="nx">sequence</span><span class="o">:</span>            <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">,</span>
            <span class="nx">generalNextFunction</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">generalNextFunction</span><span class="p">,</span>
            <span class="nx">nextFunctions</span><span class="o">:</span>       <span class="k">this</span><span class="p">.</span><span class="nx">nextFunctions</span><span class="p">,</span>
            <span class="nx">defaultStepRule</span><span class="o">:</span>     <span class="k">this</span><span class="p">.</span><span class="nx">defaultStepRule</span><span class="p">,</span>
            <span class="nx">defaultGlobals</span><span class="o">:</span>      <span class="k">this</span><span class="p">.</span><span class="nx">defaultGlobals</span><span class="p">,</span>
            <span class="nx">defaultProperties</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span><span class="p">,</span>
            <span class="nx">onInit</span><span class="o">:</span>              <span class="k">this</span><span class="p">.</span><span class="nx">onInit</span><span class="p">,</span>
            <span class="nx">onGameover</span><span class="o">:</span>          <span class="k">this</span><span class="p">.</span><span class="nx">onGameover</span><span class="p">,</span>
            <span class="nx">blocks</span><span class="o">:</span>              <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span>
        <span class="p">});</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setdefaultsteprule">
  <h3>
    <a href="#stager.setdefaultsteprule" class="pilcrow">&#182;</a>
    Stager.setDefaultStepRule
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the default step-rule function</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stepRule</span>
      <span class="dox_type">function</span>
      <span>Optional. The step-rule function.
  If undefined, the <code>SOLO</code> rule is set.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.defaultStepRule</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">stepRules
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDefaultStepRule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepRule</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stepRule</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stepRule</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setDefaultStepRule: &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;stepRule must be function or &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;undefined.&#39;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">defaultStepRule</span> <span class="o">=</span> <span class="nx">stepRule</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Initial default.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">defaultStepRule</span> <span class="o">=</span> <span class="nx">stepRules</span><span class="p">.</span><span class="nx">SOLO</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getdefaultsteprule">
  <h3>
    <a href="#stager.getdefaultsteprule" class="pilcrow">&#182;</a>
    Stager.getDefaultStepRule
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the default step-rule function</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function</span>
      <span>The default step-rule function</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDefaultStepRule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultStepRule</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setdefaultglobals">
  <h3>
    <a href="#stager.setdefaultglobals" class="pilcrow">&#182;</a>
    Stager.setDefaultGlobals
  </h3>
</div>

  </div>
  <div class="body"><p>Sets/mixes in the default globals</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">defaultGlobals</span>
      <span class="dox_type">object</span>
      <span>The map of default global
  variables</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mixin</span>
      <span class="dox_type">boolean</span>
      <span>Optional. If TRUE, parameter defaultGlobals
   will be mixed-in with current globals, otherwise it will replace
     it. Default FALSE.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.defaultGlobals</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getGlobal
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDefaultGlobals</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defaultGlobals</span><span class="p">,</span> <span class="nx">mixin</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">defaultGlobals</span> <span class="o">||</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">defaultGlobals</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setDefaultGlobals: &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;defaultGlobals must be object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mixin</span><span class="p">)</span> <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaultGlobals</span><span class="p">,</span> <span class="nx">defaultGlobals</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultGlobals</span> <span class="o">=</span> <span class="nx">defaultGlobals</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getdefaultglobals">
  <h3>
    <a href="#stager.getdefaultglobals" class="pilcrow">&#182;</a>
    Stager.getDefaultGlobals
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the default globals</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The map of default global variables</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.defaultGlobals</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getGlobal
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDefaultGlobals</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultGlobals</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setdefaultproperty">
  <h3>
    <a href="#stager.setdefaultproperty" class="pilcrow">&#182;</a>
    Stager.setDefaultProperty
  </h3>
</div>

  </div>
  <div class="body"><p>Sets a default property</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">name</span>
      <span class="dox_type">string</span>
      <span>The name of the default property</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">value</span>
      <span class="dox_type">mixed</span>
      <span>The value for the default property</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.defaultProperties</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setDefaultProperties</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getProperty
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDefaultProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setDefaultProperty: name &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setdefaultproperties">
  <h3>
    <a href="#stager.setdefaultproperties" class="pilcrow">&#182;</a>
    Stager.setDefaultProperties
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the default properties</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">defaultProperties</span>
      <span class="dox_type">object</span>
      <span>The map of default properties</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mixin</span>
      <span class="dox_type">boolean</span>
      <span>Optional. If TRUE, parameter defaulProperties
   will be mixed-in with current globals, otherwise it will replace
     it. Default FALSE.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.defaultProperties</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getProperty
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDefaultProperties</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defaultProperties</span><span class="p">,</span>
                                                     <span class="nx">mixin</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">defaultProperties</span> <span class="o">||</span>
            <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">defaultProperties</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setDefaultProperties: &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;defaultProperties must be object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mixin</span><span class="p">)</span> <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span><span class="p">,</span> <span class="nx">defaultProperties</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span> <span class="o">=</span> <span class="nx">defaultProperties</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getdefaultproperties">
  <h3>
    <a href="#stager.getdefaultproperties" class="pilcrow">&#182;</a>
    Stager.getDefaultProperties
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the default properties</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The map of default properties</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.defaultProperties</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GamePlot.getProperty
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDefaultProperties</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultProperties</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setoninit">
  <h3>
    <a href="#stager.setoninit" class="pilcrow">&#182;</a>
    Stager.setOnInit
  </h3>
</div>

  </div>
  <div class="body"><p>Sets onInit function</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">func</span>
      <span class="dox_type">function</span>
      <span class="dox_type">null</span>
      <span>The onInit function.
  NULL can be given to signify non-existence.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.onInit
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setOnInit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">func</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.setOnInit: func must be&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; function or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onInit</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getoninit">
  <h3>
    <a href="#stager.getoninit" class="pilcrow">&#182;</a>
    Stager.getOnInit
  </h3>
</div>

  </div>
  <div class="body"><p>Gets onInit function</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function</span>
      <span class="dox_type">null</span>
      <span>The onInit function.
 NULL signifies non-existence.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.onInit
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getOnInit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">onInit</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setongameover">
  <h3>
    <a href="#stager.setongameover" class="pilcrow">&#182;</a>
    Stager.setOnGameover
  </h3>
</div>

  </div>
  <div class="body"><p>Sets onGameover function</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">func</span>
      <span class="dox_type">function</span>
      <span class="dox_type">null</span>
      <span>The onGameover function.
  NULL can be given to signify non-existence.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.onGameover
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setOnGameover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">func</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.setOnGameover: func must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onGameover</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.setongameover">
  <h3>
    <a href="#stager.setongameover" class="pilcrow">&#182;</a>
    Stager.setOnGameOver
  </h3>
</div>

  </div>
  <div class="body"><p>Alias for <code>setOnGameover</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setOnGameover
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setOnGameOver</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setOnGameover</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getongameover">
  <h3>
    <a href="#stager.getongameover" class="pilcrow">&#182;</a>
    Stager.getOnGameover
  </h3>
</div>

  </div>
  <div class="body"><p>Gets onGameover function</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function</span>
      <span class="dox_type">null</span>
      <span>The onGameover function, or NULL if none
   is found</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.onGameover
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getOnGameover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">onGameover</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getongameover">
  <h3>
    <a href="#stager.getongameover" class="pilcrow">&#182;</a>
    Stager.getOnGameOver
  </h3>
</div>

  </div>
  <div class="body"><p>Alias for <code>getOnGameover</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.getOnGameover
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getOnGameOver</span> <span class="o">=</span> <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getOnGameover</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Add stages, steps.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.addstep">
  <h3>
    <a href="#stager.addstep" class="pilcrow">&#182;</a>
    Stager.addStep
  </h3>
</div>

  </div>
  <div class="body"><p>Adds a new step</p>

<p>Registers a new game step object. This must have at least the
following fields:</p>

<ul>
<li>id (string): The step's name</li>
<li>cb (function): The step's callback function</li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">object</span>
      <span>A valid step object. Shallowly copied.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">unique</span><span class="p">;</span>
        <span class="nx">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">checkStepValidity</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">unique</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.addStep: invalid step received: &#39;</span> <span class="o">+</span>
                            <span class="nx">res</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">step</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.addstage">
  <h3>
    <a href="#stager.addstage" class="pilcrow">&#182;</a>
    Stager.addStage
  </h3>
</div>

  </div>
  <div class="body"><p>Adds a new stage</p>

<p>Registers a new game stage object. The object must have an id
field.</p>

<ul>
<li>id (string): The stage's name</li>
</ul>

<p>and exactly one of the following fields:</p>

<ul>
<li>steps (array of strings): The names of the steps that belong
to this stage. These must have been added with the <code>addStep</code>
method before this call.</li>
<li>cb (function): The callback function. If this field is used,
then a step with the same name as the stage will be created.</li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>A valid stage or step object. Shallowly
   copied.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.checkStepValidity</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.checkStageValidity
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: stage must be object.&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: stage must have &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;either a steps or a cb property.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: stage.steps must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;array or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: id must be string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: stage id already &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;existing: &#39;</span> <span class="o">+</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span>
                            <span class="s1">&#39;. Use extendStage to modify it.&#39;</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>The stage contains only 1 step inside given through the callback
function. A step will be created with the same name of the stage.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
            <span class="nx">stage</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">steps</span><span class="o">:</span> <span class="p">[</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span> <span class="p">]</span>
            <span class="p">};</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>Check whether the all referenced steps exist.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>

            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.addStage: stage &#39;</span> <span class="o">+</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span>
                                    <span class="s1">&#39;: unknown step &quot;&#39;</span> <span class="o">+</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.step">
  <h3>
    <a href="#stager.step" class="pilcrow">&#182;</a>
    Stager.step
  </h3>
</div>

  </div>
  <div class="body"><p>Adds a step to the current Block.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A valid step object or the stepId string.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this step can occupy.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to the current instance for method chaining</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">step</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">step</span><span class="p">,</span>
                <span class="nx">cb</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addStep</span><span class="p">(</span><span class="nx">step</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentBlock</span><span class="p">().</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span><span class="p">,</span>
            <span class="nx">item</span><span class="o">:</span> <span class="nx">step</span><span class="p">.</span><span class="nx">id</span>
        <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">defaultSteps</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.next">
  <h3>
    <a href="#stager.next" class="pilcrow">&#182;</a>
    Stager.next
  </h3>
</div>

  </div>
  <div class="body"><p>Adds a stage block to sequence</p>

<p>The <code>id</code> parameter must have the form 'stageID' or 'stageID AS alias'.
stageID must be a valid stage and it (or alias if given) must be
unique in the sequence.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>A valid stage name with optional alias</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span class="dox_type">null</span>
      <span>this object on success, NULL on error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">stageName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.next: stage.id must be string.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.next: stage.cb must be function &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;or undefined.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
            <span class="nx">cb</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">cb</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stage</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.next: stage must be string or &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;object.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">handleAlias</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stageName</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.next: invalid stage name received: &#39;</span> <span class="o">+</span>
                           <span class="nx">stage</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">handleStageAdd</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;plain&#39;</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">stageName</span>
        <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>Ste: commented out.
if (cb) this.step({id: id, cb: cb}, '0');</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>TODO: do we need this also ?
this.defaultSteps[id] = [id];</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.repeat">
  <h3>
    <a href="#stager.repeat" class="pilcrow">&#182;</a>
    Stager.repeat
  </h3>
</div>

  </div>
  <div class="body"><p>Adds repeated stage block to sequence</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>A valid stage name with optional alias</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nRepeats</span>
      <span class="dox_type">number</span>
      <span>The number of repetitions</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span class="dox_type">null</span>
      <span>this object on success, NULL on error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">nRepeats</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">handleAlias</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">stageName</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.repeat: &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;received invalid stage name.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">nRepeats</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.repeat: &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;received invalid number of repetitions.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">handleStageAdd</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;repeat&#39;</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">stageName</span><span class="p">,</span>
            <span class="nx">num</span><span class="o">:</span> <span class="nx">nRepeats</span>
        <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.loop">
  <h3>
    <a href="#stager.loop" class="pilcrow">&#182;</a>
    Stager.loop
  </h3>
</div>

  </div>
  <div class="body"><p>Adds looped stage block to sequence</p>

<p>The given stage will be repeated as long as the <code>func</code> callback
returns TRUE. If it returns FALSE on the first time, the stage is
never executed.</p>

<p>If no callback function is specified the loop is repeated
indefinitely.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>A valid stage name with optional alias</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">func</span>
      <span class="dox_type">function</span>
      <span>Optional. Callback returning TRUE for
  repetition.
  Default: a function that returns always TRUE</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span class="dox_type">null</span>
      <span>this object on success, NULL on error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.doLoop
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">addLoop</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;loop&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">positions</span><span class="p">);</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.doloop">
  <h3>
    <a href="#stager.doloop" class="pilcrow">&#182;</a>
    Stager.doLoop
  </h3>
</div>

  </div>
  <div class="body"><p>Adds alternatively looped stage block to sequence</p>

<p>The given stage will be repeated once plus as many times as the
<code>func</code> callback returns TRUE.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>A valid stage name with optional alias</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">func</span>
      <span class="dox_type">function</span>
      <span>Optional. Callback returning TRUE for
  repetition.
  Default: a function that returns always TRUE</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span class="dox_type">null</span>
      <span>this object on success, NULL on error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.loop
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doLoop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">addLoop</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;doLoop&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">positions</span><span class="p">);</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.gameover">
  <h3>
    <a href="#stager.gameover" class="pilcrow">&#182;</a>
    Stager.gameover
  </h3>
</div>

  </div>
  <div class="body"><p>Adds gameover block to sequence</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>this object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gameover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">handleStageAdd</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;gameover&#39;</span> <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.handlestageadd">
  <h2>
    <a href="#stager.handlestageadd" class="pilcrow">&#182;</a>
    Stager.handleStageAdd
  </h2>
</div>

  </div>
  <div class="body"><p>Performs several meta operations necessary to add a stage block</p>

<p>Operations:</p>

<ul>
<li>Ends any unclosed blocks.</li>
<li>Begin a new enclosing block.</li>
<li>Adds a stage block.</li>
<li>Adds a steps block.</li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stage</span>
      <span class="dox_type">object</span>
      <span>The stage to add containing its type</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. The allowed positions for the stage</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handleStageAdd</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">name</span><span class="p">;</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="nx">stage</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>Begin stage block.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">!==</span> <span class="s2">&quot;__default&quot;</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">endBlocks</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">beginBlock</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;__enclosing_&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentBlock</span><span class="p">().</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;__stage&quot;</span><span class="p">,</span>
            <span class="nx">item</span><span class="o">:</span> <span class="nx">stage</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>Add step block inside stage block.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">beginBlock</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;__steps_&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="p">});</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>Block operations.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.beginblock">
  <h2>
    <a href="#stager.beginblock" class="pilcrow">&#182;</a>
    Stager.beginBlock
  </h2>
</div>

  </div>
  <div class="body"><p>Begins a new Block</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
   enclosing Block that this block can occupy.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>for the Block constructor</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Stager</span>
      <span>Reference to the current instance for method chainining</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Block
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">beginBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">block</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span><span class="p">});</span>
        <span class="nx">block</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Block</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">block</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">block</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.endblock">
  <h2>
    <a href="#stager.endblock" class="pilcrow">&#182;</a>
    Stager.endBlock
  </h2>
</div>

  </div>
  <div class="body"><p>Ends the current Block.</p>

<p>param {object} options Optional If options.finalize is set, the
     block gets finalized.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">endBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">block</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">currentBlock</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentBlock</span><span class="p">();</span>

        <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">currentBlock</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">currentBlock</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">block</span><span class="p">,</span> <span class="nx">block</span><span class="p">.</span><span class="nx">positions</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">finalize</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">block</span><span class="p">.</span><span class="nx">finalize</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.endblocks">
  <h2>
    <a href="#stager.endblocks" class="pilcrow">&#182;</a>
    Stager.endBlocks
  </h2>
</div>

  </div>
  <div class="body"><p>Ends multiple Blocks</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Number</span>
      <span>n Number of Blocks to be ended.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional If options.finalize is set, the
     block gets finalized.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">endBlocks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">endBlock</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.endallblocks">
  <h2>
    <a href="#stager.endallblocks" class="pilcrow">&#182;</a>
    Stager.endAllBlocks
  </h2>
</div>

  </div>
  <div class="body"><p>Ends all unfinished Blocks.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">endAllBlocks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">endBlocks</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.stepblock">
  <h2>
    <a href="#stager.stepblock" class="pilcrow">&#182;</a>
    Stager.stepBlock
  </h2>
</div>

  </div>
  <div class="body"><p>Begins a new Block of steps</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this block can occupy.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stepBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">=</span> <span class="s2">&quot;__step&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">beginBlock</span><span class="p">(</span><span class="nx">position</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.stageblock">
  <h2>
    <a href="#stager.stageblock" class="pilcrow">&#182;</a>
    Stager.stageBlock
  </h2>
</div>

  </div>
  <div class="body"><p>Begins a new Block of stages</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this block can occupy.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stageBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">!==</span> <span class="s2">&quot;__default&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">endBlocks</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentType</span> <span class="o">=</span> <span class="s2">&quot;__default&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">=</span> <span class="s2">&quot;__stage&quot;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">beginBlock</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.nextblock">
  <h2>
    <a href="#stager.nextblock" class="pilcrow">&#182;</a>
    Stager.nextBlock
  </h2>
</div>

  </div>
  <div class="body"><p>Ends current Block and begins a new one of the same type</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this block can occupy.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">nextBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">endBlock</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">===</span> <span class="s2">&quot;__stage&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stageBlock</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentBlockType</span> <span class="o">===</span> <span class="s2">&quot;__step&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stepBlock</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getcurrentblock">
  <h2>
    <a href="#stager.getcurrentblock" class="pilcrow">&#182;</a>
    Stager.getCurrentBlock
  </h2>
</div>

  </div>
  <div class="body"><p>Returns the Block that Stager is currently working on</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this block can occupy.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCurrentBlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">[</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedBlocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>Extend, Modify</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.extendstep">
  <h3>
    <a href="#stager.extendstep" class="pilcrow">&#182;</a>
    Stager.extendStep
  </h3>
</div>

  </div>
  <div class="body"><p>Extends existing step</p>

<p>Extends an existing game step object. The extension object must
have at least an id field that matches an already existing step.</p>

<p>If a valid object is provided, the fields of the new object are
merged into the existing object (done via JSUS.mixin). Note that
this overwrites already existing fields if the new object
redefines them.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stepId</span>
      <span class="dox_type">string</span>
      <span>The id of the step to update</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">update</span>
      <span class="dox_type">object</span>
      <span>The object containing the properties to update</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStep
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extendStep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepId</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newCallback</span><span class="p">,</span> <span class="nx">oldCallback</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stepId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStep: stepId must be a&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">update</span> <span class="o">||</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStep: update must be&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStep: update.id must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span>
            <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span>
            <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">cb</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span><span class="p">.</span><span class="nx">extend</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStep: update.cb must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be function, undefined or an object&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;with the properties &quot;extend&quot; and&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; &quot;cb&quot;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: stageId not found: &#39;</span> <span class="o">+</span>
                            <span class="nx">stepId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">attribute</span> <span class="k">in</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">attribute</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">].</span><span class="nx">extend</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">newCallback</span> <span class="o">=</span> <span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">].</span><span class="nx">cb</span><span class="p">;</span>
                    <span class="nx">oldCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">].</span><span class="nx">cb</span><span class="p">;</span>
                    <span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">oldCallback</span><span class="p">();</span>
                        <span class="nx">newCallback</span><span class="p">();</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">],</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.extendstage">
  <h3>
    <a href="#stager.extendstage" class="pilcrow">&#182;</a>
    Stager.extendStage
  </h3>
</div>

  </div>
  <div class="body"><p>Extends an existing stage</p>

<p>Extends an existing game stage object. The updating object cannot
have an <code>id</code> property, and if <code>cb</code> property is set, it must be
function.</p>

<p>If a valid object is provided, the fields of the new object are
merged into the existing object (done via JSUS.mixin). Note that
this overwrites already existing fields if the new object
redefines them.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stageId</span>
      <span class="dox_type">string</span>
      <span>The id of the stage to update</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">update</span>
      <span class="dox_type">object</span>
      <span>The object containing the properties to
  update</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extendStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stageId</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">newCallback</span><span class="p">,</span> <span class="nx">oldCallback</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stageId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: stageId must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;a string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">update</span> <span class="o">||</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: update must be&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: update.id must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span>
            <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span>
            <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">cb</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span><span class="p">.</span><span class="nx">extend</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStep: update.cb must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be function, undefined or an object&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;with the properties &quot;extend&quot; and&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; &quot;cb&quot;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">steps</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: update.steps &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;must be array or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">steps</span> <span class="o">&amp;&amp;</span> <span class="nx">update</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: update must have&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; either a steps or a cb property.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageId</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.extendStage: stageId not found: &#39;</span> <span class="o">+</span>
                            <span class="nx">stageId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">attribute</span> <span class="k">in</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">attribute</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">].</span><span class="nx">extend</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">newCallback</span> <span class="o">=</span> <span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">].</span><span class="nx">cb</span><span class="p">;</span>
                    <span class="nx">oldCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stageId</span><span class="p">].</span><span class="nx">cb</span><span class="p">;</span>
                    <span class="nx">update</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">oldCallback</span><span class="p">();</span>
                        <span class="nx">newCallback</span><span class="p">();</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageId</span><span class="p">],</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.skip">
  <h3>
    <a href="#stager.skip" class="pilcrow">&#182;</a>
    Stager.skip
  </h3>
</div>

  </div>
  <div class="body"><p>Removes one stage from the sequence.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">stageId</span>
      <span class="dox_type">string</span>
      <span>The id of the stage to remove from
  sequence.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStage
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stageId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">stageId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.skip: stageId must be a&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39; string.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageId</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.skip: stageId not found: &#39;</span> <span class="o">+</span>
                            <span class="nx">stageId</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">stageId</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>Get Info out.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getsequence">
  <h3>
    <a href="#stager.getsequence" class="pilcrow">&#182;</a>
    Stager.getSequence
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the sequence of stages</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">format</span>
      <span class="dox_type">string</span>
      <span>'hstages' for an array of human-readable
  stage descriptions, 'hsteps' for an array of human-readable
  step descriptions, 'o' for the internal JavaScript object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span class="dox_type">object</span>
      <span class="dox_type">null</span>
      <span>The stage sequence in requested
  format. NULL on error.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getSequence</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">seqIdx</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">seqObj</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">stepPrefix</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;hstages&#39;</span><span class="o">:</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="k">for</span> <span class="p">(</span><span class="nx">seqIdx</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">seqIdx</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">seqObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">seqIdx</span><span class="p">];</span>

                    <span class="k">switch</span> <span class="p">(</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s1">&#39;gameover&#39;</span><span class="o">:</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;[game over]&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;plain&#39;</span><span class="o">:</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;repeat&#39;</span><span class="o">:</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; [x&#39;</span> <span class="o">+</span> <span class="nx">seqObj</span><span class="p">.</span><span class="nx">num</span> <span class="o">+</span>
                            <span class="s1">&#39;]&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;loop&#39;</span><span class="o">:</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; [loop]&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;doLoop&#39;</span><span class="o">:</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; [doLoop]&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.getSequence: unknown&#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;sequence object type.&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="s1">&#39;hsteps&#39;</span><span class="o">:</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="k">for</span> <span class="p">(</span><span class="nx">seqIdx</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">seqIdx</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">seqObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">seqIdx</span><span class="p">];</span>
                    <span class="nx">stepPrefix</span> <span class="o">=</span> <span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>

                    <span class="k">switch</span> <span class="p">(</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="s1">&#39;gameover&#39;</span><span class="o">:</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;[game over]&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;plain&#39;</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">steps</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">stepID</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stepPrefix</span> <span class="o">+</span> <span class="nx">stepID</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;repeat&#39;</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">steps</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">stepID</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stepPrefix</span> <span class="o">+</span> <span class="nx">stepID</span> <span class="o">+</span>
                                    <span class="s1">&#39; [x&#39;</span> <span class="o">+</span> <span class="nx">seqObj</span><span class="p">.</span><span class="nx">num</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;loop&#39;</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">steps</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">stepID</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stepPrefix</span> <span class="o">+</span>
                                            <span class="nx">stepID</span> <span class="o">+</span> <span class="s1">&#39; [loop]&#39;</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">case</span> <span class="s1">&#39;doLoop&#39;</span><span class="o">:</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">seqObj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">steps</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">stepID</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stepPrefix</span> <span class="o">+</span>
                                            <span class="nx">stepID</span> <span class="o">+</span> <span class="s1">&#39; [doLoop]&#39;</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.getSequence: unknown&#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;sequence object type.&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="s1">&#39;o&#39;</span><span class="o">:</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.getSequence: invalid format.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.extractstage">
  <h3>
    <a href="#stager.extractstage" class="pilcrow">&#182;</a>
    Stager.extractStage
  </h3>
</div>

  </div>
  <div class="body"><p>Returns a minimal state package containing one or more stages</p>

<p>The returned package consists of a <code>setState</code>-compatible object
with the <code>steps</code> and <code>stages</code> properties set to include the given
stages.
The <code>sequence</code> is optionally set to a single <code>next</code> block for the
stage.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">ids</span>
      <span class="dox_type">string</span>
      <span class="dox_type">array</span>
      <span>Valid stage name(s)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">useSeq</span>
      <span class="dox_type">boolean</span>
      <span>Optional. Whether to generate a singleton
  sequence.  TRUE by default.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span class="dox_type">null</span>
      <span>The state object on success, NULL on error</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.setState
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extractStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">useSeq</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">steps</span><span class="o">:</span> <span class="p">{},</span> <span class="nx">stages</span><span class="o">:</span> <span class="p">{},</span> <span class="nx">sequence</span><span class="o">:</span> <span class="p">[]</span>
        <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">stepIdx</span><span class="p">,</span> <span class="nx">stepId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">stageId</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">stageObj</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">idArray</span><span class="p">,</span> <span class="nx">idIdx</span><span class="p">,</span> <span class="nx">id</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">ids</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">idArray</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">ids</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">idArray</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">ids</span> <span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>undefined (default) -> true</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">useSeq</span> <span class="o">=</span> <span class="p">(</span><span class="nx">useSeq</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">idIdx</span> <span class="k">in</span> <span class="nx">idArray</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">idArray</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">idIdx</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">id</span> <span class="o">=</span> <span class="nx">idArray</span><span class="p">[</span><span class="nx">idIdx</span><span class="p">];</span>

                <span class="nx">stageObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stageObj</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>Add step objects:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="k">for</span> <span class="p">(</span><span class="nx">stepIdx</span> <span class="k">in</span> <span class="nx">stageObj</span><span class="p">.</span><span class="nx">steps</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stageObj</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">stepIdx</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">stepId</span> <span class="o">=</span> <span class="nx">stageObj</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepIdx</span><span class="p">];</span>
                        <span class="nx">result</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="nx">stepId</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p>Add stage object:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="nx">stageId</span> <span class="o">=</span> <span class="nx">stageObj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stageObj</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>If given id is alias, also add alias:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">stageId</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stageObj</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>Add mini-sequence:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">useSeq</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">result</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;plain&#39;</span><span class="p">,</span>
                        <span class="nx">id</span><span class="o">:</span> <span class="nx">stageId</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.getstepsfromstage">
  <h3>
    <a href="#stager.getstepsfromstage" class="pilcrow">&#182;</a>
    Stager.getStepsFromStage
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the steps of a stage</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>A valid stage name</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">array</span>
      <span class="dox_type">null</span>
      <span>The steps in the stage. NULL on invalid
  stage.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getStepsFromStage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">steps</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<p>Flexible Mode</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.registergeneralnext">
  <h3>
    <a href="#stager.registergeneralnext" class="pilcrow">&#182;</a>
    Stager.registerGeneralNext
  </h3>
</div>

  </div>
  <div class="body"><p>Sets general callback for next stage decision</p>

<p>Available only when nodegame is executed in <em>flexible</em> mode.
The callback given here is used to determine the next stage.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">func</span>
      <span class="dox_type">function</span>
      <span class="dox_type">null</span>
      <span>The decider callback. It should
  return the name of the next stage, 'NODEGAME_GAMEOVER' to end
  the game or FALSE for sequence end. NULL can be given to
  signify non-existence.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerGeneralNext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">func</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.registerGeneralNext: &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;func must be function or undefined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">generalNextFunction</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="stager.registernext">
  <h3>
    <a href="#stager.registernext" class="pilcrow">&#182;</a>
    Stager.registerNext
  </h3>
</div>

  </div>
  <div class="body"><p>Registers a step-decider callback for a specific stage</p>

<p>The function overrides the general callback for the specific
stage, and determines the next stage.
Available only when nodegame is executed in <em>flexible</em> mode.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">id</span>
      <span class="dox_type">string</span>
      <span>The name of the stage after which the decider
  function will be called</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">func</span>
      <span class="dox_type">function</span>
      <span>The decider callback. It should return the
  name of the next stage, 'NODEGAME_GAMEOVER' to end the game or
  FALSE for sequence end.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.registerGeneralNext
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Stager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerNext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.registerNext: func must be &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;function.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Stager.registerNext: non existent &#39;</span> <span class="o">+</span>
                               <span class="s1">&#39;stage id: &#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">nextFunctions</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="stager-private-methods">
  <h2>
    <a href="#stager-private-methods" class="pilcrow">&#182;</a>
    Stager private methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">addLoop</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">handleAlias</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">stageName</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span>
                            <span class="s1">&#39;: received invalid stage name.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;: received invalid&#39;</span> <span class="o">+</span>
                            <span class="s1">&#39; callback.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">handleStageAdd</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">stageName</span><span class="p">,</span>
            <span class="nx">cb</span><span class="o">:</span> <span class="nx">func</span>
        <span class="p">},</span> <span class="nx">positions</span><span class="p">);</span>


        <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>checkStepValidity</p>
  </div>
  <div class="body"><p>Returns whether given step is valid</p>

<p>Checks for existence and type correctness of the fields.
Optionally, checks also for id uniqueness.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">step</span>
      <span class="dox_type">object</span>
      <span>The step object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">unique</span>
      <span class="dox_type">boolean</span>
      <span>If TRUE, checks also for id uniqueness</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>NULL for valid stages, error description else</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.addStep
</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">checkStepValidity</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">unique</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">)</span>  <span class="k">return</span> <span class="s1">&#39;step must be object&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;missing ID&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">step</span><span class="p">.</span><span class="nx">cb</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;missing callback&#39;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">unique</span> <span class="o">&amp;&amp;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">step</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">&#39;step ID already existing: &#39;</span> <span class="o">+</span> <span class="nx">step</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span>
                <span class="s1">&#39;. Use extendStep to modify it&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>

<div class="highlight"><pre><code><span class="o">/**</span>
 <span class="o">*</span> <span class="n">checkStageValidity</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Returns</span> <span class="n">whether</span> <span class="n">given</span> <span class="n">stage</span> <span class="n">is</span> <span class="n">valid</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Checks</span> <span class="k">for</span> <span class="n">existence</span> <span class="ow">and</span> <span class="n">type</span> <span class="n">correctness</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fields</span><span class="o">.</span>
 <span class="o">*</span> <span class="n">Checks</span> <span class="k">for</span> <span class="n">referenced</span> <span class="n">step</span> <span class="n">existence</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nv">@param</span> <span class="p">{</span><span class="n">object</span><span class="p">}</span> <span class="n">stage</span> <span class="n">The</span> <span class="n">stage</span> <span class="n">object</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nv">@return</span> <span class="p">{</span><span class="n">string</span><span class="p">}</span> <span class="n">NULL</span> <span class="k">for</span> <span class="n">valid</span> <span class="n">stages</span><span class="p">,</span> <span class="n">error</span> <span class="n">description</span> <span class="k">else</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nv">@see</span> <span class="n">Stager</span><span class="o">.</span><span class="n">addStage</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nv">@api</span> <span class="n">private</span>
 <span class="o">*/</span>
<span class="n">function</span> <span class="n">checkStageValidity</span><span class="p">(</span><span class="n">that</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;object&#39;</span> <span class="o">!==</span> <span class="n">typeof</span> <span class="n">stage</span><span class="p">)</span> <span class="k">return</span> <span class="s">&#39;stage must be object&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;string&#39;</span> <span class="o">!==</span> <span class="n">typeof</span> <span class="n">stage</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">return</span> <span class="s">&#39;missing ID&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stage</span><span class="o">.</span><span class="n">steps</span> <span class="o">||</span> <span class="o">!</span><span class="n">stage</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="nb">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;missing &quot;steps&quot; array&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">unique</span> <span class="o">&amp;&amp;</span> <span class="n">that</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">hasOwnProperty</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;stage id already existing: &#39;</span> <span class="o">+</span> <span class="n">stage</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span>
            <span class="s">&#39;. Use extendStage to modify it&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sr">//</span> <span class="n">Check</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">all</span> <span class="n">referenced</span> <span class="n">steps</span> <span class="n">exist</span><span class="o">.</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stage</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="nb">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">that</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">stage</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&#39;unknown step &quot;&#39;</span> <span class="o">+</span> <span class="n">stage</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-114" id="section-114">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>handleAlias</p>
  </div>
  <div class="body"><p>Handles stage id and alias strings</p>

<p>Takes a string like 'stageID' or 'stageID AS alias' and registers
the alias, if existent. Checks whether parameter is valid and unique.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">that</span>
      <span class="dox_type">object</span>
      <span>Reference to Stager object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nameAndAlias</span>
      <span class="dox_type">string</span>
      <span>The stage-name string</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">function</span>
      <span>Optional. The callback for the stage</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>the alias part of the parameter if it exists,
 the stageID part otherwise</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Stager.next
</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">handleAlias</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">nameAndAlias</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">nameAndAlias</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; AS &#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">alias</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">stageName</span> <span class="o">=</span> <span class="nx">alias</span> <span class="o">||</span> <span class="nx">id</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">seqIdx</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-115" id="section-115">&#182;</a>
</div>
<p>Check ID validity:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">addStage</span><span class="p">({</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span>
                <span class="nx">cb</span><span class="o">:</span> <span class="nx">cb</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentStepObj</span><span class="p">().</span><span class="nx">id</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">done</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-116" id="section-116">&#182;</a>
</div>
<p>Check uniqueness:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">seqIdx</span> <span class="k">in</span> <span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">seqIdx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">seqIdx</span><span class="p">].</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">stageName</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Stager.handleAlias: &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;received non-unique stage name.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-117" id="section-117">&#182;</a>
</div>
<p>Add alias:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">alias</span><span class="p">]</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
            <span class="k">return</span> <span class="nx">alias</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="block">
  <h2>
    <a href="#block" class="pilcrow">&#182;</a>
    Block
  </h2>
</div>


<div class="dox">
  <div class="summary">
<div class="pilwrap" id="block-constructor">
  <h2>
    <a href="#block-constructor" class="pilcrow">&#182;</a>
    Block constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates a new instance of Block</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions</span>
      <span class="dox_type">string</span>
      <span>Optional. Positions within the
     enclosing Block that this block can occupy.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">Block</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.id">
  <h3>
    <a href="#block.id" class="pilcrow">&#182;</a>
    Block.id
  </h3>
</div>

  </div>
  <div class="body"><p>An identifier (name) for the block instance</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.positions">
  <h3>
    <a href="#block.positions" class="pilcrow">&#182;</a>
    Block.positions
  </h3>
</div>

  </div>
  <div class="body"><p>Positions in the enclosing Block that this block can occupy</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">positions</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.tajenpositions">
  <h3>
    <a href="#block.tajenpositions" class="pilcrow">&#182;</a>
    Block.tajenPositions
  </h3>
</div>

  </div>
  <div class="body"><p>Positions within this Block that this are occupied</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">takenPositions</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.items">
  <h3>
    <a href="#block.items" class="pilcrow">&#182;</a>
    Block.items
  </h3>
</div>

  </div>
  <div class="body"><p>The items within this Block</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.unfinishedentries">
  <h3>
    <a href="#block.unfinishedentries" class="pilcrow">&#182;</a>
    Block.unfinishedEntries
  </h3>
</div>

  </div>
  <div class="body"><p>Items that have not been assigned a position in this block</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.index">
  <h3>
    <a href="#block.index" class="pilcrow">&#182;</a>
    Block.index
  </h3>
</div>

  </div>
  <div class="body"><p>Index of the current element to be returned by Block.next</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Block.next
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.finalized">
  <h3>
    <a href="#block.finalized" class="pilcrow">&#182;</a>
    Block.finalized
  </h3>
</div>

  </div>
  <div class="body"><p>Flag to indicate whether a block is completed</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.numberofitems">
  <h3>
    <a href="#block.numberofitems" class="pilcrow">&#182;</a>
    Block.numberOfItems
  </h3>
</div>

  </div>
  <div class="body"><p>The number of items in the block</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">numberOfItems</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.resetcache">
  <h3>
    <a href="#block.resetcache" class="pilcrow">&#182;</a>
    Block.resetCache
  </h3>
</div>

  </div>
  <div class="body"><p>Cache object to reset Block after finalization</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">resetCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.add">
  <h2>
    <a href="#block.add" class="pilcrow">&#182;</a>
    Block.add
  </h2>
</div>

  </div>
  <div class="body"><p>Adds an item to a block</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">item.</span>
      <span class="dox_type">object</span>
      <span>The item to be added</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">positions.</span>
      <span class="dox_type">string</span>
      <span>The positions where item can be added
     Setting this parameter to "linear" or undefined adds the
     item to the next free n-th position where this is the n-th
     call to add.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Block</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">positions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">finalized</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Block.add: stager already finalized, cannot add &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;further items.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">positions</span> <span class="o">||</span> <span class="nx">positions</span> <span class="o">===</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">takenPositions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">numberOfItems</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">numberOfItems</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                <span class="nx">item</span><span class="o">:</span> <span class="nx">item</span><span class="p">,</span>
                <span class="nx">positions</span><span class="o">:</span> <span class="nx">positions</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">numberOfItems</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.finalize">
  <h2>
    <a href="#block.finalize" class="pilcrow">&#182;</a>
    Block.finalize
  </h2>
</div>

  </div>
  <div class="body"><p>Processes all unfinished entries, assigns each to a position</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Block</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">finalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">positions</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">chosenPosition</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">available</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">var</span> <span class="nx">sortFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">left</span><span class="p">.</span><span class="nx">positions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">positions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">finalized</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-130" id="section-130">&#182;</a>
</div>
<p>Cache the current state before finalization for later reset.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">resetCache</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">classClone</span><span class="p">({</span>
            <span class="nx">takenPositions</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">takenPositions</span><span class="p">,</span>
            <span class="nx">unfinishedEntries</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">,</span>
            <span class="nx">items</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span>
        <span class="p">},</span><span class="mi">3</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-131" id="section-131">&#182;</a>
</div>
<p>Range in which the indeces must be.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">numberOfItems</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">available</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-132" id="section-132">&#182;</a>
</div>
<p>Accounting for already taken positions.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">available</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">arrayDiff</span><span class="p">(</span><span class="nx">available</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">takenPositions</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-133" id="section-133">&#182;</a>
</div>
<p>Parseing all of the position strings into arrays.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">positions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">positions</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">positions</span> <span class="o">=</span>
                    <span class="nx">J</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">available</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-134" id="section-134">&#182;</a>
</div>
<p>Assigning positions.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-135" id="section-135">&#182;</a>
</div>
<p>Select entry with least possibilities of where to go.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortFunction</span><span class="p">);</span>
            <span class="nx">entry</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
            <span class="nx">item</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">item</span><span class="p">;</span>
            <span class="nx">positions</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">positions</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-136" id="section-136">&#182;</a>
</div>
<p>No valid position specified.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">positions</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Block.finalize: No valid position &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;specified in Block &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-137" id="section-137">&#182;</a>
</div>
<p>Chose position randomly among possibilities.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nx">chosenPosition</span> <span class="o">=</span>  <span class="nx">positions</span><span class="p">[</span>
                <span class="nx">J</span><span class="p">.</span><span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">positions</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">chosenPosition</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">takenPositions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chosenPosition</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-138" id="section-138">&#182;</a>
</div>
<p>Adjust possible positions of remaining entries.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">J</span><span class="p">.</span><span class="nx">removeElement</span><span class="p">(</span><span class="nx">chosenPosition</span><span class="p">,</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">positions</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.next">
  <h2>
    <a href="#block.next" class="pilcrow">&#182;</a>
    Block.next
  </h2>
</div>

  </div>
  <div class="body"><p>Gets the next item in a hierarchy of Blocks</p>

<p>If there is not next item, false is returned.
If the next item is not a Block it is returned, otherwise next is
 called recursively.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Block</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">item</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">item</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">item</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">item</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">item</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="block.reset">
  <h2>
    <a href="#block.reset" class="pilcrow">&#182;</a>
    Block.reset
  </h2>
</div>

  </div>
  <div class="body"><p>Reset the Block to the state before finalization</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Block.finalize
  </span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">Block</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">unfinishedEntries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resetCache</span><span class="p">.</span><span class="nx">unfinishedEntries</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">takenPositions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resetCache</span><span class="p">.</span><span class="nx">takenPositions</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resetCache</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">finalized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="closure">
  <h2>
    <a href="#closure" class="pilcrow">&#182;</a>
    Closure
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="p">})(</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
    <span class="s1">&#39;undefined&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">node</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">exports</span>
<span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
