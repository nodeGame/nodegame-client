
(function(e){var t=e.JSUS={};t._classes={},t.log=function(e){console.log(e)},t.extend=function(e,n){if("object"!=typeof e&&"function"!=typeof e)return n;if("undefined"==typeof n){var n=n||this;if("function"==typeof e){var r=e.toString();r=r.substr("function ".length),r=r.substr(0,r.indexOf("("))}else var r=e.constructor||e.__proto__.constructor;r&&(this._classes[r]=e)}for(var i in e)e.hasOwnProperty(i)&&(typeof n[i]!="object"?n[i]=e[i]:t.extend(e[i],n[i]));return e.prototype&&t.extend(e.prototype,n.prototype||n),n},"object"==typeof module&&"function"==typeof require&&(require("./lib/obj"),require("./lib/array"),require("./lib/time"),require("./lib/eval"),require("./lib/dom"),require("./lib/random"),require("./lib/parse")),t.get=function(e){return"undefined"==typeof t.clone?(t.log("JSUS.clone not found. Cannot continue."),!1):"undefined"==typeof e?t.clone(t._classes):"undefined"==typeof t._classes[e]?(t.log("Could not find class "+e),!1):t.clone(t._classes[e])}})("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window),function(e){function t(){}Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[],i=arguments[1];for(var s=0;s<n;s++)if(s in t){var o=t[s];e.call(i,o,s,t)&&r.push(o)}return r}),t.isArray=function(e){return e?Object.prototype.toString.call(e)==="[object Array]"?!0:!1:!1},t.seq=function(t,n,r){if("number"!=typeof t)return!1;if(t===Infinity)return!1;if("number"!=typeof n)return!1;if(n===Infinity)return!1;if(t===n)return[t];if(r===0)return!1;if(!e.in_array(typeof r,["undefined","number"]))return!1;r=r||1;var i=t,s=[];if(t<n)while(i<=n)s.push(i),i+=r;else while(i>=n)s.push(i),i-=r;return s},t.each=function(e,t,n){if("object"!=typeof e)return!1;if(!t)return!1;n=n||this;var r,i=e.length;for(r=0;r<i;r++)t.call(n,e[r]);return!0},t.removeElement=function(t,n){if("object"==typeof t)var r=e.equals;else var r=function(e,t){return e===t};for(var i=0;i<n.length;i++)if(r(t,n[i]))return n.splice(i,1);return!1},t.in_array=function(t,n){if("undefined"==typeof t||!n)return!1;if("object"==typeof t)var r=e.equals;else var r=function(e,t){return e===t};for(var i=0;i<n.length;i++)if(r.call(this,t,n[i]))return!0;return!1},t.getNGroups=function(e,n){return t.getGroupsSizeN(e,Math.floor(e.length/n))},t.getGroupsSizeN=function(e,t){var n=e.slice(0),r=n.length,i=n.length,s=[],o,u,a=[],f=0;for(o=0;o<i;o++)u=Math.floor(Math.random()*r),f>=t&&(s.push(a),f=0,a=[]),a.push(n[u]),n.splice(u,1),r=n.length,f++;return a.length>0&&s.push(a),s},t._latinSquare=function(t,n,r){var r="undefined"==typeof r?!0:r;if(t===n&&!r)return!1;var i=[],s=[];for(var o=0;o<t;o++)i[o]=o;var u=null,a=0,f=t,l=[];r||(f=t-1);for(o=0;o<n;o++){do u=e.randomInt(a,f);while(e.in_array(u,l));l.push(u),u==1?(s[o]=i.slice(u),s[o].push(0)):s[o]=i.slice(u).concat(i.slice(0,u))}return s},t.latinSquare=function(e,n){return n||(n=e),!e||e<0||n<0?!1:(n>e&&(n=e),t._latinSquare(e,n,!0))},t.latinSquareNoSelf=function(e,n){return n||(n=e-1),!e||e<0||n<0?!1:(n>e&&(n=e-1),t._latinSquare(e,n,!1))},t.generateCombinations=function(t,n){function r(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(t[e[r]]);return n}var i=t.length,s=[];for(var o=0;o<n;o++)s.push(o);var u=[];for(var o=i-n;o<i;o++)u.push(o);while(!e.equals(s,u)){callback(r(s,t));var o=n-1;while(s[o]==i-n+o)o-=1;s[o]+=1;for(var a=o+1;a<n;a++)s[a]=s[o]+a-o}return r(s,t)},t.matchN=function(e,n,r){var i=[],s=e.length,o=[];for(var u=0;u<s;u++){var a=e.slice(0);a.splice(u,1),r&&(a=t.arrayDiff(a,o));var f=t.getNRandom(a,n);o=o.concat(f),f.splice(0,0,e[u]),i.push(f),f=[]}return i},t.arraySelfConcat=function(e){var t=0,n=e.length,r=[];for(;t<n;t++)r=r.concat(e[t]);return r},t.arrayIntersect=function(t,n){return t.filter(function(t){return e.in_array(t,n)})},t.arrayDiff=function(t,n){return t.filter(function(t){return!e.in_array(t,n)})},t.shuffle=function(e){var t=e.slice(0),n=e.length-1;for(var r=n;r>0;r--){var i=Math.floor(Math.random()*(r+1)),s=t[i];t[i]=t[r],t[r]=s}return t},t.getNRandom=function(e,n){return t.shuffle(e).slice(0,n)},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.write=function(t,n){if(!t)return;if(!n)return;var r=!e.isNode(n)||!e.isElement(n)?document.createTextNode(n):n;return t.appendChild(r),r},t.writeln=function(e,n,r){if(!e)return;var i=this.addBreak(e,r);return n?t.write(e,n):i},t.isNode=function(e){return typeof Node=="object"?e instanceof Node:typeof e=="object"&&typeof e.nodeType=="number"&&typeof e.nodeName=="string"},t.isElement=function(e){return typeof HTMLElement=="object"?e instanceof HTMLElement:typeof e=="object"&&e.nodeType===1&&typeof e.nodeName=="string"},t.getElement=function(e,t,n){var r=document.createElement(e);return"undefined"!=typeof t&&(r.id=t),this.addAttributes2Elem(r,n)},t.addElement=function(e,t,n,r){var i=this.getElement(e,n,r);return t.appendChild(i)},t.addAttributes2Elem=function(t,n){if(!t||!n)return t;if("object"!=typeof n)return t;var r=["id","label"];for(var i in n)n.hasOwnProperty(i)&&(e.in_array(i,r)?i==="id"&&(t.id=n[i]):t.setAttribute(i,n[i]));return t},t.populateSelect=function(e,t){if(!e||!t)return;for(var n in t)if(t.hasOwnProperty(n)){var r=document.createElement("option");r.value=t[n],r.appendChild(document.createTextNode(n)),e.appendChild(r)}},t.getButton=function(e,t,n){var r=document.createElement("button");return r.id=e,r.appendChild(document.createTextNode(t||"Send")),this.addAttributes2Elem(r,n)},t.addButton=function(e,t,n,r){var i=this.getButton(t,n,r);return e.appendChild(i)},t.getFieldset=function(e,t,n){var r=this.getElement("fieldset",e,n),i=document.createElement("Legend");return i.appendChild(document.createTextNode(t)),r.appendChild(i),r},t.addFieldset=function(e,t,n,r){var i=this.getFieldset(t,n,r);return e.appendChild(i)},t.getTextInput=function(e,t){var n=document.createElement("input");return"undefined"!=typeof e&&(n.id=e),n.setAttribute("type","text"),this.addAttributes2Elem(n,t)},t.addTextInput=function(e,t,n){var r=this.getTextInput(t,n);return e.appendChild(r)},t.getTextArea=function(e,t){var n=document.createElement("textarea");return"undefined"!=typeof e&&(n.id=e),this.addAttributes2Elem(n,t)},t.addTextArea=function(e,t,n){var r=this.getTextArea(t,n);return e.appendChild(r)},t.getCanvas=function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");return r?(n.id=e,this.addAttributes2Elem(n,t)):(alert("Canvas is not supported"),!1)},t.addCanvas=function(e,t,n){var r=this.getCanvas(t,n);return e.appendChild(r)},t.getSlider=function(e,t){var n=document.createElement("input");return n.id=e,n.setAttribute("type","range"),this.addAttributes2Elem(n,t)},t.addSlider=function(e,t,n){var r=this.getSlider(t,n);return e.appendChild(r)},t.getRadioButton=function(e,t){var n=document.createElement("input");return n.id=e,n.setAttribute("type","radio"),this.addAttributes2Elem(n,t)},t.addRadioButton=function(e,t,n){var r=this.getRadioButton(t,n);return e.appendChild(r)},t.getLabel=function(e,t,n,r){if(!e)return!1;var i=document.createElement("label");return i.id=t,i.appendChild(document.createTextNode(n)),"undefined"==typeof e.id&&(e.id=this.generateUniqueId()),i.setAttribute("for",e.id),this.addAttributes2Elem(i,r),i},t.addLabel=function(e,t,n,r,i){if(!e||!t||!r)return!1;var s=this.getLabel(t,n,r,i);return e.insertBefore(s,t),s},t.getSelect=function(e,t){return this.getElement("select",e,t)},t.addSelect=function(e,t,n){return this.addElement("select",e,t,n)},t.getIFrame=function(e,t){var t={name:e};return this.getElement("iframe",e,t)},t.addIFrame=function(e,t,n){var r=this.getIFrame(t,n);return e.appendChild(r)},t.addBreak=function(e,t){var n=t||"br",r=document.createElement(n);return e.appendChild(r)},t.addCSS=function(t,n,r,i){var t=t||document.head||document.body||document;return t?(i=i||{},i=e.merge(i,{rel:"stylesheet",type:"text/css",href:n}),this.addElement("link",t,r,i)):!1},t.addJS=function(t,n,r,i){var t=t||document.head||document.body||document;return t?(i=i||{},i=e.merge(i,{charset:"utf-8",type:"text/javascript",src:n}),this.addElement("script",t,r,i)):!1},t.getDiv=function(e,t){return this.getElement("div",e,t)},t.addDiv=function(e,t,n){return this.addElement("div",e,t,n)},t.highlight=function(e,t){if(!e)return;switch(t){case"OK":var n="green";break;case"WARN":var n="yellow";break;case"ERR":var n="red";break;default:if(t[0]==="#")var n=t;else var n="red"}return this.addBorder(e,n)},t.addBorder=function(e,t,n,r){if(!e)return;var t=t||"red",i=i||"5px",r=r||"solid",s={border:i+" "+r+" "+t};return this.style(e,s)},t.style=function(e,n){if(!e||!n)return;if(!t.isElement(e))return;var r="";for(var i in n)r+=i+": "+n[i]+"; ";return e.setAttribute("style",r)},t.removeClass=function(e,t){if(!e||!t)return;var n="/(?:^|s)"+t+"(?!S)/",r=e.className=e.className.replace(n,"");return e},t.addClass=function(e,t){if(!e||!t)return;return t instanceof Array&&(t=t.join(" ")),"undefined"==typeof e.className?e.className=t:e.className+=" "+t,e},t.removeChildrenFromNode=function(e){if(!e)return!1;while(e.hasChildNodes())e.removeChild(e.firstChild);return!0},t.insertAfter=function(e,t){t.insertBefore(e,t.nextSibling)},t.generateUniqueId=function(t){function r(t){var r=!0;while(r)for(var i=0;i<n.length;i++){r=n[i].document.getElementById(t);if(r){t=""+t+"_"+e.randomInt(0,1e3);break}}return t}var n=[window];return window.frames&&(n=n.concat(window.frames)),r(t+"_"+e.randomInt(0,1e7))},t.getBlankPage=function(){var e=document.createElement("html");return e.appendChild(document.createElement("body")),e},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){function EVAL(){}EVAL.eval=function(str,context){var context=context||this,func=function(str){return eval(str)};return func.call(context,str)},JSUS.extend(EVAL)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.equals=function(e,n){if(!e||!n)return!1;if(typeof e in{number:"",string:""})return typeof n in{number:"",string:""}?e===n:!1;if(typeof n in{number:"",string:""})return!1;for(var r in e)if(e.hasOwnProperty(r)){if("undefined"==typeof n[r]&&"undefined"!=typeof e[r])return!1;switch(typeof e[r]){case"object":if(!t.equals(e[r],n[r]))return!1;case"function":if(e[r].toString()!==n[r].toString())return!1;default:if(e[r]!==n[r])return!1}}for(r in n)if(n.hasOwnProperty(r)&&"undefined"==typeof e[r]&&"undefined"!=typeof n[r])return!1;return!0},t.isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},t.getListSize=t.getOwnPropertiesSize=function(e){return t.length(e)},t.size=function(e){if(!e)return 0;if("number"==typeof e)return 0;if("string"==typeof e)return 0;var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t},t._obj2Array=function(e,n,r,i){if("object"!=typeof e)return[e];if(r){var i="undefined"!=typeof i?i:1;if(i>r)return[e];i+=1}var s=[];for(var o in e)e.hasOwnProperty(o)&&("object"==typeof e[o]?s=s.concat(t._obj2Array(e[o],n,r,i)):(n&&s.push(o),s.push(e[o])));return s},t.obj2Array=function(e,n){return t._obj2Array(e,!1,n)},t.obj2KeyedArray=t.obj2KeyArray=function(e,n){return t._obj2Array(e,!0,n)},t.keys=t.objGetAllKeys=function(e,n,r){if(!e)return;n="number"==typeof n&&n>=0?n:0,r="number"==typeof r&&r>=0?r:0;var i=[];for(var s in e)e.hasOwnProperty(s)&&(i.push(s),r<n&&"object"==typeof e[s]&&(i=i.concat(t.objGetAllKeys(e[s],r+1))));return i},t.implode=t.implodeObj=function(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t},t.clone=function(e){if(!e)return;if("number"==typeof e)return e;if("string"==typeof e)return e;if(e===NaN)return e;if(e===Infinity)return e;var n={};for(var r in e){var i=e[r]&&"object"==typeof e[r]?t.clone(e[r]):e[r];e.hasOwnProperty(r)?n[r]=i:Object.defineProperty(n,r,{value:i,writable:!0,configurable:!0})}return n},t.join=function(e,n){var r=t.clone(e);if(!n)return r;for(var i in r)r.hasOwnProperty(i)&&"undefined"!=typeof n[i]&&("object"==typeof n[i]?r[i]=t.join(r[i],n[i]):r[i]=n[i]);return r},t.merge=function(e,n){if(!e&&!n)return!1;if(!e)return t.clone(n);if(!n)return t.clone(e);var r=t.clone(e);for(var i in n)n.hasOwnProperty(i)&&(n[i]&&"object"==typeof n[i]?("object"!=typeof r[i]&&(r[i]={}),r[i]=t.merge(r[i],n[i])):r[i]=n[i]);return r},t.mergeOnKey=function(e,n,r){var i=t.clone(e);if(!n||!r)return i;for(var s in n)if(n.hasOwnProperty(s)){if(!i[s]||"object"!=typeof i[s])i[s]={};i[s][r]=n[s]}return i},t.subobj=function(e,t){if(!e)return!1;var n={};if(!t)return n;t instanceof Array||(t=[t]);for(var r=0;r<t.length;r++){var i=t[r];"undefined"!=typeof e[i]&&(n[i]=e[i])}return n},t.setNestedValue=function(e,n,r){var r=r||{},i=e.split(".");if(i.length===1)return r[e]=n,r;var s=i.shift();return r[s]=t.setNestedValue(i.join("."),n,r[s]),r},t.getNestedValue=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return n[e];var i=r.shift();return t.getNestedValue(r.join("."),n[i])},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.random=function(e,t){e="undefined"==typeof e?0:e,t="undefined"==typeof t?0:t;if(e===t)return e;if(t<e){var n=e;e=t,t=n}return Math.random()*(t-e)+e},t.randomInt=function(e,n){return e===n?e:Math.floor(t.random(e,n)+1)},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.getDate=t.getFullDate=function(){var e=new Date,t=e.getUTCDate()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+" "+e.getMilliseconds();return t},t.getTime=function(){var e=new Date,t=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return t},t.parseMilliseconds=function(e){var t=[],n=e/1e3;t[4]=n;var r=n%60;t[3]=Math.floor(r);var n=n/60,i=n%60;t[2]=Math.floor(i);var n=n/60,s=n%24;t[1]=Math.floor(s);var n=n/24,o=n;return t[1]=Math.floor(o),t},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.getQueryString=function(e){var t=window.location.search.substring(1);if("undefined"==typeof e)return t;var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]===e)return unescape(i[1])}return!1},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e,t){function n(e,n,r){e=e||{};if(!t)throw new Error("JSUS not found.");this.db=[],this.tags={},this.nddb_pointer=0,this.__C={},this.__H={},this.__update={},this.__update.pointer=!1,this.__update.indexes=!1,this.__update.sort=!1,Object.defineProperty(this,"length",{set:function(){},get:function(){return this.db.length},configurable:!0}),this.__parent=r||undefined,this.init(e),this.import(n)}e.NDDB=n,n.log=console.log,n.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},n.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},n.prototype.init=function(e){this.__options=e,e.log&&(n.log=e.log),e.C&&(this.__C=e.C),e.H&&(this.__H=e.H),e.tags&&(this.tags=e.tags),e.nddb_pointer>0&&(this.nddb_pointer=e.nddb_pointer),e.update&&("undefined"!=typeof e.update.pointer&&(this.__update.pointer=e.update.pointer),"undefined"!=typeof e.update.indexes&&(this.__update.indexes=e.update.indexes),"undefined"!=typeof e.update.sort&&(this.__update.sort=e.update.sort))},n.prototype.globalCompare=function(e,t){return"undefined"==typeof e&&"undefined"==typeof t?0:"undefined"==typeof t?-1:"undefined"==typeof e?1:e.nddbid<t.nddbid?-1:e.nddbid>t.nddbid?1:0},n.prototype._masquerade=function(e,t){if("undefined"==typeof e)return!1;if("undefined"!=typeof e.nddbid)return e;var t=t||this.db;return Object.defineProperty(e,"nddbid",{value:t.length,configurable:!0,writable:!0}),e},n.prototype._masqueradeDB=function(e){if(!e)return[];var t=[];for(var n=0;n<e.length;n++)t[n]=this._masquerade(e[n],t);return t},n.prototype._autoUpdate=function(e){var n=t.merge(e||{},this.__update);n.pointer&&(this.nddb_pointer=this.db.length-1),n.sort&&this.sort(),n.indexes&&this.rebuildIndexes(),this.__parent&&this.__parent._autoUpdate(n)},n.prototype.import=function(e){if(!e)return[];this.db||(this.db=[]);for(var t=0;t<e.length;t++)this.insert(e[t])},n.prototype.insert=function(e){if("undefined"==typeof e||e===null)return;var e=this._masquerade(e);this.db.push(e),this.__update.indexes&&this.hashIt(e),this._autoUpdate({indexes:!1})},n.prototype.breed=function(e){e=e||this.db;var t=this.cloneSettings(),n=this.__parent||this;return new this.constructor(t,e,n)},n.prototype.cloneSettings=function(){var e=this.__options||{};return e.H=this.__H,e.C=this.__C,e.tags=this.tags,e.update=this.__update,t.clone(e)},n.prototype.toString=function(){var e="";for(var t=0;t<this.db.length;t++)e+=this.db[t]+"\n";return e},n.prototype.stringify=function(){var e=function(e){return t.isEmpty(e)?"{}":JSON.stringify(e)},r="[";return this.each(function(t){t=n.decycle(t),r+=e(t)+", "}),r=r.replace(/, $/,"]"),r},n.prototype.compare=n.prototype.c=function(e,t){return!e||!t?(n.log("Cannot set empty property or empty comparator","ERR"),!1):(this.__C[e]=t,!0)},n.prototype.comparator=function(e){return"undefined"!=typeof this.__C[e]?this.__C[e]:function(n,r){if("undefined"==typeof n&&"undefined"==typeof r)return 0;if("undefined"==typeof n)return 1;if("undefined"==typeof r)return-1;var i=t.getNestedValue(e,n),s=t.getNestedValue(e,r);return"undefined"==typeof i&&"undefined"==typeof s?0:"undefined"==typeof i?1:"undefined"==typeof s?-1:i>s?1:s>i?-1:0}},n.prototype.isReservedWord=function(e){return this[e]?!0:!1},n.prototype.hash=n.prototype.h=function(e,t){if("undefined"==typeof e)return n.log("Cannot hash empty dimension","ERR"),!1;t=t||Object.toString;if(this.isReservedWord(e)){var r="A reserved word have been selected as an index. ";return r+="Please select another one: "+e,n.log(r,"ERR"),!1}return this.__H[e]=t,this[e]={},!0},n.prototype.rebuildIndexes=function(){if(t.isEmpty(this.__H))return!1;for(var e in this.__H)this.__H.hasOwnProperty(e)&&(this[e]={});this.each(this.hashIt)},n.prototype.hashIt=function(e){if(!e)return!1;if(t.isEmpty(this.__H))return!1;var r=null,i=null,s=null;for(var o in this.__H)if(this.__H.hasOwnProperty(o)){r=this.__H[o],s=r(e);if("undefined"==typeof s)continue;this[o]||(this[o]={}),this[o][s]||(this[o][s]=new n),this[o][s].insert(e)}},n.prototype._analyzeQuery=function(e,r,i){var s=function(e,t,r){var i="(?)",s="Malformed query: "+e||i+" "+t||i+" "+r||i;return n.log(s,"WARN"),!1};"undefined"==typeof e&&s(e,r,i);if("undefined"!=typeof r){"undefined"==typeof i&&s(e,r,i);if(!t.in_array(r,[">",">=",">==","<","<=","<==","!=","!==","=","==","===","><","<>","in","!in"]))return n.log("Query error. Invalid operator detected: "+r,"WARN"),!1;r==="="&&(r="==");if(t.in_array(r,["><","<>","in","!in"])){i instanceof Array||(n.log("Range-queries need an array as third parameter","WARN"),s(e,r,i));if(r==="<>"||r==="><")i[0]=t.setNestedValue(e,i[0]),i[1]=t.setNestedValue(e,i[1])}else i=t.setNestedValue(e,i)}else"undefined"!=typeof i?s(e,r,i):(r="",i="");return{d:e,op:r,value:i}},n.prototype.select=function(e,r,i){var s=this._analyzeQuery(e,r,i);if(!s)return!1;var e=s.d,r=s.op,i=s.value,o=this.comparator(e),u=function(n){if("undefined"!=typeof t.getNestedValue(e,n))return n},a=function(s){try{if(t.eval(o(s,i)+r+0,s))return s}catch(u){return n.log("Malformed select query: "+e+r+i),!1}},f=function(e){if(o(e,i[0])>0&&o(e,i[1])<0)return e},l=function(e){if(o(e,i[0])<0&&o(e,i[1]>0))return e},c=function(n){if(t.in_array(t.getNestedValue(e,n),i))return n},h=function(n){if(!t.in_array(t.getNestedValue(e,n),i))return n};switch(r){case"":var p=u;break;case"<>":var p=l;break;case"><":var p=f;break;case"in":var p=c;break;case"!in":var p=h;break;default:var p=a}return this.filter(p)},n.prototype.limit=function(e){if(e===0)return this.breed();var t=e>0?this.db.slice(0,e):this.db.slice(e);return this.breed(t)},n.prototype.reverse=function(){return this.db.reverse(),this},n.prototype.sort=function(e){if(!e)var t=this.globalCompare;else if("function"==typeof e)var t=e;else if(e instanceof Array)var n=this,t=function(t,r){for(var i=0;i<e.length;i++){var s=n.comparator(e[i]).call(n,t,r);if(s!==0)return s}return s};else var t=this.comparator(e);return this.db.sort(t),this},n.prototype.shuffle=function(){return this.db=t.shuffle(this.db),!0},n.prototype.filter=function(e){return this.breed(this.db.filter(e))},n.prototype.each=n.prototype.forEach=function(){if(arguments.length===0)return;var e=arguments[0];for(var t=0;t<this.db.length;t++)arguments[0]=this.db[t],e.apply(this,arguments)},n.prototype.map=function(){if(arguments.length===0)return;var e=arguments[0],t=[],n=undefined;for(var r=0;r<this.db.length;r++)arguments[0]=this.db[r],n=e.apply(this,arguments),"undefined"!=typeof n&&t.push(n);return t},n.prototype.delete=function(){if(!this.length)return this;if(this.__parent){for(var e=0;e<this.db.length;e++){var t=this.db[e].nddbid-e;this.__parent.db.splice(t,1)}for(var e=0;e<this.__parent.length;e++)this.__parent.db[e].nddbid=e}return this.db=[],this._autoUpdate(),this},n.prototype.clear=function(e){return e?(this.db=[],this._autoUpdate()):n.log("Do you really want to clear the current dataset? Please use clear(true)","WARN"),e},n.prototype.join=function(e,n,r,i){return this._join(e,n,t.equals,r,i)},n.prototype.concat=function(e,t,n,r){return this._join(e,t,function(){return!0},n,r)},n.prototype._join=function(e,r,i,s,o){var i=i||t.equals,s="undefined"!=typeof s?s:"joined";if(o)var o=o instanceof Array?o:[o];var u=[],a=[];for(var f=0;f<this.db.length;f++)try{var l=t.eval("this."+e,this.db[f]);if("undefined"!=typeof l)for(var c=f+1;c<this.db.length;c++)try{var h=t.eval("this."+r,this.db[c]);if("undefined"!=typeof h&&i(l,h)){var p=t.clone(this.db[f]),d=o?t.subobj(this.db[c],o):this.db[c];p[s]=d,u.push(p)}}catch(v){n.log("Key not found in entry: "+r,"WARN")}}catch(v){n.log("Key not found in entry: "+e,"WARN")}return this.breed(u)},n.prototype._split=function(e,n){if("object"!=typeof e[n])return t.clone(e);var r=[],i=t.clone(e);i[n]={};var s=function(e){for(var o in e){var u=t.clone(i);e.hasOwnProperty(o)&&("object"==typeof e[o]?r=r.concat(s(e[o])):(u[n][o]=e[o],r.push(u)))}return r};return s(e[n])},n.prototype.split=function(e){var t=[];for(var n=0;n<this.db.length;n++)t=t.concat(this._split(this.db[n],e));return this.breed(t)},n.prototype._fetch=function(e,n){function r(e,n){return t.getNestedValue(n,e)}function i(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return t.obj2KeyedArray(r)}function s(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return n.split(".").concat(t.obj2KeyedArray(r))}switch(n){case"VALUES":var o=e?i:t.obj2Array;break;case"KEY_VALUES":var o=e?s:t.obj2KeyedArray;break;default:if(!e)return this.db;var o=r}var u=[];for(var a=0;a<this.db.length;a++){var f=o.call(this.db[a],this.db[a],e);"undefined"!=typeof f&&u.push(f)}return u},n.prototype.fetch=function(e){return this._fetch(e,!0)},n.prototype.fetchArray=function(e){return this._fetch(e,"VALUES")},n.prototype.fetchKeyArray=function(e){return this._fetch(e,"KEY_VALUES")},n.prototype.fetchValues=function(e){return this._fetch(e,"VALUES")},n.prototype.fetchKeyValues=function(e){return this._fetch(e,"KEY_VALUES")},n.prototype.groupBy=function(e){if(!e)return this.db;var n=[],r=[];for(var i=0;i<this.db.length;i++){var s=t.getNestedValue(e,this.db[i]);if("undefined"==typeof s)continue;if(!t.in_array(s,n)){n.push(s);var o=this.filter(function(n){if(t.equals(t.getNestedValue(e,n),s))return this});o.nddb_pointer=0,r.push(o)}}return r},n.prototype.count=function(e){if("undefined"==typeof e)return this.db.length;var n=0;for(var r=0;r<this.db.length;r++)try{var i=t.eval("this."+e,this.db[r]);"undefined"!=typeof i&&n++}catch(s){}return n},n.prototype.sum=function(e){var n=0;for(var r=0;r<this.db.length;r++)try{var i=t.getNestedValue(e,this.db[r]);isNaN(i)||(n+=i)}catch(s){}return n},n.prototype.mean=function(e){var n=0,r=0;for(var i=0;i<this.db.length;i++)try{var s=t.eval("this."+e,this.db[i]);isNaN(s)||(n+=s,r++)}catch(o){}return r===0?0:n/r},n.prototype.stddev=function(e){var n=this.mean(e);if(isNaN(n))return!1;var r=0;return this.each(function(i){try{var s=t.eval("this."+e,i);isNaN(s)||(r+=Math.pow(s-n,2))}catch(i){}}),r!==0?Math.sqrt(r):0},n.prototype.min=function(e){var n=!1;for(var r=0;r<this.db.length;r++)try{var i=t.eval("this."+e,this.db[r]);!isNaN(i)&&(i<n||n===!1)&&(n=i)}catch(s){}return n},n.prototype.max=function(e){var n=!1;for(var r=0;r<this.db.length;r++)try{var i=t.eval("this."+e,this.db[r]);!isNaN(i)&&(i>n||n===!1)&&(n=i)}catch(s){}return n},n.prototype.diff=function(e){if(!e)return this;if("object"==typeof e)if(e instanceof n||e instanceof this.constructor)var e=e.db;if(e.length===0)return this;var t=this;return this.filter(function(n){for(var r=0;r<e.length;r++)if(t.globalCompare(n,e[r])===0)return!1;return n})},n.prototype.intersect=function(e){if(!e)return this;if("object"==typeof e)if(e instanceof n||e instanceof this.constructor)var e=e.db;var t=this;return this.filter(function(n){for(var r=0;r<e.length;r++)if(t.globalCompare(n,e[r])===0)return n})},n.prototype.get=function(e){var e=e||this.nddb_pointer;return e<0||e>this.db.length-1?!1:this.db[e]},n.prototype.next=function(){var e=n.prototype.get.call(this,++this.nddb_pointer);return e||this.nddb_pointer--,e},n.prototype.previous=function(){var e=n.prototype.get.call(this,--this.nddb_pointer);return e||this.nddb_pointer++,e},n.prototype.first=function(e){var t=this.fetch(e);return t.length>0?(this.nddb_pointer=t[0].nddbid,t[0]):undefined},n.prototype.last=function(e){var t=this.fetch(e);return t.length>0?(this.nddb_pointer=t[t.length-1].nddbid,t[t.length-1]):undefined},n.prototype.tag=function(e,t){if("undefined"==typeof e){n.log("Cannot register empty tag.","ERR");return}var t=t||this.nddb_pointer;this.tags[e]=t},n.prototype.resolveTag=function(e){return"undefined"==typeof e?!1:this.tags[e]};if("object"==typeof module&&"function"==typeof require){require("./external/cycle.js");var r=require("fs");n.prototype.save=function(e,t){if(!e)return n.log("You must specify a valid file.","ERR"),!1;r.writeFile(e,this.stringify(),"utf-8",function(e){if(e)throw e;t&&t()})},n.prototype.load=function(e,t,i){if(!e)return n.log("You must specify a valid file.","ERR"),!1;t="undefined"!=typeof t?t:!0;var s=function(e){var t=JSON.parse(e.toString()),r;for(r=0;r<t.length;r++)t[r]=n.retrocycle(t[r]);this.import(t)};if(t){var o=r.readFileSync(e,"utf-8");s.call(this,o)}else r.readFile(e,"utf-8",function(e,t){if(e)throw e;s.call(this,t),i&&i()})}}}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window,"undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS||require("JSUS").JSUS),function(e){e.version="0.7.5",e.verbosity=0,e.verbosity_levels={ALWAYS:-(Number.MIN_VALUE+1),ERR:-1,WARN:0,INFO:1,DEBUG:100},e.log=function(t,n,r){if("undefined"==typeof t)return!1;n=n||0,r="undefined"==typeof r?"nodeGame: ":r,"string"==typeof n&&(n=e.verbosity_levels[n]),e.verbosity>n&&console.log(r+t)},e.game={},e.gsc={},e.session={},e.player={},e.memory={},"undefined"!=typeof JSUS&&(e.JSUS=JSUS),"undefined"!=typeof NDDB&&(e.NDDB=NDDB),"undefined"!=typeof store&&(e.store=store),"object"==typeof module&&"function"==typeof require&&(require("./init.node.js"),require("./nodeGame.js"))}("object"==typeof module?module.exports:window.node={}),function(e,t){function r(){this._listeners={},this._localListeners={},this.history=new n({update:{indexes:!0}}),this.history.h("state",function(e){if(!e)return;var n="object"==typeof e.state?e.state:t.game.state;return t.GameState.toHash(n,"S.s.r")}),this.store=!0}function i(e){var e=e||{};this.event=e.event,this.listener=e.listener,this.priority=e.priority||0,this.state=e.state||t.state||undefined,this.ttl="undefined"!=typeof e.ttl?e.ttl:-1,this.target=e.target||undefined}var n=t.NDDB;e.EventEmitter=r,r.prototype={constructor:r,addListener:function(e,n){if(!e||!n)return;"undefined"==typeof this._listeners[e]&&(this._listeners[e]=[]),t.log("Added Listener: "+e+" "+n,"DEBUG"),this._listeners[e].push(n)},addLocalListener:function(e,n){if(!e||!n)return;"undefined"==typeof this._localListeners[e]&&(this._localListeners[e]=[]),t.log("Added Local Listener: "+e+" "+n,"DEBUG"),this._localListeners[e].push(n)},emit:function(e,n,r,i){if(!e)return;"string"==typeof e&&(e={type:e}),e.target||(e.target=this);if(!e.type)throw new Error("Event object missing 'type' property.");if(this.store){var s={event:e.type,state:t.state,p1:n,p2:r,p3:i};this.history.insert(s)}if(this._listeners[e.type]instanceof Array){var o=this._listeners[e.type];for(var u=0,a=o.length;u<a;u++)o[u].call(this.game,n,r,i)}if(this._localListeners[e.type]instanceof Array){var o=this._localListeners[e.type];for(var u=0,a=o.length;u<a;u++)o[u].call(this.game,n,r,i)}},removeListener:function(e,n){function r(e,n,r){if(r[e]instanceof Array){if(!n)return delete r[e],!0;var i=r[e],s=i.length;for(var o=0;o<s;o++)if(i[o]==n)return i.splice(o,1),t.log("Removed listener "+e+" "+n,"DEBUG"),!0}return!1}var i=r(e,n,this._listeners),s=r(e,n,this._localListeners);return i||s},clearState:function(e){return this.clearLocalListeners(),!0},clearLocalListeners:function(){t.log("Cleaning Local Listeners","DEBUG");for(var e in this._localListeners)this._localListeners.hasOwnProperty(e)&&this.removeListener(e,this._localListeners[e]);this._localListeners={}},printAllListeners:function(){t.log("nodeGame:	PRINTING ALL LISTENERS","DEBUG");for(var e in this._listeners)this._listeners.hasOwnProperty(e)&&console.log(e+" "+e.length);for(var e in this._localListeners)this._listeners.hasOwnProperty(e)&&console.log(e+" "+e.length)}}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){this.state=0,this.step=0,this.round=0,this.is=r.iss.UNKNOWN,this.paused=!1;if("string"==typeof e){var t=e.split(".");this.state="undefined"!=typeof t[0]?Number(t[0]):undefined,this.step="undefined"!=typeof t[1]?Number(t[1]):undefined,this.round="undefined"!=typeof t[2]?Number(t[2]):undefined,this.is="undefined"!=typeof t[3]?Number(t[3]):r.iss.UNKNOWN,this.paused=t[4]==="1"?!0:!1}else"object"==typeof e&&(this.state=e.state,this.step=e.step,this.round=e.round,this.is=e.is?e.is:r.iss.UNKNOWN,this.paused=e.paused?e.paused:!1)}var n=t.JSUS;e.GameState=r,r.iss={},r.iss.UNKNOWN=0,r.iss.LOADING=10,r.iss.LOADED=25,r.iss.PLAYING=50,r.iss.DONE=100,r.defaults={},r.defaults.hash="S.s.r.i.p",r.prototype.toString=function(){var e=this.toHash("(r) S.s");return this.paused&&(e+=" [P]"),e},r.prototype.toHash=function(e){return r.toHash(this,e)},r.toHash=function(e,t){if(!e||"object"!=typeof e)return!1;if(!t||!t.length)return e.toString();var n="",r="Ssrip",i=["state","step","round","is","paused"];for(var s=0;s<t.length;s++){var o=r.indexOf(t[s]);n+=o<0?t[s]:Number(e[i[o]])}return n},r.compare=function(e,t,n){if(!e&&!t)return 0;if(!t)return 1;if(!e)return-1;n=n||!1,"string"==typeof e&&(e=new r(e)),"string"==typeof t&&(t=new r(t));var i=e.state-t.state;return i===0&&"undefined"!=typeof e.round&&(i=e.round-t.round,i===0&&"undefined"!=typeof e.step&&(i=e.step-t.step,n&&i===0&&"undefined"!=typeof e.is&&(i=e.is-t.is))),i},r.stringify=function(e){if(!e)return;var t=(new r(e)).toHash("(r) S.s_i");return e.paused&&(t+=" [P]"),t}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e,n,i){e=e||{},e.log||(e.log=t.log),r.call(this,e,n,i),this.globalCompare=function(e,n){return e.id===n.id?0:e.count<n.count?1:e.count>n.count?-1:(t.log("Two players with different id have the same count number","WARN"),0)}}function o(e){e=e||{};var t=e.sid;Object.defineProperty(this,"sid",{value:t,enumerable:!0});var n=e.id||t;Object.defineProperty(this,"id",{value:n,enumerable:!0});var r=e.count;Object.defineProperty(this,"count",{value:r,enumerable:!0}),this.ip=e.ip,this.name=e.name,this.state=e.state||new i;for(var s in e)e.hasOwnProperty(s)&&"function"!=typeof e[s]&&(this.hasOwnProperty(s)||(this[s]=e[s]))}var n=t.JSUS,r=t.NDDB,i=t.GameState;e.PlayerList=s,s.prototype=n.clone(r.prototype),s.prototype.constructor=s,s.array2Groups=function(e){if(!e)return;for(var t=0;t<e.length;t++)e[t]=new s({},e[t]);return e},s.prototype.add=function(e){return!e||!e.sid||!e.id?(t.log("Only instance of Player objects can be added to a PlayerList","ERR"),!1):this.exist(e.id)?(t.log("Attempt to add a new player already in the player list: "+e.id,"ERR"),!1):(this.insert(e),e.count=e.nddbid,!0)},s.prototype.remove=function(e){if(!e)return!1;var n=this.select("id","=",e);return n.length?(n.remove(),!0):(t.log("Attempt to remove a non-existing player from the the player list. id: "+e,"ERR"),!1)},s.prototype.get=function(e){if(!e)return!1;var n=this.select("id","=",e);return n.count()>0?n.count()>1?(t.log("More than one player found with id: "+e,"WARN"),n.fetch()):n.first():(t.log("Attempt to access a non-existing player from the the player list. id: "+e,"ERR"),!1)},s.prototype.pop=function(e){if(!e)return!1;var t=this.get(e);return"object"==typeof t?(this.remove(e),t):!1},s.prototype.getAllIDs=function(){return this.map(function(e){return e.id})},s.prototype.updatePlayerState=function(e,n){return this.exist(e)?"undefined"==typeof n?(t.log("Attempt to assign to a player an undefined state","WARN"),!1):(this.select("id","=",e).first().state=n,!0):(t.log("Attempt to access a non-existing player from the the player list "+player.id,"WARN"),!1)},s.prototype.exist=function(e){return this.select("id","=",e).count()>0?!0:!1},s.prototype.isStateDone=function(e,n){e=e||t.state,n=n||!1;var r=this.map(function(t){var n=new i(t.state);return t.state.is!==i.iss.DONE?0:i.compare(e,t.state,!1)!==0?0:1}),s,o=0;for(s=0;s<r.length;s++)o+=Number(r[s]);var u=n?this.length:this.actives();return o===u?!0:!1},s.prototype.actives=function(){var e=0,t;return this.each(function(n){t=new i(n.state),i.compare(t,new i)!==0&&e++}),e},s.prototype.checkState=function(e,n){this.isStateDone(e,n)&&t.emit("STATEDONE")},s.prototype.toString=function(e){var t="",n=e||"\n";return this.forEach(function(e){t+=e.id+": "+e.name;var r=new i(e.state);t+=": "+r+n}),t},s.prototype.getNGroups=function(e){if(!e)return;var t=n.getNGroups(this.db,e);return s.array2Groups(t)},s.prototype.getGroupsSizeN=function(e){if(!e)return;var t=n.getGroupsSizeN(this.db,e);return s.array2Groups(t)},s.prototype.getRandom=function(e){return e||(e=1),e<1?(t.log("N must be an integer >= 1","ERR"),!1):(this.shuffle(),e==1?this.first():this.limit(e).fetch())},e.Player=o,o.prototype.toString=function(){return this.name+" ("+this.id+") "+new i(this.state)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function i(e){e=e||{};var t=e.id||Math.floor(Math.random()*1e6);Object.defineProperty(this,"id",{value:t,enumerable:!0});var n=e.session;Object.defineProperty(this,"session",{value:n,enumerable:!0}),this.state=e.state,this.action=e.action,this.target=e.target,this.from=e.from,this.to=e.to,this.text=e.text,this.data=e.data,this.priority=e.priority,this.reliable=e.reliable,this.created=r.getDate(),this.forward=0}var n=t.GameState,r=t.JSUS;e.GameMsg=i,i.actions={},i.actions.SET="set",i.actions.GET="get",i.actions.SAY="say",i.targets={},i.targets.HI="HI",i.targets.HI_AGAIN="HI_AGAIN",i.targets.STATE="STATE",i.targets.PLIST="PLIST",i.targets.TXT="TXT",i.targets.DATA="DATA",i.targets.ACK="ACK",i.targets.WARN="WARN",i.targets.ERR="ERR",i.IN="in.",i.OUT="out.",i.clone=function(e){return new i(e)},i.prototype.stringify=function(){return JSON.stringify(this)},i.prototype.toString=function(){var e=",	",t="\n",r='"',i=new n(this.state),s=this.created+e;return s+=this.id+e,s+=this.session+e,s+=this.action+e,s+=this.target+e,s+=this.from+e,s+=this.to+e,s+=r+this.text+r+e,s+=r+this.data+r+e,s+=this.reliable+e,s+=this.priority+t,s},i.prototype.toSMS=function(){var e=/\w+/,t=e.exec(this.created),n="["+this.from+"]->["+this.to+"]	";return n+="|"+this.action+"."+this.target+"|"+"	",n+=" "+this.text+" ",n},i.prototype.toInEvent=function(){return"in."+this.toEvent()},i.prototype.toOutEvent=function(){return"out."+this.toEvent()},i.prototype.toEvent=function(){return this.action+"."+this.target}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e){this.loop=e||{};for(var t in this.loop)if(this.loop.hasOwnProperty(t)){var e=this.loop[t].state;if("function"==typeof e){var s=r.clone(this.loop[t]);this.loop[t].state={1:s}}var o=r.size(this.loop[t].state),u=this.loop[t].rounds||1;i.push({rounds:u,steps:o})}Object.defineProperty(this,"length",{set:function(){},get:function(){return that.steps2Go(new n)},configurable:!0})}var n=t.GameState,r=t.JSUS;e.GameLoop=s;var i=[];s.prototype.exist=function(e){return e?typeof this.loop[e.state]=="undefined"?(t.log("Unexisting state: "+e.state,"WARN"),!1):typeof this.loop[e.state]["state"][e.step]=="undefined"?(t.log("Unexisting step: "+e.step,"WARN"),!1):e.round>i[e.state-1].rounds?(t.log("Unexisting round: "+e.round+"Max round: "+i[e.state].rounds,"WARN"),!1):!0:!1},s.prototype.next=function(e){e=e||t.state;if(e.state===0)return new n({state:1,step:1,round:1});if(!this.exist(e))return t.log("No next state of non-existing state: "+e,"WARN"),!1;var r=Number(e.state)-1;if(i[r].steps>e.step){var s=Number(e.step)+1;return new n({state:e.state,step:s,round:e.round})}if(i[r].rounds>e.round){var o=Number(e.round)+1;return new n({state:e.state,step:1,round:o})}if(i.length>e.state){var u=Number(e.state)+1;return new n({state:u,step:1,round:1})}return!1},s.prototype.previous=function(e){e=e||t.state,this.exist(e)||t.log("No previous state of non-existing state: "+e,"WARN");var r=Number(e.state)-1;if(e.step>1){var s=Number(e.step)-1;return new n({state:e.state,step:s,round:e.round})}if(e.round>1){var o=Number(e.round)-1,s=i[r].steps;return new n({state:e.state,step:s,round:o})}if(e.state>1){var o=i[r-1].rounds,s=i[r-1].steps,u=r;return new n({state:u,step:s,round:o})}return!1},s.prototype.getName=function(e){return e=e||t.state,this.exist(e)?this.loop[e.state].state[e.step].name:!1},s.prototype.getFunction=function(e){return e=e||t.state,this.exist(e)?this.loop[e.state].state[e.step].state:!1},s.prototype.getAllParams=function(e){return e=e||t.state,this.exist(e)?this.loop[e.state].state[e.step]:!1},s.prototype.jumpTo=function(e,t){if(!this.exist(e))return!1;if(t||t===0)return e;var n=t>0?this.next:this.previous;for(var r=0;r<Math.abs(t);r++){e=n.call(this,e);if(!e)return!1}return e},s.prototype.steps2Go=function(e){e=e||t.state;var n=0;while(e)n++,e=this.next(e);return n},s.prototype.toArray=function(){var e=new n,t=[];while(e){t.push(e.toString());var e=this.next(e)}return t},s.prototype.indexOf=function(e){return e?this.diff(e,new n):-1},s.prototype.diff=function(e,r){if(!e)return!1;if(!r){if(!t.state)return!1;r=t.state}var i=0;while(r){if(n.compare(e,r)===0)return i;r=this.next(r),i++}return-1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function o(){}var n=t.GameMsg,r=t.GameState,i=t.Player,s=t.JSUS;e.GameMsgGenerator=o,o.create=function(e){var r={session:t.gsc.session,state:t.state,action:n.actions.SAY,target:n.targets.DATA,from:t.player.sid,to:"SERVER",text:null,data:null,priority:null,reliable:1};return e=s.merge(r,e),new n(e)},o.createHI=function(e,r,s){return e=e||t.player,e?(s=s||1,new n({session:t.gsc.session,state:t.state,action:n.actions.SAY,target:n.targets.HI,from:t.player.sid,to:r,text:new i(e)+" ready.",data:e,priority:null,reliable:s})):!1},o.saySTATE=function(e,t,r){return this.createSTATE(n.SAY,e,t,r)},o.setSTATE=function(e,t,r){return this.createSTATE(n.SET,e,t,r)},o.getSTATE=function(e,t,r){return this.createSTATE(n.GET,e,t,r)},o.createSTATE=function(e,i,s,o){return!e||!i?!1:(s=s||"SERVER",o=o||1,new n({session:t.gsc.session,state:t.state,action:e,target:n.targets.STATE,from:t.player.sid,to:s,text:"New State: "+r.stringify(i),data:i,priority:null,reliable:o}))},o.sayPLIST=function(e,t,r){return this.createPLIST(n.actions.SAY,e,t,r)},o.setPLIST=function(e,t,r){return this.createPLIST(n.actions.SET,e,t,r)},o.getPLIST=function(e,t,r){return this.createPLIST(n.actions.GET,e,t,r)},o.createPLIST=function(e,r,i,s){return r=r||!t.game||t.game.pl,!e||!r?!1:(i=i||"SERVER",s=s||1,new n({session:t.gsc.session,state:t.state,action:e,target:n.targets.PLIST,from:t.player.sid,to:i,text:"List of Players: "+r.length,data:r.pl,priority:null,reliable:s}))},o.createTXT=function(e,r,i){return e?(i=i||0,new n({session:t.gsc.session,state:t.state,action:n.actions.SAY,target:n.targets.TXT,from:t.player.sid,to:r,text:e,data:null,priority:null,reliable:i})):!1},o.sayDATA=function(e,t,r,i){return this.createDATA(n.actions.SAY,e,t,r,i)},o.setDATA=function(e,t,r,i){return this.createDATA(n.actions.SET,e,t,r,i)},o.getDATA=function(e,t,r,i){return this.createDATA(n.actions.GET,e,t,r,i)},o.createDATA=function(e,r,i,s,o){return e?(o=o||1,s=s||"data msg",new n({session:t.gsc.session,state:t.state,action:e,target:n.targets.DATA,from:t.player.sid,to:i,text:s,data:r,priority:null,reliable:o})):!1},o.createACK=function(e,r,i){if(!e)return!1;i=i||0;var s=new n({session:t.gsc.session,state:t.state,action:n.actions.SAY,target:n.targets.ACK,from:t.player.sid,to:r,text:"Msg "+e.id+" correctly received",data:e.id,priority:null,reliable:i});return e.forward&&(s.forward=1),s}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function f(e){e=e||{},u=[],Object.defineProperty(this,"buffer",{value:u,enumerable:!0}),a=null,Object.defineProperty(this,"session",{value:a,enumerable:!0}),this.io=null,this.url=null,this.servername=null}var r=t.GameMsg,i=t.GameState,s=t.Player,o=t.GameMsgGenerator,u,a;e.GameSocketClient=f,f.prototype.getSession=function(e){if(!e)return!1;var n=!1;return"function"==typeof t.session&&(n=t.session(e.session)),n?n:!1},f.prototype.startSession=function(e){var t={id:e.data,sid:e.data};return this.createPlayer(t),a=e.session,!0},f.prototype.restoreSession=function(e,n){if(!e)return;var r="nodeGame session recovery: ";t.log("Starting session recovery "+n,"INFO",r),t.emit("NODEGAME_RECOVERY",n),n=n||e.player.sid,this.session=e.id,a.player.sid=n,this.createPlayer(a.player),t.game.memory=a.memory,t.goto(a.state);if(!e.history)return t.log("No event history was found to recover","WARN",r),!0;t.log("Recovering "+a.history.length+" events","DEBUG",r),t.events.history.import(a.history);var s=(new i(a.state)).toHash("S.s.r");if(!t.events.history.state)return t.log("No old events to re-emit were found during session recovery","DEBUG",r),!0;if(!t.events.history.state[s])return t.log("The current state "+s+" has no events to re-emit","DEBUG",r),!0;var o=["LOG","STATECHANGE","WINDOW_LOADED","BEFORE_LOADING","LOADED","in.say.STATE","UPDATED_PLIST","NODEGAME_READY","out.say.STATE","out.set.STATE","in.say.PLIST","STATEDONE","out.say.HI"],u=t.events.history.state[s];u.select("event","in",o).remove();if(!u.length)return t.log("The current state "+s+" has no valid events to re-emit","DEBUG",r),!0;var f=function(){t.log("Re-emitting "+u.length+" events","DEBUG",r),u.each(function(e){JSUS.in_array(e.event,o)||t.emit(e.event,e.p1,e.p2,e.p3)})};return t.game.ready?f.call(t.game):t.on("LOADED",function(){f.call(t.game)}),!0},f.prototype.createPlayer=function(e){e=new s(e);if(t.conf&&t.conf.player){var n=t.conf.player;for(var r in n)if(n.hasOwnProperty(r)){if(JSUS.in_array(r,["id","sid","ip"]))continue;Object.defineProperty(e,r,{value:n[r],enumerable:!0})}}return Object.defineProperty(t,"player",{value:e,enumerable:!0}),e},f.prototype.connect=function(e){return e=e||{},e.url?(this.url=e.url,t.log("connecting to "+e.url),this.io=n.connect(e.url,e.io),this.attachFirstListeners(this.io),this.io):(t.log("cannot connect to empty url.","ERR"),!1)};var l=function(e,n){e=e||"Generic error while parsing a game message";var r=n?e+": "+n:e;return t.log(r,"ERR"),t.emit("LOG","E: "+r),!1};f.prototype.secureParse=function(e){var t;try{t=r.clone(JSON.parse(e))}catch(n){return l("Malformed msg received",n)}return this.session&&t.session!==this.session?l("Local session id does not match incoming message session id"):t},f.prototype.clearBuffer=function(){var e=u.length;for(var n=0;n<e;n++){var r=this.buffer.shift();t.emit(r.toInEvent(),r),t.log("Debuffered "+r,"DEBUG")}},f.prototype.attachFirstListeners=function(e){var n=this;e.on("connect",function(i){var s="nodeGame: connection open";t.log(s),e.on("message",function(i){var i=n.secureParse(i);if(i&&i.target==="HI"){n.servername=i.from,n.serverid=i.from;var s=n.getSession(i);if(s){n.restoreSession(s,e.id),n.attachMsgListeners(e,i.session);var i=t.msg.create({action:r.actions.SAY,target:"HI_AGAIN",data:t.player});n.send(i)}else n.startSession(i),n.attachMsgListeners(e,i.session),n.sendHI(t.player,"ALL");t.emit("out.say.HI")}})}),e.on("disconnect",function(){t.session.store(),t.log("closed")})},f.prototype.attachMsgListeners=function(e,n){var r=this;t.log("Attaching FULL listeners"),e.removeAllListeners("message"),e.on("message",function(e){var e=r.secureParse(e);e&&(t.game&&t.game.ready?t.emit(e.toInEvent(),e):(t.log("Buffering: "+e,"DEBUG"),u.push(e)))}),t.emit("NODEGAME_READY")},f.prototype.sendHI=function(e,n){e=e||t.player,n=n||"SERVER";var r=t.msg.createHI(e,n);this.send(r)},f.prototype.sendSTATE=function(e,n,r){var i=t.msg.createSTATE(e,n,r);this.send(i)},f.prototype.sendTXT=function(e,n){var r=t.msg.createTXT(e,n);this.send(r)},f.prototype.sendDATA=function(e,n,i,s){e=e||r.say,i=i||"SERVER",s=s||"DATA";var o=t.msg.createDATA(e,n,i,s);this.send(o)},f.prototype.send=function(e){this.io.send(e.stringify()),t.log("S: "+e),t.emit("LOG","S: "+e.toSMS())}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:module.parent.exports.io),function(e,t){function s(e,t,n){e=e||{},e.update||(e.update={}),e.update.indexes=!0,r.call(this,e,t,n),this.c("state",o.compareState),this.player||this.h("player",function(e){return e.player}),this.state||this.h("state",function(e){return i.toHash(e.state,"S.s.r")}),this.key||this.h("key",function(e){return e.key})}function o(e){this.state=e.state,this.player=e.player,this.key=e.key,this.value=e.value,this.time=Date?Date.now():null}var n=t.JSUS,r=t.NDDB,i=t.GameState;s.prototype=n.clone(r.prototype),s.prototype.constructor=s,e.GameDB=s,e.GameBit=o,s.prototype.add=function(e,n,r,i){return e?(i=i||t.game.gameState,r=r||t.player,this.insert(new o({player:r,key:e,value:n,state:i})),!0):!1},o.prototype.toString=function(){return this.player+", "+i.stringify(this.state)+", "+this.key+", "+this.value},o.equals=function(e,t,n){return!e||!t?!1:(n=n||!1,o.comparePlayer(e,t)!==0?!1:o.compareState(e,t)!==0?!1:o.compareKey(e,t)!==0?!1:n&&e.value&&o.compareValue(e,t)!==0?!1:!0)},o.comparePlayer=function(e,t){return!e&&!t?0:e?t?e.player===t.player?0:e.player>t.player?1:-1:-1:1},o.compareState=function(e,t){return i.compare(e.state,t.state)},o.compareKey=function(e,t){return!e&&!t?0:e?t?e.key===t.key?0:e.key<t.key?-1:1:-1:1},o.compareValue=function(e,t){return!e&&!t?0:e?t?n.equals(e.value,t.value)?0:e.value>t.value?1:-1:-1:1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function h(e){e=e||{},a=e.name||"A nodeGame game",Object.defineProperty(this,"name",{value:a,enumerable:!0}),f=e.description||"No Description",Object.defineProperty(this,"description",{value:f,enumerable:!0}),l=new o(e.loops),Object.defineProperty(this,"gameLoop",{value:l,enumerable:!0}),c=new s,Object.defineProperty(this,"pl",{value:c,enumerable:!0,configurable:!0,writable:!0}),Object.defineProperty(this,"ready",{set:function(){},get:function(){return this.gameState.is<n.iss.LOADED?!1:t.window?t.window.state>=n.iss.LOADED?!0:!1:!0},enumerable:!0}),this.observer="undefined"!=typeof e.observer?e.observer:!1,this.auto_step="undefined"!=typeof e.auto_step?e.auto_step:!0,this.auto_wait="undefined"!=typeof e.auto_wait?e.auto_wait:!1,this.minPlayers=e.minPlayers||1,this.maxPlayers=e.maxPlayers||1e3,this.init=e.init||this.init,this.memory=new i,this.player=null,this.state=this.gameState=new n;var u=this,h=r.actions.SAY+".",p=r.actions.SET+".",d=r.actions.GET+".",v=r.IN,m=r.OUT,g=function(){t.on(v+d+"DATA",function(e){e.text==="LOOP"&&t.gsc.sendDATA(r.actions.SAY,this.gameLoop,e.from,"GAME")}),t.on(v+p+"STATE",function(e){u.memory.add(e.text,e.data,e.from)}),t.on(v+p+"DATA",function(e){u.memory.add(e.text,e.data,e.from)}),t.on(v+h+"STATE",function(e){console.log("updateState: "+e.from+" -- "+new n(e.data),"DEBUG"),console.log(u.pl.length),console.log(t.gsc.serverid+"AAAAAA"),t.gsc.serverid&&e.from===t.gsc.serverid&&(console.log(t.gsc.serverid+" ---><--- "+e.from),console.log("NOT EXISTS")),u.pl.exist(e.from)?(console.log("EXIST"),u.pl.updatePlayerState(e.from,e.data),t.emit("UPDATED_PLIST"),u.pl.checkState()):(console.log("NOT EXISTS"),u.updateState(e.data))}),t.on(v+h+"PLIST",function(e){if(!e.data)return;u.pl=new s({},e.data),t.emit("UPDATED_PLIST"),u.pl.checkState()})}(),y=function(){t.on(m+h+"HI",function(){u.auto_step?u.updateState(u.next()):(u.gameState.is=n.iss.LOADED,t.gsc.sendSTATE(r.actions.SAY,u.gameState))}),t.on(m+h+"STATE",function(e,n){t.gsc.sendSTATE(r.actions.SAY,e,n)}),t.on(m+h+"TXT",function(e,n){t.gsc.sendTXT(e,n)}),t.on(m+h+"DATA",function(e,n,i){t.gsc.sendDATA(r.actions.SAY,e,n,i)}),t.on(m+p+"STATE",function(e,n){t.gsc.sendSTATE(r.actions.SET,e,n)}),t.on(m+p+"DATA",function(e,n,i){t.gsc.sendDATA(r.actions.SET,e,n,i)}),t.on(m+d+"DATA",function(e,n,i){t.gsc.sendDATA(r.actions.GET,e,n,e)})}(),b=function(){t.on("STATEDONE",function(){if(u.auto_step&&!u.observer){t.log("We play AUTO","DEBUG");var e="undefined"!==u.minPlayers?u.minPlayers-u.pl.length:0;t.log("Additional player required: "+e>0?MorePlayers:0,"DEBUG"),e>0?(t.emit("OUT.say.TXT",e+" player/s still needed to play the game"),t.log(e+" player/s still needed to play the game")):(t.emit("OUT.say.TXT",this.minPlayers+" players ready. Game can proceed"),t.log(c.length+" players ready. Game can proceed"),u.updateState(u.next()))}else t.log("Waiting for monitor to step","DEBUG")}),t.on("DONE",function(e,r,i){var s=!0,o=u.gameLoop.getAllParams(u.gameState).done;o&&(s=o.call(u,e,r,i));if(!s)return;u.gameState.is=n.iss.DONE,t.emit("BEFORE_DONE"),u.auto_wait&&t.window&&t.emit("WAITING..."),u.publishState()}),t.on("PAUSE",function(e){u.gameState.paused=!0,u.publishState()}),t.on("WINDOW_LOADED",function(){u.ready&&t.emit("LOADED")}),t.on("GAME_LOADED",function(){u.ready&&t.emit("LOADED")}),t.on("LOADED",function(){t.emit("BEFORE_LOADING"),u.gameState.is=n.iss.PLAYING,t.gsc.clearBuffer()})}()}var n=t.GameState,r=t.GameMsg,i=t.GameDB,s=t.PlayerList,o=t.GameLoop,u=t.JSUS;e.Game=h;var a,f,l,c;h.prototype.pause=function(){this.gameState.paused=!0},h.prototype.resume=function(){this.gameState.paused=!1},h.prototype.next=function(e){return e?this.gameLoop.jumpTo(this.gameState,Math.abs(e)):this.gameLoop.next(this.gameState)},h.prototype.previous=function(e){return e?this.gameLoop.jumpTo(this.gameState,-Math.abs(e)):this.gameLoop.previous(this.gameState)},h.prototype.jumpTo=function(e){if(!e)return!1;var t=this.gameLoop.jumpTo(this.gameState,e);return t?this.updateState(t):!1},h.prototype.publishState=function(){if(!this.observer){var e=r.OUT+r.actions.SAY+".STATE";t.emit(e,this.gameState,"ALL")}t.emit("STATECHANGE"),t.log("New State = "+new n(this.gameState),"DEBUG")},h.prototype.updateState=function(e){t.log("New state is going to be "+new n(e),"DEBUG"),this.step(e)!==!1?(this.paused=!1,this.gameState.is=n.iss.LOADED,this.ready&&t.emit("LOADED")):(t.log("Error in stepping","ERR"),t.emit("TXT","State was not updated"))},h.prototype.step=function(e){e=e||this.next();if(e){var r=this.gameLoop.getFunction(e);if(r)return t._ee.clearState(this.gameState),e.is=n.iss.LOADING,this.gameState=e,this.publishState(),r.call(t.game)}return!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.EventEmitter,n=e.GameSocketClient,r=e.GameState,i=e.GameMsg,s=e.Game,o=e.Player,u=e.GameSession;e.actions=i.actions,e.IN=i.IN,e.OUT=i.OUT,e.targets=i.targets,e.states=r.iss;var a=e.events=e._ee=new t;e.msg=e.GameMsgGenerator,e.gsc=new n,e.game=null,e.player=null,Object.defineProperty(e,"state",{get:function(){return e.game?e.game.gameState:!1},configurable:!1,enumerable:!0}),e._analyzeConf=function(t){if(!t)return e.log("Invalid configuration object found.","ERR"),!1;if(!t.host){if("undefined"!=typeof window){if("undefined"!=typeof window.location)var n=window.location.href}else var n=t.url;if(n){var r=n.split("/").slice(0,-2);r.length>1&&(t.host=r.join("/"))}}return t.host.lastIndexOf("/")!==n.length&&(t.host=t.host+"/"),"undefined"!=typeof t.verbosity&&(e.verbosity=t.verbosity),this.conf=t,t},e.on=function(t,n){!e.state||r.compare(e.state,new r,!0)===0?a.addListener(t,n):a.addLocalListener(t,n)},e.once=function(t,n){e.on(t,n),e.on(t,function(e,t){a.removeListener(e,t)})},e.removeListener=function(e,t){return a.removeListener(e,t)},e.play=function(t,n){e._analyzeConf(t),e.game=new s(n),e.emit("NODEGAME_GAME_CREATED"),e.game.init.call(e.game),e.gsc.connect(t),e.log("game loaded..."),e.log("ready.")},e.emit=function(e,t,n,r){a.emit(e,t,n,r)},e.say=function(e,t,n){a.emit("out.say.DATA",e,n,t)},e.set=function(e,t){a.emit("out.set.DATA",t,null,e)},e.get=function(t,n){a.emit("out.get.DATA",t);var r=function(i){i.text===t&&(n.call(e.game,i.data),a.removeListener("in.say.DATA",r))};e.on("in.say.DATA",r)},e.replay=function(t){t&&e.game.memory.clear(!0),e.goto(new r({state:1,step:1,round:1}))},e.goto=function(t){e.game.updateState(t)},e.onTXT=function(t){e.on("in.say.TXT",function(n){t.call(e.game,n)})},e.onDATA=function(t,n){e.on("in.say.DATA",function(r){t&&r.text===t&&n.call(e.game,r)}),e.on("in.set.DATA",function(t){n.call(e.game,t)})},e.onSTATE=function(t){e.on("in.set.STATE",function(n){t.call(e.game,n)})},e.onPLIST=function(t){e.on("in.set.PLIST",function(n){t.call(e.game,n)}),e.on("in.say.PLIST",function(n){t.call(e.game,n)})},e.DONE=function(t){e.emit("DONE",t)},e.TXT=function(t,n){e.emit("out.say.TXT",t,n)},e.random={},e.random.emit=function(t,n){var n=n||6e3;setTimeout(function(t){e.emit(t)},Math.random()*n,t)},e.random.exec=function(e,t){var t=t||6e3;setTimeout(function(e){e.call()},Math.random()*t,e)},e.log(e.version+" loaded","ALWAYS")}("undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){e=e||{},this.status=n.UNINITIALIZED,this.options=e,this.timer=null,this.timeLeft=null,this.timePassed=0,this.update=1e3,this.timeup="TIMEUP",this.hooks=[],this.init(),this.listeners()}e.GameTimer=n,JSUS=t.JSUS,n.STOPPED=-5,n.PAUSED=-3,n.UNINITIALIZED=-1,n.INITIALIZED=0,n.LOADING=3,n.RUNNING=5,n.prototype.init=function(e){e=e||this.options,this.status=n.UNINITIALIZED,this.timer&&clearInterval(this.timer),this.milliseconds=e.milliseconds||0,this.timeLeft=this.milliseconds,this.timePassed=0,this.update=e.update||1e3,this.timeup=e.timeup||"TIMEUP";if(e.hooks)for(var t=0;t<e.hooks.length;t++)this.addHook(e.hooks[t]);this.status=n.INITIALIZED},n.prototype.fire=function(e){if(!e&&!e.hook)return;var n=e.hook||e;if("function"==typeof n){var r=e.ctx||t.game;n.call(r)}else t.emit(n)},n.prototype.start=function(){this.status=n.LOADING;if(this.options.milliseconds===0){t.emit(this.timeup);return}var e=this;this.timer=setInterval(function(){e.status=n.RUNNING,t.log("interval started: "+e.timeLeft,"DEBUG","GameTimer: "),e.timePassed=e.timePassed+e.update,e.timeLeft=e.milliseconds-e.timePassed;for(var r=e.hooks.length;r>0;r--)e.fire(e.hooks[r-1]);e.timeLeft<=0&&(e.stop(),e.fire(e.timeup),t.log("time is up: "+e.timeup,"DEBUG","GameTimer: "))},this.update)},n.prototype.addHook=function(e,n){if(!e)return;var n=n||t.game;if(e.hook){n=e.ctx||n;var e=e.hook}this.hooks.push({hook:e,ctx:n})},n.prototype.pause=function(){this.status>0&&(this.status=n.PAUSED,clearInterval(this.timer))},n.prototype.resume=function(){if(this.status!==n.PAUSED)return;var e=JSUS.extend({milliseconds:this.milliseconds-this.timePassed},this.options);this.restart(e)},n.prototype.stop=function(){if(this.status===n.UNINITIALIZED)return;if(this.status===n.INITIALIZED)return;if(this.status===n.STOPPED)return;this.status=n.STOPPED,clearInterval(this.timer),this.timePassed=0,this.timeLeft=null},n.prototype.restart=function(e){this.init(e),this.start()},n.prototype.listeners=function(){var e=this}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){n=[],Object.defineProperty(this,"triggers",{value:n,enumerable:!0}),this.options=e||{},this.return=r.first,Object.defineProperty(this,"length",{set:function(){},get:function(){return n.length},configurable:!0}),this.init()}e.TriggerManager=r,r.first="first",r.last="last";var n;r.prototype.init=function(e){this.options=e||this.options;if(this.options.return===r.first||this.options.return===r.last)this.return=this.options.return;this.resetTriggers()},r.prototype.initTriggers=function(e){if(!e)return;e instanceof Array||(e=[e]);for(var t=0;t<e.length;t++)n.push(e[t])},r.prototype.resetTriggers=function(){n=[],this.initTriggers(this.options.triggers)},r.prototype.clear=function(e){return e?(n=[],e):(t.log("Do you really want to clear the current TriggerManager obj? Please use clear(true)","WARN"),!1)},r.prototype.addTrigger=function(e,t){return e?"function"!=typeof e?!1:(t?n.splice(t,0,e):n.push(e),!0):!1},r.prototype.removeTrigger=function(e){if(!e)return!1;for(var t=0;t<n.length;t++)if(n[t]==e)return n.splice(t,1);return!1},r.prototype.pullTriggers=function(e){if("undefined"==typeof e)return;if(!this.length)return e;for(var t=n.length;t>0;t--){var i=n[t-1].call(this,e);if("undefined"==typeof i&&this.return===r.first)return i}return"undefined"!=typeof i?i:e},r.prototype.pullTriggers=function(e){if(!e)return;for(var t=n.length;t>0;t--){var i=n[t-1].call(this,e);if(i&&this.return===r.first)return i}return e},r.prototype.size=function(){return n.length}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.JSUS,n=e.NDDB,r=e.store,i="nodegame_";e.session=function(t){if(!t){var n={id:e.gsc.session,player:e.player,memory:e.game.memory,state:e.game.gameState,game:e.game.name,history:undefined};if(e.events.history||e.events.history.length)n.history=e.events.history.fetch();return n}return e.session.enabled?e.store(i+t):!1},Object.defineProperty(e.session,"enabled",{get:function(){return e.store?e.store.persistent:!1},configurable:!1,enumerable:!0}),e.session.store=function(){if(!e.session.enabled)return e.log("Could not save the session"),!1;var t=e.session(),n=t.id;return e.store(i+n,t),e.log("Session saved with id "+n),!0}}("undefined"!=typeof node?node:module.parent.exports)