// cycle.js
// 2011-08-24
/*jslint evil: true, regexp: true *//*members $ref, apply, call, decycle, hasOwnProperty, length, prototype, push,
    retrocycle, stringify, test, toString
*/
typeof JSON.decycle!="function"&&(JSON.decycle=function(t){"use strict";var n=[],r=[];return function i(e,t){var s,o,u;switch(typeof e){case"object":if(!e)return null;for(s=0;s<n.length;s+=1)if(n[s]===e)return{$ref:r[s]};n.push(e),r.push(t);if(Object.prototype.toString.apply(e)==="[object Array]"){u=[];for(s=0;s<e.length;s+=1)u[s]=i(e[s],t+"["+s+"]")}else{u={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(u[o]=i(e[o],t+"["+JSON.stringify(o)+"]"))}return u;case"number":case"string":case"boolean":return e}}(t,"$")}),typeof JSON.retrocycle!="function"&&(JSON.retrocycle=function retrocycle($){"use strict";var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function rez(value){var i,item,name,path;if(value&&typeof value=="object")if(Object.prototype.toString.apply(value)==="[object Array]")for(i=0;i<value.length;i+=1)item=value[i],item&&typeof item=="object"&&(path=item.$ref,typeof path=="string"&&px.test(path)?value[i]=eval(path):rez(item));else for(name in value)typeof value[name]=="object"&&(item=value[name],item&&(path=item.$ref,typeof path=="string"&&px.test(path)?value[name]=eval(path):rez(item)))}($),$}),function(e){var t="0.3",n=e.store=function(e,t,r,i){r=r||{},i=r.type&&r.type in n.types?r.type:n.type;if(!i||!n.types[i]){n.log("Cannot save/load value. Invalid storage type selected: "+i,"ERR");return}return n.log("Accessing "+i+" storage"),n.types[i](e,t,r)};n.name="__shelf__",n.verbosity=0,n.types={};var r="volatile";try{Object.defineProperty(n,"type",{set:function(e){return"undefined"==typeof n.types[e]?(n.log("Cannot set store.type to an invalid type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!1,enumerable:!0})}catch(i){n.type=r}n.addType=function(e,t){n.types[e]=t,n[e]=function(t,r,i){return i=i||{},i.type=e,n(t,r,i)};if(!n.type||n.type==="volatile")n.type=e},n.error=function(){return"shelf quota exceeded"},n.log=function(e){n.verbosity>0&&console.log("Shelf v."+t+": "+e)},n.isPersistent=function(){return n.types?n.type==="volatile"?!1:!0:!1};try{Object.defineProperty(n,"persistent",{set:function(){},get:n.isPersistent,configurable:!1})}catch(i){n.persistent=!1}n.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},n.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},n.stringify=function(e){if(!JSON||!JSON.stringify||"function"!=typeof JSON.stringify)throw new Error("JSON.stringify not found. Received non-string value and could not serialize.");return e=n.decycle(e),JSON.stringify(e)},n.parse=function(e){if("undefined"==typeof e)return undefined;if(JSON&&JSON.parse&&"function"==typeof JSON.parse)try{e=JSON.parse(e)}catch(t){n.log("Error while parsing a value: "+t,"ERR"),n.log(e)}return e=n.retrocycle(e),e},function(){function r(e){return n.parse(n.stringify(e))}var e={},t={};n.addType("volatile",function(n,i,s){return n?i===undefined?r(e[n]):(t[n]&&(clearTimeout(t[n]),delete t[n]),i===null?(delete e[n],null):(e[n]=i,s.expires&&(t[n]=setTimeout(function(){delete e[n],delete t[n]},s.expires)),i)):r(e)})}()}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:this),function(e){var t=e.store;if(!t){console.log("cookie.shelf.js: shelf.js core not found. Cookie storage not available.");return}if("undefined"==typeof window){console.log("cookie.shelf.js: am I running in a browser? Cookie storage not available.");return}var n=function(){var e,n,r,i,s={expiresAt:null,path:"/",domain:null,secure:!1};return e=function(e){var t,n;return typeof e!="object"||e===null?t=s:(t={expiresAt:s.expiresAt,path:s.path,domain:s.domain,secure:s.secure},typeof e.expiresAt=="object"&&e.expiresAt instanceof Date?t.expiresAt=e.expiresAt:typeof e.hoursToLive=="number"&&e.hoursToLive!==0&&(n=new Date,n.setTime(n.getTime()+e.hoursToLive*60*60*1e3),t.expiresAt=n),typeof e.path=="string"&&e.path!==""&&(t.path=e.path),typeof e.domain=="string"&&e.domain!==""&&(t.domain=e.domain),e.secure===!0&&(t.secure=e.secure)),t},n=function(t){return t=e(t),(typeof t.expiresAt=="object"&&t.expiresAt instanceof Date?"; expires="+t.expiresAt.toGMTString():"")+"; path="+t.path+(typeof t.domain=="string"?"; domain="+t.domain:"")+(t.secure===!0?"; secure":"")},r=function(){var e={},n,r,i,s,o=document.cookie.split(";"),u;for(n=0;n<o.length;n+=1){r=o[n].split("="),i=r[0].replace(/^\s*/,"").replace(/\s*$/,"");try{s=decodeURIComponent(r[1])}catch(a){s=r[1]}e[i]=t.parse(s)}return e},i=function(){},i.prototype.get=function(e){var t,n,i=r();if(typeof e=="string")t=typeof i[e]!="undefined"?i[e]:null;else if(typeof e=="object"&&e!==null){t={};for(n in e)typeof i[e[n]]!="undefined"?t[e[n]]=i[e[n]]:t[e[n]]=null}else t=i;return t},i.prototype.filter=function(e){var t,n={},i=r();typeof e=="string"&&(e=new RegExp(e));for(t in i)t.match(e)&&(n[t]=i[t]);return n},i.prototype.set=function(e,r,i){if(typeof i!="object"||i===null)i={};typeof r=="undefined"||r===null?(r="",i.hoursToLive=-8760):typeof r!="string"&&(r=t.stringify(r));var s=n(i);document.cookie=e+"="+encodeURIComponent(r)+s},i.prototype.del=function(e,t){var n={},r;if(typeof t!="object"||t===null)t={};typeof e=="boolean"&&e===!0?n=this.get():typeof e=="string"&&(n[e]=!0);for(r in n)typeof r=="string"&&r!==""&&this.set(r,null,t)},i.prototype.test=function(){var e=!1,t="cT",n="data";return this.set(t,n),this.get(t)===n&&(this.del(t),e=!0),e},i.prototype.setOptions=function(t){typeof t!="object"&&(t=null),s=e(t)},new i}();n.test()&&t.addType("cookie",function(e,t,r){return"undefined"==typeof e?n.get():"undefined"==typeof t?n.get(e):t===null?(n.del(e),null):n.set(e,t,r)})}(this),function(e){function r(e,r){t.addType(e,function(i,s,o){var u,a,f,l,c=s,h=(new Date).getTime();if(!i){c={},l=[],f=0;try{i=r.length;while(i=r.key(f++))n.test(i)&&(a=t.parse(r.getItem(i)),a.expires&&a.expires<=h?l.push(i):c[i.replace(rprefix,"")]=a.data);while(i=l.pop())r.removeItem(i)}catch(p){}return c}i=t.name+i;if(s===undefined){u=r.getItem(i),a=u?t.parse(u):{expires:-1};if(!(a.expires&&a.expires<=h))return a.data;r.removeItem(i)}else if(s===null)r.removeItem(i);else{a=t.stringify({data:s,expires:o.expires?h+o.expires:null});try{r.setItem(i,a)}catch(p){t[e]();try{r.setItem(i,a)}catch(p){throw t.error()}}}return c})}var t=e.store;if(!t){console.log("amplify.shelf.js: shelf.js core not found. Amplify storage not available.");return}if("undefined"==typeof window){console.log("amplify.shelf.js: am I running in a browser? Amplify storage not available.");return}var n=new RegExp("^"+t.name);for(var i in{localStorage:1,sessionStorage:1})try{window[i].getItem&&r(i,window[i])}catch(s){}if(!t.types.localStorage&&window.globalStorage)try{r("globalStorage",window.globalStorage[window.location.hostname]),t.type==="sessionStorage"&&(t.type="globalStorage")}catch(s){}(function(){if(t.types.localStorage)return;var e=document.createElement("div"),n="shelf";e.style.display="none",document.getElementsByTagName("head")[0].appendChild(e);try{e.addBehavior("#default#userdata"),e.load(n)}catch(r){e.parentNode.removeChild(e);return}t.addType("userData",function(r,i,s){e.load(n);var o,u,a,f,l,c=i,h=(new Date).getTime();if(!r){c={},l=[],f=0;while(o=e.XMLDocument.documentElement.attributes[f++])u=t.parse(o.value),u.expires&&u.expires<=h?l.push(o.name):c[o.name]=u.data;while(r=l.pop())e.removeAttribute(r);return e.save(n),c}r=r.replace(/[^-._0-9A-Za-z\xb7\xc0-\xd6\xd8-\xf6\xf8-\u037d\u37f-\u1fff\u200c-\u200d\u203f\u2040\u2070-\u218f]/g,"-"),r=r.replace(/^-/,"_-");if(i===undefined){o=e.getAttribute(r),u=o?t.parse(o):{expires:-1};if(!(u.expires&&u.expires<=h))return u.data;e.removeAttribute(r)}else i===null?e.removeAttribute(r):(a=e.getAttribute(r),u=t.stringify({data:i,expires:s.expires?h+s.expires:null}),e.setAttribute(r,u));try{e.save(n)}catch(p){a===null?e.removeAttribute(r):e.setAttribute(r,a),t.userData();try{e.setAttribute(r,u),e.save(n)}catch(p){throw a===null?e.removeAttribute(r):e.setAttribute(r,a),t.error()}}return c})})()}(this),function(e){var t=e.store;if(!t){console.log("fs.shelf.js: shelf.js core not found. File system storage not available.");return}t.filename="./shelf.out";var n=require("fs"),r=require("path"),i=require("util"),s=function(e,t,r){var i,s;return i=n.createReadStream(e),s=n.createWriteStream(t),i.on("end",function(){return r(null)}),i.pipe(s)},o={},u=function(e,i){var o=e||t.filename;if(!o)return t.log("You must specify a valid file.","ERR"),!1;var u=r.dirname(o)+"."+r.basename(o);s(o,u,function(){var e=t.stringify(i);e=e.substr(1,e=e.substr(0,e.legth-1)),n.writeFile(o,e,"utf-8",function(e){if(e)throw e;return n.unlink(u,function(e){if(e)throw e}),!0})})};if("undefined"!=typeof n.appendFileSync)var a=function(e,r,i){var s=e||t.filename;if(!s)return t.log("You must specify a valid file.","ERR"),!1;if(!r)return;var o=t.stringify(r)+": "+t.stringify(i)+",\n";return n.appendFileSync(s,o,"utf-8")};else var a=function(e,r,i){var s=e||t.filename;if(!s)return t.log("You must specify a valid file.","ERR"),!1;if(!r)return;var o=t.stringify(r)+": "+t.stringify(i)+",\n";return n.open(s,"a",666,function(e,t){n.write(t,o,null,"utf8",function(){n.close(t,function(){})})}),!0};var f=function(e,r){var i=e||t.filename;if(!i)return t.log("You must specify a valid file.","ERR"),!1;var s=n.readFileSync(i,"utf-8");s=s.substr(0,s.length-2);var o=t.parse("{"+s+"}");return r?o[r]:o},l=function(e,n){var r=e||t.filename,i=f(r);return delete i[n],u(r,i),null};t.addType("fs",function(e,n,r){var i=r.file||t.filename;return e?n===undefined?f(i,e):(o[e]&&(clearTimeout(o[e]),l(i,e)),n===null?(l(i,e),null):(a(i,e,n),r.expires&&(o[e]=setTimeout(function(){l(i,e)},r.expires)),n)):f(i)})}("undefined"!=typeof module&&"function"==typeof require?module.exports||module.parent.exports:{}),function(e){var t=e.JSUS={};t._classes={},t.log=function(e){console.log(e)},t.extend=function(e,n){if("object"!=typeof e&&"function"!=typeof e)return n;if("undefined"==typeof n){n=n||this;if("function"==typeof e){var r=e.toString();r=r.substr("function ".length),r=r.substr(0,r.indexOf("("))}else var r=e.constructor||e.__proto__.constructor;r&&(this._classes[r]=e)}for(var i in e)e.hasOwnProperty(i)&&(typeof n[i]!="object"?n[i]=e[i]:t.extend(e[i],n[i]));return e.prototype&&t.extend(e.prototype,n.prototype||n),n},t.require=t.get=function(e){return"undefined"==typeof t.clone?(t.log("JSUS.clone not found. Cannot continue."),!1):"undefined"==typeof e?t.clone(t._classes):"undefined"==typeof t._classes[e]?(t.log("Could not find class "+e),!1):t.clone(t._classes[e])},t.isNodeJS=function(){return"undefined"!=typeof module&&"undefined"!=typeof module.exports&&"function"==typeof require},t.isNodeJS()&&(require("./lib/compatibility"),require("./lib/obj"),require("./lib/array"),require("./lib/time"),require("./lib/eval"),require("./lib/dom"),require("./lib/random"),require("./lib/parse"),require("./lib/fs"))}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window),function(e){function t(){}Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[],i=arguments[1];for(var s=0;s<n;s++)if(s in t){var o=t[s];e.call(i,o,s,t)&&r.push(o)}return r}),t.isArray=function(e){return e?Object.prototype.toString.call(e)==="[object Array]":!1},t.seq=function(t,n,r,i){if("number"!=typeof t)return!1;if(t===Infinity)return!1;if("number"!=typeof n)return!1;if(n===Infinity)return!1;if(t===n)return[t];if(r===0)return!1;if(!e.in_array(typeof r,["undefined","number"]))return!1;r=r||1,i=i||function(e){return e};var s=t,o=[];if(t<n)while(s<=n)o.push(i(s)),s+=r;else while(s>=n)o.push(i(s)),s-=r;return o},t.each=function(e,t,n){if("object"!=typeof e)return!1;if(!t)return!1;n=n||this;var r,i=e.length;for(r=0;r<i;r++)t.call(n,e[r]);return!0},t.map=function(){if(arguments.length<2)return;var n=Array.prototype.slice.call(arguments),r=n.shift(),i=n[0];if(!t.isArray(r)){e.log("ARRAY.map() the first argument must be an array. Found: "+r);return}var s=[],o=undefined;for(var u=0;u<r.length;u++)n[0]=r[u],o=i.apply(this,n),"undefined"!=typeof o&&s.push(o);return s},t.removeElement=function(t,n){if("undefined"==typeof t||!n)return!1;if("object"==typeof t)var r=e.equals;else var r=function(e,t){return e===t};for(var i=0;i<n.length;i++)if(r(t,n[i]))return n.splice(i,1);return!1},t.inArray=t.in_array=function(t,n){if(!n)return!1;var r=e.equals;for(var i=0;i<n.length;i++)if(r.call(this,t,n[i]))return!0;return!1},t.getNGroups=function(e,n){return t.getGroupsSizeN(e,Math.floor(e.length/n))},t.getGroupsSizeN=function(e,t){var n=e.slice(0),r=n.length,i=n.length,s=[],o,u,a=[],f=0;for(o=0;o<i;o++)u=Math.floor(Math.random()*r),f>=t&&(s.push(a),f=0,a=[]),a.push(n[u]),n.splice(u,1),r=n.length,f++;return a.length>0&&s.push(a),s},t._latinSquare=function(t,n,r){r="undefined"==typeof r?!0:r;if(t===n&&!r)return!1;var i=[],s=[];for(var o=0;o<t;o++)i[o]=o;var u=null,a=0,f=t,l=[];r||(f=t-1);for(o=0;o<n;o++){do u=e.randomInt(a,f);while(e.in_array(u,l));l.push(u),u==1?(s[o]=i.slice(u),s[o].push(0)):s[o]=i.slice(u).concat(i.slice(0,u))}return s},t.latinSquare=function(e,n){return n||(n=e),!e||e<0||n<0?!1:(n>e&&(n=e),t._latinSquare(e,n,!0))},t.latinSquareNoSelf=function(e,n){return n||(n=e-1),!e||e<0||n<0?!1:(n>e&&(n=e-1),t._latinSquare(e,n,!1))},t.generateCombinations=function(t,n){function r(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(t[e[r]]);return n}var i=t.length,s=[];for(var o=0;o<n;o++)s.push(o);var u=[];for(var o=i-n;o<i;o++)u.push(o);while(!e.equals(s,u)){callback(r(s,t));var o=n-1;while(s[o]==i-n+o)o-=1;s[o]+=1;for(var a=o+1;a<n;a++)s[a]=s[o]+a-o}return r(s,t)},t.matchN=function(e,n,r){if(!e)return;if(!n)return e;var i=[],s=e.length,o=[];for(var u=0;u<s;u++){var a=e.slice(0);a.splice(u,1),r&&(a=t.arrayDiff(a,o));var f=t.getNRandom(a,n);o=o.concat(f),f.splice(0,0,e[u]),i.push(f),f=[]}return i},t.rep=function(t,n){if(!t)return;if(!n)return t.slice(0);if(n<1){e.log("times must be greater or equal 1","ERR");return}var r=1,i=t.slice(0);for(;r<n;r++)i=i.concat(t);return i},t.stretch=function(n,r){if(!n)return;if(!r)return n.slice(0);if("number"==typeof r){if(r<1){e.log("times must be greater or equal 1","ERR");return}r=t.rep([r],n.length)}var i=[];for(var s=0;s<n.length;s++){var o=r[s%r.length];for(var u=0;u<o;u++)i.push(n[s])}return i},t.arrayIntersect=function(t,n){return t.filter(function(t){return e.in_array(t,n)})},t.arrayDiff=function(t,n){return t.filter(function(t){return!e.in_array(t,n)})},t.shuffle=function(e){if(!e)return;var t=e.slice(0),n=e.length-1,r,i;for(var s=n;s>0;s--)r=Math.floor(Math.random()*(s+1)),i=t[r],t[r]=t[s],t[s]=i;return t},t.getNRandom=function(e,n){return t.shuffle(e).slice(0,n)},t.distinct=function(e){var n=[];return e?(t.each(e,function(e){t.in_array(e,n)||n.push(e)}),n):n},t.transpose=function(e){if(!e)return;var n,r,i,s,o=[];n=e.length||0,r=t.isArray(e[0])?e[0].length:0;if(n===0||r===0)return o;for(i=0;i<r;i++){o[i]=[];for(s=0;s<n;s++)o[i][s]=e[s][i]}return o},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.write=function(t,n){if(!t)return;if(!n)return;var r=!e.isNode(n)||!e.isElement(n)?document.createTextNode(n):n;return t.appendChild(r),r},t.writeln=function(e,n,r){if(!e)return;var i=this.addBreak(e,r);return n?t.write(e,n):i},t.sprintf=function(t,n,r){var i,s,o,u,a,f,l,c={};if(!n)return document.createTextNode(t);r=r||document.createElement("span");for(var h in n)if(n.hasOwnProperty(h)){if(u===-1)continue;switch(h[0]){case"%":u=t.indexOf(h),f=u+h.length,a=t.indexOf(h,f);if(a===-1){e.log("Error. Could not find closing key: "+h);continue}c[u]=h;break;case"@":t=t.replace(h,escape(n[h]));break;case"!":t=t.replace(h,n[h]);break;default:e.log("Identifier not in [!,@,%]: "+h[0])}}if(!e.size(c))return document.createTextNode(t);l=e.keys(c).sort(function(e,t){return e-t}),a=0;for(var p=0;p<l.length;p++)h=c[l[p]],u=t.indexOf(h),a!==u-1&&r.appendChild(document.createTextNode(t.substring(a,u))),f=u+h.length,a=t.indexOf(h,f),o=W.getElement("span",null,n[h]),i=t.substring(f,a),o.appendChild(document.createTextNode(i)),r.appendChild(o),a+=h.length;return a!==t.length&&r.appendChild(document.createTextNode(t.substring(a))),r},t.isNode=function(e){return typeof Node=="object"?e instanceof Node:typeof e=="object"&&typeof e.nodeType=="number"&&typeof e.nodeName=="string"},t.isElement=function(e){return typeof HTMLElement=="object"?e instanceof HTMLElement:typeof e=="object"&&e.nodeType===1&&typeof e.nodeName=="string"},t.getElement=function(e,t,n){var r=document.createElement(e);return"undefined"!=typeof t&&(r.id=t),this.addAttributes2Elem(r,n)},t.addElement=function(e,t,n,r){var i=this.getElement(e,n,r);return t.appendChild(i)},t.addAttributes2Elem=function(t,n){if(!t||!n)return t;if("object"!=typeof n)return t;var r=["id","label"];for(var i in n)n.hasOwnProperty(i)&&(e.in_array(i,r)?i==="id"&&(t.id=n[i]):t.setAttribute(i,n[i]));return t},t.populateSelect=function(e,t){if(!e||!t)return;for(var n in t)if(t.hasOwnProperty(n)){var r=document.createElement("option");r.value=t[n],r.appendChild(document.createTextNode(n)),e.appendChild(r)}},t.removeChildrenFromNode=function(e){if(!e)return!1;while(e.hasChildNodes())e.removeChild(e.firstChild);return!0},t.insertAfter=function(e,t){t.insertBefore(e,t.nextSibling)},t.generateUniqueId=function(t){function r(t){var r=!0;while(r)for(var i=0;i<n.length;i++){r=n[i].document.getElementById(t);if(r){t=""+t+"_"+e.randomInt(0,1e3);break}}return t}var n=[window];return window.frames&&(n=n.concat(window.frames)),r(t+"_"+e.randomInt(0,1e7))},t.getBlankPage=function(){var e=document.createElement("html");return e.appendChild(document.createElement("body")),e},t.getButton=function(e,t,n){var r=document.createElement("button");return r.id=e,r.appendChild(document.createTextNode(t||"Send")),this.addAttributes2Elem(r,n)},t.addButton=function(e,t,n,r){var i=this.getButton(t,n,r);return e.appendChild(i)},t.getFieldset=function(e,t,n){var r=this.getElement("fieldset",e,n),i=document.createElement("Legend");return i.appendChild(document.createTextNode(t)),r.appendChild(i),r},t.addFieldset=function(e,t,n,r){var i=this.getFieldset(t,n,r);return e.appendChild(i)},t.getTextInput=function(e,t){var n=document.createElement("input");return"undefined"!=typeof e&&(n.id=e),n.setAttribute("type","text"),this.addAttributes2Elem(n,t)},t.addTextInput=function(e,t,n){var r=this.getTextInput(t,n);return e.appendChild(r)},t.getTextArea=function(e,t){var n=document.createElement("textarea");return"undefined"!=typeof e&&(n.id=e),this.addAttributes2Elem(n,t)},t.addTextArea=function(e,t,n){var r=this.getTextArea(t,n);return e.appendChild(r)},t.getCanvas=function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");return r?(n.id=e,this.addAttributes2Elem(n,t)):(alert("Canvas is not supported"),!1)},t.addCanvas=function(e,t,n){var r=this.getCanvas(t,n);return e.appendChild(r)},t.getSlider=function(e,t){var n=document.createElement("input");return n.id=e,n.setAttribute("type","range"),this.addAttributes2Elem(n,t)},t.addSlider=function(e,t,n){var r=this.getSlider(t,n);return e.appendChild(r)},t.getRadioButton=function(e,t){var n=document.createElement("input");return n.id=e,n.setAttribute("type","radio"),this.addAttributes2Elem(n,t)},t.addRadioButton=function(e,t,n){var r=this.getRadioButton(t,n);return e.appendChild(r)},t.getLabel=function(e,t,n,r){if(!e)return!1;var i=document.createElement("label");return i.id=t,i.appendChild(document.createTextNode(n)),"undefined"==typeof e.id&&(e.id=this.generateUniqueId()),i.setAttribute("for",e.id),this.addAttributes2Elem(i,r),i},t.addLabel=function(e,t,n,r,i){if(!e||!t||!r)return!1;var s=this.getLabel(t,n,r,i);return e.insertBefore(s,t),s},t.getSelect=function(e,t){return this.getElement("select",e,t)},t.addSelect=function(e,t,n){return this.addElement("select",e,t,n)},t.getIFrame=function(e,t){var t={name:e};return this.getElement("iframe",e,t)},t.addIFrame=function(e,t,n){var r=this.getIFrame(t,n);return e.appendChild(r)},t.addBreak=function(e,t){var n=t||"br",r=document.createElement(n);return e.appendChild(r)},t.getDiv=function(e,t){return this.getElement("div",e,t)},t.addDiv=function(e,t,n){return this.addElement("div",e,t,n)},t.addCSS=function(t,n,r,i){var t=t||document.head||document.body||document;return t?(i=i||{},i=e.merge(i,{rel:"stylesheet",type:"text/css",href:n}),this.addElement("link",t,r,i)):!1},t.addJS=function(t,n,r,i){var t=t||document.head||document.body||document;return t?(i=i||{},i=e.merge(i,{charset:"utf-8",type:"text/javascript",src:n}),this.addElement("script",t,r,i)):!1},t.highlight=function(e,t){if(!e)return;switch(t){case"OK":var n="green";break;case"WARN":var n="yellow";break;case"ERR":var n="red";break;default:if(t[0]==="#")var n=t;else var n="red"}return this.addBorder(e,n)},t.addBorder=function(e,t,n,r){if(!e)return;var t=t||"red",i=i||"5px",r=r||"solid",s={border:i+" "+r+" "+t};return this.style(e,s)},t.style=function(e,n){if(!e||!n)return;if(!t.isElement(e))return;var r="";for(var i in n)r+=i+": "+n[i]+"; ";return e.setAttribute("style",r)},t.removeClass=function(e,t){if(!e||!t)return;var n="/(?:^|s)"+t+"(?!S)/",r=e.className=e.className.replace(n,"");return e},t.addClass=function(e,t){if(!e||!t)return;return t instanceof Array&&(t=t.join(" ")),"undefined"==typeof e.className?e.className=t:e.className+=" "+t,e},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){function EVAL(){}EVAL.eval=function(str,context){if(!str)return;context=context||this;var func=function(str){return eval(str)};return func.call(context,str)},JSUS.extend(EVAL)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}var n=null;"undefined"!=typeof e.compatibility&&(n=e.compatibility()),t.equals=function(e,n){if("undefined"==typeof e||"undefined"==typeof n)return e===n;if(e===null||n===null)return e===n;if("number"==typeof e&&isNaN(e)&&"number"==typeof n&&isNaN(n))return isNaN(e)&&isNaN(n);var r={number:"",string:"","boolean":""};if(typeof e in r)return typeof n in r?e===n:!1;if(typeof n in{number:"",string:"","boolean":""})return!1;for(var i in e)if(e.hasOwnProperty(i)){if("undefined"==typeof n[i]&&"undefined"!=typeof e[i])return!1;if(!n[i]&&e[i])return!1;switch(typeof e[i]){case"function":if(e[i].toString()!==n[i].toString())return!1;default:if(!t.equals(e[i],n[i]))return!1}}for(i in n)if(n.hasOwnProperty(i)){if("undefined"==typeof e[i]&&"undefined"!=typeof n[i])return!1;if(!e[i]&&n[i])return!1}return!0},t.isEmpty=function(e){if("undefined"==typeof e)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},t.size=t.getListSize=function(e){if(!e)return 0;if("number"==typeof e)return 0;if("string"==typeof e)return 0;var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t},t._obj2Array=function(e,n,r,i){if("object"!=typeof e)return[e];if(r){i="undefined"!=typeof i?i:1;if(i>r)return[e];i+=1}var s=[];for(var o in e)e.hasOwnProperty(o)&&("object"==typeof e[o]?s=s.concat(t._obj2Array(e[o],n,r,i)):(n&&s.push(o),s.push(e[o])));return s},t.obj2Array=function(e,n){return t._obj2Array(e,!1,n)},t.obj2KeyedArray=t.obj2KeyArray=function(e,n){return t._obj2Array(e,!0,n)},t.keys=t.objGetAllKeys=function(e,n,r){if(!e)return[];n="number"==typeof n&&n>=0?n:0,r="number"==typeof r&&r>=0?r:0;var i=[];for(var s in e)e.hasOwnProperty(s)&&(i.push(s),r<n&&"object"==typeof e[s]&&(i=i.concat(t.objGetAllKeys(e[s],r+1))));return i},t.implode=t.implodeObj=function(e){if(!e)return[];var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t},t.clone=function(e){if(!e)return e;if("number"==typeof e)return e;if("string"==typeof e)return e;if("boolean"==typeof e)return e;if(e===NaN)return e;if(e===Infinity)return e;var r;"function"==typeof e?r=function(){return e.apply(r,arguments)}:r=Object.prototype.toString.call(e)==="[object Array]"?[]:{};for(var i in e){var s;e[i]&&"object"==typeof e[i]?Object.prototype.toString.call(e[i])==="[object Array]"?s=e[i].slice(0):s=t.clone(e[i]):s=e[i];if(e.hasOwnProperty(i))r[i]=s;else if(n&&n.defineProperty)Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0});else try{Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0})}catch(o){r[i]=s}}return r},t.join=function(e,n){var r=t.clone(e);if(!n)return r;for(var i in r)r.hasOwnProperty(i)&&"undefined"!=typeof n[i]&&("object"==typeof n[i]?r[i]=t.join(r[i],n[i]):r[i]=n[i]);return r},t.merge=function(e,n){if(!e&&!n)return!1;if(!e)return t.clone(n);if(!n)return t.clone(e);var r=t.clone(e);for(var i in n)n.hasOwnProperty(i)&&(n[i]&&"object"==typeof n[i]?("object"!=typeof r[i]&&(Object.prototype.toString.call(n[i])==="[object Array]"?r[i]=[]:r[i]={}),r[i]=t.merge(r[i],n[i])):r[i]=n[i]);return r},t.mixin=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]=t[n]},t.mixout=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]||(e[n]=t[n])},t.mixcommon=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]&&(e[n]=t[n])},t.mergeOnKey=function(e,n,r){var i=t.clone(e);if(!n||!r)return i;for(var s in n)if(n.hasOwnProperty(s)){if(!i[s]||"object"!=typeof i[s])i[s]={};i[s][r]=n[s]}return i},t.subobj=function(e,n){if(!e)return!1;var r={};if(!n)return r;n instanceof Array||(n=[n]);for(var i=0;i<n.length;i++){var s=n[i];t.hasOwnNestedProperty(s,e)&&t.setNestedValue(s,t.getNestedValue(s,e),r)}return r},t.skim=function(e,n){if(!e)return!1;var r=t.clone(e);if(!n)return r;n instanceof Array||(n=[n]);for(var i=0;i<n.length;i++)t.deleteNestedKey(n[i],r);return r},t.setNestedValue=function(n,r,i){if(!n)return e.log("Cannot set value of undefined property","ERR"),!1;i="object"==typeof i?i:{};var s=n.split(".");if(s.length===1)return i[n]=r,i;var o=s.shift();return i[o]=t.setNestedValue(s.join("."),r,i[o]),i},t.getNestedValue=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return n[e];var i=r.shift();return t.getNestedValue(r.join("."),n[i])},t.deleteNestedKey=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return delete n[e],!0;var i=r.shift();return"undefined"==typeof n[i]?!1:t.deleteNestedKey(r.join("."),n[i])},t.hasOwnNestedProperty=function(e,n){if(!n)return!1;var r=e.split(".");if(r.length===1)return n.hasOwnProperty(e);var i=r.shift();return t.hasOwnNestedProperty(r.join("."),n[i])},t.split=function(t,n){if(!t)return;if(!n||"object"!=typeof t[n])return e.clone(t);var r=[],i=e.clone(t);i[n]={};var s=function(t){for(var o in t){var u=e.clone(i);t.hasOwnProperty(o)&&("object"==typeof t[o]?r=r.concat(s(t[o])):(u[n][o]=t[o],r.push(u)))}return r};return s(t[n])},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.random=function(e,t){e="undefined"==typeof e?0:e,t="undefined"==typeof t?0:t;if(e===t)return e;if(t<e){var n=e;e=t,t=n}return Math.random()*(t-e)+e},t.randomInt=function(e,n){return e===n?e:Math.floor(t.random(e,n)+1)},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.getDate=t.getFullDate=function(){var e=new Date,t=e.getUTCDate()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+" "+e.getMilliseconds();return t},t.getTime=function(){var e=new Date,t=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return t},t.parseMilliseconds=function(e){if("number"!=typeof e)return;var t=[],n=e/1e3;t[4]=n;var r=n%60;t[3]=Math.floor(r);var n=n/60,i=n%60;t[2]=Math.floor(i);var n=n/60,s=n%24;t[1]=Math.floor(s);var n=n/24,o=n;return t[1]=Math.floor(o),t},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.getQueryString=function(e){var t=window.location.search.substring(1);if("undefined"==typeof e)return t;var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]===e)return unescape(i[1])}return!1},t.tokenize=function(t,n,r){if(!t)return;if(!n||!n.length)return[t];r=r||{};var i="[";e.each(n,function(e){e===" "&&(e="\\s"),i+=e}),i+="]+";var s=new RegExp(i);return t.split(s,r.limit)},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e,t,n){function u(e,n,r){e=e||{};if(!t)throw new Error("JSUS not found.");this.db=[],this.tags={},this.hooks={},this.nddb_pointer=0,u.compatibility.getter?this.__defineGetter__("length",function(){return this.db.length}):this.length=null,this.__C={},this.__H={},this.__update={},this.__update.pointer=!1,this.__update.indexes=!1,this.__update.sort=!1,this.__parent=r||undefined,this.init(e),this.importDB(n)}var r=null,i=[],s=function(e,t){return!e||!t?(u.log("Attempt to add invalid condition","ERR"),!1):(i.push({type:e,condition:t}),!0)},o=function(e,t,n,i){if(!r)return u.log("No operation found.","ERR"),!1;var o=this._analyzeQuery(t,n,i);return o?s(e,o):!1};u.prototype.and=u.prototype.AND=function(e,t,n){return o("AND",e,t,n)},u.prototype.or=u.prototype.OR=function(e,t,n){return o("OR",e,t,n)},u.prototype.not=u.prototype.NOT=function(e,t,n){return o("NOT",e,t,n)},u.compatibility=t.compatibility(),e.NDDB=u,u.log=console.log,u.__symbols=[">",">=",">==","<","<=","<==","!=","!==","=","==","===","><","<>","in","!in"],u.__operations=["select","groupby","limit","first","fetch","last"],u.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},u.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},u.prototype.init=function(e){e=e||{},this.__options=e,e.log&&(u.log=e.log),e.C&&(this.__C=e.C),e.H&&(this.__H=e.H),e.tags&&(this.tags=e.tags),e.nddb_pointer>0&&(this.nddb_pointer=e.nddb_pointer),e.hooks&&(this.hooks=e.hook),e.update&&("undefined"!=typeof e.update.pointer&&(this.__update.pointer=e.update.pointer),"undefined"!=typeof e.update.indexes&&(this.__update.indexes=e.update.indexes),"undefined"!=typeof e.update.sort&&(this.__update.sort=e.update.sort))},u.prototype.globalCompare=function(e,t){return"undefined"==typeof e&&"undefined"==typeof t?0:"undefined"==typeof t?-1:"undefined"==typeof e?1:e.nddbid<t.nddbid?-1:e.nddbid>t.nddbid?1:0},u.prototype._masquerade=function(e,t){return"undefined"==typeof e?!1:"undefined"!=typeof e.nddbid?e:(t=t||this.db,u.compatibility.defineProperty?Object.defineProperty(e,"nddbid",{value:t.length,configurable:!0,writable:!0}):e.nddbid=t.length,e)},u.prototype._masqueradeDB=function(e){if(!e)return[];var t=[];for(var n=0;n<e.length;n++)t[n]=this._masquerade(e[n],t);return t},u.prototype._autoUpdate=function(e){var n=e?t.merge(e,this.__update):this.__update;n.pointer&&(this.nddb_pointer=this.db.length-1),n.sort&&this.sort(),n.indexes&&this.rebuildIndexes(),this.__parent&&this.__parent._autoUpdate(n)},u.prototype.importDB=function(e){if(!e)return;this.db||(this.db=[]);for(var t=0;t<e.length;t++)this.insert(e[t])},u.prototype.insert=function(e){if("undefined"==typeof e||e===null)return;this.db||(this.db=[]),this._insert(e)},u.prototype._insert=function(e){if("undefined"==typeof e||e===null)return;e=this._masquerade(e),this.db.push(e),this.__update.indexes&&this._hashIt(e),this._autoUpdate({indexes:!1})},u.prototype.breed=function(e){e=e||this.db;var t=this.cloneSettings(),n=this.__parent||this;return new this.constructor(t,e,n)},u.prototype.cloneSettings=function(){var e=this.__options||{};return e.H=this.__H,e.C=this.__C,e.tags=this.tags,e.update=this.__update,t.clone(e)},u.prototype.toString=function(){var e="";for(var t=0;t<this.db.length;t++)e+=this.db[t]+"\n";return e},u.prototype.stringify=function(e){if(!this.length)return"[]";e="undefined"==typeof e?!0:e;var n;e?n=function(e){return t.isEmpty(e)?"{}":JSON.stringify(e)}:n=function(e){return t.isEmpty(e)?"{}":JSON.stringify(e,null,4)};var r="[";return this.each(function(e){e=u.decycle(e),r+=n(e)+", "}),r=r.replace(/, $/,"]"),r},u.prototype.compare=u.prototype.c=function(e,t){return!e||!t?(u.log("Cannot set empty property or empty comparator","ERR"),!1):(this.__C[e]=t,!0)},u.prototype.comparator=function(e){return"undefined"!=typeof this.__C[e]?this.__C[e]:function(n,r){if("undefined"==typeof n&&"undefined"==typeof r)return 0;if("undefined"==typeof n)return 1;if("undefined"==typeof r)return-1;var i=t.getNestedValue(e,n),s=t.getNestedValue(e,r);return"undefined"==typeof i&&"undefined"==typeof s?0:"undefined"==typeof i?1:"undefined"==typeof s?-1:i>s?1:s>i?-1:0}},u.prototype.isReservedWord=function(e){return this[e]?!0:!1},u.prototype.hash=u.prototype.h=function(e,t){if("undefined"==typeof e)return u.log("A valid index name must be provided","ERR"),!1;t=t||Object.toString;if(this.isReservedWord(e)){var n="A reserved word have been selected as an index. ";return n+="Please select another one: "+e,u.log(n,"ERR"),!1}return this.__H[e]=t,this[e]={},!0},u.prototype.rebuildIndexes=function(){if(t.isEmpty(this.__H))return;for(var e in this.__H)this.__H.hasOwnProperty(e)&&(this[e]={});this.each(this._hashIt)},u.prototype._hashIt=function(e){if(!e)return!1;if(t.isEmpty(this.__H))return!1;var n=null,r=null,i=null;for(var s in this.__H)if(this.__H.hasOwnProperty(s)){n=this.__H[s],i=n(e);if("undefined"==typeof i)continue;this[s]||(this[s]={}),this[s][i]||(this[s][i]=new u),this[s][i].insert(e)}},u.prototype._analyzeQuery=function(e,n,r){var i=function(e,t,n){var r="(?)",i="Malformed query: "+e||r+" "+t||r+" "+n||r;return u.log(i,"WARN"),!1};"undefined"==typeof e&&i(e,n,r);if("undefined"!=typeof n){"undefined"==typeof r&&i(e,n,r);if(!t.in_array(n,[">",">=",">==","<","<=","<==","!=","!==","=","==","===","><","<>","in","!in"]))return u.log("Query error. Invalid operator detected: "+n,"WARN"),!1;n==="="&&(n="==");if(t.in_array(n,["><","<>","in","!in"])){r instanceof Array||(u.log("Range-queries need an array as third parameter","WARN"),i(e,n,r));if(n==="<>"||n==="><")r[0]=t.setNestedValue(e,r[0]),r[1]=t.setNestedValue(e,r[1])}else r=t.setNestedValue(e,r)}else"undefined"!=typeof r?i(e,n,r):(n="",r="");return{d:e,op:n,value:r}},u.prototype.distinct=function(){return this.breed(t.distinct(this.db))},u.prototype.select=function(e,n,r){var i=this._analyzeQuery(e,n,r);if(!i)return!1;var e=i.d,n=i.op,r=i.value,s=this.comparator(e),o=function(n){if("undefined"!=typeof t.getNestedValue(e,n))return n},a=function(i){try{if(t.eval(s(i,r)+n+0,i))return i}catch(o){return u.log("Malformed select query: "+e+n+r),!1}},f=function(e){if(s(e,r[0])>0&&s(e,r[1])<0)return e},l=function(e){if(s(e,r[0])<0&&s(e,r[1]>0))return e},c=function(n){if(t.in_array(t.getNestedValue(e,n),r))return n},h=function(n){if(!t.in_array(t.getNestedValue(e,n),r))return n};switch(n){case"":var p=o;break;case"<>":var p=l;break;case"><":var p=f;break;case"in":var p=c;break;case"!in":var p=h;break;default:var p=a}return this.filter(p)},u.prototype.limit=function(e){e=e||0;if(e===0)return this.breed();var t=e>0?this.db.slice(0,e):this.db.slice(e);return this.breed(t)},u.prototype.reverse=function(){return this.db.reverse(),this},u.prototype.sort=function(e){if(!e)var t=this.globalCompare;else if("function"==typeof e)var t=e;else if(e instanceof Array)var n=this,t=function(t,r){for(var i=0;i<e.length;i++){var s=n.comparator(e[i]).call(n,t,r);if(s!==0)return s}return s};else var t=this.comparator(e);return this.db.sort(t),this},u.prototype.shuffle=function(){return this.db=t.shuffle(this.db),!0},u.prototype.filter=function(e){return this.breed(this.db.filter(e))},u.prototype.each=u.prototype.forEach=function(){if(arguments.length===0)return;var e=arguments[0];for(var t=0;t<this.db.length;t++)arguments[0]=this.db[t],e.apply(this,arguments)},u.prototype.map=function(){if(arguments.length===0)return;var e=arguments[0],t=[],n=undefined;for(var r=0;r<this.db.length;r++)arguments[0]=this.db[r],n=e.apply(this,arguments),"undefined"!=typeof n&&t.push(n);return t},u.prototype.remove=function(){if(!this.length)return this;if(this.__parent){for(var e=0;e<this.db.length;e++){var t=this.db[e].nddbid-e;this.__parent.db.splice(t,1)}for(var e=0;e<this.__parent.length;e++)this.__parent.db[e].nddbid=e}return this.db=[],this._autoUpdate(),this},u.prototype.clear=function(e){return e?(this.db=[],this._autoUpdate()):u.log("Do you really want to clear the current dataset? Please use clear(true)","WARN"),e},u.prototype.join=function(e,n,r,i){return this._join(e,n,t.equals,r,i)},u.prototype.concat=function(e,t,n,r){return this._join(e,t,function(){return!0},n,r)},u.prototype._join=function(e,n,r,i,s){r=r||t.equals,i="undefined"!=typeof i?i:"joined";if(s)var s=s instanceof Array?s:[s];var o=[],a=[];for(var f=0;f<this.db.length;f++)try{var l=t.eval("this."+e,this.db[f]);if("undefined"!=typeof l)for(var c=f+1;c<this.db.length;c++)try{var h=t.eval("this."+n,this.db[c]);if("undefined"!=typeof h&&r(l,h)){var p=t.clone(this.db[f]),d=s?t.subobj(this.db[c],s):this.db[c];p[i]=d,o.push(p)}}catch(v){u.log("Key not found in entry: "+n,"WARN")}}catch(v){u.log("Key not found in entry: "+e,"WARN")}return this.breed(o)},u.prototype.split=function(e){var n=[];for(var r=0;r<this.db.length;r++)n=n.concat(t.split(this.db[r],e));return this.breed(n)},u.prototype._fetch=function(e,n){function r(e,n){return t.getNestedValue(n,e)}function i(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return t.obj2KeyedArray(r)}function s(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return n.split(".").concat(t.obj2KeyedArray(r))}switch(n){case"VALUES":var o=e?i:t.obj2Array;break;case"KEY_VALUES":var o=e?s:t.obj2KeyedArray;break;default:if(!e)return this.db;var o=r}var u=[];for(var a=0;a<this.db.length;a++){var f=o.call(this.db[a],this.db[a],e);"undefined"!=typeof f&&u.push(f)}return u},u.prototype.fetch=function(e){return this._fetch(e,!0)},u.prototype.fetchArray=function(e){return this._fetch(e,"VALUES")},u.prototype.fetchKeyArray=function(e){return this._fetch(e,"KEY_VALUES")},u.prototype.fetchValues=function(e){return this._fetch(e,"VALUES")},u.prototype.fetchKeyValues=function(e){return this._fetch(e,"KEY_VALUES")},u.prototype.groupBy=function(e){if(!e)return this.db;var n=[],r=[];for(var i=0;i<this.db.length;i++){var s=t.getNestedValue(e,this.db[i]);if("undefined"==typeof s)continue;if(!t.in_array(s,n)){n.push(s);var o=this.filter(function(n){if(t.equals(t.getNestedValue(e,n),s))return this});o.nddb_pointer=0,r.push(o)}}return r},u.prototype.count=function(e){if("undefined"==typeof e)return this.db.length;var n=0;for(var r=0;r<this.db.length;r++)t.hasOwnNestedProperty(e,this.db[r])&&n++;return n},u.prototype.sum=function(e){if("undefined"==typeof e)return!1;var n=0;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);isNaN(i)||(n+=i)}return n},u.prototype.mean=function(e){if("undefined"==typeof e)return!1;var n=0,r=0;for(var i=0;i<this.db.length;i++){var s=t.getNestedValue(e,this.db[i]);isNaN(s)||(n+=s,r++)}return r===0?0:n/r},u.prototype.stddev=function(e){if("undefined"==typeof e)return!1;var n=this.mean(e);if(isNaN(n))return!1;var r=0;return this.each(function(i){var s=t.getNestedValue(e,i);isNaN(s)||(r+=Math.pow(s-n,2))}),r!==0?Math.sqrt(r):0},u.prototype.min=function(e){if("undefined"==typeof e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);!isNaN(i)&&(i<n||n===!1)&&(n=i)}return n},u.prototype.max=function(e){if("undefined"==typeof e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);!isNaN(i)&&(i>n||n===!1)&&(n=i)}return n},u.prototype.skim=function(e){return e?this.breed(this.map(function(n){var r=t.skim(n,e);if(!t.isEmpty(r))return r})):this},u.prototype.keep=function(e){return e?this.breed(this.map(function(n){var r=t.subobj(n,e);if(!t.isEmpty(r))return r})):this.breed([])},u.prototype.diff=function(e){return!e||!e.length?this:("object"==typeof e&&(e instanceof u||e instanceof this.constructor)&&(e=e.db),this.breed(t.arrayDiff(this.db,e)))},u.prototype.intersect=function(e){if(!e||!e.length)return this;if("object"==typeof e)if(e instanceof u||e instanceof this.constructor)var e=e.db;return this.breed(t.arrayIntersect(this.db,e))},u.prototype.get=function(e){var e=e||this.nddb_pointer;return e<0||e>this.db.length-1?!1:this.db[e]},u.prototype.next=function(){var e=u.prototype.get.call(this,++this.nddb_pointer);return e||this.nddb_pointer--,e},u.prototype.previous=function(){var e=u.prototype.get.call(this,--this.nddb_pointer);return e||this.nddb_pointer++,e},u.prototype.first=function(e){var t=this.fetch(e);return t.length?(this.nddb_pointer=t[0].nddbid,t[0]):undefined},u.prototype.last=function(e){var t=this.fetch(e);return t.length?(this.nddb_pointer=t[t.length-1].nddbid,t[t.length-1]):undefined},u.prototype.tag=function(e,t){return"undefined"==typeof e?(u.log("Cannot register empty tag.","ERR"),!1):(t=t||this.nddb_pointer,t>this.length||t<0?(u.log("Invalid index provided for tag registration","ERR"),!1):(this.tags[e]=this.db[t],!0))},u.prototype.resolveTag=function(e){return"undefined"==typeof e?(u.log("Cannot resolve empty tag.","ERR"),!1):this.tags[e]};var a=function(){return"function"==typeof n};if(t.isNodeJS()){require("./external/cycle.js");var f=require("fs")}u.prototype.save=function(e,r,i){if(!e)return u.log("You must specify a valid file / id.","ERR"),!1;i=i||!1;if(!t.isNodeJS())return a()?(n(e,this.stringify(i)),r&&r(),!0):(u.log("No support for persistent storage found.","ERR"),!1);f.writeFile(e,this.stringify(i),"utf-8",function(e){if(e)throw e;return r&&r(),!0})},u.prototype.load=function(e,r){if(!e)return u.log("You must specify a valid file / id.","ERR"),!1;if(!t.isNodeJS()){if(!a())return u.log("No support for persistent storage found.","ERR"),!1;var i=n(e);return this.importDB(i),r&&r(),!0}var s=function(e){var t=JSON.parse(e.toString()),n;for(n=0;n<t.length;n++)t[n]=u.retrocycle(t[n]);this.importDB(t)};if(!r){var o=f.readFileSync(e,"utf-8");s.call(this,o)}else f.readFile(e,"utf-8",function(e,t){if(e)throw e;s.call(this,t),r()})}}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window,"undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS||require("JSUS").JSUS,"object"==typeof module&&"function"==typeof require?module.parent.exports.store||require("shelf.js/build/shelf-fs.js").store:this.store),function(node){node.version="0.7.5",node.verbosity=0,node.verbosity_levels={ALWAYS:-(Number.MIN_VALUE+1),ERR:-1,WARN:0,INFO:1,DEBUG:100},node.warn=function(e,t){node.log(e,node.verbosity_levels.WARN,t)},node.err=function(e,t){node.log(e,node.verbosity_levels.ERR,t)},node.info=function(e,t){node.log(e,node.verbosity_levels.INFO,t)},node.support={},function(){try{Object.defineProperty({},"a",{enumerable:!1,value:1}),node.support.defineProperty=!0}catch(e){node.support.defineProperty=!1}try{eval("({ get x(){ return 1 } }).x === 1"),node.support.setter=!0}catch(err){node.support.setter=!1}try{var value;eval("({ set x(v){ value = v; } }).x = 1"),node.support.getter=!0}catch(err){node.support.getter=!1}}(),node.log=function(e,t,n){if("undefined"==typeof e)return!1;t=t||0,n="undefined"==typeof n?"nodeGame: ":n,"string"==typeof t&&(t=node.verbosity_levels[t]),node.verbosity>t&&console.log(n+e)},node.game={},node.socket={},node.session={},node.player={},node.memory={},"undefined"!=typeof JSUS&&(node.JSUS=JSUS),"undefined"!=typeof NDDB&&(node.NDDB=NDDB),"undefined"!=typeof store&&(node.store=store),"object"==typeof module&&"function"==typeof require&&(require("./init.node.js"),require("./nodeGame.js"),require("./listeners/incoming.js"),require("./listeners/internal.js"),require("./listeners/outgoing.js"))}("object"==typeof module?module.exports:window.node={}),function(e,t){function r(){this.global=this._listeners={},this.local=this._localListeners={},this.history=new n({update:{indexes:!0}}),this.history.h("state",function(e){if(!e)return;var n="object"==typeof e.state?e.state:t.game.state;return t.GameState.toHash(n,"S.s.r")})}function i(e){var e=e||{};this.event=e.event,this.listener=e.listener,this.priority=e.priority||0,this.state=e.state||t.game.state,this.ttl="undefined"!=typeof e.ttl?e.ttl:-1,this.target=e.target||undefined}var n=t.NDDB;e.EventEmitter=r,r.prototype={constructor:r,add:function(e,n){if(!e||!n)return;"undefined"==typeof this.global[e]&&(this.global[e]=[]),t.log("Added Listener: "+e+" "+n,"DEBUG"),this.global[e].push(n)},addLocal:function(e,n){if(!e||!n)return;"undefined"==typeof this.local[e]&&(this.local[e]=[]),t.log("Added Local Listener: "+e+" "+n,"DEBUG"),this.local[e].push(n)},emit:function(e,n,r,i){if(!e)return;"string"==typeof e&&(e={type:e}),e.target||(e.target=this);if(!e.type)throw new Error("Event object missing 'type' property.");if(!t.conf||!t.conf.events)t.log("node.conf.events object not found. Is everthing all right?","WARN");else{if(t.conf.events.history){var s={event:e.type,state:t.game.state,p1:n,p2:r,p3:i};this.history.insert(s)}t.conf.events.dumpEvents&&t.log("Fired "+e.type)}if(this.global[e.type]instanceof Array){var o=this.global[e.type];for(var u=0,a=o.length;u<a;u++)o[u].call(this.game,n,r,i)}if(this.local[e.type]instanceof Array){var o=this.local[e.type];for(var u=0,a=o.length;u<a;u++)o[u].call(this.game,n,r,i)}},remove:function(e,n){function r(e,n,r){if(r[e]instanceof Array){if(!n)return delete r[e],!0;var i=r[e],s=i.length;for(var o=0;o<s;o++)if(i[o]==n)return i.splice(o,1),t.log("Removed listener "+e+" "+n,"DEBUG"),!0}return!1}var i=r(e,n,this.global),s=r(e,n,this.local);return i||s},clearState:function(e){return this.clearLocal(),!0},clearLocal:function(){t.log("Cleaning Local Listeners","DEBUG");for(var e in this.local)this.local.hasOwnProperty(e)&&this.remove(e,this.local[e]);this.local={}},printAll:function(){t.log("nodeGame:	PRINTING ALL LISTENERS","DEBUG");for(var e in this.global)this.global.hasOwnProperty(e)&&console.log(e+" "+e.length);for(var e in this.local)this.local.hasOwnProperty(e)&&console.log(e+" "+e.length)}}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){this.state=0,this.step=0,this.round=0,this.is=r.iss.UNKNOWN,this.paused=!1;if("string"==typeof e){var t=e.split(".");this.state="undefined"!=typeof t[0]?Number(t[0]):undefined,this.step="undefined"!=typeof t[1]?Number(t[1]):undefined,this.round="undefined"!=typeof t[2]?Number(t[2]):undefined,this.is="undefined"!=typeof t[3]?Number(t[3]):r.iss.UNKNOWN,this.paused=t[4]==="1"?!0:!1}else"object"==typeof e&&(this.state=e.state,this.step=e.step,this.round=e.round,this.is=e.is?e.is:r.iss.UNKNOWN,this.paused=e.paused?e.paused:!1)}var n=t.JSUS;e.GameState=r,r.iss={},r.iss.UNKNOWN=0,r.iss.LOADING=10,r.iss.LOADED=25,r.iss.PLAYING=50,r.iss.DONE=100,r.defaults={},r.defaults.hash="S.s.r.i.p",r.prototype.toString=function(){var e=this.toHash("(r) S.s");return this.paused&&(e+=" [P]"),e},r.prototype.toHash=function(e){return r.toHash(this,e)},r.toHash=function(e,t){if(!e||"object"!=typeof e)return!1;if(!t||!t.length)return e.toString();var n="",r="Ssrip",i=["state","step","round","is","paused"];for(var s=0;s<t.length;s++){var o=r.indexOf(t[s]);n+=o<0?t[s]:Number(e[i[o]])}return n},r.compare=function(e,t,n){if(!e&&!t)return 0;if(!t)return 1;if(!e)return-1;n=n||!1,"string"==typeof e&&(e=new r(e)),"string"==typeof t&&(t=new r(t));var i=e.state-t.state;return i===0&&"undefined"!=typeof e.round&&(i=e.round-t.round,i===0&&"undefined"!=typeof e.step&&(i=e.step-t.step,n&&i===0&&"undefined"!=typeof e.is&&(i=e.is-t.is))),i},r.stringify=function(e){if(!e)return;var t=(new r(e)).toHash("(r) S.s_i");return e.paused&&(t+=" [P]"),t}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e,n,i){e=e||{},e.log||(e.log=t.log),r.call(this,e,n,i),this.globalCompare=function(e,n){return e.id===n.id?0:e.count<n.count?1:e.count>n.count?-1:(t.log("Two players with different id have the same count number","WARN"),0)}}function o(e){e=e||{};var n=e.sid;t.support.defineProperty?Object.defineProperty(this,"sid",{value:n,enumerable:!0}):this.sid=n;var r=e.id||n;t.support.defineProperty?Object.defineProperty(this,"id",{value:r,enumerable:!0}):this.id=r;var s=e.count;t.support.defineProperty?Object.defineProperty(this,"count",{value:s,enumerable:!0}):this.count=s,this.ip=e.ip,this.name=e.name,this.state=e.state||new i;for(var o in e)e.hasOwnProperty(o)&&"function"!=typeof e[o]&&(this.hasOwnProperty(o)||(this[o]=e[o]))}var n=t.JSUS,r=t.NDDB,i=t.GameState;e.PlayerList=s,s.prototype=n.clone(r.prototype),s.prototype.constructor=s,s.array2Groups=function(e){if(!e)return;for(var t=0;t<e.length;t++)e[t]=new s({},e[t]);return e},s.prototype.add=function(e){return!e||!e.sid||!e.id?(t.log("Only instance of Player objects can be added to a PlayerList","ERR"),!1):this.exist(e.id)?(t.log("Attempt to add a new player already in the player list: "+e.id,"ERR"),!1):(this.insert(e),e.count=e.nddbid,!0)},s.prototype.remove=function(e){if(!e)return r.prototype.remove.call(this);var n=this.select("id","=",e);return n.length?(n.remove(),!0):(t.log("Attempt to remove a non-existing player from the the player list. id: "+e,"ERR"),!1)},s.prototype.get=function(e){if(!e)return!1;var n=this.select("id","=",e);return n.count()>0?n.count()>1?(t.log("More than one player found with id: "+e,"WARN"),n.fetch()):n.first():(t.log("Attempt to access a non-existing player from the the player list. id: "+e,"ERR"),!1)},s.prototype.pop=function(e){if(!e)return!1;var t=this.get(e);return"object"==typeof t?(this.remove(e),t):!1},s.prototype.getAllIDs=function(){return this.map(function(e){return e.id})},s.prototype.updatePlayerState=function(e,n){return this.exist(e)?"undefined"==typeof n?(t.log("Attempt to assign to a player an undefined state","WARN"),!1):(this.select("id","=",e).first().state=n,!0):(t.log("Attempt to access a non-existing player from the the player list "+player.id,"WARN"),!1)},s.prototype.exist=function(e){return this.select("id","=",e).count()>0?!0:!1},s.prototype.isStateDone=function(e,n){e=e||t.game.state,n=n||!1;var r=this.map(function(t){var n=new i(t.state);return t.state.is!==i.iss.DONE?0:i.compare(e,t.state,!1)!==0?0:1}),s,o=0;for(s=0;s<r.length;s++)o+=Number(r[s]);var u=n?this.length:this.actives();return o===u?!0:!1},s.prototype.actives=function(){var e=0,t;return this.each(function(n){t=new i(n.state),i.compare(t,new i)!==0&&e++}),e},s.prototype.checkState=function(e,n){this.isStateDone(e,n)&&t.emit("STATEDONE")},s.prototype.toString=function(e){var t="",n=e||"\n";return this.forEach(function(e){t+=e.id+": "+e.name;var r=new i(e.state);t+=": "+r+n}),t},s.prototype.getNGroups=function(e){if(!e)return;var t=n.getNGroups(this.db,e);return s.array2Groups(t)},s.prototype.getGroupsSizeN=function(e){if(!e)return;var t=n.getGroupsSizeN(this.db,e);return s.array2Groups(t)},s.prototype.getRandom=function(e){return e||(e=1),e<1?(t.log("N must be an integer >= 1","ERR"),!1):(this.shuffle(),e==1?this.first():this.limit(e).fetch())},e.Player=o,o.prototype.toString=function(){return(this.name||"")+" ("+this.id+") "+new i(this.state)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function i(e){e=e||{};var n=e.id||Math.floor(Math.random()*1e6);t.support.defineProperty?Object.defineProperty(this,"id",{value:n,enumerable:!0}):this.id=n;var i=e.session;t.support.defineProperty?Object.defineProperty(this,"session",{value:i,enumerable:!0}):this.session=i,this.state=e.state,this.action=e.action,this.target=e.target,this.from=e.from,this.to=e.to,this.text=e.text,this.data=e.data,this.priority=e.priority,this.reliable=e.reliable,this.created=r.getDate(),this.forward=0}var n=t.GameState,r=t.JSUS;e.GameMsg=i,i.actions={},i.actions.SET="set",i.actions.GET="get",i.actions.SAY="say",i.targets={},i.targets.HI="HI",i.targets.HI_AGAIN="HI_AGAIN",i.targets.PCONNECT="PCONNECT",i.targets.PDISCONNECT="PDISCONNECT",i.targets.MCONNECT="MCONNECT",i.targets.MDISCONNECT="MDISCONNECT",i.targets.PLIST="PLIST",i.targets.MLIST="MLIST",i.targets.STATE="STATE",i.targets.TXT="TXT",i.targets.DATA="DATA",i.targets.REDIRECT="REDIRECT",i.targets.BYE="BYE",i.targets.ACK="ACK",i.targets.WARN="WARN",i.targets.ERR="ERR",i.IN="in.",i.OUT="out.",i.clone=function(e){return new i(e)},i.prototype.stringify=function(){return JSON.stringify(this)},i.prototype.toString=function(){var e=",	",t="\n",r='"',i=new n(this.state),s=this.created+e;return s+=this.id+e,s+=this.session+e,s+=this.action+e,s+=this.target+e,s+=this.from+e,s+=this.to+e,s+=r+this.text+r+e,s+=r+this.data+r+e,s+=this.reliable+e,s+=this.priority+t,s},i.prototype.toSMS=function(){var e=/\w+/,t=e.exec(this.created),n="["+this.from+"]->["+this.to+"]	";return n+="|"+this.action+"."+this.target+"|"+"	",n+=" "+this.text+" ",n},i.prototype.toInEvent=function(){return"in."+this.toEvent()},i.prototype.toOutEvent=function(){return"out."+this.toEvent()},i.prototype.toEvent=function(){return this.action+"."+this.target}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e){this.loop=e||{};for(var n in this.loop)if(this.loop.hasOwnProperty(n)){var e=this.loop[n].state;if("function"==typeof e){var s=r.clone(this.loop[n]);this.loop[n].state={1:s}}var o=r.size(this.loop[n].state),u=this.loop[n].rounds||1;i.push({rounds:u,steps:o})}t.support.getter?Object.defineProperty(this,"length",{set:function(){},get:this.size,configurable:!0}):this.length=null}var n=t.GameState,r=t.JSUS;e.GameLoop=s;var i=[];s.prototype.size=function(){return this.steps2Go(new n)},s.prototype.exist=function(e){return e?(e=new n(e),typeof this.loop[e.state]=="undefined"?(t.log("Unexisting state: "+e.state,"WARN"),!1):typeof this.loop[e.state]["state"][e.step]=="undefined"?(t.log("Unexisting step: "+e.step,"WARN"),!1):e.round>i[e.state-1].rounds?(t.log("Unexisting round: "+e.round+"Max round: "+i[e.state].rounds,"WARN"),!1):!0):!1},s.prototype.next=function(e){e=e?new n(e):t.game.state;if(e.state===0)return new n({state:1,step:1,round:1});if(!this.exist(e))return t.log("No next state of non-existing state: "+e,"WARN"),!1;var r=Number(e.state)-1;if(i[r].steps>e.step){var s=Number(e.step)+1;return new n({state:e.state,step:s,round:e.round})}if(i[r].rounds>e.round){var o=Number(e.round)+1;return new n({state:e.state,step:1,round:o})}if(i.length>e.state){var u=Number(e.state)+1;return new n({state:u,step:1,round:1})}return!1},s.prototype.previous=function(e){e=e?new n(e):t.game.state,this.exist(e)||t.log("No previous state of non-existing state: "+e,"WARN");var r=Number(e.state)-1;if(e.step>1){var s=Number(e.step)-1;return new n({state:e.state,step:s,round:e.round})}if(e.round>1){var o=Number(e.round)-1,s=i[r].steps;return new n({state:e.state,step:s,round:o})}if(e.state>1){var o=i[r-1].rounds,s=i[r-1].steps,u=r;return new n({state:u,step:s,round:o})}return!1},s.prototype.getName=function(e){return e=e?new n(e):t.game.state,this.exist(e)?this.loop[e.state].state[e.step].name:!1},s.prototype.getFunction=function(e){return e=e?new n(e):t.game.state,this.exist(e)?this.loop[e.state].state[e.step].state:!1},s.prototype.getAllParams=function(e){return e=e?new n(e):t.game.state,this.exist(e)?this.loop[e.state].state[e.step]:!1},s.prototype.jumpTo=function(e,t){if(!this.exist(e))return!1;if(!t)return e;var n=t>0?this.next:this.previous;for(var r=0;r<Math.abs(t);r++){e=n.call(this,e);if(!e)return!1}return e},s.prototype.steps2Go=function(e){e=e?new n(e):t.game.state;var r=0;while(e)r++,e=this.next(e);return r},s.prototype.toArray=function(){var e=new n,t=[];while(e){t.push(e.toString());var e=this.next(e)}return t},s.prototype.indexOf=function(e){return e?this.diff(e,new n):-1},s.prototype.diff=function(e,r){if(!e)return!1;e=new n(e);if(!r){if(!t.game.state)return!1;r=t.game.state}else r=new n(r);var i=0;while(r){if(n.compare(e,r)===0)return i;r=this.next(r),i++}return-1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function o(){}var n=t.GameMsg,r=t.GameState,i=t.Player,s=t.JSUS;e.GameMsgGenerator=o,o.create=function(e){var r={session:t.gsc.session,state:t.game.state,action:n.actions.SAY,target:n.targets.DATA,from:t.player.sid,to:"SERVER",text:null,data:null,priority:null,reliable:1};return e=s.merge(r,e),new n(e)},o.createHI=function(e,r,s){return e=e||t.player,e?(s=s||1,new n({session:t.gsc.session,state:t.game.state,action:n.actions.SAY,target:n.targets.HI,from:t.player.sid,to:r,text:new i(e)+" ready.",data:e,priority:null,reliable:s})):!1},o.saySTATE=function(e,t,r){return this.createSTATE(n.SAY,e,t,r)},o.setSTATE=function(e,t,r){return this.createSTATE(n.SET,e,t,r)},o.getSTATE=function(e,t,r){return this.createSTATE(n.GET,e,t,r)},o.createSTATE=function(e,i,s,o){return!e||!i?!1:(s=s||"SERVER",o=o||1,new n({session:t.gsc.session,state:t.game.state,action:e,target:n.targets.STATE,from:t.player.sid,to:s,text:"New State: "+r.stringify(i),data:i,priority:null,reliable:o}))},o.sayPLIST=function(e,t,r){return this.createPLIST(n.actions.SAY,e,t,r)},o.setPLIST=function(e,t,r){return this.createPLIST(n.actions.SET,e,t,r)},o.getPLIST=function(e,t,r){return this.createPLIST(n.actions.GET,e,t,r)},o.createPLIST=function(e,r,i,s){return r=r||!t.game||t.game.pl,!e||!r?!1:(i=i||"SERVER",s=s||1,new n({session:t.gsc.session,state:t.game.state,action:e,target:n.targets.PLIST,from:t.player.sid,to:i,text:"List of Players: "+r.length,data:r.pl,priority:null,reliable:s}))},o.createTXT=function(e,r,i){return e?(i=i||0,new n({session:t.gsc.session,state:t.game.state,action:n.actions.SAY,target:n.targets.TXT,from:t.player.sid,to:r,text:e,data:null,priority:null,reliable:i})):!1},o.sayDATA=function(e,t,r,i){return this.createDATA(n.actions.SAY,e,t,r,i)},o.setDATA=function(e,t,r,i){return this.createDATA(n.actions.SET,e,t,r,i)},o.getDATA=function(e,t,r,i){return this.createDATA(n.actions.GET,e,t,r,i)},o.createDATA=function(e,r,i,s,o){return e?(o=o||1,s=s||"data msg",new n({session:t.gsc.session,state:t.game.state,action:e,target:n.targets.DATA,from:t.player.sid,to:i,text:s,data:r,priority:null,reliable:o})):!1},o.createACK=function(e,r,i){if(!e)return!1;i=i||0;var s=new n({session:t.gsc.session,state:t.game.state,action:n.actions.SAY,target:n.targets.ACK,from:t.player.sid,to:r,text:"Msg "+e.id+" correctly received",data:e.id,priority:null,reliable:i});return e.forward&&(s.forward=1),s}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function f(e){e=e||{},u=[],t.support.defineProperty?Object.defineProperty(this,"buffer",{value:u,enumerable:!0}):this.buffer=u,a=null,t.support.defineProperty?Object.defineProperty(this,"session",{value:a,enumerable:!0}):this.session=a,this.io=null,this.url=null,this.servername=null}var r=t.GameMsg,i=t.GameState,s=t.Player,o=t.GameMsgGenerator,u,a;e.GameSocketClient=f,f.prototype.getSession=function(e){if(!e)return!1;var n=!1;return"function"==typeof t.session&&(n=t.session(e.session)),n?n:!1},f.prototype.startSession=function(e){var t={id:e.data,sid:e.data};return this.createPlayer(t),a=e.session,!0},f.prototype.restoreSession=function(e,n){if(!e)return;var r="nodeGame session recovery: ";t.log("Starting session recovery "+n,"INFO",r),t.emit("NODEGAME_RECOVERY",n),n=n||e.player.sid,this.session=e.id,a.player.sid=n,this.createPlayer(a.player),t.game.memory=a.memory,t.goto(a.state);if(!e.history)return t.log("No event history was found to recover","WARN",r),!0;t.log("Recovering "+a.history.length+" events","DEBUG",r),t.events.history.importDB(a.history);var s=(new i(a.state)).toHash("S.s.r");if(!t.events.history.state)return t.log("No old events to re-emit were found during session recovery","DEBUG",r),!0;if(!t.events.history.state[s])return t.log("The current state "+s+" has no events to re-emit","DEBUG",r),!0;var o=["LOG","STATECHANGE","WINDOW_LOADED","BEFORE_LOADING","LOADED","in.say.STATE","UPDATED_PLIST","NODEGAME_READY","out.say.STATE","out.set.STATE","in.say.PLIST","STATEDONE","out.say.HI"],u=t.events.history.state[s];u.select("event","in",o).remove();if(!u.length)return t.log("The current state "+s+" has no valid events to re-emit","DEBUG",r),!0;var f=function(){t.log("Re-emitting "+u.length+" events","DEBUG",r),u.each(function(e){JSUS.in_array(e.event,o)||t.emit(e.event,e.p1,e.p2,e.p3)})};return t.game.isReady()?f.call(t.game):t.on("LOADED",function(){f.call(t.game)}),!0},f.prototype.createPlayer=function(e){e=new s(e);if(t.conf&&t.conf.player){var n=t.conf.player;for(var r in n)if(n.hasOwnProperty(r)){if(JSUS.in_array(r,["id","sid","ip"]))continue;t.support.defineProperty?Object.defineProperty(e,r,{value:n[r],enumerable:!0}):e[r]=n[r]}}return t.support.defineProperty?Object.defineProperty(t,"player",{value:e,enumerable:!0}):t.player=e,e},f.prototype.connect=function(e){return e=e||{},e.url?(this.url=e.url,t.log("connecting to "+e.url),this.io=n.connect(e.url,e.io),this.attachFirstListeners(this.io),this.io):(t.log("cannot connect to empty url.","ERR"),!1)};var l=function(e,n){e=e||"Generic error while parsing a game message";var r=n?e+": "+n:e;return t.log(r,"ERR"),t.emit("LOG","E: "+r),!1};f.prototype.secureParse=function(e){var n;try{n=r.clone(JSON.parse(e)),t.info(n,"R: ")}catch(i){return l("Malformed msg received",i)}return this.session&&n.session!==this.session?l("Local session id does not match incoming message session id"):n},f.prototype.clearBuffer=function(){var e=u.length;for(var n=0;n<e;n++){var r=this.buffer.shift();r&&(t.emit(r.toInEvent(),r),t.log("Debuffered "+r,"DEBUG"))}},f.prototype.attachFirstListeners=function(e){var n=this;e.on("connect",function(i){var s="nodeGame: connection open";t.log(s),e.on("message",function(i){var i=n.secureParse(i);if(i&&i.target==="HI"){n.servername=i.from,n.serverid=i.from;var s=n.getSession(i);if(s){n.restoreSession(s,e.id),n.attachMsgListeners(e,i.session);var i=t.msg.create({action:r.actions.SAY,target:"HI_AGAIN",data:t.player});n.send(i)}else n.startSession(i),n.attachMsgListeners(e,i.session),n.sendHI(t.player,"ALL");t.emit("out.say.HI")}})}),e.on("disconnect",function(){t.session.store(),t.log("closed")})},f.prototype.attachMsgListeners=function(e,n){var r=this;t.log("Attaching FULL listeners"),e.removeAllListeners("message"),e.on("message",function(e){var e=r.secureParse(e);e&&(t.game&&t.game.isReady()?t.emit(e.toInEvent(),e):(t.log("Buffering: "+e,"DEBUG"),u.push(e)))}),t.emit("NODEGAME_READY")},f.prototype.sendHI=function(e,n){e=e||t.player,n=n||"SERVER";var r=t.msg.createHI(e,n);this.send(r)},f.prototype.sendSTATE=function(e,n,r){var i=t.msg.createSTATE(e,n,r);this.send(i)},f.prototype.sendTXT=function(e,n){var r=t.msg.createTXT(e,n);this.send(r)},f.prototype.sendDATA=function(e,n,i,s){e=e||r.say,i=i||"SERVER",s=s||"DATA";var o=t.msg.createDATA(e,n,i,s);this.send(o)},f.prototype.send=function(e){this.io.send(e.stringify()),t.log("S: "+e),t.emit("LOG","S: "+e.toSMS())}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:module.parent.exports.io),function(e,t){function s(e,t,n){e=e||{},e.update||(e.update={}),e.update.indexes=!0,r.call(this,e,t,n),this.c("state",o.compareState),this.player||this.h("player",function(e){return e.player}),this.state||this.h("state",function(e){return i.toHash(e.state,"S.s.r")}),this.key||this.h("key",function(e){return e.key})}function o(e){this.state=e.state,this.player=e.player,this.key=e.key,this.value=e.value,this.time=Date?Date.now():null}var n=t.JSUS,r=t.NDDB,i=t.GameState;s.prototype=n.clone(r.prototype),s.prototype.constructor=s,e.GameDB=s,e.GameBit=o,s.prototype.add=function(e,n,r,i){return e?(i=i||t.game.state,r=r||t.player,this.insert(new o({player:r,key:e,value:n,state:i})),!0):!1},o.prototype.toString=function(){return this.player+", "+i.stringify(this.state)+", "+this.key+", "+this.value},o.equals=function(e,t,n){return!e||!t?!1:(n=n||!1,o.comparePlayer(e,t)!==0?!1:o.compareState(e,t)!==0?!1:o.compareKey(e,t)!==0?!1:n&&e.value&&o.compareValue(e,t)!==0?!1:!0)},o.comparePlayer=function(e,t){return!e&&!t?0:e?t?e.player===t.player?0:e.player>t.player?1:-1:-1:1},o.compareState=function(e,t){return i.compare(e.state,t.state)},o.compareKey=function(e,t){return!e&&!t?0:e?t?e.key===t.key?0:e.key<t.key?-1:1:-1:1},o.compareValue=function(e,t){return!e&&!t?0:e?t?n.equals(e.value,t.value)?0:e.value>t.value?1:-1:-1:1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function d(e){e=e||{},f=e.name||"A nodeGame game",t.support.defineProperty?Object.defineProperty(this,"name",{value:f,enumerable:!0}):this.name=f,l=e.description||"No Description",t.support.defineProperty?Object.defineProperty(this,"description",{value:l,enumerable:!0}):this.description=l,c=new u(e.loop||e.loops),t.support.defineProperty?Object.defineProperty(this,"gameLoop",{value:c,enumerable:!0}):this.gameLoop=c,h=new s,t.support.defineProperty?Object.defineProperty(this,"pl",{value:h,enumerable:!0,configurable:!0,writable:!0}):this.pl=h,p=new s,t.support.defineProperty?Object.defineProperty(this,"ml",{value:h,enumerable:!0,configurable:!0,writable:!0}):this.ml=p,t.support.getter?Object.defineProperty(this,"ready",{set:function(){},get:this.isReady,enumerable:!0}):this.ready=null,this.observer="undefined"!=typeof e.observer?e.observer:!1,this.auto_step="undefined"!=typeof e.auto_step?e.auto_step:!0,this.auto_wait="undefined"!=typeof e.auto_wait?e.auto_wait:!1,this.solo_mode="undefined"!=typeof e.solo_mode?e.solo_mode:!1,this.minPlayers=e.minPlayers||1,this.maxPlayers=e.maxPlayers||1e3,e.init&&(this.init=e.init),this.memory=new i,this.player=null,this.state=new n}var n=t.GameState,r=t.GameMsg,i=t.GameDB,s=t.PlayerList,o=t.Player,u=t.GameLoop,a=t.JSUS;e.Game=d;var f,l,c,h,p;d.prototype.init=function(){},d.prototype.pause=function(){this.state.paused=!0},d.prototype.resume=function(){this.state.paused=!1},d.prototype.next=function(e){return e?this.gameLoop.jumpTo(this.state,Math.abs(e)):this.gameLoop.next(this.state)},d.prototype.previous=function(e){return e?this.gameLoop.jumpTo(this.state,-Math.abs(e)):this.gameLoop.previous(this.state)},d.prototype.jumpTo=function(e){if(!e)return!1;var t=this.gameLoop.jumpTo(this.state,e);return t?this.updateState(t):!1},d.prototype.publishState=function(){if(!this.observer){var e=r.OUT+r.actions.SAY+".STATE";t.emit(e,this.state,"ALL")}t.emit("STATECHANGE"),t.log("New State = "+new n(this.state),"DEBUG")},d.prototype.updateState=function(e){t.log("New state is going to be "+new n(e),"DEBUG"),this.step(e)!==!1?(this.paused=!1,this.state.is=n.iss.LOADED,this.isReady()&&t.emit("LOADED")):(t.log("Error in stepping","ERR"),t.emit("TXT","State was not updated"))},d.prototype.step=function(e){e=e||this.next();if(e){var r=this.gameLoop.getFunction(e);if(r)return t.events.clearState(this.state),e.is=n.iss.LOADING,this.state=e,this.publishState(),r.call(t.game)}return!1},d.prototype.isReady=function(){return this.state.is<n.iss.LOADED?!1:t.window?t.window.state>=n.iss.LOADED?!0:!1:!0}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.EventEmitter,n=e.GameSocketClient,r=e.GameState,i=e.GameMsg,s=e.Game,o=e.Player,u=e.GameSession;e.actions=i.actions,e.IN=i.IN,e.OUT=i.OUT,e.targets=i.targets,e.states=r.iss,e.events=new t,e.msg=e.GameMsgGenerator,e.socket=e.gsc=new n,e.env=function(t,n,r,i){if(!t||!n||!e.env[t])return;r=r||e,i=i||[],n.apply(r,i)},e._analyzeConf=function(t){if(!t)return e.log("Invalid configuration object found.","ERR"),!1;if(!t.host){if("undefined"!=typeof window){if("undefined"!=typeof window.location)var n=window.location.href}else var n=t.url;if(n){var r=n.split("/").slice(0,-2);r.length>1&&(t.host=r.join("/"))}}t.host&&t.host.lastIndexOf("/")!==n.length&&(t.host=t.host+"/"),"undefined"!=typeof t.verbosity&&(e.verbosity=t.verbosity);if("undefined"!=typeof t.env)for(var i in t.env)t.env.hasOwnProperty(i)&&(e.env[i]=t.env[i]);return t.events||(t.events={}),"undefined"===t.events.history&&(t.events.history=!1),"undefined"===t.events.dumpEvents&&(t.events.dumpEvents=!1),this.conf=t,t},e.on=function(t,n){!e.game||!e.game.state||r.compare(e.game.state,new r,!0)===0?e.events.add(t,n):e.events.addLocal(t,n)},e.once=function(t,n){e.on(t,n),e.on(t,function(t,n){e.events.remove(t,n)})},e.removeListener=function(t,n){return e.events.remove(t,n)},e.connect=e.play=function(t,n){e._analyzeConf(t),e.game=new s(n),e.emit("NODEGAME_GAME_CREATED"),e.game.init.call(e.game),e.socket.connect(t),e.log("game loaded..."),e.log("ready.")},e.emit=function(t,n,r,i){e.events.emit(t,n,r,i)},e.say=function(t,n,r){e.events.emit("out.say.DATA",t,r,n)},e.set=function(t,n){e.events.emit("out.set.DATA",n,null,t)},e.get=function(t,n){e.events.emit("out.get.DATA",t);var r=function(i){i.text===t&&(n.call(e.game,i.data),e.events.remove("in.say.DATA",r))};e.on("in.say.DATA",r)},e.replay=function(t){t&&e.game.memory.clear(!0),e.goto(new r({state:1,step:1,round:1}))},e.goto=function(t){e.game.updateState(t)},e.redirect=function(t,n){if(!t||!n)return!1;var r=e.msg.create({target:e.targets.REDIRECT,data:t,to:n});return e.socket.send(r),!0},e.onTXT=function(t){e.on("in.say.TXT",function(n){t.call(e.game,n)})},e.onDATA=function(t,n){e.on("in.say.DATA",function(r){t&&r.text===t&&n.call(e.game,r)}),e.on("in.set.DATA",function(r){t&&r.text===t&&n.call(e.game,r)})},e.onSTATE=function(t){e.on("in.set.STATE",function(n){t.call(e.game,n)})},e.onPLIST=function(t){e.on("in.set.PLIST",function(n){t.call(e.game,n)}),e.on("in.say.PLIST",function(n){t.call(e.game,n)})},e.DONE=function(t){e.emit("DONE",t)},e.TXT=function(t,n){e.emit("out.say.TXT",t,n)},e.random={},e.random.emit=function(t,n){var n=n||6e3;setTimeout(function(t){e.emit(t)},Math.random()*n,t)},e.random.exec=function(e,t){var t=t||6e3;setTimeout(function(e){e.call()},Math.random()*t,e)},e.log(e.version+" loaded","ALWAYS")}("undefined"!=typeof node?node:module.parent.exports),function(e){if(!e)return console.log("nodeGame not found. Cannot add incoming listeners"),!1;var t=e.GameMsg,n=e.GameState,r=e.PlayerList,i=e.Player,s=t.actions.SAY+".",o=t.actions.SET+".",u=t.actions.GET+".",a=t.IN;e.on(a+s+"PCONNECT",function(t){if(!t.data)return;e.game.pl.add(new i(t.data)),e.emit("UPDATED_PLIST"),e.game.pl.checkState()}),e.on(a+s+"PDISCONNECT",function(t){if(!t.data)return;e.game.pl.remove(t.data.id),e.emit("UPDATED_PLIST"),e.game.pl.checkState()}),e.on(a+s+"MCONNECT",function(t){if(!t.data)return;e.game.ml.add(new i(t.data)),e.emit("UPDATED_MLIST")}),e.on(a+s+"MDISCONNECT",function(t){if(!t.data)return;e.game.ml.remove(t.data.id),e.emit("UPDATED_MLIST")}),e.on(a+s+"PLIST",function(t){if(!t.data)return;e.game.pl=new r({},t.data),e.emit("UPDATED_PLIST")}),e.on(a+s+"MLIST",function(t){if(!t.data)return;e.game.ml=new r({},t.data),e.emit("UPDATED_MLIST")}),e.on(a+u+"DATA",function(n){n.text==="LOOP"&&e.socket.sendDATA(t.actions.SAY,e.game.gameLoop,n.from,"GAME")}),e.on(a+o+"STATE",function(t){e.game.memory.add(t.text,t.data,t.from)}),e.on(a+o+"DATA",function(t){e.game.memory.add(t.text,t.data,t.from)}),e.on(a+s+"STATE",function(t){e.socket.serverid&&t.from===e.socket.serverid,e.game.pl.exist(t.from)?(e.game.pl.updatePlayerState(t.from,t.data),e.emit("UPDATED_PLIST"),e.game.pl.checkState()):e.game.updateState(t.data)}),e.on(a+s+"REDIRECT",function(t){if(!t.data)return;if("undefined"==typeof window||!window.location)return e.log("window.location not found. Cannot redirect","err"),!1;e.emit("REDIRECTING...",t.data),window.location=t.data}),e.log("incoming listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e){if(!e)return console.log("nodeGame not found. Cannot add outgoing listeners"),!1;var t=e.GameMsg,n=e.GameState,r=t.actions.SAY+".",i=t.actions.SET+".",s=t.actions.GET+".",o=t.OUT;e.on(o+r+"HI",function(){e.game.auto_step?e.game.updateState(e.game.next()):(e.game.state.is=n.iss.LOADED,e.socket.sendSTATE(t.actions.SAY,e.game.state))}),e.on(o+r+"STATE",function(n,r){e.socket.sendSTATE(t.actions.SAY,n,r)}),e.on(o+r+"TXT",function(t,n){e.socket.sendTXT(t,n)}),e.on(o+r+"DATA",function(n,r,i){e.socket.sendDATA(t.actions.SAY,n,r,i)}),e.on(o+i+"STATE",function(n,r){e.socket.sendSTATE(t.actions.SET,n,r)}),e.on(o+i+"DATA",function(n,r,i){e.socket.sendDATA(t.actions.SET,n,r,i)}),e.on(o+s+"DATA",function(n,r,i){e.socket.sendDATA(t.actions.GET,n,r,n)}),e.log("outgoing listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e){if(!e)return console.log("nodeGame not found. Cannot add internal listeners"),!1;var t=e.GameMsg,n=e.GameState,r=t.actions.SAY+".",i=t.actions.SET+".",s=t.actions.GET+".",o=t.IN,u=t.OUT;e.on("STATEDONE",function(){if(e.game.solo_mode)return;if(e.game.auto_step&&!e.game.observer){e.log("We play AUTO","DEBUG");var t="undefined"!==e.game.minPlayers?e.game.minPlayers-e.game.pl.count():0;e.log("Additional player required: "+t>0?MorePlayers:0,"DEBUG"),t>0?(e.emit("OUT.say.TXT",t+" player/s still needed to play the game"),e.log(t+" player/s still needed to play the game")):(e.emit("OUT.say.TXT",e.game.minPlayers+" players ready. Game can proceed"),e.log(e.game.pl.count()+" players ready. Game can proceed"),e.game.updateState(e.game.next()))}else e.log("Waiting for monitor to step","DEBUG")}),e.on("DONE",function(t,r,i){var s=!0,o=e.game.gameLoop.getAllParams(e.game.state).done;o&&(s=o.call(e.game,t,r,i));if(!s)return;e.game.state.is=n.iss.DONE,e.emit("BEFORE_DONE"),e.game.auto_wait&&e.window&&e.emit("WAITING..."),e.game.publishState(),e.game.solo_mode&&e.game.updateState(e.game.next())}),e.on("PAUSE",function(t){e.game.state.paused=!0,e.game.publishState()}),e.on("WINDOW_LOADED",function(){e.game.ready&&e.emit("LOADED")}),e.on("GAME_LOADED",function(){e.game.ready&&e.emit("LOADED")}),e.on("LOADED",function(){e.emit("BEFORE_LOADING"),e.game.state.is=n.iss.PLAYING,e.socket.clearBuffer()}),e.log("internal listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){e=e||{},this.status=n.UNINITIALIZED,this.options=e,this.timer=null,this.timeLeft=null,this.timePassed=0,this.update=1e3,this.timeup="TIMEUP",this.hooks=[],this.init(),this.listeners()}e.GameTimer=n,JSUS=t.JSUS,n.STOPPED=-5,n.PAUSED=-3,n.UNINITIALIZED=-1,n.INITIALIZED=0,n.LOADING=3,n.RUNNING=5,n.prototype.init=function(e){e=e||this.options,this.status=n.UNINITIALIZED,this.timer&&clearInterval(this.timer),this.milliseconds=e.milliseconds||0,this.timeLeft=this.milliseconds,this.timePassed=0,this.update=e.update||1e3,this.timeup=e.timeup||"TIMEUP";if(e.hooks)for(var t=0;t<e.hooks.length;t++)this.addHook(e.hooks[t]);this.status=n.INITIALIZED},n.prototype.fire=function(e){if(!e&&!e.hook)return;var n=e.hook||e;if("function"==typeof n){var r=e.ctx||t.game;n.call(r)}else t.emit(n)},n.prototype.start=function(){this.status=n.LOADING;if(this.options.milliseconds===0){t.emit(this.timeup);return}var e=this;this.timer=setInterval(function(){e.status=n.RUNNING,t.log("interval started: "+e.timeLeft,"DEBUG","GameTimer: "),e.timePassed=e.timePassed+e.update,e.timeLeft=e.milliseconds-e.timePassed;for(var r=e.hooks.length;r>0;r--)e.fire(e.hooks[r-1]);e.timeLeft<=0&&(e.stop(),e.fire(e.timeup),t.log("time is up: "+e.timeup,"DEBUG","GameTimer: "))},this.update)},n.prototype.addHook=function(e,n){if(!e)return;var n=n||t.game;if(e.hook){n=e.ctx||n;var e=e.hook}this.hooks.push({hook:e,ctx:n})},n.prototype.pause=function(){this.status>0&&(this.status=n.PAUSED,clearInterval(this.timer))},n.prototype.resume=function(){if(this.status!==n.PAUSED)return;var e=JSUS.extend({milliseconds:this.milliseconds-this.timePassed},this.options);this.restart(e)},n.prototype.stop=function(){if(this.status===n.UNINITIALIZED)return;if(this.status===n.INITIALIZED)return;if(this.status===n.STOPPED)return;this.status=n.STOPPED,clearInterval(this.timer),this.timePassed=0,this.timeLeft=null},n.prototype.restart=function(e){this.init(e),this.start()},n.prototype.listeners=function(){var e=this}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){this.triggers=[],this.options=e||{};var r=n.first;Object.defineProperty(this,"returnAt",{set:function(e){return!e||e!==n.first&&e!==n.last?(t.log("Invalid returnAt type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!0,enumerable:!0}),Object.defineProperty(this,"length",{set:function(){},get:function(){return this.triggers.length},configurable:!0}),this.init()}e.TriggerManager=n,n.first="first",n.last="last",n.prototype.init=function(e){this.options=e||this.options;if(this.options.returnAt===n.first||this.options.returnAt===n.last)this.returnAt=this.options.returnAt;this.resetTriggers()},n.prototype.initTriggers=function(e){if(!e)return;e instanceof Array||(e=[e]);for(var t=0;t<e.length;t++)this.triggers.push(e[t])},n.prototype.resetTriggers=function(){this.triggers=[],this.initTriggers(this.options.triggers)},n.prototype.clear=function(e){return e?(this.triggers=[],e):(t.log("Do you really want to clear the current TriggerManager obj? Please use clear(true)","WARN"),!1)},n.prototype.addTrigger=function(e,t){return e?"function"!=typeof e?!1:(t?this.triggers.splice(t,0,e):this.triggers.push(e),!0):!1},n.prototype.removeTrigger=function(e){if(!e)return!1;for(var t=0;t<this.triggers.length;t++)if(this.triggers[t]==e)return this.triggers.splice(t,1);return!1},n.prototype.pullTriggers=function(e){if("undefined"==typeof e)return;if(!this.length)return e;for(var t=this.triggers.length;t>0;t--){var r=this.triggers[t-1].call(this,e);if("undefined"!=typeof r&&this.returnAt===n.first)return r}return"undefined"!=typeof r?r:e},n.prototype.size=function(){return this.triggers.length}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.JSUS,n=e.NDDB,r=e.store,i="nodegame_";e.session=function(t){if(!t){var n={id:e.gsc.session,player:e.player,memory:e.game.memory,state:e.game.state,game:e.game.name,history:undefined};if(e.events.history||e.events.history.length)n.history=e.events.history.fetch();return n}return e.session.isEnabled()?e.store(i+t):!1},e.session.isEnabled=function(){return e.store?e.store.isPersistent():!1},e.session.store=function(){if(!e.session.isEnabled())return e.log("Could not save the session"),!1;var t=e.session(),n=t.id;return e.store(i+n,t),e.log("Session saved with id "+n),!0}}("undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){e=e||{},this.players=e.players}function i(e){t.TriggerManager.call(this,e),t.pool=new t.PlayerList,t.game.room={};var n=this,i=function(){console.log("CAPTURED");var e=n.pullTriggers();if(!e)return;r.isArray(e)||(e=[e]);var i,s,o=0;for(i=0;i<e.length;i++)s=e[i].name||o++,t.game.room[s]=new Game(e[i]),t.game.room[s].step()},s=function(){t.onPLIST(function(){i()})},o;Object.defineProperty(this,"onConnect",{set:function(e){e===!1?(t.removeListener("in.say.PLIST",i),t.removeListener("in.set.PLIST",i)):e===!0&&t.onPLIST(i),o=e},get:function(){return o},configurable:!0});var u,a;Object.defineProperty(this,"onTimeout",{set:function(e){e?"numeric"==typeof e&&(u&&clearTimeout(u),a=e,u=setTimeout(i)):(clearTimeout(u),a=e,u=!1)},get:function(){return a},configurable:!0});var f,l;Object.defineProperty(this,"onInterval",{set:function(e){e?"numeric"==typeof e&&(f&&clearInterval(f),f=setInterval(i),l=e):(clearInterval(f),l=e,f=!1)},get:function(){return l},configurable:!0}),this.init(e)}if(!t.TriggerManager)throw new Error("node.TriggerManager not found. Aborting");var r=t.JSUS;e.WaitingRoom=i,i.prototype=new t.TriggerManager,i.prototype.constructor=i,i.defaults={},i.prototype.init=function(e){e=e||{},this.onConnect=e.onConnect||!0,this.onTimeout=e.onTimeout||!1,this.onInterval=e.onInterval||!1,this.addTrigger(function(){return new n({players:t.pool,game:e.loops})}),e.minPlayers&&e.maxPlayers&&this.addTrigger(function(){if(t.pool.length<e.minPlayers)return!1;if(t.pool.length>e.maxPlayers){var r=t.pool.shuffle().limit(e.maxPlayers);return new n({players:r,game:e.loops})}return new n({players:t.pool,game:e.loops})}),e.minPlayers&&this.addTrigger(function(){return t.pool.length<e.minPlayers?!1:new n({players:t.pool,game:e.loops})}),e.maxPlayers&&this.addTrigger(function(){if(t.pool.length>e.maxPlayers){var r=t.pool.shuffle().limit(e.maxPlayers);return new n({players:r,game:e.loops})}}),e.nPlayers&&this.addTrigger(function(){if(t.pool.length===e.nPlayers)return new n({players:t.pool,game:e.loops})})},i.prototype.criteria=function(e,t){this.addTrigger(e,t)},i.prototype.setInterval=function(e){e||clearInterval(this.interval),this.interval&&clearInterval(this.interval),this.interval=setInterval(this.pullTriggers,e)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function f(){var n=this;if("undefined"==typeof e)throw new Error("nodeWindow: no DOM found. Are we in a browser? Aborting.");"undefined"==typeof t&&t.log("nodeWindow: nodeGame not found","ERR"),t.log("nodeWindow: loading..."),this.frame=null,this.mainframe="mainframe",this.root=null,this.conf={},this.state=s.iss.LOADED,this.areLoading=0,this.init()}var n=t.JSUS,r=t.Player,i=t.PlayerList,s=t.GameState,o=t.GameMsg,u=t.GameMsgGenerator,a=n.get("DOM");if(!a)throw new Error("DOM object not found. Aborting");f.prototype=a,f.prototype.constructor=f,f.defaults={},f.defaults.promptOnleave=!0,f.defaults.noEscape=!0,f.prototype.init=function(e){e=e||{},this.conf=n.merge(f.defaults,e),this.conf.promptOnleave?this.promptOnleave():this.conf.promptOnleave===!1&&this.restoreOnleave(),this.conf.noEscape?this.noEscape():this.conf.noEscape===!1&&this.restoreEscape()},f.prototype.getElementById=function(e){var t=null;return this.frame&&this.frame.getElementById&&(t=this.frame.getElementById(e)),t||(t=document.getElementById(e)),t},f.prototype.getElementsByTagName=function(e){return this.frame?this.frame.getElementsByTagName(e):document.getElementsByTagName(e)},f.prototype.setup=function(n){this.root||(this.root=document.body);switch(n){case"MONITOR":t.widgets.append("NextPreviousState"),t.widgets.append("GameSummary"),t.widgets.append("StateDisplay"),t.widgets.append("StateBar"),t.widgets.append("DataBar"),t.widgets.append("MsgBar"),t.widgets.append("GameBoard"),t.widgets.append("ServerInfoDisplay"),t.widgets.append("Wall"),t.conf.host&&this.addCSS(document.body,t.conf.host+"/stylesheets/monitor.css");break;case"PLAYER":this.header=this.generateHeader();var r=this.addIFrame(this.root,"mainframe");t.game.vs=t.widgets.append("VisualState",this.header),t.game.timer=t.widgets.append("VisualTimer",this.header),t.game.sd=t.widgets.append("StateDisplay",this.header),t.widgets.append("WaitScreen"),t.conf.host&&this.addCSS(document.body,t.conf.host+"/stylesheets/player.css"),this.frame=e.frames[this.mainframe];var i=this.getBlankPage();this.conf.noEscape,e.frames[this.mainframe].src=i}},f.prototype.load=f.prototype.loadFrame=function(n,r,i){if(!n)return;i=i||this.mainframe,this.state=s.iss.LOADING,this.areLoading++;var o=this,u=document.getElementById(i);u.onload=function(){o.conf.noEscape,o.updateStatus(r,i)},e.frames[i].location=n,e.frames[i].window.node=t},f.prototype.updateStatus=function(n,r){this.frame=e.frames[r].document,n&&n.call(t.game),this.areLoading--,this.areLoading===0?(this.state=s.iss.LOADED,t.emit("WINDOW_LOADED")):t.log("Attempt to update state, before the window object was loaded","DEBUG")},f.prototype.generateHeader=function(){return this.header&&(this.header.innerHTML="",this.header=null),this.addElement("div",this.root,"gn_header")},f.prototype._write=a.write,f.prototype._writeln=a.writeln,f.prototype.write=function(e,n){var n=n||this.getScreen();return n?this._write(n,e):(t.log("Could not determine where writing","ERR"),!1)},f.prototype.writeln=function(e,n,r){var n=n||this.getScreen();return n?this._writeln(n,e,r):(t.log("Could not determine where writing","ERR"),!1)},f.prototype.toggleInputs=function(e,t){if("undefined"!=typeof e)var n=this.getElementById(e);if("undefined"==typeof n)var n=this.frame.body;var r=["button","select","textarea","input"],i=0;for(;i<r.length;i++){var s=n.getElementsByTagName(r[i]),o=0,u=s.length;for(;o<u;o++)state="undefined"!=typeof t?t:s[o].disabled?!1:!0,state?s[o].disabled=state:s[o].removeAttribute("disabled")}},f.prototype._generateRoot=function(e,t){var e=e||document.body||document.lastElementChild;return e||(this.addElement("body",document),e=document.body),this.root=this.addElement("div",e,t),this.root},f.prototype.generateNodeGameRoot=function(e){return this._generateRoot(e,"nodegame")},f.prototype.generateRandomRoot=function(e,t){return this._generateRoot(e,this.generateUniqueId())},f.prototype.getEventButton=function(e,n,r,i){if(!e)return;var s=this.getButton(r,n,i);return s.onclick=function(){t.emit(e)},s},f.prototype.addEventButton=function(e,t,n,r,i){if(!e)return;if(!n)var n=this.getScreen();var s=this.getEventButton(e,t,r,i);return n.appendChild(s)},f.prototype.getRecipientSelector=function(e){var t=document.createElement("select");return"undefined"!=typeof e&&(t.id=e),this.addStandardRecipients(t),t},f.prototype.addRecipientSelector=function(e,t){if(!e)return!1;var n=this.getRecipientSelector(t);return e.appendChild(n)},f.prototype.addStandardRecipients=function(e){var t=document.createElement("option");t.value="ALL",t.appendChild(document.createTextNode("ALL")),e.appendChild(t);var t=document.createElement("option");t.value="SERVER",t.appendChild(document.createTextNode("SERVER")),e.appendChild(t)},f.prototype.populateRecipientSelector=function(e,t){if("object"!=typeof t||"object"!=typeof e)return;this.removeChildrenFromNode(e),this.addStandardRecipients(e);var r,i;r=t.db||t,n.each(r,function(t){i=document.createElement("option"),i.value=t.id,i.appendChild(document.createTextNode(t.name||t.id)),e.appendChild(i)})},f.prototype.getActionSelector=function(e){var n=document.createElement("select");return"undefined"!=typeof e&&(n.id=e),this.populateSelect(n,t.actions),n},f.prototype.addActionSelector=function(e,t){if(!e)return;var n=this.getActionSelector(t);return e.appendChild(n)},f.prototype.getTargetSelector=function(e){var n=document.createElement("select");return"undefined"!=typeof e&&(n.id=e),this.populateSelect(n,t.targets),n},f.prototype.addTargetSelector=function(e,t){if(!e)return;var n=this.getTargetSelector(t);return e.appendChild(n)},f.prototype.getStateSelector=function(e){var t=this.getTextInput(e);return t},f.prototype.addStateSelector=function(e,t){if(!e)return;var n=this.getStateSelector(t);return e.appendChild(n)},f.prototype.generateUniqueId=function(e){var t=""+(e||n.randomInt(0,1e3)),r=this.getElementById(t);while(r)t=""+e+"_"+n.randomInt(0,1e3),r=this.getElementById(t);return t},f.prototype.noEscape=function(t){t=t||e,t.document.onkeydown=function(t){var n=e.event?event.keyCode:t.keyCode;if(n===27)return!1}},f.prototype.restoreEscape=function(t){t=t||e,t.document.onkeydown=null},f.prototype.promptOnleave=function(t,n){t=t||e,n="undefined"==typeof n?this.conf.textOnleave:n,t.onbeforeunload=function(t){return t=t||e.event,t&&(t.returnValue=n),n}},f.prototype.restoreOnleave=function(t){t=t||e,t.onbeforeunload=null},f.prototype.getScreen=function(){var e=this.frame;return e?e=this.frame.body||e:e=document.body||document.lastElementChild,e},f.prototype.getFrame=function(){return this.frame=e.frames.mainframe.document},t.window=new f,"undefined"!=typeof e&&(e.W=t.window)}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){if(!e)return console.log("nodegame-window: node object not found."),!1;if(!t)return e.err("window object not found.","nodegame-window"),!1;e.on("NODEGAME_GAME_CREATED",function(){t.init(e.conf.window)}),e.on("HIDE",function(n){var r=t.getElementById(n);if(!r){e.log("Cannot hide element "+n);return}r.style.visibility="hidden"}),e.on("SHOW",function(n){var r=t.getElementById(n);if(!r){e.log("Cannot show element "+n);return}r.style.visibility="visible"}),e.on("TOGGLE",function(n){var r=t.getElementById(n);if(!r){e.log("Cannot toggle element "+n);return}r.style.visibility==="visible"?r.style.visibility="hidden":r.style.visibility="visible"}),e.on("INPUT_DISABLE",function(e){t.toggleInputs(e,!0)}),e.on("INPUT_ENABLE",function(e){t.toggleInputs(e,!1)}),e.on("INPUT_TOGGLE",function(e){t.toggleInputs(e)}),e.log("node-window: listeners added")}("undefined"!=typeof node?node:undefined,"undefined"!=typeof node.window?node.window:undefined),function(e){function t(e){this.canvas=e,this.ctx=e.getContext("2d"),this.centerX=e.width/2,this.centerY=e.height/2,this.width=e.width,this.height=e.height}e.Canvas=t,t.prototype={constructor:t,drawOval:function(e){var t=e.x/e.scale_x,n=e.y/e.scale_y,r=e.radius||100;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.scale(e.scale_x,e.scale_y),this.ctx.beginPath(),this.ctx.arc(t,n,r,0,Math.PI*2,!1),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},drawLine:function(e){var t=e.x,n=e.y,r=e.length,i=e.angle,s=-Math.cos(i)*r+e.x,o=Math.sin(i)*r+e.y;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(s,o),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},scale:function(e,t){this.ctx.scale(e,t),this.centerX=this.canvas.width/2/e,this.centerY=this.canvas.height/2/t},clear:function(){this.ctx.clearRect(0,0,this.width,this.height);var e=this.canvas.width;this.canvas.width=1,this.canvas.width=e}}}(node.window),function(e,t,n){function o(e){this.options=e||{},this.tm=new s,this.init(this.options)}function u(e){e=e||{},this.content="undefined"!=typeof e.content?e.content:"",this.className="undefined"!=typeof e.style?e.style:null}var r=t.document,i=n.JSUS,s=n.TriggerManager;e.HTMLRenderer=o,e.HTMLRenderer.Entity=u,o.prototype.init=function(e){e=e||this.options,this.options=e,this.reset(),e.returnAt&&(this.tm.returnAt=e.returnAt),e.pipeline&&this.tm.initTriggers(e.pipeline)},o.prototype.reset=function(){this.clear(!0),this.addDefaultPipeline()},o.prototype.addDefaultPipeline=function(){this.tm.addTrigger(function(e){return r.createTextNode(e.content)}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&"object"==typeof e.content){var t=r.createElement("div");for(var n in e.content)if(e.content.hasOwnProperty(n)){var i=n+":	"+e.content[n];t.appendChild(r.createTextNode(i)),t.appendChild(r.createElement("br"))}return t}}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&e.content.parse&&"function"==typeof e.content.parse){var t=e.content.parse();if(i.isElement(t)||i.isNode(t))return t}}),this.tm.addTrigger(function(e){if(!e)return;if(i.isElement(e.content)||i.isNode(e.content))return e.content})},o.prototype.clear=function(e){return this.tm.clear(e)},o.prototype.addRenderer=function(e,t){return this.tm.addTrigger(e,t)},o.prototype.removeRenderer=function(e){return this.tm.removeTrigger(e)},o.prototype.render=function(e){return this.tm.pullTriggers(e)},o.prototype.size=function(){return this.tm.triggers.length}}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e,t){function o(e,t){e=e||{},this.options=e,r.call(this,e,t),this.id=e.id||"list_"+Math.round(Math.random()*1e3),this.DL=null,this.auto_update=this.options.auto_update||!1,this.htmlRenderer=null,this.lifo=!1,this.init(this.options)}function u(e){s.call(this,e),this.dt="undefined"!=typeof e.dt?e.dt:null,"undefined"!=typeof e.dd&&(this.dd=e.dd)}var n=t.JSUS,r=t.NDDB,i=t.window.HTMLRenderer,s=t.window.HTMLRenderer.Entity;e.List=o,o.prototype=new r,o.prototype.constructor=o,o.prototype.init=function(e){e=e||this.options,this.FIRST_LEVEL=e.first_level||"dl",this.SECOND_LEVEL=e.second_level||"dt",this.THIRD_LEVEL=e.third_level||"dd",this.last_dt=0,this.last_dd=0,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:this.auto_update;var t=this.lifo="undefined"!=typeof e.lifo?e.lifo:this.lifo;this.globalCompare=function(e,n){if(!e&&!n)return 0;if(!n)return 1;if(!e)return-1;if(!t){if(e.dt<n.dt)return-1;if(e.dt>n.dt)return 1}else{if(e.dt<n.dt)return 1;if(e.dt>n.dt)return-1}if(e.dt===n.dt){if("undefined"==typeof e.dd)return-1;if("undefined"==typeof n.dd)return 1;if(e.dd<n.dd)return-1;if(e.dd>n.dd)return 1;if(e.nddbid<n.nddbid)return 1;if(e.nddbid>n.nddbid)return-1}return 0},this.DL=e.list||document.createElement(this.FIRST_LEVEL),this.DL.id=e.id||this.id,e.className&&(this.DL.className=e.className),this.options.title&&this.DL.appendChild(document.createTextNode(e.title)),this.htmlRenderer=new i({render:e.render})},o.prototype._add=function(e){if(!e)return;this.insert(e),this.auto_update&&this.parse()},o.prototype.addDT=function(e,t){if("undefined"==typeof e)return;this.last_dt++,t="undefined"!=typeof t?t:this.last_dt,this.last_dd=0;var n=new u({dt:t,content:e});return this._add(n)},o.prototype.addDD=function(e,t,n){if("undefined"==typeof e)return;t="undefined"!=typeof t?t:this.last_dt,n="undefined"!=typeof n?n:this.last_dd++;var r=new u({dt:t,dd:n,content:e});return this._add(r)},o.prototype.parse=function(){this.sort();var e=null,t=null,n=function(){var n=document.createElement(this.SECOND_LEVEL);return this.DL.appendChild(n),t=null,e=n,n},r=function(){var e=document.createElement(this.THIRD_LEVEL);return this.DL.appendChild(e),e};if(this.DL){while(this.DL.hasChildNodes())this.DL.removeChild(this.DL.firstChild);this.options.title&&this.DL.appendChild(document.createTextNode(this.options.title))}for(var i=0;i<this.db.length;i++){var s=this.db[i],o;"undefined"==typeof s.dd?o=n.call(this):o=r.call(this);var u=this.htmlRenderer.render(s);o.appendChild(u)}return this.DL},o.prototype.getRoot=function(){return this.DL},u.prototype=new s,u.prototype.constructor=u}("undefined"!=typeof node?"undefined"!=typeof node.window?node.window:node:module.parent.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function a(e,t,n){e=e||{},a.log=e.log||a.log,this.defaultDim1=e.defaultDim1||"x",this.defaultDim2=e.defaultDim2||"y",this.defaultDim3=e.defaultDim3||"z",this.table=e.table||r.createElement("table"),this.id=e.id||"table_"+Math.round(Math.random()*1e3),this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!1,this.missing=e.missing||"missing",this.pointers={x:e.pointerX||0,y:e.pointerY||0,z:e.pointerZ||0},this.header=[],this.footer=[],this.left=[],this.right=[],s.call(this,e,t,n),this.options=this.__options}function f(e){u.call(this,e),this.x="undefined"!=typeof e.x?e.x:null,this.y="undefined"!=typeof e.y?e.y:null,this.z="undefined"!=typeof e.z?e.z:null}var r=t.document;e.Table=a,e.Table.Cell=f;var i=n.JSUS,s=n.NDDB,o=n.window.HTMLRenderer,u=n.window.HTMLRenderer.Entity;a.prototype=i.clone(s.prototype),a.prototype.constructor=a,a.H=["x","y","z"],a.V=["y","x","z"],a.log=n.log,a.prototype.init=function(e){s.prototype.init.call(this,e),e=e||this.options,"undefined"!=typeof e.id&&(this.table.id=e.id,this.id=e.id),e.className&&(this.table.className=e.className),this.initRenderer(e.render)},a.prototype.initRenderer=function(e){e=e||{},this.htmlRenderer=new o(e),this.htmlRenderer.addRenderer(function(e){if("object"==typeof e.content){var t=new a;for(var n in e.content)e.content.hasOwnProperty(n)&&t.addRow([n,e.content[n]]);return t.parse()}},2)},a.prototype.get=function(e,t){var n=this;return"undefined"!=typeof e&&(n=this.select("x","=",e)),"undefined"!=typeof t&&(n=n.select("y","=",t)),n.fetch()},a.prototype.addClass=function(e){if(!e)return;return e instanceof Array&&(e=e.join(" ")),this.forEach(function(t){n.window.addClass(t,e)}),this.auto_update&&this.parse(),this},a.prototype.removeClass=function(e){if(!e)return;var t;return e instanceof Array?t=function(e,t){for(var r=0;r<t.length;r++)n.window.removeClass(e,t[r])}:t=n.window.removeClass,this.forEach(function(n){t.call(this,n,e)}),this.auto_update&&this.parse(),this},a.prototype._addSpecial=function(e,t){if(!e)return;t=t||"header";if("object"!=typeof e)return{content:e,type:t};var n=[];for(var r=0;r<e.length;r++)n.push({content:e[r],type:t});return n},a.prototype.setHeader=function(e){this.header=this._addSpecial(e)},a.prototype.add2Header=function(e){this.header=this.header.concat(this._addSpecial(e))},a.prototype.setLeft=function(e){this.left=this._addSpecial(e,"left")},a.prototype.add2Left=function(e){this.left=this.left.concat(this._addSpecial(e,"left"))},a.prototype.setFooter=function(e){this.footer=this._addSpecial(e,"footer")},a._checkDim123=function(e){var t=a.H.slice(0);for(var n=0;n<e.length;n++)if(!i.removeElement(e[n],t))return!1;return!0},a.prototype.updatePointer=function(e,t){if(!e)return!1;if(!i.in_array(e,a.H))return a.log("Cannot update invalid pointer: "+e,"ERR"),!1;if(t>this.pointers[e])return this.pointers[e]=t,!0},a.prototype._add=function(e,t,n,r,i){if(!e)return!1;if(t){if(!a._checkDim123(t))return a.log("Invalid value for dimensions. Accepted only: x,y,z."),!1}else t=a.H;var s=function(e){var n={};n[t[0]]=u,n[t[1]]=l?r+l:r,n[t[2]]=c?i+c:i,n.content=e,this.insert(new f(n)),this.updatePointer(t[0],n[t[0]]),this.updatePointer(t[1],n[t[1]]),this.updatePointer(t[2],n[t[2]])};n=n||this.pointers[t[0]],r=r||this.pointers[t[1]]+1,i=i||this.pointers[t[2]],"object"!=typeof e&&(e=[e]);var o=null;for(var u=0;u<e.length;u++)if(e[u]instanceof Array){for(var l=0;l<e[u].length;l++)if(e[u][l]instanceof Array){for(var c=0;c<e[u][l].length;c++)s.call(this,e[u][l][c]);c=0}else s.call(this,e[u][l]);l=0}else s.call(this,e[u]);this.auto_update&&this.parse(!0)},a.prototype.add=function(e,t,n){if(!e)return;var r=e instanceof f?e:new f({x:t,y:n,content:e}),i=this.insert(r);return i&&(this.updatePointer("x",t),this.updatePointer("y",n)),i},a.prototype.addColumn=function(e,t,n){return e?this._add(e,a.V,t,n):!1},a.prototype.addRow=function(e,t,n){return e?this._add(e,a.H,t,n):!1},a.prototype.parse=function(){var e=function(e,t){if(!e)return;t=t||"td";var n=r.createElement(t),i=this.htmlRenderer.render(e);return n.appendChild(i),e.className&&(n.className=e.className),n};if(this.table)while(this.table.hasChildNodes())this.table.removeChild(this.table.firstChild);var t=this.table,n,i,s;if(this.header&&this.header.length>0){var o=r.createElement("thead");n=r.createElement("tr"),this.left&&this.left.length>0&&n.appendChild(r.createElement("th"));for(s=0;s<this.header.length;s++)n.appendChild(e.call(this,this.header[s],"th"));o.appendChild(n),s=0,t.appendChild(o)}if(this.length){var u=r.createElement("tbody");this.sort(["y","x"]);var a=-1,f=this.first(),l=f.x,c=0;for(s=0;s<this.db.length;s++){a!==this.db[s].y&&(n=r.createElement("tr"),u.appendChild(n),a=this.db[s].y,l=f.x-1,this.left&&this.left.length&&(i=r.createElement("td"),n.appendChild(e.call(this,this.left[c])),c++));if(this.db[s].x>l+1){var h=this.db[s].x-(l+1);for(var p=0;p<h;p++)i=r.createElement("td"),i.className=this.missing,n.appendChild(i)}n.appendChild(e.call(this,this.db[s])),l=this.db[s].x}t.appendChild(u)}if(this.footer&&this.footer.length>0){var d=r.createElement("tfoot");n=r.createElement("tr");for(s=0;s<this.header.length;s++)n.appendChild(e.call(this,this.footer[s]));d.appendChild(n),t.appendChild(d)}return t},a.prototype.resetPointers=function(e){e=e||{},this.pointers={x:e.pointerX||0,y:e.pointerY||0,z:e.pointerZ||0}},a.prototype.clear=function(e){s.prototype.clear.call(this,e)&&this.resetPointers()},f.prototype=new u,f.prototype.constructor=f}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e){function t(){this.root=null}e.Widget=t,t.prototype.dependencies={},t.prototype.defaults={},t.prototype.defaults.fieldset={legend:"Widget"},t.prototype.listeners=function(){},t.prototype.getRoot=function(){return this.root},t.prototype.getValues=function(){},t.prototype.append=function(){},t.prototype.init=function(){},t.prototype.getRoot=function(){},t.prototype.listeners=function(){},t.prototype.getAllValues=function(){},t.prototype.highlight=function(){}}("undefined"!=typeof node?node:module.parent.exports.node),function(e,t){function r(){this.widgets={},this.root=t.window.root||document.body}var n=t.JSUS;r.prototype.register=function(e,r){if(!e||!r)return t.err("Could not register widget: "+e,"nodegame-widgets: "),!1;for(var i in t.Widget.prototype)!r[i]&&!r.prototype[i]&&(!r.prototype.__proto__||!r.prototype.__proto__[i])&&(r.prototype[i]=n.clone(t.Widget.prototype[i]));return this.widgets[e]=r,this.widgets[e]},r.prototype.get=function(e,r){function s(e,t,n){if(!e||!t||!n)return;e.getRoot()[t]=function(){n.call(e)}}function o(e,t){if(!e||!t)return;var r=!1;for(var i in e)e.hasOwnProperty(i)&&(r=n.in_array(i,["onclick","onfocus","onblur","onchange","onsubmit","onload","onunload","onmouseover"]),r&&"function"==typeof e[i]&&s(t,i,e[i]))}if(!e)return;var i=this;r=r||{};var u=n.getNestedValue(e,this.widgets),a;if(!u){t.err("widget "+e+" not found.","node-widgets: ");return}t.info("registering "+u.name+" v."+u.version,"node-widgets: ");if(!this.checkDependencies(u))return!1;n.mixout(r,n.clone(u.defaults));try{a=new u(r),a.defaults=r,a.listeners.call(a),o(r,a)}catch(f){throw new Error("Error while loading widget "+u.name+": "+f)}return a},r.prototype.append=r.prototype.add=function(e,t,n){function i(e,t,n){if(!t)return e;var r=t.id||n.id+"_fieldset",i=t.legend||n.legend;return W.addFieldset(e,r,i,t.attributes)}if(!e)return;var r=this;return t=t||this.root,n=n||{},"object"!=typeof e&&(e=this.get(e,n)),e?(t=i(t,n.fieldset||e.defaults.fieldset,e),e.append(t),e):!1},r.prototype.checkDependencies=function(r,i){if(!r.dependencies)return!0;var s=function(e,n){var r=e.name||e.id;t.log(n+" not found. "+r+" cannot be loaded.","ERR")},o=[e,t,this.widgets,t.window],u=r.dependencies;for(var a in u)if(u.hasOwnProperty(a)){var f=!1;for(var l=0;l<o.length;l++)if(n.getNestedValue(a,o[l])){var f=!0;break}if(!f)return i||s(r,a),!1}return!0},t.widgets=new r}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){function t(e){this.id=e.id,this.text="Waiting for other players to be done...",this.waitingDiv=null}e.widgets.register("WaitScreen",t),t.defaults={},t.defaults.id="waiting",t.defaults.fieldset=!1,t.name="WaitingScreen",t.version="0.3.2",t.description="Show a standard waiting screen",t.prototype.append=function(e){return e},t.prototype.getRoot=function(){return this.waitingDiv},t.prototype.listeners=function(){var t=this;e.on("WAITING...",function(n){t.waitingDiv||(t.waitingDiv=e.window.addDiv(document.body,t.id)),t.waitingDiv.style.display==="none"&&(t.waitingDiv.style.display=""),t.waitingDiv.innerHTML=n||t.text,e.game.pause()}),e.on("LOADED",function(e){t.waitingDiv&&t.waitingDiv.style.display===""&&(t.waitingDiv.style.display="none")})}}(node),function(e){function t(n){this.id=n.id||t.id,this.event=n.event||"D3",this.svg=null;var r=this;e.on(this.event,function(e){r.tick.call(r,e)})}function n(e){t.call(this,e);var r=this.options=JSUS.merge(n.defaults,e),i=this.n=r.n;this.data=[0],this.margin=r.margin;var s=this.width=r.width-this.margin.left-this.margin.right,o=this.height=r.height-this.margin.top-this.margin.bottom,u=this.x=d3.scale.linear().domain(r.domain.x).range(r.range.x),a=this.y=d3.scale.linear().domain(r.domain.y).range(r.range.y);this.line=d3.svg.line().x(function(e,t){return u(t)}).y(function(e,t){return a(e)})}e.widgets.register("D3",t),e.widgets.register("D3ts",n),t.prototype.__proto__=e.Widget.prototype,t.prototype.constructor=t,t.defaults={},t.defaults.id="D3",t.defaults.fieldset={legend:"D3 plot"},t.name="D3",t.version="0.1",t.description="Real time plots for nodeGame with d3.js",t.dependencies={d3:{},JSUS:{}},t.prototype.append=function(e){return this.root=e,this.svg=d3.select(e).append("svg"),e},t.prototype.tick=function(){},n.id="D3ts",n.name="D3ts",n.version="0.1",n.description="Time series plot for nodeGame with d3.js",n.dependencies={D3:{},JSUS:{}},n.prototype.__proto__=t.prototype,n.prototype.constructor=n,n.defaults={},n.defaults.width=400,n.defaults.height=200,n.defaults.margin={top:10,right:10,bottom:20,left:40},n.defaults.domain={x:[0,10],y:[0,1]},n.defaults.range={x:[0,n.defaults.width],y:[n.defaults.height,0]},n.prototype.init=function(e){console.log("init!");var t=this.x,n=this.y,r=this.height,i=this.width,s=this.margin;this.svg.attr("width",i+s.left+s.right).attr("height",r+s.top+s.bottom).append("g").attr("transform","translate("+s.left+","+s.top+")"),this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",i).attr("height",r),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.svg.axis().scale(t).orient("bottom")),this.svg.append("g").attr("class","y axis").call(d3.svg.axis().scale(n).orient("left")),this.path=this.svg.append("g").attr("clip-path","url(#clip)").append("path").data([this.data]).attr("class","line").attr("d",this.line)},n.prototype.tick=function(e){this.alreadyInit=this.alreadyInit||!1,this.alreadyInit||(this.init(),this.alreadyInit=!0);var t=this.x;console.log("tick!"),this.data.push(e),this.path.attr("d",this.line).attr("transform",null),this.data.length>this.n&&(this.path.transition().duration(500).ease("linear").attr("transform","translate("+t(-1)+")"),this.data.shift())}}(node),function(e){function i(e){this.options=e,this.nddb=null,this.commandsDiv=document.createElement("div"),this.id=e.id,"undefined"!=typeof this.id&&(this.commandsDiv.id=this.id),this.info=null,this.init(this.options)}e.widgets.register("NDDBBrowser",i);var t=e.JSUS,n=e.NDDB,r=e.TriggerManager;i.defaults={},i.defaults.id="nddbbrowser",i.defaults.fieldset=!1,i.name="NDDBBrowser",i.version="0.1.2",i.description="Provides a very simple interface to control a NDDB istance.",i.dependencies={JSUS:{},NDDB:{},TriggerManager:{}},i.prototype.init=function(t){function i(){var t=this.id;e.window.addEventButton(t+"_GO_TO_FIRST","<<",this.commandsDiv,"go_to_first"),e.window.addEventButton(t+"_GO_TO_PREVIOUS","<",this.commandsDiv,"go_to_previous"),e.window.addEventButton(t+"_GO_TO_NEXT",">",this.commandsDiv,"go_to_next"),e.window.addEventButton(t+"_GO_TO_LAST",">>",this.commandsDiv,"go_to_last"),e.window.addBreak(this.commandsDiv)}function s(){var e=this.commandsDiv.appendChild(document.createElement("span"));return e}i.call(this),this.info=s.call(this),this.tm=new r,this.tm.init(t.triggers),this.nddb=t.nddb||new n({auto_update_pointer:!0})},i.prototype.append=function(e){return this.root=e,e.appendChild(this.commandsDiv),e},i.prototype.getRoot=function(e){return this.commandsDiv},i.prototype.add=function(e){return this.nddb.insert(e)},i.prototype.sort=function(e){return this.nddb.sort(e)},i.prototype.addTrigger=function(e){return this.tm.addTrigger(e)},i.prototype.removeTrigger=function(e){return this.tm.removeTrigger(e)},i.prototype.resetTriggers=function(){return this.tm.resetTriggers()},i.prototype.listeners=function(){function r(t,r){t?(e.emit(n+"_GOT",t),this.writeInfo(this.nddb.nddb_pointer+1+"/"+this.nddb.length)):this.writeInfo("No element found")}var t=this,n=this.id;e.on(n+"_GO_TO_FIRST",function(){var e=t.tm.pullTriggers(t.nddb.first());r.call(t,e)}),e.on(n+"_GO_TO_PREVIOUS",function(){var e=t.tm.pullTriggers(t.nddb.previous());r.call(t,e)}),e.on(n+"_GO_TO_NEXT",function(){var e=t.tm.pullTriggers(t.nddb.next());r.call(t,e)}),e.on(n+"_GO_TO_LAST",function(){var e=t.tm.pullTriggers(t.nddb.last());r.call(t,e)})},i.prototype.writeInfo=function(e){this.infoTimeout&&clearTimeout(this.infoTimeout),this.info.innerHTML=e;var t=this;this.infoTimeout=setTimeout(function(){t.info.innerHTML=""},2e3)}}(node),function(e){function t(e){this.bar=null,this.root=null,this.recipient=null}e.widgets.register("DataBar",t),t.defaults={},t.defaults.id="databar",t.defaults.fieldset={legend:"Send DATA to players"},t.name="Data Bar",t.version="0.3",t.description="Adds a input field to send DATA messages to the players",t.prototype.append=function(t){var n,r,i;n=W.addButton(t),W.writeln("Text"),r=W.addTextInput(t,"data-bar-text"),W.writeln("Data"),i=W.addTextInput(t,"data-bar-data"),this.recipient=W.addRecipientSelector(t);var s=this;return n.onclick=function(){var t,n,o;t=s.recipient.value,o=r.value,n=i.value,e.log("Parsed Data: "+JSON.stringify(n)),e.say(n,o,t)},e.on("UPDATED_PLIST",function(){e.window.populateRecipientSelector(s.recipient,e.game.pl)}),t}}(node),function(e){function t(e){this.id=e.id,this.root=null,this.div=document.createElement("div"),this.table=null,this.button=null}e.widgets.register("ServerInfoDisplay",t),t.defaults={},t.defaults.id="serverinfodisplay",t.defaults.fieldset={legend:"Server Info",id:"serverinfo_fieldset"},t.name="Server Info Display",t.version="0.3",t.prototype.init=function(t){var n=this;this.div||(this.div=document.createElement("div")),this.div.innerHTML="Waiting for the reply from Server...",this.table||(this.table=new e.window.Table(t)),this.table.clear(!0),this.button=document.createElement("button"),this.button.value="Refresh",this.button.appendChild(document.createTextNode("Refresh")),this.button.onclick=function(){n.getInfo()},this.root.appendChild(this.button),this.getInfo()},t.prototype.append=function(e){return this.root=e,e.appendChild(this.div),e},t.prototype.getInfo=function(){var t=this;e.get("INFO",function(n){e.window.removeChildrenFromNode(t.div),t.div.appendChild(t.processInfo(n))})},t.prototype.processInfo=function(e){this.table.clear(!0);for(var t in e)e.hasOwnProperty(t)&&this.table.addRow([t,e[t]]);return this.table.parse()},t.prototype.listeners=function(){var t=this;e.on("NODEGAME_READY",function(){t.init()})}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.root=null,this.listRoot=null,this.fieldset=null,this.submit=null,this.changeEvent=this.id+"_change",this.init(e)}function r(e){n.call(this,e)}function i(e){n.call(this,e)}function s(t){n.call(this,t),this.groupName="undefined"!=typeof t.name?t.name:e.window.generateUniqueId()}e.widgets.register("Controls",n);var t={id:"controls"};n.defaults=t,n.Slider=r,n.jQuerySlider=i,n.Radio=s,n.name="Controls",n.version="0.2",n.description="Wraps a collection of user-inputs controls.",n.prototype.add=function(e,t,n){},n.prototype.getItem=function(e,t){},n.prototype.init=function(t){this.hasChanged=!1,"undefined"!=typeof t.change&&(t.change?this.changeEvent=t.change:this.changeEvent=!1),this.list=new e.window.List(t),this.listRoot=this.list.getRoot();if(!t.features)return;this.root||(this.root=this.listRoot),this.features=t.features,this.populate()},n.prototype.append=function(t){this.root=t;var n=this.listRoot;this.list.parse(),t.appendChild(this.listRoot);if(this.options.submit){var r="submit_"+this.id;this.options.submit.id&&(r=this.options.submit.id,delete this.options.submit.id),this.submit=e.window.addButton(t,r,this.options.submit,this.options.attributes);var i=this;this.submit.onclick=function(){i.options.change&&e.emit(i.options.change)}}return n},n.prototype.parse=function(){return this.list.parse()},n.prototype.populate=function(){var t=this;for(var n in this.features)if(this.features.hasOwnProperty(n)){var r=this.features[n],i=n;r.id&&(i=r.id,delete r.id);var s=document.createElement("div"),o=this.add(s,i,r);this.changeEvent&&(o.onchange=function(){e.emit(t.changeEvent)}),r.label&&e.window.addLabel(s,o,null,r.label),this.list.addDT(s)}},n.prototype.listeners=function(){var t=this;e.on(this.changeEvent,function(){t.hasChanged=!0})},n.prototype.refresh=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);n&&(n.value=this.features[t].value)}return!0},n.prototype.getAllValues=function(){var t={};for(var n in this.features)if(this.features.hasOwnProperty(n)){var r=e.window.getElementById(n);r&&(t[n]=Number(r.value))}return t},n.prototype.highlight=function(t){return e.window.highlight(this.listRoot,t)},r.prototype.__proto__=n.prototype,r.prototype.constructor=r,r.id="slidercontrols",r.name="Slider Controls",r.version="0.2",r.dependencies={Controls:{}},r.prototype.add=function(t,n,r){return e.window.addSlider(t,n,r)},r.prototype.getItem=function(t,n){return e.window.getSlider(t,n)},i.prototype.__proto__=n.prototype,i.prototype.constructor=i,i.id="jqueryslidercontrols",i.name="Experimental: jQuery Slider Controls",i.version="0.13",i.dependencies={jQuery:{},Controls:{}},i.prototype.add=function(e,t,n){var r=jQuery("<div/>",{id:t}).slider(),i=r.appendTo(e);return i[0]},i.prototype.getItem=function(e,t){var n=jQuery("<div/>",{id:e}).slider();return n},s.prototype.__proto__=n.prototype,s.prototype.constructor=s,s.id="radiocontrols",s.name="Radio Controls",s.version="0.1.1",s.dependencies={Controls:{}},s.prototype.add=function(t,n,r){return"undefined"==typeof r.name&&(r.name=this.groupName),e.window.addRadioButton(t,n,r)},s.prototype.getItem=function(t,n){return"undefined"==typeof n.name&&(n.name=this.groupName),e.window.getRadioButton(t,n)},s.prototype.getAllValues=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);if(n.checked)return n.value}return!1}}(node),function(e){function i(t){this.id=t.id,this.gameLoop=e.game.gameLoop,this.root=null,this.table=new r}e.widgets.register("VisualState",i);var t=e.GameState,n=e.JSUS,r=e.window.Table;i.defaults={},i.defaults.id="visualstate",i.defaults.fieldset={legend:"State",id:"visualstate_fieldset"},i.name="Visual State",i.version="0.2.1",i.description="Visually display current, previous and next state of the game.",i.dependencies={JSUS:{},Table:{}},i.prototype.getRoot=function(){return this.root},i.prototype.append=function(e,t){var n=this,r=this.id+"_";return e.appendChild(this.table.table),this.writeState(),e},i.prototype.listeners=function(){var t=this;e.on("STATECHANGE",function(){t.writeState()})},i.prototype.writeState=function(){var t=!1,n=!1,r=!1,i="-";e.game&&e.game.state?(t=this.gameLoop.getName(e.game.state)||i,n=this.gameLoop.getName(e.game.previous())||i,r=this.gameLoop.getName(e.game.next())||i):(t="Uninitialized",n=i,r=i),this.table.clear(!0),this.table.addRow(["Previous: ",n]),this.table.addRow(["Current: ",t]),this.table.addRow(["Next: ",r]);var s=this.table.select("y","=",2);s.addClass("strong"),s.select("x","=",0).addClass("underline"),this.table.parse()}}(node),function(e){function r(e){this.id=e.id,this.root=null,this.table=new t}var t=e.window.Table,n=e.GameState;e.widgets.register("StateDisplay",r),r.defaults={},r.defaults.id="statedisplay",r.defaults.fieldset={legend:"State Display"},r.name="State Display",r.version="0.4.1",r.description="Display basic information about player's status.",r.prototype.init=function(){},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(t){var n=this,r=this.id+"_",i=r+"fieldset",s=r+"player",o=r+"state",u=setInterval(function(t,r){e.player&&e.player.id&&(clearInterval(u),n.updateAll())},100);return t.appendChild(this.table.table),this.root=t,t},r.prototype.updateAll=function(){var t=e.game?new n(e.game.state):new n,r=e.player?e.player.id:"-";name=e.player&&e.player.name?e.player.name:"-",this.table.clear(!0),this.table.addRow(["Name: ",name]),this.table.addRow(["State: ",t.toString()]),this.table.addRow(["Id: ",r]),this.table.parse()},r.prototype.listeners=function(){var t=this,n=e.actions.SAY+".",r=e.actions.SET+".",i=e.actions.GET+".",s=e.IN,o=e.OUT;e.on("STATECHANGE",function(){t.updateAll()})}}(node),function(e){function s(e,t){r.call(this,e,t),this.options=e,this.id=e.id,this.name=e.name||"Dynamic Table",this.fieldset={legend:this.name,id:this.id+"_fieldset"},this.root=null,this.bindings={},this.init(this.options)}var t=e.GameState,n=e.PlayerList,r=e.window.Table,i=e.window.HTMLRenderer;e.widgets.register("DynamicTable",s),s.prototype=new r,s.prototype.constructor=r,s.id="dynamictable",s.name="Dynamic Table",s.version="0.3.1",s.dependencies={Table:{},JSUS:{},HTMLRenderer:{}},s.prototype.init=function(e){this.options=e,this.name=e.name||this.name,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!0,this.replace=e.replace||!1,this.htmlRenderer=new i({renderers:e.renderers}),this.c("state",t.compare),this.setLeft([]),this.parse(!0)},s.prototype.bind=function(t,n){if(!t||!n)return;var i=this;e.on(t,function(e){if(n.x||n.y){var t;i.replace?t=function(t,s){var o=i.get(t,s);if(o.length!==0)for(var u=0;u<o.length;u++)n.cell.call(i,e,o[u]);else{var a=n.cell.call(i,e,new r.Cell({x:t,y:s}));i.add(a)}}:t=function(t,s){var o=n.cell.call(i,e,new r.Cell({x:t,y:s}));i.add(o,t,s)};var s=n.x.call(i,e),o=n.y.call(i,e);if(s&&o){s=s instanceof Array?s:[s],o=o instanceof Array?o:[o];for(var u=0;u<s.length;u++)for(var a=0;a<o.length;a++)t.call(i,s[u],o[a])}}if(n.header){var f=n.header.call(i,e);f=f instanceof Array?f:[f],i.setHeader(f)}if(n.left){var l=n.left.call(i,e);JSUS.in_array(l,i.left)||i.header.push(l)}i.auto_update&&i.parse()})},s.prototype.append=function(e){return this.root=e,e.appendChild(this.table),e},s.prototype.listeners=function(){}}(node),function(e){function r(e){this.id=e.id||r.defaults.id,this.status_id=this.id+"_statusbar",this.board=null,this.status=null,this.root=null}e.widgets.register("GameBoard",r);var t=e.GameState,n=e.PlayerList;r.defaults={},r.defaults.id="gboard",r.defaults.fieldset={legend:"Game Board"},r.name="GameBoard",r.version="0.4.0",r.description="Offer a visual representation of the state of all players in the game.",r.prototype.append=function(t){return this.root=t,this.status=e.window.addDiv(t,this.status_id),this.board=e.window.addDiv(t,this.id),this.updateBoard(e.game.pl),t},r.prototype.listeners=function(){var t=this;e.on("UPDATED_PLIST",function(){t.updateBoard(e.game.pl)})},r.prototype.printLine=function(e){var n="["+(e.name||e.id)+"]> 	";n+="("+e.state.round+") "+e.state.state+"."+e.state.step,n+=" ";switch(e.state.is){case t.iss.UNKNOWN:n+="(unknown)";break;case t.iss.LOADING:n+="(loading)";break;case t.iss.LOADED:n+="(loaded)";break;case t.iss.PLAYING:n+="(playing)";break;case t.iss.DONE:n+="(done)";break;default:n+="("+e.state.is+")"}return e.state.paused&&(n+=" (P)"),n},r.prototype.printSeparator=function(e){return W.getElement("hr",null,{style:"color: #CCC;"})},r.prototype.updateBoard=function(t){var n=this;this.status.innerHTML="Updating...";var r,i;t.length&&(n.board.innerHTML="",t.forEach(function(e){r=n.printLine(e),W.write(r,n.board),i=n.printSeparator(e),W.write(i,n.board)})),this.status.innerHTML="Connected players: "+e.game.pl.length}}(node),function(e){function n(n){this.options=n,this.id=n.id,this.table=new t({id:"cf_table"}),this.root=n.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.dims=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function r(t,r){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/n.defaults.canvas.width,this.scaleY=t.height/n.defaults.canvas.heigth}function i(e){var e=e||{};this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=i.defaults[t].value)}var t=e.window.Table;e.widgets.register("ChernoffFacesSimple",n),n.defaults={},n.defaults.id="ChernoffFaces",n.defaults.canvas={},n.defaults.canvas.width=100,n.defaults.canvas.heigth=100,n.name="Chernoff Faces",n.version="0.3",n.description="Display parametric data in the form of a Chernoff Face.",n.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},n.FaceVector=i,n.FacePainter=r,n.prototype.init=function(t){var s=this;this.id=t.id||this.id;var o=this.id+"_";this.features=t.features||this.features||i.random(),this.controls="undefined"!=typeof t.controls?t.controls:!0;var u=t.idCanvas?t.idCanvas:o+"canvas",a=t.idButton?t.idButton:o+"button";this.dims={width:t.width?t.width:n.defaults.canvas.width,height:t.height?t.height:n.defaults.canvas.heigth},this.canvas=e.window.getCanvas(u,this.dims),this.fp=new r(this.canvas),this.fp.draw(new i(this.features));var f={id:"cf_controls",features:JSUS.mergeOnKey(i.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",f),this.controls&&this.table.add(this.sc),"undefined"==typeof t.change?e.on(this.change,this.changeFunc):(t.change?e.on(t.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=t.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},n.prototype.getRoot=function(){return this.root},n.prototype.getCanvas=function(){return this.canvas},n.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},n.prototype.listeners=function(){},n.prototype.draw=function(e){if(!e)return;var t=new i(e);this.fp.redraw(t),this.sc.init({features:JSUS.mergeOnKey(i.defaults,e,"value")}),this.sc.refresh()},n.prototype.getAllValues=function(){return this.fp.face},n.prototype.randomize=function(){var e=i.random();this.fp.redraw(e);var t={features:JSUS.mergeOnKey(i.defaults,e,"value"),change:this.change};return this.sc.init(t),this.sc.refresh(),!0},r.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY);var t=t||this.canvas.centerX,n=n||this.canvas.centerY;this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},r.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},r.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},r.prototype.fit2Canvas=function(e){if(!this.canvas){console.log("No canvas found");return}if(this.canvas.width>this.canvas.height)var t=this.canvas.width/e.head_radius*e.head_scale_x;else var t=this.canvas.height/e.head_radius*e.head_scale_y;e.scaleX=t/2,e.scaleY=t/2},r.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyes=function(e,t,n){var i=r.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawPupils=function(e,t,n){var i=e.pupil_radius,s=e.eye_spacing,o=r.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyebrow=function(e,t,n){var i=r.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:i,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:i,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawNose=function(e,t,n){var i=r.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=i+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,i),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},r.prototype.drawMouth=function(e,t,n){var i=r.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=i-e.mouth_top_y,a=i+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,u,o,i),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,a,o,i),this.canvas.ctx.stroke()},r.computeFaceOffset=function(e,t,n){var n=n||0,r=n-e.head_radius+e.head_radius*2*t;return r},r.computeEyebrowOffset=function(e,t){var t=t||0,n=2;return r.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},i.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},i.random=function(){var e={};for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(JSUS.in_array(t,["color","lineWidth","scaleX","scaleY"])||(e[t]=i.defaults[t].min+Math.random()*i.defaults[t].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new i(e)},i.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&i.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=i.defaults[e].min+Math.random()*i.defaults[e].max)},i.prototype.distance=function(e){return i.distance(this,e)},i.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},i.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.root=null,this.text="Send",this.button=document.createElement("button"),this.callback=null,this.init(this.options)}function r(e){e.event="DONE",e.text=e.text||"Done!",n.call(this,e)}var t=e.JSUS;e.widgets.register("EventButton",n),n.defaults={},n.defaults.id="eventbutton",n.defaults.fieldset=!1,n.name="Event Button",n.version="0.2",n.dependencies={JSUS:{}},n.prototype.init=function(t){t=t||this.options,this.button.id=t.id||this.id;var n=t.text||this.text;while(this.button.hasChildNodes())this.button.removeChild(this.button.firstChild);this.button.appendChild(document.createTextNode(n)),this.event=t.event||this.event,this.callback=t.callback||this.callback;var r=this;this.event&&(this.button.onclick=function(){var n=!0;this.callback&&(n=t.callback.call(e.game)),n&&e.emit(r.event)})},n.prototype.append=function(e){return this.root=e,e.appendChild(this.button),e},n.prototype.listeners=function(){},e.widgets.register("DoneButton",r),r.prototype.__proto__=n.prototype,r.prototype.constructor=r,r.id="donebutton",r.version="0.1",r.name="Done Button",r.dependencies={EventButton:{}}}(node),function(e){function r(t){this.options=t,this.id=t.id,this.table=new n({id:"cf_table"}),this.root=t.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function i(t,n){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/r.defaults.canvas.width,this.scaleY=t.height/r.defaults.canvas.heigth}function s(e){e=e||{},this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in s.defaults)s.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=s.defaults[t].value)}var t=e.JSUS,n=e.window.Table;e.widgets.register("ChernoffFaces",r),r.defaults={},r.defaults.id="ChernoffFaces",r.defaults.canvas={},r.defaults.canvas.width=100,r.defaults.canvas.heigth=100,r.name="Chernoff Faces",r.version="0.3",r.description="Display parametric data in the form of a Chernoff Face.",r.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},r.FaceVector=s,r.FacePainter=i,r.prototype.init=function(n){var r=this;this.id=n.id||this.id;var o=this.id+"_";this.features=n.features||this.features||s.random(),this.controls="undefined"!=typeof n.controls?n.controls:!0;var u=n.idCanvas?n.idCanvas:o+"canvas",a=n.idButton?n.idButton:o+"button";this.canvas=e.window.getCanvas(u,n.canvas),this.fp=new i(this.canvas),this.fp.draw(new s(this.features));var f={id:"cf_controls",features:t.mergeOnKey(s.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",f),this.controls&&this.table.add(this.sc),"undefined"==typeof n.change?e.on(this.change,this.changeFunc):(n.change?e.on(n.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=n.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},r.prototype.getCanvas=function(){return this.canvas},r.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},r.prototype.draw=function(e){if(!e)return;var n=new s(e);this.fp.redraw(n),this.sc.init({features:t.mergeOnKey(s.defaults,e,"value")}),this.sc.refresh()},r.prototype.getAllValues=function(){return this.fp.face},r.prototype.randomize=function(){var e=s.random();this.fp.redraw(e);var n={features:t.mergeOnValue(s.defaults,e),change:this.change};return this.sc.init(n),this.sc.refresh(),!0},i.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY),t=t||this.canvas.centerX,n=n||this.canvas.centerY,this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},i.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},i.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},i.prototype.fit2Canvas=function(e){if(!this.canvas){console.log("No canvas found");return}var t;this.canvas.width>this.canvas.height?ratio=this.canvas.width/e.head_radius*e.head_scale_x:ratio=this.canvas.height/e.head_radius*e.head_scale_y,e.scaleX=ratio/2,e.scaleY=ratio/2},i.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyes=function(e,t,n){var r=i.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawPupils=function(e,t,n){var r=e.pupil_radius,s=e.eye_spacing,o=i.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyebrow=function(e,t,n){var r=i.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:r,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:r,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawNose=function(e,t,n){var r=i.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=r+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,r),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},i.prototype.drawMouth=function(e,t,n){var r=i.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=r-e.mouth_top_y,a=r+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,u,o,r),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,a,o,r),this.canvas.ctx.stroke()},i.computeFaceOffset=function(e,t,n){n=n||0;var r=n-e.head_radius+e.head_radius*2*t;return r},i.computeEyebrowOffset=function(e,t){t=t||0;var n=2;return i.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},s.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},s.random=function(){var e={};for(var n in s.defaults)s.defaults.hasOwnProperty(n)&&(t.in_array(n,["color","lineWidth","scaleX","scaleY"])||(e[n]=s.defaults[n].min+Math.random()*s.defaults[n].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new s(e)},s.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&s.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=s.defaults[e].min+Math.random()*s.defaults[e].max)},s.prototype.distance=function(e){return s.distance(this,e)},s.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},s.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){function t(e){this.summaryDiv=null}e.widgets.register("GameSummary",t),t.defaults={},t.defaults.id="gamesummary",t.defaults.fieldset={legend:"Game Summary"},t.name="Game Summary",t.version="0.3",t.description="Show the general configuration options of the game.",t.prototype.append=function(t){return this.root=t,this.summaryDiv=e.window.addDiv(t),this.writeSummary(),t},t.prototype.writeSummary=function(t,n){var r=document.createTextNode("Name: "+e.game.name),i=document.createTextNode("Descr: "+e.game.description),s=document.createTextNode("Min Pl.: "+e.game.minPlayers),o=document.createTextNode("Max Pl.: "+e.game.maxPlayers);this.summaryDiv.appendChild(r),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(i),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(s),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(o),e.window.addDiv(this.root,this.summaryDiv,n)}}(node),function(e){function r(e){this.id=e.id||r.defaults.id,this.root=null,this.spanCurrency=document.createElement("span"),this.spanMoney=document.createElement("span"),this.currency="EUR",this.money=0,this.precision=2,this.init(e)}e.widgets.register("MoneyTalks",r);var t=e.JSUS;r.defaults={},r.defaults.id="moneytalks",r.defaults.fieldset={legend:"Earnings"},r.name="Money talks",r.version="0.1.0",r.description="Display the earnings of a player.",r.dependencies={JSUS:{}},r.prototype.init=function(e){this.currency=e.currency||this.currency,this.money=e.money||this.money,this.precision=e.precision||this.precision,this.spanCurrency.id=e.idCurrency||this.spanCurrency.id||"moneytalks_currency",this.spanMoney.id=e.idMoney||this.spanMoney.id||"moneytalks_money",this.spanCurrency.innerHTML=this.currency,this.spanMoney.innerHTML=this.money},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(e,t){var n=this.id+"_";return e.appendChild(this.spanMoney),e.appendChild(this.spanCurrency),e},r.prototype.listeners=function(){var t=this;e.on("MONEYTALKS",function(e){t.update(e)})},r.prototype.update=function(e){if("number"!=typeof e){e=parseInt(e);if(isNaN(n)||!isFinite(n))return}this.money+=e,this.spanMoney.innerHTML=this.money.toFixed(this.precision)}}(node),function(e){function r(e){this.id=e.id,this.recipient=null,this.actionSel=null,this.targetSel=null,this.table=new n,this.init()}var t=e.GameMsg,n=e.window.Table;e.widgets.register("MsgBar",r),r.defaults={},r.defaults.id="msgbar",r.defaults.fieldset={legend:"Send MSG"},r.name="Msg Bar",r.version="0.4",r.description="Send a nodeGame message to players",r.prototype.init=function(){var n=this,r=new t,i=0;for(var s in r)if(r.hasOwnProperty(s)){var o=this.id+"_"+s;this.table.add(s,0,i),this.table.add(e.window.getTextInput(o),1,i),s==="target"?(this.targetSel=e.window.getTargetSelector(this.id+"_targets"),this.table.add(this.targetSel,2,i),this.targetSel.onchange=function(){e.window.getElementById(n.id+"_target").value=n.targetSel.value}):s==="action"?(this.actionSel=e.window.getActionSelector(this.id+"_actions"),this.table.add(this.actionSel,2,i),this.actionSel.onchange=function(){e.window.getElementById(n.id+"_action").value=n.actionSel.value}):s==="to"&&(this.recipient=e.window.getRecipientSelector(this.id+"recipients"),this.table.add(this.recipient,2,i),this.recipient.onchange=function(){e.window.getElementById(n.id+"_to").value=n.recipient.value}),i++}this.table.parse()},r.prototype.append=function(t){var n=e.window.addButton(t),r=e.window.addButton(t,"stub","Add Stub"),i=this;return n.onclick=function(){var t=i.parse();e.gsc.send(t)},r.onclick=function(){i.addStub()},t.appendChild(this.table.table),this.root=t,t},r.prototype.getRoot=function(){return this.root},r.prototype.listeners=function(){var t=this;e.onPLIST(function(n){e.window.populateRecipientSelector(t.recipient,n.data)})},r.prototype.parse=function(){var n={},r=this,i=null,s=null;this.table.forEach(function(e){if(e.x===0)i=e.content,n[i]="";else if(e.x===1){s=e.content.value;if(i==="state"||i==="data")try{s=JSON.parse(e.content.value)}catch(t){s=e.content.value}n[i]=s}});var o=new t(n);return e.info(o,"MsgBar sent: "),o},r.prototype.addStub=function(){e.window.getElementById(this.id+"_from").value=e.player?e.player.id:"undefined",e.window.getElementById(this.id+"_to").value=this.recipient.value,e.window.getElementById(this.id+"_forward").value=0,e.window.getElementById(this.id+"_reliable").value=1,e.window.getElementById(this.id+"_priority").value=0,e.gsc&&e.gsc.session&&(e.window.getElementById(this.id+"_session").value=e.gsc.session),e.window.getElementById(this.id+"_state").value=JSON.stringify(e.state),e.window.getElementById(this.id+"_action").value=this.actionSel.value,e.window.getElementById(this.id+"_target").value=this.targetSel.value}}(node),function(e){function r(e){this.id=e.id||r.id,this.mode=e.mode||r.defaults.mode,this.root=null,this.textarea_id=e.textarea_id||r.defaults.textarea_id,this.chat_id=e.chat_id||r.defaults.chat_id,this.submit_id=e.submit_id||r.defaults.submit_id,this.chat_event=e.chat_event||r.defaults.chat_event,this.submit_text=e.submit_text||r.defaults.submit_text,this.submit=n.getEventButton(this.chat_event,this.submit_text,this.submit_id),this.textarea=n.getElement("textarea",this.textarea_id),this.chat=n.getElement("div",this.chat_id),"undefined"!=typeof e.displayName&&(this.displayName=e.displayName);switch(this.mode){case r.modes.RECEIVER_ONLY:this.recipient={value:"SERVER"};break;case r.modes.MANY_TO_ONE:this.recipient={value:"ALL"};break;case r.modes.ONE_TO_ONE:this.recipient={value:"SERVER"};break;default:this.recipient=n.getRecipientSelector()}}e.widgets.register("Chat",r);var t=e.JSUS,n=e.window;r.defaults={},r.defaults.id="chat",r.defaults.fieldset={legend:"Chat"},r.defaults.mode="MANY_TO_MANY",r.defaults.textarea_id="chat_textarea",r.defaults.chat_id="chat_chat",r.defaults.chat_event="CHAT",r.defaults.submit_id="chat_submit",r.defaults.submit_text="chat",r.modes={MANY_TO_MANY:"MANY_TO_MANY",MANY_TO_ONE:"MANY_TO_ONE",ONE_TO_ONE:"ONE_TO_ONE",RECEIVER_ONLY:"RECEIVER_ONLY"},r.name="Chat",r.version="0.4",r.description="Offers a uni / bi-directional communication interface between players, or between players and the experimenter.",r.dependencies={JSUS:{}},r.prototype.append=function(e){return this.root=e,e.appendChild(this.chat),this.mode!==r.modes.RECEIVER_ONLY&&(n.writeln("",e),e.appendChild(this.textarea),n.writeln("",e),e.appendChild(this.submit),this.mode===r.modes.MANY_TO_MANY&&e.appendChild(this.recipient)),e},r.prototype.getRoot=function(){return this.root},r.prototype.displayName=function(e){return e},r.prototype.readTA=function(){var e=this.textarea.value;return this.textarea.value="",e},r.prototype.writeTA=function(e,r){t.sprintf(e,r,this.chat),n.writeln("",this.chat),this.chat.scrollTop=this.chat.scrollHeight},r.prototype.listeners=function(){var t=this;e.on(this.chat_event,function(){var n=t.readTA();if(!n)return;var r=t.recipient.value,i={"%s":{"class":"chat_me"},"%msg":{"class":"chat_msg"},"!txt":n};t.writeTA("%sMe%s: %msg!txt%msg",i),e.say(n.trim(),t.chat_event,r)}),this.mode===r.modes.MANY_TO_MANY&&e.on("UPDATED_PLIST",function(){n.populateRecipientSelector(t.recipient,e.game.pl.fetch())}),e.onDATA(this.chat_event,function(n){if(n.from===e.player.id||n.from===e.player.sid)return;if(this.mode===r.modes.ONE_TO_ONE&&n.from===this.recipient.value)return;var i=t.displayName(n.from),s={"%s":{"class":"chat_others"},"%msg":{"class":"chat_msg"},"!txt":n.data,"!from":i};t.writeTA("%s!from%s: %msg!txt%msg",s)})}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.gameTimer=null,this.timerDiv=null,this.root=null,this.init(this.options)}e.widgets.register("VisualTimer",n);var t=e.JSUS;n.defaults={},n.defaults.id="visualtimer",n.defaults.fieldset={legend:"Time left",id:"visualtimer_fieldset"},n.name="Visual Timer",n.version="0.3.3",n.description="Display a timer for the game. Timer can trigger events. Only for countdown smaller than 1h.",n.dependencies={GameTimer:{},JSUS:{}},n.prototype.init=function(t){t=t||this.options;var n=this;(function(){t.hooks?!t.hooks instanceof Array&&(t.hooks=[t.hooks]):t.hooks=[],t.hooks.push({hook:n.updateDisplay,ctx:n})})(),this.gameTimer=t.gameTimer||new e.GameTimer,this.gameTimer?this.gameTimer.init(t):e.log("GameTimer object could not be initialized. VisualTimer will not work properly.","ERR"),this.timerDiv&&(this.timerDiv.className=t.className||"")},n.prototype.getRoot=function(){return this.root},n.prototype.append=function(t){return this.root=t,this.timerDiv=e.window.addDiv(t,this.id+"_div"),this.updateDisplay(),t},n.prototype.updateDisplay=function(){if(!this.gameTimer.milliseconds||this.gameTimer.milliseconds===0){this.timerDiv.innerHTML="00:00";return}var e=this.gameTimer.milliseconds-this.gameTimer.timePassed;e=t.parseMilliseconds(e);var n=e[2]<10?"0"+e[2]:e[2],r=e[3]<10?"0"+e[3]:e[3];this.timerDiv.innerHTML=n+":"+r},n.prototype.start=function(){this.updateDisplay(),this.gameTimer.start()},n.prototype.restart=function(e){this.init(e),this.start()},n.prototype.stop=function(e){this.gameTimer.stop()},n.prototype.resume=function(e){this.gameTimer.resume()},n.prototype.listeners=function(){var n=this;e.on("LOADED",function(){var r=e.game.gameLoop.getAllParams(e.game.gameState).timer;if(r){r=t.clone(r),n.timerDiv.className="";var i={},s=typeof r;switch(s){case"number":i.milliseconds=r;break;case"object":i=r;break;case"function":i.milliseconds=r;break;case"string":i.milliseconds=Number(r)}if(!i.milliseconds)return;"function"==typeof i.milliseconds&&(i.milliseconds=i.milliseconds.call(e.game)),i.timeup||(i.timeup="DONE"),n.gameTimer.init(i),n.start()}}),e.on("DONE",function(){n.gameTimer.stop(),n.timerDiv.className="strike"})}}(node),function(e){function t(e){this.id=e.id}e.widgets.register("NextPreviousState",t),t.defaults={},t.defaults.id="nextprevious",t.defaults.fieldset={legend:"Rew-Fwd"},t.name="Next,Previous State",t.version="0.3.1",t.description="Adds two buttons to push forward or rewind the state of the game by one step.",t.prototype.getRoot=function(){return this.root},t.prototype.append=function(t){var n=this.id+"_button",r=this.id+"_button",i=e.window.addButton(t,n,"<<"),s=e.window.addButton(t,r,">>"),o=this,u=function(t){if(t){var n=e.IN+e.actions.SAY+".STATE",r=e.msg.createSTATE(n,t);e.emit(n,r),n=e.OUT+e.actions.SAY+".STATE",e.emit(n,t,"ALL")}else e.log("No next/previous state. Not sent","ERR")};return s.onclick=function(){u(e.game.next())},i.onclick=function(){u(e.game.previous())},this.root=t,t}}(node),function(e){function n(t){this.id=t.id||n.id,this.name=t.name||this.name,this.buffer=[],this.counter=0,this.wall=e.window.getElement("pre",this.id)}e.widgets.register("Wall",n);var t=e.JSUS;n.defaults={},n.defaults.id="wall",n.defaults.fieldset={legend:"Game Log"},n.name="Wall",n.version="0.3",n.description="Intercepts all LOG events and prints them ",n.description+="into a DIV element with an ordinal number and a timestamp.",n.dependencies={JSUS:{}},n.prototype.init=function(e){e=e||{},this.counter=e.counter||this.counter},n.prototype.append=function(e){return e.appendChild(this.wall)},n.prototype.getRoot=function(){return this.wall},n.prototype.listeners=function(){var t=this;e.on("LOG",function(e){t.debuffer(),t.write(e)})},n.prototype.write=function(e){if(document.readyState!=="complete")this.buffer.push(s);else{var n=this.counter++ +") "+t.getTime()+" ";this.wall.innerHTML=n+e+"\n"+this.wall.innerHTML}},n.prototype.debuffer=function(){if(document.readyState==="complete"&&this.buffer.length>0){for(var e=0;e<this.buffer.length;e++)this.write(this.buffer[e]);this.buffer=[]}}}(node),function(e){function r(e){this.options=e,this.id=e.id,this.name=e.name||r.name,this.root=null,this.gtbl=null,this.plist=null,this.init(this.options)}var t=e.GameState,n=e.PlayerList;e.widgets.register("GameTable",r),r.defaults={},r.defaults.id="gametable",r.defaults.fieldset={legend:"Game Table",id:"gametable_fieldset"},r.name="Game Table",r.version="0.2",r.dependencies={JSUS:{}},r.prototype.init=function(r){this.plist||(this.plist=new n),this.gtbl=new e.window.Table({auto_update:!0,id:r.id||this.id,render:r.render},e.game.memory.db),this.gtbl.c("state",t.compare),this.gtbl.setLeft([]),this.gtbl.parse(!0)},r.prototype.addRenderer=function(e){return this.gtbl.addRenderer(e)},r.prototype.resetRender=function(){return this.gtbl.resetRenderer()},r.prototype.removeRenderer=function(e){return this.gtbl.removeRenderer(e)},r.prototype.append=function(e){return this.root=e,e.appendChild(this.gtbl.table),e},r.prototype.listeners=function(){var t=this;e.onPLIST(function(e){if(!e.data.length)return;var r=new n({},e.data),i=r.diff(t.plist);i&&i.forEach(function(e){t.addPlayer(e)}),t.gtbl.parse(!0)}),e.on("in.set.DATA",function(n){t.addLeft(n.state,n.from);var r=t.player2x(n.from),i=t.state2y(e.game.state,n.text);t.gtbl.add(n.data,r,i),t.gtbl.parse(!0)})},r.prototype.addPlayer=function(e){this.plist.add(e);var t=this.plist.map(function(e){return e.name});this.gtbl.setHeader(t)},r.prototype.addLeft=function(e,n){if(!e)return;e=new t(e);if(!JSUS.in_array({content:e.toString(),type:"left"},this.gtbl.left))this.gtbl.add2Left(e.toString());else{var r=this.state2y(e),i=this.player2x(n);this.gtbl.select("y","=",r).select("x","=",i).count()>1&&this.gtbl.add2Left(e.toString())}},r.prototype.player2x=function(e){return e?this.plist.select("id","=",e).first().count:!1},r.prototype.x2Player=function(e){return e?this.plist.select("count","=",e).first().count:!1},r.prototype.state2y=function(t){return t?e.game.gameLoop.indexOf(t):!1},r.prototype.y2State=function(n){return n?e.game.gameLoop.jumpTo(new t,n):!1}}(node),function(e){function t(e){this.id=e.id,this.recipient=null}e.widgets.register("StateBar",t),t.defaults={},t.defaults.id="statebar",t.defaults.fieldset={legend:"Change Game State"},t.name="State Bar",t.version="0.3.1",t.description="Provides a simple interface to change the state of the game.",t.prototype.getRoot=function(){return this.root},t.prototype.append=function(t){var n=this.id+"_",r=n+"sendButton",i=n+"stateSel",s=n+"recipient",o=e.window.addButton(t,r),u=e.window.addStateSelector(t,i);this.recipient=e.window.addRecipientSelector(t,s);var a=this;return e.on("UPDATED_PLIST",function(){e.window.populateRecipientSelector(a.recipient,e.game.pl)}),o.onclick=function(){var t=a.recipient.value,n=/^(\d+)(?:\.(\d+))?(?::(\d+))?$/,r=n.exec(u.value),i,s,o,f,l;r!==null?(i=r[1],s=r[2]||1,o=r[3]||1,e.log("Parsed State: "+r.join("|")),i=new e.GameState({state:i,step:s,round:o}),t==="ALL"&&(f=e.IN+e.actions.SAY+".STATE",l=e.msg.createSTATE(f,i),e.emit(f,l)),f=e.OUT+e.actions.SAY+".STATE",e.emit(f,i,t)):(e.err("Not valid state. Not sent."),e.socket.sendTXT("E: not valid state. Not sent"))},this.root=t,t}}(node)