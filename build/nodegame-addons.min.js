/**
 * # GameTimer
 * 
 * Copyright(c) 2012 Stefano Balietti
 * MIT Licensed 
 * 
 * Creates a controllable timer object for nodeGame 
 * 
 * ---
 * 
 */
(function(e,t){function n(e){e=e||{},this.status=n.UNINITIALIZED,this.options=e,this.timer=null,this.timeLeft=null,this.timePassed=0,this.update=1e3,this.timeup="TIMEUP",this.hooks=[],this.init(),this.listeners()}e.GameTimer=n,JSUS=t.JSUS,n.STOPPED=-5,n.PAUSED=-3,n.UNINITIALIZED=-1,n.INITIALIZED=0,n.LOADING=3,n.RUNNING=5,n.prototype.init=function(e){e=e||this.options,this.status=n.UNINITIALIZED,this.timer&&clearInterval(this.timer),this.milliseconds=e.milliseconds||0,this.timeLeft=this.milliseconds,this.timePassed=0,this.update=e.update||1e3,this.timeup=e.timeup||"TIMEUP";if(e.hooks)for(var t=0;t<e.hooks.length;t++)this.addHook(e.hooks[t]);this.status=n.INITIALIZED},n.prototype.fire=function(e){if(!e&&!e.hook)return;var n=e.hook||e;if("function"==typeof n){var r=e.ctx||t.game;n.call(r)}else t.emit(n)},n.prototype.start=function(){this.status=n.LOADING;if(this.options.milliseconds===0){t.emit(this.timeup);return}var e=this;this.timer=setInterval(function(){e.status=n.RUNNING,t.log("interval started: "+e.timeLeft,"DEBUG","GameTimer: "),e.timePassed=e.timePassed+e.update,e.timeLeft=e.milliseconds-e.timePassed;for(var r=e.hooks.length;r>0;r--)e.fire(e.hooks[r-1]);e.timeLeft<=0&&(e.stop(),e.fire(e.timeup),t.log("time is up: "+e.timeup,"DEBUG","GameTimer: "))},this.update)},n.prototype.addHook=function(e,n){if(!e)return;var n=n||t.game;if(e.hook){n=e.ctx||n;var e=e.hook}this.hooks.push({hook:e,ctx:n})},n.prototype.pause=function(){this.status>0&&(this.status=n.PAUSED,clearInterval(this.timer))},n.prototype.resume=function(){if(this.status!==n.PAUSED)return;var e=JSUS.extend({milliseconds:this.milliseconds-this.timePassed},this.options);this.restart(e)},n.prototype.stop=function(){if(this.status===n.UNINITIALIZED)return;if(this.status===n.INITIALIZED)return;if(this.status===n.STOPPED)return;this.status=n.STOPPED,clearInterval(this.timer),this.timePassed=0,this.timeLeft=null},n.prototype.restart=function(e){this.init(e),this.start()},n.prototype.listeners=function(){var e=this}})("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){this.triggers=[],this.options=e||{};var r=n.first;Object.defineProperty(this,"returnAt",{set:function(e){return!e||e!==n.first&&e!==n.last?(t.log("Invalid returnAt type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!0,enumerable:!0}),Object.defineProperty(this,"length",{set:function(){},get:function(){return this.triggers.length},configurable:!0}),this.init()}e.TriggerManager=n,n.first="first",n.last="last",n.prototype.init=function(e){this.options=e||this.options;if(this.options.returnAt===n.first||this.options.returnAt===n.last)this.returnAt=this.options.returnAt;this.resetTriggers()},n.prototype.initTriggers=function(e){if(!e)return;e instanceof Array||(e=[e]);for(var t=0;t<e.length;t++)this.triggers.push(e[t])},n.prototype.resetTriggers=function(){this.triggers=[],this.initTriggers(this.options.triggers)},n.prototype.clear=function(e){return e?(this.triggers=[],e):(t.log("Do you really want to clear the current TriggerManager obj? Please use clear(true)","WARN"),!1)},n.prototype.addTrigger=function(e,t){return e?"function"!=typeof e?!1:(t?this.triggers.splice(t,0,e):this.triggers.push(e),!0):!1},n.prototype.removeTrigger=function(e){if(!e)return!1;for(var t=0;t<this.triggers.length;t++)if(this.triggers[t]==e)return this.triggers.splice(t,1);return!1},n.prototype.pullTriggers=function(e){if("undefined"==typeof e)return;if(!this.length)return e;for(var t=this.triggers.length;t>0;t--){var r=this.triggers[t-1].call(this,e);if("undefined"!=typeof r&&this.returnAt===n.first)return r}return"undefined"!=typeof r?r:e},n.prototype.size=function(){return this.triggers.length}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.JSUS,n=e.NDDB,r=e.store,i="nodegame_";e.session=function(t){if(!t){var n={id:e.gsc.session,player:e.player,memory:e.game.memory,state:e.game.state,game:e.game.name,history:undefined};if(e.events.history||e.events.history.length)n.history=e.events.history.fetch();return n}return e.session.isEnabled()?e.store(i+t):!1},e.session.isEnabled=function(){return e.store?e.store.isPersistent():!1},e.session.store=function(){if(!e.session.isEnabled())return e.log("Could not save the session"),!1;var t=e.session(),n=t.id;return e.store(i+n,t),e.log("Session saved with id "+n),!0}}("undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){e=e||{},this.players=e.players}function i(e){t.TriggerManager.call(this,e),t.pool=new t.PlayerList,t.game.room={};var n=this,i=function(){console.log("CAPTURED");var e=n.pullTriggers();if(!e)return;r.isArray(e)||(e=[e]);var i,s,o=0;for(i=0;i<e.length;i++)s=e[i].name||o++,t.game.room[s]=new Game(e[i]),t.game.room[s].step()},s=function(){t.onPLIST(function(){i()})},o;Object.defineProperty(this,"onConnect",{set:function(e){e===!1?(t.removeListener("in.say.PLIST",i),t.removeListener("in.set.PLIST",i)):e===!0&&t.onPLIST(i),o=e},get:function(){return o},configurable:!0});var u,a;Object.defineProperty(this,"onTimeout",{set:function(e){e?"numeric"==typeof e&&(u&&clearTimeout(u),a=e,u=setTimeout(i)):(clearTimeout(u),a=e,u=!1)},get:function(){return a},configurable:!0});var f,l;Object.defineProperty(this,"onInterval",{set:function(e){e?"numeric"==typeof e&&(f&&clearInterval(f),f=setInterval(i),l=e):(clearInterval(f),l=e,f=!1)},get:function(){return l},configurable:!0}),this.init(e)}if(!t.TriggerManager)throw new Error("node.TriggerManager not found. Aborting");var r=t.JSUS;e.WaitingRoom=i,i.prototype=new t.TriggerManager,i.prototype.constructor=i,i.defaults={},i.prototype.init=function(e){e=e||{},this.onConnect=e.onConnect||!0,this.onTimeout=e.onTimeout||!1,this.onInterval=e.onInterval||!1,this.addTrigger(function(){return new n({players:t.pool,game:e.loops})}),e.minPlayers&&e.maxPlayers&&this.addTrigger(function(){if(t.pool.length<e.minPlayers)return!1;if(t.pool.length>e.maxPlayers){var r=t.pool.shuffle().limit(e.maxPlayers);return new n({players:r,game:e.loops})}return new n({players:t.pool,game:e.loops})}),e.minPlayers&&this.addTrigger(function(){return t.pool.length<e.minPlayers?!1:new n({players:t.pool,game:e.loops})}),e.maxPlayers&&this.addTrigger(function(){if(t.pool.length>e.maxPlayers){var r=t.pool.shuffle().limit(e.maxPlayers);return new n({players:r,game:e.loops})}}),e.nPlayers&&this.addTrigger(function(){if(t.pool.length===e.nPlayers)return new n({players:t.pool,game:e.loops})})},i.prototype.criteria=function(e,t){this.addTrigger(e,t)},i.prototype.setInterval=function(e){e||clearInterval(this.interval),this.interval&&clearInterval(this.interval),this.interval=setInterval(this.pullTriggers,e)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports)